<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
<meta name="author" content="Nikolai Tschacher" />
<meta name="description" content="UPDATE on 18th February 2014: This python module has now its own github repository! The plugin can extract All links Link titles The description/caption below the links and has the following features: Advanced proxy support for SOCKS4/4a/5 and HTTP PROXY Multithreading XPATH parsing Supports almost all search ..." />
<meta name="keywords" content="Google, Scraping, Programming, Security">
<meta property="og:site_name" content="Coding, Learning and IT Security"/>
<meta property="og:title" content="GoogleScraper.py - A simple python module to parse google search results."/>
<meta property="og:description" content="UPDATE on 18th February 2014: This python module has now its own github repository! The plugin can extract All links Link titles The description/caption below the links and has the following features: Advanced proxy support for SOCKS4/4a/5 and HTTP PROXY Multithreading XPATH parsing Supports almost all search ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/googlesearch-a-rapid-python-class-to-get-search-results.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2013-01-06 21:27:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/nikolai-tschacher.html">
<meta property="article:section" content="Programming"/>
<meta property="article:tag" content="Google"/>
<meta property="article:tag" content="Scraping"/>
<meta property="article:tag" content="Programming"/>
<meta property="article:tag" content="Security"/>
<meta property="og:image" content="">  <title>Coding, Learning and IT Security &ndash; GoogleScraper.py - A simple python module to parse google search results.</title>
</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="Coding, Learning and IT Security" title="Coding, Learning and IT Security">
      </a>
      <h1><a href="">Coding, Learning and IT Security</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/pages/about.html#about">About</a></li>
          <li><a href="/pages/contact.html#contact">Contact</a></li>
          <li><a href="/pages/googlescraper-py.html#googlescraper-py">GoogleScraper.py</a></li>
          <li><a href="/pages/projects.html#projects">Projects</a></li>
          <li><a href="/pages/impressum.html#impressum">Site Notice</a></li>
          <li><a href="/pages/svgcaptcha.html#svgcaptcha">SVGCaptcha</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="https://twitter.com/incolumitas_" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/NikolaiT" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="//incolumitas/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1052496/nikolai-tschacher" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
    </nav>

<article>
  <header>
    <h1 id="googlesearch-a-rapid-python-class-to-get-search-results">GoogleScraper.py - A simple python module to parse google search results.</h1>
    <p>Posted on So 06 Januar 2013 in <a href="/category/programming.html">Programming</a></p>
  </header>
  <div>
    <p><strong>UPDATE on 18th February 2014:</strong></p>
<p>This python module has now <a href="https://github.com/NikolaiT/GoogleScraper" title="github repo for GoogleScraper">its own github
repository</a>!</p>
<p>The plugin can extract</p>
<ul>
<li>All links</li>
<li>Link titles</li>
<li>The description/caption below the links</li>
</ul>
<p>and has the following features:</p>
<ul>
<li>Advanced proxy support for SOCKS4/4a/5 and HTTP PROXY</li>
<li>Multithreading</li>
<li>XPATH parsing</li>
<li>Supports almost <a href="http://www.google.com/support/enterprise/static/gsa/docs/admin/70/gsa_doc_set/xml_reference/" title="search protocol reference">all search
    parameters</a></li>
</ul>
<p>Please note that this is by no means a permanent version! Heavy
structural changes will be implemented in the near future (I'll
experiment with asynchronous networking for instance). But on this site,
I will always host a working version with instructions how to use it,
such that visitors can always use the script!</p>
<p><strong>1. Edit (07.01.2013):</strong></p>
<ul>
<li>Using requests instead of urllib</li>
<li>Added random User Agents for every new search.</li>
<li>Cleaned the code</li>
<li>Implemented foundation to combine with proxychains</li>
</ul>
<h3>Original Blog Post</h3>
<p>Sample output after searching for 'cats are not cute' (sorry) with 100
results per page on 3 ascending pages:
<a href="/uploads/2013/01/out.txt">results.txt</a></p>
<p>I always was in need of a fast and reliable working python module to
query the google search engine. The google API is rubbish, because they
just give you maximally 36 results. This is completly inacceptable!</p>
<p>So, I looked further and found <a href="http://code.google.com/p/pygoogle/">http://code.google.com/p/pygoogle/</a>,
which is not what we want. They say:</p>
<blockquote>
<p><em>pygoogle is a <strong>very basic</strong> Google search module for Python. It has
a limitation of only 64 results. If you want more results, see
xgoogle.<a href="http://www.catonmat.net/blog/python-library-for-google-translate/"><br />
</a></em></p>
</blockquote>
<p>Le optimistic me goes to the homepage of
<a href="http://www.catonmat.net/blog/python-library-for-google-search/">xgoogle</a>,
just to be disappointed again. The module seems broken and imports some
outdated libraries and is generally very very large. The author probably
did a nice job, but I immediately realized that I have to implement my
own. This was unacceptable, since my python programming knowledge and
coding style really lacks any depth and profundity.</p>
<p><strong>The module should basically satisfy two purposes:</strong></p>
<ul>
<li>Parse arbitrary number of pages with maximally number of search
    results per page.</li>
<li>Clean the found urls from badboys like 'gstatic.com' or 'google.com'</li>
</ul>
<p><strong>What can you use the module for?</strong></p>
<ul>
<li>Statistics</li>
<li>Find vulnerable applications</li>
<li>scanning lots of sites with dorks (with intext, inurl, site
    parameters usable in the query!)</li>
</ul>
<p><strong>To-do list (06.01.2013):</strong></p>
<ul>
<li>Clean the code. Treat all errors correctly and make the script more
    robust.</li>
<li>Add functionality, like a parallel yahoo and bing search to compare
    the search results to gain maximal knowledge!</li>
<li>Provide better configuration freedom. There are a lot of google
    search parameters :/</li>
<li>Maybe: Port to Python 2.7</li>
</ul>
<h3>Usage</h3>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">GoogleScraper</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">GoogleScraper</span><span class="o">.</span><span class="n">scrape</span><span class="p">(</span><span class="s">&#39;Best SEO tool&#39;</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">num_pages</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">link_title</span><span class="p">,</span> <span class="n">link_snippet</span><span class="p">,</span> <span class="n">link_url</span> <span class="ow">in</span> <span class="n">page</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]:</span>
            <span class="c"># You can access all parts of the search results like that</span>
            <span class="c"># link_url.scheme =&gt; URL scheme specifier (Ex: &#39;http&#39;)</span>
            <span class="c"># link_url.netloc =&gt; Network location part (Ex: &#39;www.python.org&#39;)</span>
            <span class="c"># link_url.path =&gt; URL scheme specifier (Ex: &#39;&#39;help/Python.html&#39;&#39;)</span>
            <span class="c"># link_url.params =&gt; Parameters for last path element</span>
            <span class="c"># link_url.query =&gt; Query component</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">link_url</span><span class="o">.</span><span class="n">geturl</span><span class="p">()))</span> <span class="c"># This reassembles the parts of the url to the whole thing</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c"># How many urls did we get on all pages?</span>
<span class="k">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">results</span><span class="p">))</span>

<span class="c"># How many hits has google found with our keyword (as shown on the first page)?</span>
<span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;num_results_for_kw&#39;</span><span class="p">])</span>
</pre></div>


<p><strong>[Warning: This description is deprecated, the sources are fresh
tough]</strong></p>
<p>How it works: Basically you create a GoogleScraper object with the
query to search. You also specify the number of results per page
(10,25,50 or 100) you want to obtain. Then you call the method search()
on the new made object with a parameter indicating the number of pages
too search for. I didn't try how many pages I can scrape\^\^ It's up to
you to tell me!</p>
<p>The GoogleScraper.search() methods returns a list of special tuples!
Each of these tuples represents a URL. If you want to know more about
this special tupel, please read the python
<a href="http://docs.python.org/3.2/library/urllib.parse.html#url-parsing">documentation</a>.</p>
<p>The module is here:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/python3</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Complete rewrite.</span>
<span class="sd">Many thanks go to v3nz3n</span>

<span class="sd">This is a little module that uses Google to automate search</span>
<span class="sd">queries. It gives straightforward access to all relevant data of Google such as</span>
<span class="sd">- The links of the result page</span>
<span class="sd">- The title of the links</span>
<span class="sd">- The caption/description below each link</span>
<span class="sd">- The number of results for this keyword</span>

<span class="sd">GoogleScraper&#39;s architecture outlined:</span>
<span class="sd">- Proxy support (Socks5, Socks4, HTTP Proxy)</span>
<span class="sd">- Threading support</span>

<span class="sd">The module implements some countermeasures to circumvent spamming detection</span>
<span class="sd">from the Google Servers:</span>
<span class="sd">{List them here}</span>

<span class="sd">Note: Scraping compromises the google terms of service (TOS).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__VERSION__</span> <span class="o">=</span> <span class="s">&#39;0.4&#39;</span>
<span class="n">__UPDATED__</span> <span class="o">=</span> <span class="s">&#39;17.02.2014&#39;</span> <span class="c"># day.month.year</span>
<span class="n">__AUTHOR__</span> <span class="o">=</span> <span class="s">&#39;Nikolai Tschacher&#39;</span>
<span class="n">__WEBSITE__</span> <span class="o">=</span> <span class="s">&#39;incolumitas.com&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">lxml.html</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">choice</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">requests</span>
    <span class="kn">from</span> <span class="nn">cssselect</span> <span class="k">import</span> <span class="n">HTMLTranslator</span><span class="p">,</span> <span class="n">SelectorError</span>
    <span class="kn">from</span> <span class="nn">bs4</span> <span class="k">import</span> <span class="n">UnicodeDammit</span>
    <span class="kn">import</span> <span class="nn">socks</span> <span class="c"># should be in the same directory</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s">&#39;You can install missing modules with `pip install [modulename]`&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># module wide global variables and configuration</span>

<span class="c"># First obtain a logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;GoogleScraper&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39;</span><span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

<span class="c"># Whether caching shall be enabled</span>
<span class="n">DO_CACHING</span> <span class="o">=</span> <span class="k">True</span>
<span class="c"># The directory path for cached google results</span>
<span class="n">CACHEDIR</span> <span class="o">=</span> <span class="s">&#39;.scrapecache/&#39;</span>

<span class="k">if</span> <span class="n">DO_CACHING</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="mo">0o744</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GoogleSearchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Exception in GoogleSearch class&#39;</span>


<span class="k">class</span> <span class="nc">InvalidNumberResultsException</span><span class="p">(</span><span class="n">GoogleSearchError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_results</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nres</span> <span class="o">=</span> <span class="n">number_of_results</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;{} is not a valid number of results per page&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nres</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">maybe_clean_cache</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Delete all .cache files in the cache directory that are older than 12 hours.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">12</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>

<span class="k">if</span> <span class="n">DO_CACHING</span><span class="p">:</span>
    <span class="c"># Clean the CACHEDIR once in a while</span>
    <span class="n">maybe_clean_cache</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">cached_file_name</span><span class="p">(</span><span class="n">search_params</span><span class="p">):</span>
    <span class="n">sha</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
    <span class="c"># Make a unique file name based on the values of the google search parameters.</span>
    <span class="n">sha</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">search_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">search_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="k">return</span> <span class="s">&#39;{}.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sha</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="s">&#39;cache&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_cached</span><span class="p">(</span><span class="n">search_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads a cached search results page from scrapecache/fname.cache</span>

<span class="sd">    It helps in testing and avoid requesting</span>
<span class="sd">    the same resources again and again (such that google may</span>
<span class="sd">    recognize us as what we are: Sneaky SEO crawlers!)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">cached_file_name</span><span class="p">(</span><span class="n">search_params</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">):</span>
            <span class="c"># If the cached file is older than 12 hours, return False and thus</span>
            <span class="c"># make a new fresh request.</span>
            <span class="n">modtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">modtime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">False</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unexpected file not found: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">return</span> <span class="k">False</span>


<span class="k">def</span> <span class="nf">cache_results</span><span class="p">(</span><span class="n">search_params</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stores a html resource as a file in scrapecache/fname.cache</span>

<span class="sd">    This will always write(overwrite) the cache file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">cached_file_name</span><span class="p">(</span><span class="n">search_params</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GoogleScrape</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Offers a fast way to query the google search engine.</span>

<span class="sd">    Overrides the run() method of the superclass threading.Thread.</span>
<span class="sd">    Each thread represents a crawl for one Google Results Page.</span>

<span class="sd">    http://www.blueglass.com/blog/google-search-url-parameters-query-string-anatomy/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Valid URL (taken from django)</span>
    <span class="n">_REGEX_VALID_URL</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s">r&#39;^(?:http|ftp)s?://&#39;</span> <span class="c"># http:// or https://</span>
        <span class="s">r&#39;(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+(?:[A-Z]{2,6}\.?|[A-Z0-9-]{2,}\.?)|&#39;</span> <span class="c"># domain...</span>
        <span class="s">r&#39;localhost|&#39;</span> <span class="c"># localhost...</span>
        <span class="s">r&#39;\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})&#39;</span> <span class="c"># ...or ip</span>
        <span class="s">r&#39;(?::\d+)?&#39;</span> <span class="c"># optional port</span>
        <span class="s">r&#39;(?:/?|[/?]\S+)$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">_REGEX_VALID_URL_SIMPLE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s">&#39;http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&amp;+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+&#39;</span><span class="p">)</span>

    <span class="c"># Named tuple type for the search results</span>
    <span class="n">Result</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;LinkResult&#39;</span><span class="p">,</span> <span class="s">&#39;link_title link_snippet link_url&#39;</span><span class="p">)</span>

    <span class="c"># Several different User-Agents to diversify the requests.</span>
    <span class="c"># Keep the User-Agents updated. Last update: 17th february 14</span>
    <span class="c"># Get them here: http://techblog.willshouse.com/2012/01/03/most-common-user-agents/</span>
    <span class="n">_UAS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/537.73.11 (KHTML, like Gecko) Version/7.0.1 Safari/537.73.11&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:26.0) Gecko/20100101 Firefox/26.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.107 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.77 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.107 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.102 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.102 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (iPhone; CPU iPhone OS 7_0_4 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11B554a Safari/9537.53&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (iPad; CPU OS 7_0_4 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11B554a Safari/9537.53&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; rv:26.0) Gecko/20100101 Firefox/26.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36&#39;</span>
    <span class="p">]</span>

    <span class="n">_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s">&#39;Mozilla/5.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Accept&#39;</span><span class="p">:</span> <span class="s">&#39;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#39;</span><span class="p">,</span>
        <span class="s">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s">&#39;gzip, deflate&#39;</span><span class="p">,</span>
        <span class="s">&#39;Connection&#39;</span><span class="p">:</span> <span class="s">&#39;close&#39;</span><span class="p">,</span>
        <span class="s">&#39;DNT&#39;</span><span class="p">:</span> <span class="s">&#39;1&#39;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_query</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_page</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">search_params</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Initialises an object responsible for scraping one particular results page.</span>

<span class="sd">        @param search_query: The query to scrape for.</span>
<span class="sd">        @param num_results_per_page: The number of results per page. Must be smaller than 1000.</span>
<span class="sd">        (My tests though have shown that at most 100 results were returned per page)</span>
<span class="sd">        @param num_page: The number/index of the page.</span>
<span class="sd">        @param search_params: A dictionary with additional search params. The default search params is updated with this parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Created new GoogleScrape object with params: query={}, num_results_per_page={}, num_page={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">search_query</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="p">,</span> <span class="n">num_page</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span>
        <span class="k">if</span> <span class="n">num_results_per_page</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">):</span> <span class="c"># The maximum value of this parameter is 1000. See search appliance docs</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;The parameter -n must be smaller or equal to 1000&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidNumberResultsException</span><span class="p">(</span><span class="n">num_results_per_page</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_page</span><span class="o">*</span><span class="n">num_results_per_page</span> <span class="o">+</span> <span class="n">num_results_per_page</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;The maximal number of results for a query is 1000&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidNumberResultsException</span><span class="p">(</span><span class="n">num_page</span><span class="o">*</span><span class="n">num_results_per_page</span> <span class="o">+</span> <span class="n">num_results_per_page</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_results_per_page</span> <span class="o">=</span> <span class="n">num_results_per_page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_page</span> <span class="o">=</span> <span class="n">num_page</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_URL</span> <span class="o">=</span> <span class="s">&#39;http://www.google.com/search&#39;</span>

        <span class="c"># http://www.rankpanel.com/blog/google-search-parameters/</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># the search query string</span>
            <span class="s">&#39;num&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># the number of results per page</span>
            <span class="s">&#39;numgm&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Number of KeyMatch results to return with the results. A value between 0 to 50 can be specified for this option.</span>
            <span class="s">&#39;start&#39;</span><span class="p">:</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="c"># Specifies the index number of the first entry in the result set that is to be returned. page number = (start / num) + 1</span>
                          <span class="c"># The maximum number of results available for a query is 1,000, i.e., the value of the start parameter added to the value of the num parameter cannot exceed 1,000.</span>
            <span class="s">&#39;rc&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># Request an accurate result count for up to 1M documents. If a user submits a search query without the site parameter, the entire search index is queried.</span>
            <span class="s">&#39;site&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Limits search results to the contents of the specified collection.</span>
            <span class="s">&#39;sort&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Specifies a sorting method. Results can be sorted by date.</span>
            <span class="s">&#39;client&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># required parameter. Indicates a valid front end.</span>
            <span class="s">&#39;output&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># required parameter. Selects the format of the search results.</span>
            <span class="s">&#39;partialfields&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Restricts the search results to documents with meta tags whose values contain the specified words or phrases.</span>
            <span class="s">&#39;pws&#39;</span><span class="p">:</span> <span class="s">&#39;0&#39;</span><span class="p">,</span>      <span class="c"># personalization turned off</span>
            <span class="s">&#39;cd&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Passes down the keyword rank clicked.</span>
            <span class="s">&#39;filter&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c"># Include omitted results</span>
            <span class="s">&#39;complete&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c">#Turn auto-suggest and Google Instant on (=1) or off (=0)</span>
            <span class="s">&#39;nfpr&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c">#Turn off auto-correction of spelling</span>
            <span class="s">&#39;ncr&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c">#No country redirect: Allows you to set the Google country engine you would like to use despite your current geographic location.</span>
            <span class="s">&#39;safe&#39;</span><span class="p">:</span> <span class="s">&#39;off&#39;</span><span class="p">,</span> <span class="c"># Turns the adult content filter on or off</span>
            <span class="s">&#39;rls&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c">#Source of query with version of the client and language set, other examples are can be found</span>
            <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span>  <span class="c">#Google navigational parameter specifying where you came from, here universal search</span>
            <span class="s">&#39;tbm&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Used when you select any of the “special” searches, like image search or video search</span>
            <span class="s">&#39;tbs&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Also undocumented as `tbm`, allows you to specialize the time frame of the results you want to obtain.</span>
                         <span class="c"># Examples: Any time: tbs=qdr:a, Last second: tbs=qdr:s, Last minute: tbs=qdr:n, Last day: tbs=qdr:d, Time range: tbs=cdr:1,cd_min:3/2/1984,cd_max:6/5/1987</span>
                         <span class="c"># But the tbs parameter is also used to specify content:</span>
                         <span class="c"># Examples: Sites with images: tbs=img:1, Results by reading level, Basic level: tbs=rl:1,rls:0, Results that are translated from another language: tbs=clir:1,</span>
                         <span class="c"># For full documentation, see http://stenevang.wordpress.com/2013/02/22/google-search-url-request-parameters/</span>
            <span class="s">&#39;lr&#39;</span><span class="p">:</span> <span class="s">&#39;lang_de&#39;</span><span class="p">,</span> <span class="c"># Restricts searches to pages in the specified language. If there are no results in the specified language, the search appliance displays results in all languages .</span>
                             <span class="c"># lang_xx where xx is the country code such as en, de, fr, ca, ...</span>
            <span class="s">&#39;hl&#39;</span><span class="p">:</span> <span class="s">&#39;en&#39;</span><span class="p">,</span> <span class="c"># Language settings passed down by your browser</span>
            <span class="s">&#39;cr&#39;</span><span class="p">:</span> <span class="s">&#39;countryDE&#39;</span><span class="p">,</span> <span class="c"># The region the results should come from</span>
            <span class="s">&#39;gr&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Just as gl shows you how results look in a specified country, gr limits the results to a certain region</span>
            <span class="s">&#39;gcs&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Limits results to a certain city, you can also use latitude and longitude</span>
            <span class="s">&#39;gpc&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c">#Limits results to a certain zip code</span>
            <span class="s">&#39;gm&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Limits results to a certain metropolitan region</span>
            <span class="s">&#39;gl&#39;</span><span class="p">:</span> <span class="s">&#39;de&#39;</span><span class="p">,</span> <span class="c"># as if the search was conducted in a specified location. Can be unreliable.</span>
            <span class="s">&#39;ie&#39;</span><span class="p">:</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="c"># Sets the character encoding that is used to interpret the query string.</span>
            <span class="s">&#39;oe&#39;</span><span class="p">:</span> <span class="s">&#39;utf-8&#39;</span> <span class="c"># Sets the character encoding that is used to encode the results.</span>
        <span class="p">}</span>

        <span class="c"># Maybe update the default search params when the user has supplied a dictionary</span>
        <span class="k">if</span> <span class="n">search_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">search_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;cache_file&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># A path to a file that caches the results.</span>
            <span class="s">&#39;search_keyword&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_query</span><span class="p">,</span> <span class="c"># The query keyword</span>
            <span class="s">&#39;num_results_for_kw&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># The number of results for the keyword</span>
            <span class="s">&#39;results&#39;</span><span class="p">:</span> <span class="p">[]</span> <span class="c"># List of Result named tuples</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make the the scrape and clean the URL&#39;s.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">()</span>

        <span class="c"># Now try to create ParseResult objects from the URL</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;/url\?q=(?P.*?)&amp;sa=U&amp;ei=&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">link_url</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REGEX_VALID_URL</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>   
                   <span class="bp">self</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">link_title</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">link_title</span><span class="p">,</span> <span class="n">link_url</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                                <span class="n">link_snippet</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">link_snippet</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;URL={} found to be invalid.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_build_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the headers and params for the GET request towards the Google server.</span>

<span class="sd">        When random is True, several headers (like the UA) are chosen</span>
<span class="sd">        randomly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_query</span><span class="p">,</span>
             <span class="s">&#39;num&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_results_per_page</span><span class="p">),</span>
             <span class="s">&#39;start&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_results_per_page</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_page</span><span class="p">))</span>
            <span class="p">})</span>

        <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADERS</span><span class="p">[</span><span class="s">&#39;User-Agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_UAS</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The actual search and parsing of the results.</span>

<span class="sd">        Private, internal method.</span>
<span class="sd">        Parsing is done with lxml and cssselect. The html structure of the Google Search</span>
<span class="sd">        results may change over time. Effective: February 2014</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_query</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">DO_CACHING</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">get_cached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;cache_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">cached_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="k">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">html</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADERS</span><span class="p">,</span>
                                 <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Scraped with url: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>

            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">cerr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Network problem occurred {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cerr</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>
                <span class="k">return</span> <span class="k">False</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">terr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Connection timeout {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">terr</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>
                <span class="k">return</span> <span class="k">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;HTTP Error:&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;5&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Maybe google recognizes you as sneaky spammer after&#39;</span>
                          <span class="s">&#39; you requested their services too inexhaustibly :D&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">False</span>

            <span class="n">html</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>
            <span class="c"># cache fresh results</span>
            <span class="k">if</span> <span class="n">DO_CACHING</span><span class="p">:</span>
                <span class="n">cache_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;cache_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">cached_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">))</span>

        <span class="c"># Try to parse the google HTML result using lxml</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">UnicodeDammit</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">is_html</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">declared_html_encoding</span><span class="p">)</span>
            <span class="n">dom</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">document_fromstring</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>
            <span class="n">dom</span><span class="o">.</span><span class="n">resolve_base_href</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Some error occurred while lxml tried to parse: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">return</span> <span class="k">False</span>

        <span class="c"># Try to extract all links of non-ad results, including their snippets(descriptions) and titles.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">li_g_results</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">HTMLTranslator</span><span class="p">()</span><span class="o">.</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="s">&#39;li.g&#39;</span><span class="p">))</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">li_g_results</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">link_element</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">HTMLTranslator</span><span class="p">()</span><span class="o">.</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="s">&#39;h3.r &gt; a:first-child&#39;</span><span class="p">))</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">link_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">link_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error while parsing link/title element: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">snippet_element</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">HTMLTranslator</span><span class="p">()</span><span class="o">.</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="s">&#39;div.s &gt; span.st&#39;</span><span class="p">))</span>
                    <span class="n">snippet</span> <span class="o">=</span> <span class="n">snippet_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error while parsing snippet element: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">link_title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">link_url</span><span class="o">=</span><span class="n">link</span><span class="p">,</span> <span class="n">link_snippet</span><span class="o">=</span><span class="n">snippet</span><span class="p">))</span>
        <span class="c"># Catch further errors besides parsing errors that take shape as IndexErrors</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error in parsing result links: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>

        <span class="c"># try to get the number of results for our search query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;num_results_for_kw&#39;</span><span class="p">]</span> <span class="o">=</span>   
               <span class="n">dom</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">HTMLTranslator</span><span class="p">()</span><span class="o">.</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="s">&#39;div#resultStats&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scrape</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_pages</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Public API function to search for terms and return a list of results.</span>

<span class="sd">    arguments:</span>
<span class="sd">    query -- the search query. Can be whatever you want to crawl google for.</span>

<span class="sd">    Keyword arguments:</span>
<span class="sd">    num_results_per_page -- the number of results per page. Either 10, 25, 50 or 100.</span>
<span class="sd">    num_pages -- The number of pages to search for.</span>
<span class="sd">    offset -- specifies the offset to the page to begin searching.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">GoogleScrape</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_pages</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">deep_scrape</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Launches many different Google searches with different parameter combinations to maximize return of results.</span>

<span class="sd">    @param query: The query to search for.</span>
<span class="sd">    @return: All the result sets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># First obtain some synonyms for the search query</span>

    <span class="c"># For each proxy, run the scrapes</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">&#39;GoogleScraper&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&#39;Scrapes the Google search engine&#39;</span><span class="p">,</span>
                                     <span class="n">epilog</span><span class="o">=</span><span class="s">&#39;This program might infringe Google TOS, so use at your own risk&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--query&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;search_string&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The search query.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--num_results_per_page&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;number_of_results_per_page&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;num_results_per_page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The number of results per page. Most be &gt;= 100&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--num_pages&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;num_of_pages&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;num_pages&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The number of pages to search in. Each page is requested by a unique connection and if possible by a unique IP.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--proxy&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;proxycredentials&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;proxy&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="c">#default=(&#39;127.0.0.1&#39;, 9050)</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A string such as &quot;127.0.0.1:9050&quot; specifying a single proxy server&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--proxy_file&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;proxyfile&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;proxy_file&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="c">#default=&#39;.proxies&#39;</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A filename for a list of proxies (supported are HTTP PROXIES, SOCKS4/4a/5) with the following format: &quot;Proxyprotocol (proxy_ip|proxy_host):Port</span><span class="se">\\</span><span class="s">n&quot;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-x&#39;</span><span class="p">,</span> <span class="s">&#39;--deep-scrape&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Launches a wide range of parallel searches by modifying the search &#39;</span>   
                       <span class="s">&#39;query string with synonyms and by scraping with different Google search parameter combinations that might yield more unique &#39;</span>   
                       <span class="s">&#39;results. The algorithm is optimized for maximum of results for a specific keyword whilst trying avoid detection. This is the heart of GoogleScraper.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--view&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;View the response in a default browser tab.&quot;</span>
                                                                 <span class="s">&quot; Mainly for debug purposes. Works only when caching is enabled.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbosity&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;The verbosity of the output reporting for the found search results.&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy_file</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Coming soon.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">source_address</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socks</span><span class="o">.</span><span class="n">socksocket</span><span class="p">()</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sock</span>

        <span class="n">proxy_host</span><span class="p">,</span> <span class="n">proxy_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>

        <span class="c"># Patch the socket module</span>
        <span class="n">socks</span><span class="o">.</span><span class="n">setdefaultproxy</span><span class="p">(</span><span class="n">socks</span><span class="o">.</span><span class="n">PROXY_TYPE_SOCKS5</span><span class="p">,</span> <span class="n">proxy_host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">proxy_port</span><span class="p">),</span>
                              <span class="n">rdns</span><span class="o">=</span><span class="k">True</span><span class="p">)</span> <span class="c"># rdns is by default on true. Never use rnds=False with TOR, otherwise you are screwed!</span>
        <span class="n">socks</span><span class="o">.</span><span class="n">wrap_module</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span> <span class="o">=</span> <span class="n">create_connection</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">deep_scrape</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">deep_scrape</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">scrape</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_results_per_page</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_pages</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;{} links found! The search with the keyword &quot;{}&quot; yielded the result:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]),</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;search_keyword&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;num_results_for_kw&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">webbrowser</span>
            <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;cache_file&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">link_title</span><span class="p">,</span> <span class="n">link_snippet</span><span class="p">,</span> <span class="n">link_url</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Link: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">link_url</span><span class="o">.</span><span class="n">geturl</span><span class="p">())))</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">textwrap</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Title: </span><span class="se">\n</span><span class="s">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">link_title</span><span class="p">,</span> <span class="mi">50</span><span class="p">)),</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s">&#39;Description: </span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">link_snippet</span><span class="p">,</span> <span class="mi">70</span><span class="p">)),</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</pre></div>
</td></tr></table>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/google.html">Google</a>
      <a href="/tag/scraping.html">Scraping</a>
      <a href="/tag/programming.html">Programming</a>
      <a href="/tag/security.html">Security</a>
    </p>
  </div>
</article>

    <footer>
      <p>&copy; Nikolai Tschacher 2015</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "GoogleScraper.py - A simple python module to parse google search results.",
  "headline": "GoogleScraper.py - A simple python module to parse google search results.",
  "datePublished": "2013-01-06 21:27:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Nikolai Tschacher",
    "url": "/author/nikolai-tschacher.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "/googlesearch-a-rapid-python-class-to-get-search-results.html",
  "description": "UPDATE on 18th February 2014: This python module has now its own github repository! The plugin can extract All links Link titles The description/caption below the links and has the following features: Advanced proxy support for SOCKS4/4a/5 and HTTP PROXY Multithreading XPATH parsing Supports almost all search ..."
}
</script></body>
</html>