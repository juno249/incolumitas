<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
<meta name="author" content="Nikolai Tschacher" />
<meta name="description" content="22.05.2014: Updated the bot, should work better now Hi everyone! I was in a coding mood during Easter and decided to write a small chess bot with selenium and stockfish engine to cheat a bit on lichess.org. I think the code is pretty self explanatory and I ..." />
<meta name="keywords" content="Uncategorized, Programming, Chess">
<meta property="og:site_name" content="Coding, Learning and IT Security"/>
<meta property="og:title" content="Lichess.org chess bot!"/>
<meta property="og:description" content="22.05.2014: Updated the bot, should work better now Hi everyone! I was in a coding mood during Easter and decided to write a small chess bot with selenium and stockfish engine to cheat a bit on lichess.org. I think the code is pretty self explanatory and I ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/lichess-org-chess-bot.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2014-04-23 18:03:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/nikolai-tschacher.html">
<meta property="article:section" content="Uncategorized"/>
<meta property="article:tag" content="Uncategorized"/>
<meta property="article:tag" content="Programming"/>
<meta property="article:tag" content="Chess"/>
<meta property="og:image" content="">  <title>Coding, Learning and IT Security &ndash; Lichess.org chess bot!</title>
</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="Coding, Learning and IT Security" title="Coding, Learning and IT Security">
      </a>
      <h1><a href="">Coding, Learning and IT Security</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/pages/about.html#about">About</a></li>
          <li><a href="/pages/contact.html#contact">Contact</a></li>
          <li><a href="/pages/googlescraper-py.html#googlescraper-py">GoogleScraper.py</a></li>
          <li><a href="/pages/projects.html#projects">Projects</a></li>
          <li><a href="/pages/impressum.html#impressum">Site Notice</a></li>
          <li><a href="/pages/svgcaptcha.html#svgcaptcha">SVGCaptcha</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="https://twitter.com/incolumitas_" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/NikolaiT" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="//incolumitas/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1052496/nikolai-tschacher" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
    </nav>

<article>
  <header>
    <h1 id="lichess-org-chess-bot">Lichess.org chess bot!</h1>
    <p>Posted on Mi 23 April 2014 in <a href="/category/uncategorized.html">Uncategorized</a></p>
  </header>
  <div>
    <p><strong>22.05.2014: Updated the bot, should work better now</strong></p>
<p>Hi everyone!</p>
<p>I was in a coding mood during Easter and decided to write a small chess
bot with
<a href="http://selenium-python.readthedocs.org/en/latest/" title="selenium python">selenium</a>
and <a href="http://stockfishchess.org/" title="stockfish engine">stockfish</a> engine to
cheat a bit on
<a href="http://en.lichess.org/" title="lichess chess arena">lichess.org</a>.</p>
<p>I think the code is pretty self explanatory and I won't discuss it in
depth here. You can tweak the config, the comments should explain what
the parameters do.</p>
<p>The config is in the beginning of the code, so modify it there. You
should maybe modify it to use your username and password. Make sure that
you download stockfish and install it. Then supply the correct path in
the 'stockfish_binary' parameter.</p>
<p>As always: Have fun!</p>
<p>Some open issues:</p>
<ul>
<li>Sometimes the last move fails because the bot won't to start a new game
  before it can checkmate</li>
<li>
<p>Promoting doesn't work yet :/</p>
<p>:::python
<strong>author</strong> = 'nikolai'
<strong>date</strong> = 'Easter 2014'</p>
<p>config = {
    'username' : 'probably_a_spider', # the login username
    'password' : 'somepwd', # the login password
    'stockfish_binary' : '/home/nikolai/PycharmProjects/LichessBot/stockfish-dd-src/src/stockfish', # the path to your local stockfish binary
    #Set to true if the bot should play forever
    'pwn_forever' : True, # if the bot should play endlessly
    'min_per_side' : 1, # how long each player may play
    'increment' : 0, # the increment per move
    'thinking_time': .5, # How long stockfish is allowd to search, set to None and stockfish will search 0.75 seconds by default
    'thinking_skew': .2 # This is the maximal random derivative in decimal of the thinking time (0-1) (to not make the bot to appear to move in the same time intervals all the time)
}</p>
<p>from selenium import webdriver
from selenium.webdriver import ActionChains
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException, UnexpectedAlertPresentException
import subprocess
import os
import time
import sys
import re
import random</p>
<p>def get(proc, poll=True):
    if poll:
        proc.stdin.write('isready\n')
    buf = ''
    while True:
        line = proc.stdout.readline().strip()
        buf += line
        if 'readyok' in line:
            return buf
        if 'bestmove' in line:
            return buf</p>
<p>def init_stockfish():
    if os.path.exists(config['stockfish_binary']):
        proc = subprocess.Popen([config['stockfish_binary']], universal_newlines=True,
                                stdout=subprocess.PIPE, stdin=subprocess.PIPE)</p>
<div class="highlight"><pre>    greeting = get(proc)
    if not &#39;Stockfish&#39; in greeting:
        raise ValueError(&#39;Couldnt execute stockfish&#39;)

    proc.stdin.write(&#39;uci\n&#39;)
    get(proc)
    # stolen from https://github.com/brandonhsiao/lichess-bot/blob/master/server.py
    proc.stdin.write(&#39;ucinewgame\n&#39;)
    proc.stdin.write(&#39;setoption name Hash value 128\n&#39;)
    proc.stdin.write(&#39;setoption name Threads value 4\n&#39;)
    proc.stdin.write(&#39;setoption name Best Book Move value true\n&#39;)
    proc.stdin.write(&#39;setoption name Aggressiveness value 200\n&#39;)
    proc.stdin.write(&#39;setoption name Cowardice value 0\n&#39;)
    proc.stdin.write(&#39;setoption name Contempt Factor value 50\n&#39;)
    return proc
</pre></div>


<p>proc = init_stockfish()</p>
<p>def make_move(thinking_time=.5, moves=[]):
    if moves:
        cmd = 'position startpos moves {}\n'.format(' '.join(moves))
        proc.stdin.write(cmd)
    proc.stdin.write('go infinite\n')
    try:
        time.sleep(float(thinking_time))
    except ValueError as ve:
        print(ve)
        sys.exit(0)
    proc.stdin.write('stop\n')
    out = get(proc, False)
    try:
        bestmove = re.search(r'bestmove\s(?P[a-h][1-8][a-h][1-8])', out).group('move')
        ponder = re.search(r'ponder\s(?P[a-h][1-8][a-h][1-8])', out).group('ponder')
    except AttributeError:
        return False
    return bestmove</p>
<p>def newgame_stockfish():
    proc.stdin.write('ucinewgame\n')
    get(proc)</p>
<p>def quit_stockfish():
    proc.stdin.write('quit\n')
    proc.terminate()</p>
<p>def login():
    wd = webdriver.Firefox()
    wd.get('http://en.lichess.org/login')
    u, p = wd.find_element_by_name("username"), wd.find_element_by_name("password")
    u.send_keys(config['username'])
    p.send_keys(config['password'])
    p.submit()
    return wd</p>
<p>def create_game(wd, min_per_side=config['min_per_side'], increment=config['increment']):
    wait = WebDriverWait(wd, 10)
    try:
        element = wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR,'a[title="Create a game"]')))
        element.click()
    except UnexpectedAlertPresentException:
        pass
    except Exception as e:
        print(e)</p>
<div class="highlight"><pre>WebDriverWait(wd, 5).until(EC.presence_of_element_located((By.ID, &#39;increment&#39;)));
# Change the inputs with a bit of jQuery (but wait first until the dom bitch is loaded)
wd.execute_script(&quot;$(&#39;#time&#39;).val(&#39;{}&#39;)&quot;.format(str(min_per_side)))
wd.execute_script(&quot;$(&#39;#increment&#39;).val(&#39;{}&#39;)&quot;.format(str(increment)))
time.sleep(1)
wd.find_element_by_name(&#39;color&#39;).submit()
</pre></div>


<p>def play(wd):
    def move(moves=[]):
        t = config['thinking_time'] or .75
        if config['thinking_skew']:
            t = t * (1 - random.randint(0, config['thinking_skew']*1000) / 1000)</p>
<div class="highlight"><pre>    move = make_move(thinking_time=t, moves=moves)
    if move:
        print(&#39;[i]Bot is going to make move {} by calculating {} seconds&#39;.format(move, float(t)))
        f, t = move[:2], move[2:]
        for i in range(6):
            action = ActionChains(wd)
            action.drag_and_drop(wd.find_element_by_id(f), wd.find_element_by_id(t))
            action.perform()
            try:
                moved = wd.find_elements_by_css_selector(&#39;div.moved.lcs&#39;)
                move1, move2 = moved[0].get_attribute(&#39;id&#39;), moved[1].get_attribute(&#39;id&#39;)
                if t == move1 or f == move1:
                    break
            except:
                break
            time.sleep(.2)
        return move
    else:
        return False

def get_last_move(moves=[]):
    WebDriverWait(wd, 100).until(EC.presence_of_element_located((By.CSS_SELECTOR, &#39;div.moved.lcs&#39;)))
    t = wd.find_element_by_css_selector(&#39;div.moved.lcs div.piece&#39;).find_element_by_xpath(&#39;..&#39;).get_attribute(&#39;id&#39;)
    f = [e.get_attribute(&#39;id&#39;) for e in wd.find_elements_by_css_selector(&#39;div.moved.lcs&#39;) if e.get_attribute(&#39;id&#39;) != t][0]
    # If last move was my last move, sleep a bit and try again to get the next move
    if moves:
        print(f+t, moves[-1])
        while f+t == moves[-1]:
            # busy polling, that&#39;s very inefficient
            time.sleep(.35)
            t = wd.find_element_by_css_selector(&#39;div.moved.lcs div.piece&#39;).find_element_by_xpath(&#39;..&#39;).get_attribute(&#39;id&#39;)
            f = [e.get_attribute(&#39;id&#39;) for e in wd.find_elements_by_css_selector(&#39;div.moved.lcs&#39;) if e.get_attribute(&#39;id&#39;) != t][0]
            try:
                wd.find_element_by_css_selector(&#39;div.table_with_clock.finished&#39;)
                return False
            except NoSuchElementException:
                pass
    print(&#39;[i]Opponent moved {}&#39;.format(f+t))
    return f+t

try:
    # wait maximally 100 seconds for an opponent
    wait = WebDriverWait(wd, 100)
    # wait until the square a1 is present which means we got a board
    element = wait.until(EC.presence_of_element_located((By.ID,&#39;a1&#39;)))
except TimeoutException as te:
    print(&quot;No board found: {}&quot;.format(te))
    sys.exit(0)

print(&#39;We got a board, games beginning...&#39;)

moves = []
# detect what color we play
players  = wd.find_elements_by_css_selector(&#39;.player &gt; a&#39;)
is_black = False
for e in players:
        is_black = config[&#39;username&#39;] in e.get_attribute(&#39;href&#39;) and &#39;black&#39; in e.get_attribute(&#39;class&#39;)
print(&#39;[i]Bot is playing {}&#39;.format([&#39;white&#39;, &#39;black&#39;][is_black]))
if not is_black:
    moves.append(move())

while True:
    print(&#39;[i] Moves played: {}&#39;.format(moves), end=&#39;\n\n&#39;)

    last = get_last_move(moves)
    print(&#39;last move found was {}&#39;.format(last))
    if last:
        moves.append(last)
    else:
        print(&#39;no last move appended. Leaving: {}&#39;.format(last))
        return

    m = move(moves)
    if m:
        moves.append(m)
    else:
        return
    try:
        wd.find_element_by_css_selector(&#39;div.table_with_clock.finished&#39;)
        return
    except:
        pass
</pre></div>


<p>def go_forever():
    wd = login()
    while True:
        create_game(wd)
        newgame_stockfish()
        play(wd)
        wd.get('http://en.lichess.org/')</p>
<div class="highlight"><pre>quit_stockfish()
</pre></div>


<p>if <strong>name</strong> == '<strong>main</strong>':
    if config['pwn_forever']:
        go_forever()
    else:
        wd = login()
        create_game(wd)
        play(wd)</p>
</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/uncategorized.html">Uncategorized</a>
      <a href="/tag/programming.html">Programming</a>
      <a href="/tag/chess.html">Chess</a>
    </p>
  </div>
</article>

    <footer>
      <p>&copy; Nikolai Tschacher 2015</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Lichess.org chess bot!",
  "headline": "Lichess.org chess bot!",
  "datePublished": "2014-04-23 18:03:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Nikolai Tschacher",
    "url": "/author/nikolai-tschacher.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "/lichess-org-chess-bot.html",
  "description": "22.05.2014: Updated the bot, should work better now Hi everyone! I was in a coding mood during Easter and decided to write a small chess bot with selenium and stockfish engine to cheat a bit on lichess.org. I think the code is pretty self explanatory and I ..."
}
</script></body>
</html>