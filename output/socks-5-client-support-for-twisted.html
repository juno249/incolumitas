<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
<meta name="author" content="Nikolai Tschacher" />
<meta name="description" content="I recently forked twisted-socks to add SOCKS 5 support for my GoogleScraper in order to scraper Google pages asynchronously. Obviously I needed SOCKS5 support to anonymize the parallel requests such that I can scrape more pages simultaneously. I tested the code for SOCKS4 and SOCKS4a with a local TOR proxy ..." />
<meta name="keywords" content="Python, Twisted, Socks5, Programming, Security">
<meta property="og:site_name" content="Coding, Learning and IT Security"/>
<meta property="og:title" content="Socks 5 client support for twisted"/>
<meta property="og:description" content="I recently forked twisted-socks to add SOCKS 5 support for my GoogleScraper in order to scraper Google pages asynchronously. Obviously I needed SOCKS5 support to anonymize the parallel requests such that I can scrape more pages simultaneously. I tested the code for SOCKS4 and SOCKS4a with a local TOR proxy ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/socks-5-client-support-for-twisted.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2014-02-05 22:24:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/nikolai-tschacher.html">
<meta property="article:section" content="Programming"/>
<meta property="article:tag" content="Python"/>
<meta property="article:tag" content="Twisted"/>
<meta property="article:tag" content="Socks5"/>
<meta property="article:tag" content="Programming"/>
<meta property="article:tag" content="Security"/>
<meta property="og:image" content="">  <title>Coding, Learning and IT Security &ndash; Socks 5 client support for twisted</title>
</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="Coding, Learning and IT Security" title="Coding, Learning and IT Security">
      </a>
      <h1><a href="">Coding, Learning and IT Security</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/pages/about.html#about">About</a></li>
          <li><a href="/pages/contact.html#contact">Contact</a></li>
          <li><a href="/pages/googlescraper-py.html#googlescraper-py">GoogleScraper.py</a></li>
          <li><a href="/pages/projects.html#projects">Projects</a></li>
          <li><a href="/pages/impressum.html#impressum">Site Notice</a></li>
          <li><a href="/pages/svgcaptcha.html#svgcaptcha">SVGCaptcha</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="https://twitter.com/incolumitas_" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/NikolaiT" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="//incolumitas/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1052496/nikolai-tschacher" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
    </nav>

<article>
  <header>
    <h1 id="socks-5-client-support-for-twisted">Socks 5 client support for twisted</h1>
    <p>Posted on Mi 05 Februar 2014 in <a href="/category/programming.html">Programming</a></p>
  </header>
  <div>
    <p>I recently forked
<a href="https://github.com/ln5/twisted-socks" title="twisted socks client">twisted-socks</a>
to add SOCKS 5 support for my
<a href="http://incolumitas.com/googlescraper-py/" title="GoogleScraper">GoogleScraper</a>
in order to scraper Google pages asynchronously. Obviously I needed
SOCKS5 support to anonymize the parallel requests such that I can scrape
more pages simultaneously.</p>
<p>I tested the code for SOCKS4 and SOCKS4a with a local TOR proxy and
<code>twistd -n socks</code> and the SOCKS5 protocol with the <a href="http://www.inet.no/dante/" title="dante">dante socks proxy
server</a> on my VPS. So I guess the
basic functionality should be working by now. GSSAPI (Kerberos)
<a href="https://tools.ietf.org/html/rfc1961">support</a> is planned.</p>
<p>Here is the socksclient code, which is also available on my github
repository:</p>
<div class="highlight"><pre><span class="c"># Copyright (c) 2011-2013, The Tor Project</span>
<span class="c"># See LICENSE for the license.</span>

<span class="c"># Updated on 25.01.14-28.01.14 to add SOCKS 5 support.</span>
<span class="c"># Cleaned some parts of the code and abstracted quite a bit to handle the most important SOCKS5</span>
<span class="c"># functionality like</span>
<span class="c"># - username/password authentication</span>
<span class="c"># - gssapi authentication (planned)</span>
<span class="c"># - CONNECT command (the normal case, there are others: UDP ASSOCIATE and BIND, but they aren&#39;t as important. Maybe I will add them</span>
<span class="c">#   in the future. If anyone wants to implement them, the basic structure is already here and the SOCKSv5ClientProtocol should be</span>
<span class="c">#   rather easy extensible (how the actual connection, listening for incoming connections (BIND) and opening a UDP connection (UDP ASSOCIATE)</span>
<span class="c">#   is done in the twisted world, is another question.</span>
<span class="c"># Added:</span>
<span class="c"># - SOCKSv4ClientFactory was renamed to SOCKSClientFactory and abstracted to handle all SOCKS 4/4a SOCKS5 (It is still ONE protocol, so one Factory should be logical correct)</span>
<span class="c"># - added SOCKS5ClientFactory</span>
<span class="c"># - SOCKSClientProtocol is the base class for all three protocols</span>
<span class="c"># - SOCKSv4aClientProtocol inherits from  SOCKSv4ClientProtocol. I made the deliberate choice to differ between SOCKS 4 and 4a, altough 4a has the exactly same functionality as 4,</span>
<span class="c">#   it might be the case that servers only speak version 4.</span>
<span class="c"># References:</span>
<span class="c"># A actively maintained, most recent version of PySocks from https://github.com/Anorov/PySocks</span>
<span class="c"># The original version of socksclient.py:</span>

<span class="c"># Author: Nikolai Tschacher</span>
<span class="c"># Contact: incolumitas.com</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implements</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>
<span class="kn">from</span> <span class="nn">twisted.internet.interfaces</span> <span class="kn">import</span> <span class="n">IStreamClientEndpoint</span><span class="p">,</span> <span class="n">IReactorTime</span>
<span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">ClientFactory</span>
<span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">_WrappingFactory</span>

<span class="k">class</span> <span class="nc">SOCKSError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SOCKSClientProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Base class for SOCKS protocols 4, 4a and 5</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">noteTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handshakeDone</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span><span class="n">SOCKSError</span><span class="p">(</span><span class="s">&#39;SOCKS </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">],</span> <span class="n">errmsg</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">isHostname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="n">dns_label_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(?![0-9]+$)(?!-)[a-zA-Z0-9-]{,63}(?H&quot;, port)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;RELAY_REQUEST_SENT&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">=</span> <span class="s">&#39;connection_requested&#39;</span>

    <span class="k">def</span> <span class="nf">verifySocksReply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">where</span> <span class="o">=</span> <span class="s">&#39;SOCKS5 verifySocksReply&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="c"># all hostname are longer than a IPv4 address</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Too few data from server </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">version</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">address_type</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!BBBB&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="mh">0x5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Invalid version&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">reply</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Server reply indicates failure. Reason: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">SOCKS5_ERRORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="s">&quot;Unknown error&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">address_type</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">:</span> <span class="c"># handle IPv4 address</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bound_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_port</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span>  
                                                       <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">address_type</span> <span class="o">==</span> <span class="mh">0x3</span><span class="p">:</span> <span class="c"># handle domain name</span>
                <span class="n">dns_name_len</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bound_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_port</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">dns_name_len</span><span class="p">],</span>  
                                                      <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[(</span><span class="mi">5</span><span class="o">+</span><span class="n">dns_name_len</span><span class="p">):(</span><span class="mi">5</span><span class="o">+</span><span class="n">dns_name_len</span><span class="o">+</span><span class="mi">2</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">address_type</span> <span class="o">==</span> <span class="mh">0x4</span><span class="p">:</span> <span class="c"># handle Ipv6 address</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bound_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_port</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntop</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">20</span><span class="p">]),</span>  
                                                                   <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">22</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">=</span> <span class="s">&#39;connection_verified&#39;</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;CONNECTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;NEGOTIATE_AUTH_METHOD&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negotiateAuthenticationMethod</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">==</span> <span class="s">&#39;do_auth&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">==</span> <span class="s">&#39;check_auth&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkAuth</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">==</span> <span class="s">&#39;authenticated&#39;</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span><span class="o">.</span><span class="n">_host</span>
            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span><span class="o">.</span><span class="n">_port</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendRelayRequest</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">==</span> <span class="s">&#39;connection_requested&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifySocksReply</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setupRelay</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SOCKSv4ClientProtocol</span><span class="p">(</span><span class="n">SOCKSClientProtocol</span><span class="p">):</span>
    <span class="n">SOCKS4_ERRORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mh">0x5B</span><span class="p">:</span> <span class="s">&quot;Request rejected or failed&quot;</span><span class="p">,</span>
        <span class="mh">0x5C</span><span class="p">:</span> <span class="s">&quot;Request rejected because SOCKS server cannot connect to identd on the client&quot;</span><span class="p">,</span>
        <span class="mh">0x5D</span><span class="p">:</span> <span class="s">&quot;Request rejected because the client program and identd report different user-ids&quot;</span>
    <span class="p">}</span>
    <span class="k">def</span> <span class="nf">sendRelayRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version_specific&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">+</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">][</span><span class="ow">not</span> <span class="ow">not</span> <span class="n">username</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Not a valid IPv4 address.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;!BBH&#39;</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;REQUEST&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verifySocksReply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True on success and False on need-more-data or error.</span>
<span class="sd">        In the case of an error, the connection is closed and the</span>
<span class="sd">        handshakeDone errback is invoked with a SOCKSError exception</span>
<span class="sd">        before False is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Expected 0 bytes&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mh">0x5a</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Relay request failed. Reason=</span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">SOCKS4_ERRORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;Unknown error&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;CONNECT&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;NEGOTIATE&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendRelayRequest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span><span class="o">.</span><span class="n">_port</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifySocksReply</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setupRelay</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SOCKSv4aClientProtocol</span><span class="p">(</span><span class="n">SOCKSv4ClientProtocol</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Only extends SOCKS 4 to remotely resolve hostnames.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">sendRelayRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version_specific&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">+</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">][</span><span class="ow">not</span> <span class="ow">not</span> <span class="n">username</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x00\x00\x00\x01</span><span class="s">&#39;</span>
            <span class="n">dnsname</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">host</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;!BBH&#39;</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="n">dnsname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;!BBH&#39;</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;REQUEST&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SOCKSClientFactory</span><span class="p">(</span><span class="n">ClientFactory</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span> <span class="o">=</span> <span class="n">proxy_config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;4&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SOCKSv4ClientProtocol</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;4a&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SOCKSv4aClientProtocol</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;5&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SOCKSv5ClientProtocol</span>

    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ClientFactory</span><span class="o">.</span><span class="n">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">proxy_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span>
        <span class="n">r</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span>
        <span class="n">r</span><span class="o">.</span><span class="n">postHandshakeFactory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeFactory</span>
        <span class="n">r</span><span class="o">.</span><span class="n">handshakeDone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handshakeDone</span>
        <span class="n">r</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span>
        <span class="n">r</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span>
        <span class="k">return</span> <span class="n">r</span>

<span class="k">class</span> <span class="nc">SOCKSWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generic class to wrap all 3 SOCKS protocol versions 4, 4a, 5 around a TCP connection</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IStreamClientEndpoint</span><span class="p">)</span>

    <span class="n">factory</span> <span class="o">=</span> <span class="n">SOCKSClientFactory</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_config</span> <span class="o">=</span> <span class="n">proxy_config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reactor</span> <span class="o">=</span> <span class="n">reactor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">timestamps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="n">timestamps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="n">IReactorTime</span><span class="p">(</span><span class="n">reactor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">noteTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocolFactory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a deferred firing when the SOCKS connection is established.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">createWrappingFactory</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Wrap creation of _WrappingFactory since __init__() doesn&#39;t</span>
<span class="sd">            take a canceller as of Twisted 12.1 or something.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">_WrappingFactory</span><span class="o">.</span><span class="n">__init__</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">_canceller</span><span class="p">(</span><span class="n">deferred</span><span class="p">):</span>
                    <span class="n">connector</span><span class="o">.</span><span class="n">stopConnecting</span><span class="p">()</span>
                    <span class="n">deferred</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span>
                        <span class="n">error</span><span class="o">.</span><span class="n">ConnectingCancelledError</span><span class="p">(</span>
                            <span class="n">connector</span><span class="o">.</span><span class="n">getDestination</span><span class="p">()))</span>
                <span class="k">return</span> <span class="n">_WrappingFactory</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_canceller</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                           <span class="c"># Twisted &gt;= 12.1.</span>
                <span class="k">return</span> <span class="n">_WrappingFactory</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;START&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Connect with an intermediate SOCKS factory/protocol,</span>
            <span class="c"># which then hands control to the provided protocolFactory</span>
            <span class="c"># once a SOCKS connection has been established.</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_config</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span>
            <span class="n">f</span><span class="o">.</span><span class="n">postHandshakeFactory</span> <span class="o">=</span> <span class="n">protocolFactory</span>
            <span class="n">f</span><span class="o">.</span><span class="n">handshakeDone</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="n">createWrappingFactory</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span> <span class="n">wf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;SOCKET&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">handshakeDone</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">fail</span><span class="p">()</span>
</pre></div>


<p>You can use the module for HTTP connection endpoints somehow like that</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="c"># Copyright (c) 2011-2013, The Tor Project</span>
<span class="c"># See LICENSE for the license.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">endpoints</span>
<span class="kn">from</span> <span class="nn">socksclient</span> <span class="kn">import</span> <span class="n">SOCKSv4ClientProtocol</span><span class="p">,</span> <span class="n">SOCKSWrapper</span>
<span class="kn">from</span> <span class="nn">twisted.web</span> <span class="kn">import</span> <span class="n">client</span>

<span class="k">class</span> <span class="nc">TestClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npages</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">wrappercb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;connected to proxy&quot;</span><span class="p">,</span> <span class="n">proxy</span>

    <span class="k">def</span> <span class="nf">clientcb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;ok, got: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">content</span><span class="p">[:</span><span class="mi">120</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;timetamps &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npages</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sockswrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">dest</span><span class="o">.</span><span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;Must specify port number.&#39;</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">TCP4ClientEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">dest</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">dest</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SOCKSWrapper</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">thing</span> <span class="o">=</span> <span class="n">TestClass</span><span class="p">()</span>

    <span class="c"># Mandatory first argument is a URL to fetch over Tor (or whatever</span>
    <span class="c"># SOCKS proxy that is running on localhost:9050).</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">proxy_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span>
        <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="mi">1080</span><span class="p">,</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="s">&#39;4&#39;</span><span class="p">,</span>
        <span class="s">&#39;version_specific&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;rdns&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># Enforce resolving hostnames remotely (Only supported by version 4a and 5)</span>
            <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x01</span><span class="s">&#39;</span><span class="p">,</span> <span class="c"># this may be CONNECT, BIND and UDP in version 5. In 4 and 4a, it&#39;s always CONNECT or BIND</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;socksuser&#39;</span><span class="p">,</span> <span class="c"># Enables simple username/password authentication mechanism in version 5</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">proxy_config2</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;212.224.92.182&#39;</span><span class="p">,</span>
        <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="mi">7777</span><span class="p">,</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="s">&#39;5&#39;</span><span class="p">,</span>
        <span class="s">&#39;version_specific&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;rdns&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># Enforce resolving hostnames remotely (Only supported by version 4a and 5)</span>
            <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x01</span><span class="s">&#39;</span><span class="p">,</span> <span class="c"># this may be CONNECT, BIND and UDP in version 5. In 4 and 4a, it&#39;s always CONNECT or BIND</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;someuser&#39;</span><span class="p">,</span> <span class="c"># Enables simple username/password authentication mechanism in version 5</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;somepass&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c"># From http://fastproxyservers.org/socks5-servers.htm</span>
    <span class="n">proxy_config3</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;202.84.44.129&#39;</span><span class="p">,</span>
        <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="mi">1080</span><span class="p">,</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="s">&#39;4&#39;</span><span class="p">,</span>
        <span class="s">&#39;version_specific&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;rdns&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># Enforce resolving hostnames remotely (Only supported by version 4a and 5)</span>
            <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x01</span><span class="s">&#39;</span><span class="p">,</span> <span class="c"># this may be CONNECT, BIND and UDP in version 5. In 4 and 4a, it&#39;s always CONNECT or BIND</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># Enables simple username/password authentication mechanism in version 5</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">HTTPClientFactory</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">deferred</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">clientcb</span><span class="p">)</span>

    <span class="n">sw</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">sockswrapper</span><span class="p">(</span><span class="n">proxy_config2</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">sw</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">wrappercb</span><span class="p">)</span>
    <span class="n">thing</span><span class="o">.</span><span class="n">npages</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">if</span> <span class="s">&#39;__main__&#39;</span> <span class="o">==</span> <span class="n">__name__</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/python.html">Python</a>
      <a href="/tag/twisted.html">Twisted</a>
      <a href="/tag/socks5.html">Socks5</a>
      <a href="/tag/programming.html">Programming</a>
      <a href="/tag/security.html">Security</a>
    </p>
  </div>
</article>

    <footer>
      <p>&copy; Nikolai Tschacher 2015</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Socks 5 client support for twisted",
  "headline": "Socks 5 client support for twisted",
  "datePublished": "2014-02-05 22:24:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Nikolai Tschacher",
    "url": "/author/nikolai-tschacher.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "/socks-5-client-support-for-twisted.html",
  "description": "I recently forked twisted-socks to add SOCKS 5 support for my GoogleScraper in order to scraper Google pages asynchronously. Obviously I needed SOCKS5 support to anonymize the parallel requests such that I can scrape more pages simultaneously. I tested the code for SOCKS4 and SOCKS4a with a local TOR proxy ..."
}
</script></body>
</html>