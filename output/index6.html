<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <meta name="author" content="Nikolai Tschacher" />
  <meta name="description" content="Nikolai Tschacher's ideas and programming around security and computer science" />
<meta property="og:site_name" content="Coding, Learning and IT Security"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Coding, Learning and IT Security"/>
<meta property="og:description" content="Nikolai Tschacher's ideas and programming around security and computer science"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content=""/>
  <title>Coding, Learning and IT Security</title>
</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="Coding, Learning and IT Security" title="Coding, Learning and IT Security">
      </a>
      <h1><a href="">Coding, Learning and IT Security</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/pages/about.html#about">About</a></li>
          <li><a href="/pages/contact.html#contact">Contact</a></li>
          <li><a href="/pages/googlescraper-py.html#googlescraper-py">GoogleScraper.py</a></li>
          <li><a href="/pages/projects.html#projects">Projects</a></li>
          <li><a href="/pages/impressum.html#impressum">Site Notice</a></li>
          <li><a href="/pages/svgcaptcha.html#svgcaptcha">SVGCaptcha</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="https://twitter.com/incolumitas_" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/NikolaiT" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="//incolumitas/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1052496/nikolai-tschacher" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
    </nav>

<article>
  <header>
    <h2><a href="/how-to-make-your-own-little-captcha-in-php.html#how-to-make-your-own-little-captcha-in-php">Another wordpress catpcha implementation</a></h2>
    <p>
      Posted on Fr 25 Januar 2013 in <a href="/category/learning.html">Learning</a>
      &#8226; Tagged with
      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/learning.html">Learning</a>,      <a href="/tag/security.html">Security</a>    </p>
  </header>
  <div>
      <h3>Hey dear readership and dudelmatz :)</h3>
<p>I'm kinda overworked and planned quite a while ago to release my own
little captcha implementation to prevent this massive bulk of spam
comments I receive on a daily base: It's obnoxious to scroll through
this sheer amount of spam comments and delete them. You can't just
masstrash them, because you might miss a legit comment and therefore you
need to check every single one. I assume the spammer embrace this
expected behaviour of a blogger, and therefore exploit it.</p>
<p>So I needed to put a stop to this violation of my spare time and I
created my own captcha. Of course, I first searched for a working and
already existing solution (and I am sure there are many which are better
then what I came up with), but the one I used is basically
<a href="http://wordpress.org/extend/plugins/captcha/">crap</a>.Â <a href="http://wordpress.org/extend/plugins/captcha/"><br />
</a></p>
<p>Its plugin description states:</p>
<blockquote>
<p><em>Captcha plugin allows you to protect your website from spam using
math logic which can be used for login, registration, reseting
password, comments forms.</em></p>
</blockquote>
<p>And yeah as I feared this simple elegant captcha is worthless, because
math logic is a joke to parse and solve by computers (=>spamscripts). I
was pissed and in a mood to write my first wordpress plugin, so I did my
own from scratch.</p>
<p>Well, I need to warn you: My solution is designed to work only on this
site, because it wouldn't be all too hard to crack it and to bypass its
deception. But this won't happen, because there's no reason: This site
has by far not the critical traffic (not yet) which would make it
interesting for a spammer to circumwent the captcha.</p>
<p>Well enough said, you can see the plugin in action on this site (see the
comments section). Here's the source:</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="cm">/*</span>
<span class="cm">Plugin Name: CunningCaptcha</span>
<span class="cm">Plugin URI: http://incolumitas.com</span>
<span class="cm">Description: Simple/easy captcha to prevent spam at commenting.</span>
<span class="cm">Version: 0.1</span>
<span class="cm">Author: Nikolai</span>
<span class="cm">Author URI: http://incolumitas.com</span>
<span class="cm">License: GPLv2 or later</span>
<span class="cm">*/</span>

<span class="cm">/*  Copyright 2013  Nikolai  (email : admin@incolumitas.com)</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License, version 2, as </span>
<span class="cm">    published by the Free Software Foundation.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm"> *  A really simplistic approach to eliminate my spam problem on my</span>
<span class="cm"> *  website. Generates a captcha consisting of 4 figures and inserts</span>
<span class="cm"> *  some noise to prevent it from being cracked by skids.</span>
<span class="cm"> *  I think the effort of cracking it wouldn&#39;t take longer than 3 hours</span>
<span class="cm"> *  for an intermediate programmer. Its efectiveness lies in the captchas</span>
<span class="cm"> *  uniqueness. Generally, security by obfuscation is a bad idea. At least I </span>
<span class="cm"> *  know that :) When somebody tries to crack it, I will harden it. As long</span>
<span class="cm"> *  as you give up...</span>
<span class="cm"> */</span>

<span class="c1">// http://wpengineer.com/2214/adding-input-fields-to-the-comment-form/</span>
<span class="c1">// http://wpengineer.com/2205/comment-form-hooks-visualized/</span>

<span class="nb">define</span><span class="p">(</span><span class="s2">&quot;CCAPTCHA_DEBUG&quot;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">CCAPTCHA_DEBUG</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">error_reporting</span><span class="p">(</span><span class="k">E_ALL</span><span class="p">);</span>
  <span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;display_errors&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">define</span><span class="p">(</span><span class="s2">&quot;FIGURE_SIZE&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s2">&quot;NUM_BRUSH_CHANGES_MAX&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s2">&quot;PPM_FILE&quot;</span><span class="p">,</span> <span class="nx">plugin_dir_path</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;gen.ppm&quot;</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s2">&quot;CAPTCHA_PNG&quot;</span><span class="p">,</span> <span class="nx">plugin_dir_path</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;captcha.png&quot;</span><span class="p">);</span>

<span class="cm">/* Apply intercepting logic with wordpress API */</span>

<span class="c1">// Set a filter to add additional input fields for the comment</span>
<span class="nx">add_filter</span><span class="p">(</span><span class="s1">&#39;comment_form_defaults&#39;</span><span class="p">,</span> <span class="s1">&#39;ccaptcha_comment_form_defaults&#39;</span><span class="p">);</span>
<span class="c1">// Add a filter to verify if the captch was correct</span>
<span class="nx">add_filter</span><span class="p">(</span><span class="s1">&#39;preprocess_comment&#39;</span><span class="p">,</span> <span class="s1">&#39;ccaptcha_check&#39;</span><span class="p">);</span>
<span class="c1">// Add a action hook to add the additioal field to the db</span>
<span class="nx">add_action</span><span class="p">(</span><span class="s1">&#39;comment_post&#39;</span><span class="p">,</span> <span class="s1">&#39;ccaptcha_save_input&#39;</span><span class="p">);</span>

<span class="k">function</span> <span class="nf">ccaptcha_save_input</span><span class="p">(</span><span class="nv">$comment_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">add_comment_meta</span><span class="p">(</span><span class="nv">$comment_id</span><span class="p">,</span>
            <span class="s1">&#39;ccaptcha&#39;</span><span class="p">,</span> <span class="nb">strip_tags</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ccaptcha&#39;</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">ccaptcha_check</span><span class="p">(</span><span class="nv">$commentdata</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="nv">$current_user</span><span class="p">;</span>
    <span class="nx">get_currentuserinfo</span><span class="p">();</span>
    <span class="nv">$uid</span> <span class="o">=</span> <span class="nv">$current_user</span><span class="o">-&gt;</span><span class="na">ID</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$uid</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ccaptcha&#39;</span><span class="p">]))</span>
          <span class="nx">wp_die</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Error: You need to enter the captcha.&#39;</span><span class="p">));</span>

        <span class="nv">$answer</span> <span class="o">=</span> <span class="nb">strip_tags</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;ccaptcha&#39;</span><span class="p">]);</span>
        <span class="nv">$generated</span> <span class="o">=</span> <span class="nx">get_option</span><span class="p">(</span><span class="s1">&#39;ccaptcha&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">strcasecmp</span><span class="p">(</span><span class="nv">$answer</span><span class="p">,</span> <span class="nv">$generated</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
          <span class="nx">wp_die</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Error: Your supplied captcha is incorrect.&#39;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$commentdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create the captcha and store the string in the database.</span>
<span class="cm"> */</span>
<span class="k">function</span> <span class="nf">ccaptcha_comment_form_defaults</span><span class="p">(</span><span class="nv">$default</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$answer</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">ccaptcha_generate</span><span class="p">());</span>

    <span class="c1">// Well, that is ugly, but how else?</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">get_option</span><span class="p">(</span><span class="s1">&#39;ccaptcha&#39;</span><span class="p">))</span>
        <span class="nx">add_option</span><span class="p">(</span><span class="s1">&#39;ccaptcha&#39;</span><span class="p">,</span> <span class="nv">$answer</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="nx">update_option</span><span class="p">(</span><span class="s1">&#39;ccaptcha&#39;</span><span class="p">,</span> <span class="nv">$answer</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_user_logged_in</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$default</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">.=</span> 
            <span class="s1">&#39;&lt;img id=&quot;captcha_image&quot; src=&quot;&#39;</span><span class="o">.</span><span class="nx">__</span><span class="p">(</span><span class="nx">plugin_dir_url</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">))</span><span class="o">.</span><span class="s1">&#39;captcha.png&quot;&gt;</span>
<span class="s1">            &lt;p class=&quot;comment-form-captcha&quot;&gt;</span>
<span class="s1">            &lt;label for=&quot;captcha&quot;&gt;&#39;</span><span class="o">.</span><span class="nx">__</span><span class="p">(</span><span class="s1">&#39;Captcha&#39;</span><span class="p">)</span><span class="o">.</span> <span class="s1">&#39;&lt;/label&gt;</span>
<span class="s1">            &lt;input id=&quot;ccaptcha&quot; name=&quot;ccaptcha&quot; size=&quot;30&quot; type=&quot;text&quot; /&gt;&lt;/p&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$default</span><span class="p">;</span>
<span class="p">}</span>

<span class="sd">/*** CunningCaptcha Logic begins ***/</span>

<span class="k">function</span> <span class="nf">ccaptcha_generate</span><span class="p">()</span> <span class="p">{</span>

  <span class="nv">$h</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nx">PPM_FILE</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$h</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">&quot;fopen() error&quot;</span><span class="p">;</span>
  <span class="nb">var_dump</span><span class="p">(</span><span class="nb">error_get_last</span><span class="p">());</span>
  <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nv">$figures</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="nv">$str</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="nv">$index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$index</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="nv">$index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$choose</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>

      <span class="k">switch</span> <span class="p">(</span><span class="nv">$choose</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
            <span class="nv">$figures</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_1</span><span class="p">();</span> <span class="nv">$str</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
            <span class="nv">$figures</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_7</span><span class="p">();</span> <span class="nv">$str</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;7&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
            <span class="nv">$figures</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_E</span><span class="p">();</span> <span class="nv">$str</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
            <span class="nv">$figures</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_Z</span><span class="p">();</span> <span class="nv">$str</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>

  <span class="nv">$captcha</span> <span class="o">=</span> <span class="nx">glue_figures</span><span class="p">(</span><span class="nv">$figures</span><span class="p">);</span>

  <span class="nv">$width</span> <span class="o">=</span> <span class="nx">FIGURE_SIZE</span> <span class="o">*</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$figures</span><span class="p">);</span>
  <span class="nv">$height</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$captcha</span><span class="p">);</span>

  <span class="cm">/* write the ppm header */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">fwrite</span><span class="p">(</span><span class="nv">$h</span><span class="p">,</span> <span class="s2">&quot;P3</span><span class="se">\n</span><span class="si">$width</span><span class="s2"> </span><span class="si">$height\n255\n</span><span class="s2">&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;fwrite(header) failed&#39;</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$height</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;</span> <span class="nv">$width</span><span class="p">;</span> <span class="nv">$j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$h</span><span class="p">,</span> <span class="nv">$captcha</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$h</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nb">fclose</span><span class="p">(</span><span class="nv">$h</span><span class="p">);</span>

  <span class="cm">/* Convert to png and remove ppm */</span>
  <span class="nb">system</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;pnmtopng %s &gt; %s &amp;&amp; rm %s;&quot;</span><span class="p">,</span>
                <span class="nx">PPM_FILE</span><span class="p">,</span> <span class="nx">CAPTCHA_PNG</span><span class="p">,</span> <span class="nx">PPM_FILE</span><span class="p">));</span>

  <span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Glue the figures together. Expects an array of figures. Returns</span>
<span class="cm"> * a single array representing the bitmap, ready to print...</span>
<span class="cm"> */</span>
<span class="k">function</span> <span class="nf">glue_figures</span><span class="p">(</span><span class="nv">$array_figures</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$captcha</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">());</span>
    <span class="nv">$off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nv">$pad_size</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$pad_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nv">$pad_size</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// make even</span>

    <span class="nv">$pad_size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nv">$shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nv">$index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$index</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$array_figures</span><span class="p">);</span> <span class="nv">$index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$shift</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$pad_size</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="o">+</span><span class="nv">$pad_size</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="p">;</span> <span class="nv">$j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$off</span> <span class="o">=</span> <span class="nx">FIGURE_SIZE</span> <span class="o">*</span> <span class="nv">$index</span> <span class="o">+</span> <span class="nv">$j</span><span class="p">;</span>
          <span class="nv">$captcha</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$off</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rand_grey</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&gt;</span> <span class="nv">$pad_size</span> <span class="o">&amp;&amp;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="o">+</span><span class="nv">$pad_size</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$captcha</span><span class="p">[</span><span class="nv">$i</span><span class="o">-</span><span class="nv">$shift</span><span class="p">][</span><span class="nv">$off</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$array_figures</span><span class="p">[</span><span class="nv">$index</span><span class="p">][</span><span class="nv">$i</span><span class="o">-</span><span class="nv">$pad_size</span><span class="p">][</span><span class="nv">$j</span><span class="p">];</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$captcha</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get a random grey scale color to make some noise :) */</span>
<span class="k">function</span> <span class="nf">rand_grey</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$grey</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;%s %s %s&quot;</span><span class="p">,</span> <span class="nv">$grey</span><span class="p">,</span> <span class="nv">$grey</span><span class="p">,</span> <span class="nv">$grey</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get a random color */</span>
<span class="k">function</span> <span class="nf">rand_color</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">sprintf</span>
    <span class="p">(</span>
            <span class="s2">&quot;%s %s %s&quot;</span><span class="p">,</span>
            <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
            <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
            <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$one</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">());</span>
  <span class="c1">// Apply a random shift</span>
  <span class="nv">$r_offset</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">FIGURE_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
  <span class="c1">// the number of changing the brush color of the figure</span>
  <span class="nv">$n_color_changes</span> <span class="o">=</span> <span class="nx">FIGURE_SIZE</span> <span class="o">/</span> 
            <span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">NUM_BRUSH_CHANGES_MAX</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="c1">// Get a random brush</span>
  <span class="nv">$brush</span> <span class="o">=</span> <span class="nx">rand_color</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">%</span> <span class="nv">$n_color_changes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nv">$brush</span> <span class="o">=</span> <span class="nx">rand_color</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="p">;</span> <span class="nv">$j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Fill the rest with greyscale colors</span>
    <span class="nv">$one</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rand_grey</span><span class="p">();</span>

    <span class="c1">// The tree of the &#39;1&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span> <span class="o">||</span> 
        <span class="nv">$j</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="nv">$r_offset</span><span class="p">)</span> <span class="p">{</span>
       <span class="nv">$one</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$brush</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// The hook of the &#39;1&#39;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nv">$i</span> <span class="o">+</span> <span class="nv">$j</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span> <span class="o">&amp;&amp;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="nv">$i</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="nv">$j</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span> <span class="o">&amp;&amp;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="nv">$one</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$brush</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$one</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_7</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$seven</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">());</span>
  <span class="c1">// Apply a random shift</span>
  <span class="nv">$r_offset</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">FIGURE_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
  <span class="c1">// the number of changing the brush color of the figure</span>
  <span class="nv">$n_color_changes</span> <span class="o">=</span> <span class="nx">FIGURE_SIZE</span> <span class="o">/</span> 
            <span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">NUM_BRUSH_CHANGES_MAX</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="c1">// Get a random brush</span>
  <span class="nv">$brush</span> <span class="o">=</span> <span class="nx">rand_color</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">%</span> <span class="nv">$n_color_changes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nv">$brush</span> <span class="o">=</span> <span class="nx">rand_color</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="p">;</span> <span class="nv">$j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Fill the rest with greyscale colors</span>
      <span class="nv">$seven</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rand_grey</span><span class="p">();</span>

      <span class="c1">// The roof of the &#39;7&#39;</span>
      <span class="k">if</span> <span class="p">((</span><span class="nv">$i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nv">$i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
              <span class="nv">$j</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="nv">$seven</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="o">-</span><span class="nv">$r_offset</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$brush</span><span class="p">;</span>

      <span class="c1">// The tree of the &#39;7&#39;</span>
      <span class="k">if</span> <span class="p">(</span>  <span class="p">(</span><span class="nv">$i</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$j</span><span class="p">)</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span>      <span class="o">||</span>
            <span class="p">(</span><span class="nv">$i</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span>    <span class="o">||</span>
            <span class="p">((</span><span class="nv">$i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$j</span><span class="p">)</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span>  <span class="o">||</span>
            <span class="p">((</span><span class="nv">$i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span> <span class="p">)</span>
        <span class="nv">$seven</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$brush</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$seven</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_Z</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$z</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">());</span>
  <span class="c1">// Apply a random shift</span>
  <span class="nv">$r_offset</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">FIGURE_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
  <span class="c1">// the number of changing the brush color of the figure</span>
  <span class="nv">$n_color_changes</span> <span class="o">=</span> <span class="nx">FIGURE_SIZE</span> <span class="o">/</span> 
            <span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">NUM_BRUSH_CHANGES_MAX</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="c1">// Get a random brush</span>
  <span class="nv">$brush</span> <span class="o">=</span> <span class="nx">rand_color</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">%</span> <span class="nv">$n_color_changes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nv">$brush</span> <span class="o">=</span> <span class="nx">rand_color</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="p">;</span> <span class="nv">$j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Fill the rest with greyscale colors</span>
      <span class="nv">$z</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rand_grey</span><span class="p">();</span>

      <span class="c1">// The roof and soil of the &#39;Z&#39;</span>
      <span class="k">if</span> <span class="p">(((</span><span class="nv">$i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nv">$i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> 
          <span class="p">(</span><span class="nv">$i</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nv">$i</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
           <span class="nv">$j</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="nv">$z</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="o">-</span><span class="nv">$r_offset</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$brush</span><span class="p">;</span>

      <span class="c1">// The tree of the &#39;Z&#39;</span>
      <span class="k">if</span> <span class="p">(</span>  <span class="p">(</span><span class="nv">$i</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$j</span><span class="p">)</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span>      <span class="o">||</span>
            <span class="p">(</span><span class="nv">$i</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span>    <span class="o">||</span>
            <span class="p">((</span><span class="nv">$i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$j</span><span class="p">)</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span>  <span class="o">||</span>
            <span class="p">((</span><span class="nv">$i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nv">$j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span> <span class="p">)</span>
        <span class="nv">$z</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$brush</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$z</span><span class="p">;</span> 
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_E</span><span class="p">()</span> <span class="p">{</span>  
  <span class="nv">$e</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">());</span>
  <span class="c1">// Apply a random shift</span>
  <span class="nv">$r_offset</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">FIGURE_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
  <span class="c1">// the number of changing the brush color of the figure</span>
  <span class="nv">$n_color_changes</span> <span class="o">=</span> <span class="nx">FIGURE_SIZE</span> <span class="o">/</span> 
            <span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">NUM_BRUSH_CHANGES_MAX</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="c1">// Get a random brush</span>
  <span class="nv">$brush</span> <span class="o">=</span> <span class="nx">rand_color</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">%</span> <span class="nv">$n_color_changes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nv">$brush</span> <span class="o">=</span> <span class="nx">rand_color</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;</span> <span class="nx">FIGURE_SIZE</span><span class="p">;</span> <span class="nv">$j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Fill the rest with greyscale colors</span>
      <span class="nv">$e</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rand_grey</span><span class="p">();</span>

      <span class="c1">// The left vertical bar</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="nv">$r_offset</span> <span class="o">||</span>
          <span class="nv">$j</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nv">$r_offset</span><span class="p">)</span>
        <span class="nv">$e</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$brush</span><span class="p">;</span>

      <span class="c1">// The three balks of the &#39;E&#39;</span>
      <span class="k">if</span> <span class="p">(((</span><span class="nv">$i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nv">$i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> 
          <span class="p">(</span><span class="nv">$i</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nv">$i</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
          <span class="p">(</span><span class="nv">$i</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nv">$i</span> <span class="o">==</span> <span class="nx">FIGURE_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
          <span class="cm">/* prevent out of bounds indices */</span>
          <span class="o">&amp;&amp;</span> <span class="nv">$j</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">FIGURE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="nv">$e</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="nv">$j</span><span class="o">-</span><span class="nv">$r_offset</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$brush</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$e</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/googlesearch-a-rapid-python-class-to-get-search-results.html#googlesearch-a-rapid-python-class-to-get-search-results">GoogleScraper.py - A simple python module to parse google search results.</a></h2>
    <p>
      Posted on So 06 Januar 2013 in <a href="/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="/tag/google.html">Google</a>,      <a href="/tag/scraping.html">Scraping</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/security.html">Security</a>    </p>
  </header>
  <div>
      <p><strong>UPDATE on 18th February 2014:</strong></p>
<p>This python module has now <a href="https://github.com/NikolaiT/GoogleScraper" title="github repo for GoogleScraper">its own github
repository</a>!</p>
<p>The plugin can extract</p>
<ul>
<li>All links</li>
<li>Link titles</li>
<li>The description/caption below the links</li>
</ul>
<p>and has the following features:</p>
<ul>
<li>Advanced proxy support for SOCKS4/4a/5 and HTTP PROXY</li>
<li>Multithreading</li>
<li>XPATH parsing</li>
<li>Supports almost <a href="http://www.google.com/support/enterprise/static/gsa/docs/admin/70/gsa_doc_set/xml_reference/" title="search protocol reference">all search
    parameters</a></li>
</ul>
<p>Please note that this is by no means a permanent version! Heavy
structural changes will be implemented in the near future (I'll
experiment with asynchronous networking for instance). But on this site,
I will always host a working version with instructions how to use it,
such that visitors can always use the script!</p>
<p><strong>1. Edit (07.01.2013):</strong></p>
<ul>
<li>Using requests instead of urllib</li>
<li>Added random User Agents for every new search.</li>
<li>Cleaned the code</li>
<li>Implemented foundation to combine with proxychains</li>
</ul>
<h3>Original Blog Post</h3>
<p>Sample output after searching for 'cats are not cute' (sorry) with 100
results per page on 3 ascending pages:
<a href="/uploads/2013/01/out.txt">results.txt</a></p>
<p>I always was in need of a fast and reliable working python module to
query the google search engine. The google API is rubbish, because they
just give you maximally 36 results. This is completly inacceptable!</p>
<p>So, I looked further and foundÂ <a href="http://code.google.com/p/pygoogle/">http://code.google.com/p/pygoogle/</a>,
which is not what we want. They say:</p>
<blockquote>
<p><em>pygoogle is aÂ <strong>very basic</strong>Â Google search module for Python. It has
a limitation of only 64 results. If you want more results, see
xgoogle.<a href="http://www.catonmat.net/blog/python-library-for-google-translate/"><br />
</a></em></p>
</blockquote>
<p>Le optimistic me goes to the homepage of
<a href="http://www.catonmat.net/blog/python-library-for-google-search/">xgoogle</a>,
just to be disappointed again. The module seems broken and imports some
outdated libraries and is generally very very large. The author probably
did a nice job, but I immediately realized that I have to implement my
own. This was unacceptable, since my python programming knowledge and
coding style really lacks any depth and profundity.</p>
<p><strong>The module should basically satisfy two purposes:</strong></p>
<ul>
<li>Parse arbitrary number of pages with maximally number of search
    results per page.</li>
<li>Clean the found urls from badboys like 'gstatic.com' or 'google.com'</li>
</ul>
<p><strong>What can you use the module for?</strong></p>
<ul>
<li>Statistics</li>
<li>Find vulnerable applications</li>
<li>scanning lots of sites with dorks (with intext, inurl, site
    parameters usable in the query!)</li>
</ul>
<p><strong>To-do list (06.01.2013):</strong></p>
<ul>
<li>Clean the code. Treat all errors correctly and make the script more
    robust.</li>
<li>Add functionality, like a parallel yahoo and bing search to compare
    the search results to gain maximal knowledge!</li>
<li>Provide better configuration freedom. There are a lot of google
    search parameters :/</li>
<li>Maybe: Port to Python 2.7</li>
</ul>
<h3>Usage</h3>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">GoogleScraper</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">GoogleScraper</span><span class="o">.</span><span class="n">scrape</span><span class="p">(</span><span class="s">&#39;Best SEO tool&#39;</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">num_pages</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">link_title</span><span class="p">,</span> <span class="n">link_snippet</span><span class="p">,</span> <span class="n">link_url</span> <span class="ow">in</span> <span class="n">page</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]:</span>
            <span class="c"># You can access all parts of the search results like that</span>
            <span class="c"># link_url.scheme =&gt; URL scheme specifier (Ex: &#39;http&#39;)</span>
            <span class="c"># link_url.netloc =&gt; Network location part (Ex: &#39;www.python.org&#39;)</span>
            <span class="c"># link_url.path =&gt; URL scheme specifier (Ex: &#39;&#39;help/Python.html&#39;&#39;)</span>
            <span class="c"># link_url.params =&gt; Parameters for last path element</span>
            <span class="c"># link_url.query =&gt; Query component</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">link_url</span><span class="o">.</span><span class="n">geturl</span><span class="p">()))</span> <span class="c"># This reassembles the parts of the url to the whole thing</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c"># How many urls did we get on all pages?</span>
<span class="k">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">results</span><span class="p">))</span>

<span class="c"># How many hits has google found with our keyword (as shown on the first page)?</span>
<span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;num_results_for_kw&#39;</span><span class="p">])</span>
</pre></div>


<p><strong>[Warning: This description is deprecated, the sources are fresh
tough]</strong></p>
<p>How it works: Basically you create aÂ GoogleScraper object with the
query to search. You also specify the number of results per page
(10,25,50 or 100) you want to obtain. Then you call the method search()
on the new made object with a parameter indicating the number of pages
too search for. I didn't try how many pages I can scrape\^\^ It's up to
you to tell me!</p>
<p>TheÂ GoogleScraper.search() methods returns a list of special tuples!
Each of these tuples represents a URL. If you want to know more about
this special tupel, please read the python
<a href="http://docs.python.org/3.2/library/urllib.parse.html#url-parsing">documentation</a>.</p>
<p>The module is here:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/python3</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Complete rewrite.</span>
<span class="sd">Many thanks go to v3nz3n</span>

<span class="sd">This is a little module that uses Google to automate search</span>
<span class="sd">queries. It gives straightforward access to all relevant data of Google such as</span>
<span class="sd">- The links of the result page</span>
<span class="sd">- The title of the links</span>
<span class="sd">- The caption/description below each link</span>
<span class="sd">- The number of results for this keyword</span>

<span class="sd">GoogleScraper&#39;s architecture outlined:</span>
<span class="sd">- Proxy support (Socks5, Socks4, HTTP Proxy)</span>
<span class="sd">- Threading support</span>

<span class="sd">The module implements some countermeasures to circumvent spamming detection</span>
<span class="sd">from the Google Servers:</span>
<span class="sd">{List them here}</span>

<span class="sd">Note: Scraping compromises the google terms of service (TOS).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__VERSION__</span> <span class="o">=</span> <span class="s">&#39;0.4&#39;</span>
<span class="n">__UPDATED__</span> <span class="o">=</span> <span class="s">&#39;17.02.2014&#39;</span> <span class="c"># day.month.year</span>
<span class="n">__AUTHOR__</span> <span class="o">=</span> <span class="s">&#39;Nikolai Tschacher&#39;</span>
<span class="n">__WEBSITE__</span> <span class="o">=</span> <span class="s">&#39;incolumitas.com&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">lxml.html</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">choice</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">requests</span>
    <span class="kn">from</span> <span class="nn">cssselect</span> <span class="k">import</span> <span class="n">HTMLTranslator</span><span class="p">,</span> <span class="n">SelectorError</span>
    <span class="kn">from</span> <span class="nn">bs4</span> <span class="k">import</span> <span class="n">UnicodeDammit</span>
    <span class="kn">import</span> <span class="nn">socks</span> <span class="c"># should be in the same directory</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s">&#39;You can install missing modules with `pip install [modulename]`&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># module wide global variables and configuration</span>

<span class="c"># First obtain a logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;GoogleScraper&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39;</span><span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

<span class="c"># Whether caching shall be enabled</span>
<span class="n">DO_CACHING</span> <span class="o">=</span> <span class="k">True</span>
<span class="c"># The directory path for cached google results</span>
<span class="n">CACHEDIR</span> <span class="o">=</span> <span class="s">&#39;.scrapecache/&#39;</span>

<span class="k">if</span> <span class="n">DO_CACHING</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="mo">0o744</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GoogleSearchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Exception in GoogleSearch class&#39;</span>


<span class="k">class</span> <span class="nc">InvalidNumberResultsException</span><span class="p">(</span><span class="n">GoogleSearchError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_results</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nres</span> <span class="o">=</span> <span class="n">number_of_results</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;{} is not a valid number of results per page&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nres</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">maybe_clean_cache</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Delete all .cache files in the cache directory that are older than 12 hours.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">12</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>

<span class="k">if</span> <span class="n">DO_CACHING</span><span class="p">:</span>
    <span class="c"># Clean the CACHEDIR once in a while</span>
    <span class="n">maybe_clean_cache</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">cached_file_name</span><span class="p">(</span><span class="n">search_params</span><span class="p">):</span>
    <span class="n">sha</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
    <span class="c"># Make a unique file name based on the values of the google search parameters.</span>
    <span class="n">sha</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">search_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">search_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="k">return</span> <span class="s">&#39;{}.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sha</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="s">&#39;cache&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_cached</span><span class="p">(</span><span class="n">search_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads a cached search results page from scrapecache/fname.cache</span>

<span class="sd">    It helps in testing and avoid requesting</span>
<span class="sd">    the same resources again and again (such that google may</span>
<span class="sd">    recognize us as what we are: Sneaky SEO crawlers!)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">cached_file_name</span><span class="p">(</span><span class="n">search_params</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">):</span>
            <span class="c"># If the cached file is older than 12 hours, return False and thus</span>
            <span class="c"># make a new fresh request.</span>
            <span class="n">modtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">modtime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">False</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unexpected file not found: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">return</span> <span class="k">False</span>


<span class="k">def</span> <span class="nf">cache_results</span><span class="p">(</span><span class="n">search_params</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stores a html resource as a file in scrapecache/fname.cache</span>

<span class="sd">    This will always write(overwrite) the cache file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">cached_file_name</span><span class="p">(</span><span class="n">search_params</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GoogleScrape</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Offers a fast way to query the google search engine.</span>

<span class="sd">    Overrides the run() method of the superclass threading.Thread.</span>
<span class="sd">    Each thread represents a crawl for one Google Results Page.</span>

<span class="sd">    http://www.blueglass.com/blog/google-search-url-parameters-query-string-anatomy/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Valid URL (taken from django)</span>
    <span class="n">_REGEX_VALID_URL</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s">r&#39;^(?:http|ftp)s?://&#39;</span> <span class="c"># http:// or https://</span>
        <span class="s">r&#39;(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+(?:[A-Z]{2,6}\.?|[A-Z0-9-]{2,}\.?)|&#39;</span> <span class="c"># domain...</span>
        <span class="s">r&#39;localhost|&#39;</span> <span class="c"># localhost...</span>
        <span class="s">r&#39;\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})&#39;</span> <span class="c"># ...or ip</span>
        <span class="s">r&#39;(?::\d+)?&#39;</span> <span class="c"># optional port</span>
        <span class="s">r&#39;(?:/?|[/?]\S+)$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">_REGEX_VALID_URL_SIMPLE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s">&#39;http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&amp;+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+&#39;</span><span class="p">)</span>

    <span class="c"># Named tuple type for the search results</span>
    <span class="n">Result</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;LinkResult&#39;</span><span class="p">,</span> <span class="s">&#39;link_title link_snippet link_url&#39;</span><span class="p">)</span>

    <span class="c"># Several different User-Agents to diversify the requests.</span>
    <span class="c"># Keep the User-Agents updated. Last update: 17th february 14</span>
    <span class="c"># Get them here: http://techblog.willshouse.com/2012/01/03/most-common-user-agents/</span>
    <span class="n">_UAS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/537.73.11 (KHTML, like Gecko) Version/7.0.1 Safari/537.73.11&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:26.0) Gecko/20100101 Firefox/26.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.107 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.77 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.107 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.102 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.102 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (iPhone; CPU iPhone OS 7_0_4 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11B554a Safari/9537.53&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:26.0) Gecko/20100101 Firefox/26.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (iPad; CPU OS 7_0_4 like Mac OS X) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11B554a Safari/9537.53&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1; rv:26.0) Gecko/20100101 Firefox/26.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36&#39;</span>
    <span class="p">]</span>

    <span class="n">_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s">&#39;Mozilla/5.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;Accept&#39;</span><span class="p">:</span> <span class="s">&#39;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#39;</span><span class="p">,</span>
        <span class="s">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s">&#39;gzip, deflate&#39;</span><span class="p">,</span>
        <span class="s">&#39;Connection&#39;</span><span class="p">:</span> <span class="s">&#39;close&#39;</span><span class="p">,</span>
        <span class="s">&#39;DNT&#39;</span><span class="p">:</span> <span class="s">&#39;1&#39;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_query</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_page</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">search_params</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Initialises an object responsible for scraping one particular results page.</span>

<span class="sd">        @param search_query: The query to scrape for.</span>
<span class="sd">        @param num_results_per_page: The number of results per page. Must be smaller than 1000.</span>
<span class="sd">        (My tests though have shown that at most 100 results were returned per page)</span>
<span class="sd">        @param num_page: The number/index of the page.</span>
<span class="sd">        @param search_params: A dictionary with additional search params. The default search params is updated with this parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Created new GoogleScrape object with params: query={}, num_results_per_page={}, num_page={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">search_query</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="p">,</span> <span class="n">num_page</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span>
        <span class="k">if</span> <span class="n">num_results_per_page</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">):</span> <span class="c"># The maximum value of this parameter is 1000. See search appliance docs</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;The parameter -n must be smaller or equal to 1000&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidNumberResultsException</span><span class="p">(</span><span class="n">num_results_per_page</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_page</span><span class="o">*</span><span class="n">num_results_per_page</span> <span class="o">+</span> <span class="n">num_results_per_page</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;The maximal number of results for a query is 1000&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidNumberResultsException</span><span class="p">(</span><span class="n">num_page</span><span class="o">*</span><span class="n">num_results_per_page</span> <span class="o">+</span> <span class="n">num_results_per_page</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_results_per_page</span> <span class="o">=</span> <span class="n">num_results_per_page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_page</span> <span class="o">=</span> <span class="n">num_page</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_URL</span> <span class="o">=</span> <span class="s">&#39;http://www.google.com/search&#39;</span>

        <span class="c"># http://www.rankpanel.com/blog/google-search-parameters/</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># the search query string</span>
            <span class="s">&#39;num&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># the number of results per page</span>
            <span class="s">&#39;numgm&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Number of KeyMatch results to return with the results. A value between 0 to 50 can be specified for this option.</span>
            <span class="s">&#39;start&#39;</span><span class="p">:</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="c"># Specifies the index number of the first entry in the result set that is to be returned. page number = (start / num) + 1</span>
                          <span class="c"># The maximum number of results available for a query is 1,000, i.e., the value of the start parameter added to the value of the num parameter cannot exceed 1,000.</span>
            <span class="s">&#39;rc&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># Request an accurate result count for up to 1M documents. If a user submits a search query without the site parameter, the entire search index is queried.</span>
            <span class="s">&#39;site&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Limits search results to the contents of the specified collection.</span>
            <span class="s">&#39;sort&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Specifies a sorting method. Results can be sorted by date.</span>
            <span class="s">&#39;client&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># required parameter. Indicates a valid front end.</span>
            <span class="s">&#39;output&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># required parameter. Selects the format of the search results.</span>
            <span class="s">&#39;partialfields&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Restricts the search results to documents with meta tags whose values contain the specified words or phrases.</span>
            <span class="s">&#39;pws&#39;</span><span class="p">:</span> <span class="s">&#39;0&#39;</span><span class="p">,</span>      <span class="c"># personalization turned off</span>
            <span class="s">&#39;cd&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Passes down the keyword rank clicked.</span>
            <span class="s">&#39;filter&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c"># Include omitted results</span>
            <span class="s">&#39;complete&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c">#Turn auto-suggest and Google Instant on (=1) or off (=0)</span>
            <span class="s">&#39;nfpr&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c">#Turn off auto-correction of spelling</span>
            <span class="s">&#39;ncr&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c">#No country redirect: Allows you to set the Google country engine you would like to use despite your current geographic location.</span>
            <span class="s">&#39;safe&#39;</span><span class="p">:</span> <span class="s">&#39;off&#39;</span><span class="p">,</span> <span class="c"># Turns the adult content filter on or off</span>
            <span class="s">&#39;rls&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c">#Source of query with version of the client and language set, other examples are can be found</span>
            <span class="s">&#39;source&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span>  <span class="c">#Google navigational parameter specifying where you came from, here universal search</span>
            <span class="s">&#39;tbm&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Used when you select any of the âspecialâ searches, like image search or video search</span>
            <span class="s">&#39;tbs&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Also undocumented as `tbm`, allows you to specialize the time frame of the results you want to obtain.</span>
                         <span class="c"># Examples: Any time: tbs=qdr:a, Last second: tbs=qdr:s, Last minute: tbs=qdr:n, Last day: tbs=qdr:d, Time range: tbs=cdr:1,cd_min:3/2/1984,cd_max:6/5/1987</span>
                         <span class="c"># But the tbs parameter is also used to specify content:</span>
                         <span class="c"># Examples: Sites with images: tbs=img:1, Results by reading level, Basic level: tbs=rl:1,rls:0, Results that are translated from another language: tbs=clir:1,</span>
                         <span class="c"># For full documentation, see http://stenevang.wordpress.com/2013/02/22/google-search-url-request-parameters/</span>
            <span class="s">&#39;lr&#39;</span><span class="p">:</span> <span class="s">&#39;lang_de&#39;</span><span class="p">,</span> <span class="c"># Restricts searches to pages in the specified language. If there are no results in the specified language, the search appliance displays results in all languages .</span>
                             <span class="c"># lang_xx where xx is the country code such as en, de, fr, ca, ...</span>
            <span class="s">&#39;hl&#39;</span><span class="p">:</span> <span class="s">&#39;en&#39;</span><span class="p">,</span> <span class="c"># Language settings passed down by your browser</span>
            <span class="s">&#39;cr&#39;</span><span class="p">:</span> <span class="s">&#39;countryDE&#39;</span><span class="p">,</span> <span class="c"># The region the results should come from</span>
            <span class="s">&#39;gr&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Just as gl shows you how results look in a specified country, gr limits the results to a certain region</span>
            <span class="s">&#39;gcs&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Limits results to a certain city, you can also use latitude and longitude</span>
            <span class="s">&#39;gpc&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c">#Limits results to a certain zip code</span>
            <span class="s">&#39;gm&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># Limits results to a certain metropolitan region</span>
            <span class="s">&#39;gl&#39;</span><span class="p">:</span> <span class="s">&#39;de&#39;</span><span class="p">,</span> <span class="c"># as if the search was conducted in a specified location. Can be unreliable.</span>
            <span class="s">&#39;ie&#39;</span><span class="p">:</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="c"># Sets the character encoding that is used to interpret the query string.</span>
            <span class="s">&#39;oe&#39;</span><span class="p">:</span> <span class="s">&#39;utf-8&#39;</span> <span class="c"># Sets the character encoding that is used to encode the results.</span>
        <span class="p">}</span>

        <span class="c"># Maybe update the default search params when the user has supplied a dictionary</span>
        <span class="k">if</span> <span class="n">search_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">search_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">search_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;cache_file&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span> <span class="c"># A path to a file that caches the results.</span>
            <span class="s">&#39;search_keyword&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_query</span><span class="p">,</span> <span class="c"># The query keyword</span>
            <span class="s">&#39;num_results_for_kw&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># The number of results for the keyword</span>
            <span class="s">&#39;results&#39;</span><span class="p">:</span> <span class="p">[]</span> <span class="c"># List of Result named tuples</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make the the scrape and clean the URL&#39;s.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">()</span>

        <span class="c"># Now try to create ParseResult objects from the URL</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;/url\?q=(?P.*?)&amp;sa=U&amp;ei=&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">link_url</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REGEX_VALID_URL</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>   
                   <span class="bp">self</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">link_title</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">link_title</span><span class="p">,</span> <span class="n">link_url</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                                <span class="n">link_snippet</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">link_snippet</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;URL={} found to be invalid.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_build_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the headers and params for the GET request towards the Google server.</span>

<span class="sd">        When random is True, several headers (like the UA) are chosen</span>
<span class="sd">        randomly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_query</span><span class="p">,</span>
             <span class="s">&#39;num&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_results_per_page</span><span class="p">),</span>
             <span class="s">&#39;start&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_results_per_page</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_page</span><span class="p">))</span>
            <span class="p">})</span>

        <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADERS</span><span class="p">[</span><span class="s">&#39;User-Agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_UAS</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The actual search and parsing of the results.</span>

<span class="sd">        Private, internal method.</span>
<span class="sd">        Parsing is done with lxml and cssselect. The html structure of the Google Search</span>
<span class="sd">        results may change over time. Effective: February 2014</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_query</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">DO_CACHING</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">get_cached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;cache_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">cached_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="k">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">html</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADERS</span><span class="p">,</span>
                                 <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Scraped with url: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>

            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">cerr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Network problem occurred {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cerr</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>
                <span class="k">return</span> <span class="k">False</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">terr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Connection timeout {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">terr</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>
                <span class="k">return</span> <span class="k">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;HTTP Error:&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;5&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Maybe google recognizes you as sneaky spammer after&#39;</span>
                          <span class="s">&#39; you requested their services too inexhaustibly :D&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">False</span>

            <span class="n">html</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>
            <span class="c"># cache fresh results</span>
            <span class="k">if</span> <span class="n">DO_CACHING</span><span class="p">:</span>
                <span class="n">cache_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;cache_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHEDIR</span><span class="p">,</span> <span class="n">cached_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SEARCH_PARAMS</span><span class="p">))</span>

        <span class="c"># Try to parse the google HTML result using lxml</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">UnicodeDammit</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">is_html</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">doc</span><span class="o">.</span><span class="n">declared_html_encoding</span><span class="p">)</span>
            <span class="n">dom</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">document_fromstring</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>
            <span class="n">dom</span><span class="o">.</span><span class="n">resolve_base_href</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Some error occurred while lxml tried to parse: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">return</span> <span class="k">False</span>

        <span class="c"># Try to extract all links of non-ad results, including their snippets(descriptions) and titles.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">li_g_results</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">HTMLTranslator</span><span class="p">()</span><span class="o">.</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="s">&#39;li.g&#39;</span><span class="p">))</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">li_g_results</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">link_element</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">HTMLTranslator</span><span class="p">()</span><span class="o">.</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="s">&#39;h3.r &gt; a:first-child&#39;</span><span class="p">))</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">link_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">link_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error while parsing link/title element: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">snippet_element</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">HTMLTranslator</span><span class="p">()</span><span class="o">.</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="s">&#39;div.s &gt; span.st&#39;</span><span class="p">))</span>
                    <span class="n">snippet</span> <span class="o">=</span> <span class="n">snippet_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error while parsing snippet element: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">link_title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">link_url</span><span class="o">=</span><span class="n">link</span><span class="p">,</span> <span class="n">link_snippet</span><span class="o">=</span><span class="n">snippet</span><span class="p">))</span>
        <span class="c"># Catch further errors besides parsing errors that take shape as IndexErrors</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error in parsing result links: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>

        <span class="c"># try to get the number of results for our search query</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span><span class="p">[</span><span class="s">&#39;num_results_for_kw&#39;</span><span class="p">]</span> <span class="o">=</span>   
               <span class="n">dom</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">HTMLTranslator</span><span class="p">()</span><span class="o">.</span><span class="n">css_to_xpath</span><span class="p">(</span><span class="s">&#39;div#resultStats&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scrape</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_pages</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Public API function to search for terms and return a list of results.</span>

<span class="sd">    arguments:</span>
<span class="sd">    query -- the search query. Can be whatever you want to crawl google for.</span>

<span class="sd">    Keyword arguments:</span>
<span class="sd">    num_results_per_page -- the number of results per page. Either 10, 25, 50 or 100.</span>
<span class="sd">    num_pages -- The number of pages to search for.</span>
<span class="sd">    offset -- specifies the offset to the page to begin searching.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">GoogleScrape</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">num_results_per_page</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_pages</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">SEARCH_RESULTS</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">deep_scrape</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Launches many different Google searches with different parameter combinations to maximize return of results.</span>

<span class="sd">    @param query: The query to search for.</span>
<span class="sd">    @return: All the result sets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># First obtain some synonyms for the search query</span>

    <span class="c"># For each proxy, run the scrapes</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">&#39;GoogleScraper&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&#39;Scrapes the Google search engine&#39;</span><span class="p">,</span>
                                     <span class="n">epilog</span><span class="o">=</span><span class="s">&#39;This program might infringe Google TOS, so use at your own risk&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--query&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;search_string&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;query&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The search query.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--num_results_per_page&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;number_of_results_per_page&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;num_results_per_page&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The number of results per page. Most be &gt;= 100&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--num_pages&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;num_of_pages&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;num_pages&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The number of pages to search in. Each page is requested by a unique connection and if possible by a unique IP.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--proxy&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;proxycredentials&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;proxy&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="c">#default=(&#39;127.0.0.1&#39;, 9050)</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A string such as &quot;127.0.0.1:9050&quot; specifying a single proxy server&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--proxy_file&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;proxyfile&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;proxy_file&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="c">#default=&#39;.proxies&#39;</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A filename for a list of proxies (supported are HTTP PROXIES, SOCKS4/4a/5) with the following format: &quot;Proxyprotocol (proxy_ip|proxy_host):Port</span><span class="se">\\</span><span class="s">n&quot;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-x&#39;</span><span class="p">,</span> <span class="s">&#39;--deep-scrape&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Launches a wide range of parallel searches by modifying the search &#39;</span>   
                       <span class="s">&#39;query string with synonyms and by scraping with different Google search parameter combinations that might yield more unique &#39;</span>   
                       <span class="s">&#39;results. The algorithm is optimized for maximum of results for a specific keyword whilst trying avoid detection. This is the heart of GoogleScraper.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--view&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;View the response in a default browser tab.&quot;</span>
                                                                 <span class="s">&quot; Mainly for debug purposes. Works only when caching is enabled.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbosity&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;The verbosity of the output reporting for the found search results.&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy_file</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Coming soon.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">source_address</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socks</span><span class="o">.</span><span class="n">socksocket</span><span class="p">()</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sock</span>

        <span class="n">proxy_host</span><span class="p">,</span> <span class="n">proxy_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>

        <span class="c"># Patch the socket module</span>
        <span class="n">socks</span><span class="o">.</span><span class="n">setdefaultproxy</span><span class="p">(</span><span class="n">socks</span><span class="o">.</span><span class="n">PROXY_TYPE_SOCKS5</span><span class="p">,</span> <span class="n">proxy_host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">proxy_port</span><span class="p">),</span>
                              <span class="n">rdns</span><span class="o">=</span><span class="k">True</span><span class="p">)</span> <span class="c"># rdns is by default on true. Never use rnds=False with TOR, otherwise you are screwed!</span>
        <span class="n">socks</span><span class="o">.</span><span class="n">wrap_module</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span> <span class="o">=</span> <span class="n">create_connection</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">deep_scrape</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">deep_scrape</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">scrape</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_results_per_page</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_pages</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;{} links found! The search with the keyword &quot;{}&quot; yielded the result:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]),</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;search_keyword&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;num_results_for_kw&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">webbrowser</span>
            <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;cache_file&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">link_title</span><span class="p">,</span> <span class="n">link_snippet</span><span class="p">,</span> <span class="n">link_url</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Link: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">link_url</span><span class="o">.</span><span class="n">geturl</span><span class="p">())))</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">textwrap</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;Title: </span><span class="se">\n</span><span class="s">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">link_title</span><span class="p">,</span> <span class="mi">50</span><span class="p">)),</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s">&#39;Description: </span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">link_snippet</span><span class="p">,</span> <span class="mi">70</span><span class="p">)),</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</pre></div>
</td></tr></table>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/linuxunix-privileges-from-a-blackhats-perspective.html#linuxunix-privileges-from-a-blackhats-perspective">Linux/Unix privileges from a blackhats perspective</a></h2>
    <p>
      Posted on So 30 Dezember 2012 in <a href="/category/security.html">Security</a>
      &#8226; Tagged with
      <a href="/tag/privilegeescalation.html">Privilegeescalation</a>,      <a href="/tag/unix.html">Unix</a>,      <a href="/tag/security.html">Security</a>,      <a href="/tag/filepermissions.html">Filepermissions</a>    </p>
  </header>
  <div>
      <p>Hey folks!</p>
<p>Had some difficulties understanding UNIX file permissions in all it's
variations and eternal predisposition to misuse as adminman! Made a
little PDF, the independent blog article will follow soon. It's just a
pain in the ass to format all that LibreOffice into a nice wordpress
format. Next time, I will just do it in plain ASCII 7 Bit style,
goddamnit...</p>
<p>Hell, it's time to read some phrack stuff again :)</p>
<p><strong>Download PDF here:</strong> <a href="/uploads/2012/12/blackhats_view.pdf">blackhats_view</a>
)</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/bullet-chess-challange.html#bullet-chess-challange">Bullet chess challenge :)</a></h2>
    <p>
      Posted on Mo 26 November 2012 in <a href="/category/chess.html">Chess</a>
      &#8226; Tagged with
      <a href="/tag/learning.html">Learning</a>,      <a href="/tag/chess.html">Chess</a>    </p>
  </header>
  <div>
      <p>I realised once more, that, when I excessively play bullet chess, I tend
to stagnate or my performance even goes down the tubes. The reason
behind this, I am assuming, the absence of defined goal or when I play
without thinking (as far as thinking in bullet chess is the legit word)
or other bad behaviour, as listening to music...</p>
<p>Therefore, I will try a little experiment: I play every day not more
than 10 bullet games. This is around 20 minutes of playing. But every
time I lose, I have to to 6 full and slow chin-ups. I'll play on
chess.com and my starting rating is right nowÂ <strong>1924</strong>, which actually
is pretty high for me. Nevertheless, my goal is to reach ELO 2050. My
all time highscore isÂ <strong>1974.Â </strong>Let's go and breake some records...</p>
<p>Ok let the journey begin :)</p>
<ul>
<li>26.11.2012:Â <strong>1924 - 1896.Â </strong>Did around 30 chin-ups. Tired as hell.
    Lost too many times :)</li>
<li>28.11.2012 <strong>1896 - 1903.Â </strong>Back in the 1900s. Did lot's of chin
    ups. My game improved slightly, I think more and deeper. My speed is
    still to slow...</li>
<li>29.11.2012 <strong>1903 - 1900.Â </strong>I am stagnating, I have the impression
    that I still lack creativity and don't really want to play. My
    motivation is weak, but I am ways more concentrated compared to
    playing endless long sessions. 4 from 10 games were chin-ups. That
    means 24 chin ups :)</li>
<li>30.11.2012<strong>1900 - 1888</strong>. What the fuck? I play excellent but
    freaking slow :/</li>
<li>1.12.2012 <strong>1888 - 1926</strong>. It goes up and up :)</li>
<li>2.12.2012 <strong>1926 - 1945.Â </strong>Seems like I am back in the solid 1900s.
    This rating is close to my all time high and I am looking forward to
    make a new record and to fullfill my goal!</li>
<li>3.12.2012 <strong>1945 - 1865</strong>. Played like 50 games. That's the
    punishment. That was this opponent who really made me angry. Next
    time, I'll stick to the plan and won't get emotional. I shouldn't
    play more than 10 games. Waaaaah !</li>
<li>4.12.2012 <strong>1865 - 1909.Â </strong>Hangled myself brutally back in the 1900s
    with 2 wins against a 2200 elo player. Played my 10 games...</li>
<li>8.12.2012 <strong>1797 - 1825Â </strong>Don't ask. At least I played today 10
    games. 5 wins, 5 losts. I do now 5 * 10 pushups...</li>
<li>10.12.2012 <strong>1800 - 1847</strong></li>
<li>16.12.2012 <strong>1847 - 1823Â </strong>Played 10 games...</li>
<li>18.12.2012 <strong>1800 - 2000Â </strong>Hell yeah, I played at least 300 games
    the last days and I finally achieved the freakin 2000 Elo. To be
    honest, if I really tried I could crack my genuine goal of Elo 2050,
    but it's just ways to risky that I suddently digress and get
    unconcentrated and it begins all over. So I am stopping here. It's a
    new all time record since I played bullet chess (now aproximately 5
    years) and it's good like that. It's just too much time wasted ;)</li>
</ul>
<p>The message (not complete) I received on chess.com when I reached the
2000:</p>
<p>...</p>
<p><em>CongratulationsÂ <strong>zardaxt</strong>Â on achieving a high rating on Chess.com!
You are now among the strongest players on our site.</em></p>
<p>...</p>
<p>The challange ends with that...</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/bullet-chess-a-silly-game.html#bullet-chess-a-silly-game">Bullet Chess - A silly game?</a></h2>
    <p>
      Posted on Mo 05 November 2012 in <a href="/category/chess.html">Chess</a>
      &#8226; Tagged with
      <a href="/tag/chess.html">Chess</a>    </p>
  </header>
  <div>
      <p>I define bullet chess as games with one minute time for each
player.Â There are plenty of other definitions, but I think my
definitionÂ refers to the most common one. This article is definitely
worth a read andÂ helps to understand my further
deliberations:Â <a href="http://en.wikipedia.org/wiki/Fast_chess">http://en.wikipedia.org/wiki/Fast_chess</a></p>
<p>Well, besides my enthusiasm for IT security, I have always been a bullet
chess player with myself worrying adictive feautures. It all began
around three or four years ago,Â when I realised that simply too much
people tend to use chess engines on online platform and in addition, I
was just to nervous and unwilled to calculate and thinkÂ the average
(somehow boring long) length of a entire chess game. Bullet games came
perfect in this manner:Â It is almost impossible to cheat manually in
bullet games (of course you couldÂ write bots which directly interact
with the server through the underliningÂ protocol - HTTP when you're
lucky, or some really badass proprietary one, when youÂ have misfortune,
but I assume that's a rather low percentage). It turns out, that
myÂ renunciation of the original purpose of chess; thinking deep and
beeing patient,Â turned my in a slightly better long time chess player,
but what is more important: It letÂ me keep my fascination for this
highly complex and interesting game. Nevertheless, theÂ increase of
tension and fun comes also to a high price, I mentioned before: Addictve
elements ;)</p>
<p>I played more than once a whole night and I guess that I played more
than 10 000 games overÂ the last years. I saw people online with
astonishing 200 000 bullet games. Assuming this person was 10 years
onÂ this platform (which indeed is a very long time) this would be 55
bullet chess games perÂ day! This adds to (just a rough guess - supposing
a game is last a average 90 seconds) 1 hourÂ and 20 minutes spend on
chess for every day for freakin 10 years! This sounds crazy but may
notÂ be unrealistic. I played many times just against one player 80 games
withoutÂ interruption. Just think about it: 80 * 90 seconds = 7200/3600
= 2 hours of chess without any pause!</p>
<p>Although this might not be very healthy, there are lots of voices out
there which critizeÂ the nature and even raison ÃªtreÂ of bullet chess.
I'll list and argue against them, which finally,Â brings os to the
initial purpose of this blog post: Is bullet chess just a random, silly
game for playersÂ who suck at real chess?</p>
<p><strong>Prejudice 1. Bullet Chess is all about luck and moving figures
randomly.</strong></p>
<p>No, definitely not. While novice bullet chess players might judge it
this way, itÂ changes rapidly if you improve. With 60 seconds on your
clock, there is plenty of timeÂ to mate your opponent. Of course the
general approach to attack and defenseÂ is modified. Bringing your king
into a safe position is essential; you just don't haveÂ the time to
figure out, if you might be able to defend him. This reveals a very
importantÂ property of being successful (at least up to a specific
degree) in this kind of chess:<br />
Intuition and strategy over knowing and thinking!Â It is for example
ways easier to play in a situition in which you don't have to care for<br />
potential mate threats, but otherwise would be lost in a longer game,
due to some disadvantes in figure constellation or positioning. This
works as long as you have enough power to generate new mate threats, but
as soon asÂ your opponent can stop your attack he can just play very fast
towards figure exchange and run a peasant into a queen. If you run out
of threats and your opponent has three or 4 seconds left, this is
usually considered enough time to mate you.</p>
<p>And this brings us to the second fact: Better bullet chess players tend
to play stronger.Â This sounds stupid, but it isn't. Stronger isn't equal
to 'better' in bullet chess. Till a specificÂ rating (I'd say as far as
ELO 1650), playing faster means playing better in bullet chess terms.
But ifÂ you cross this border, while your improvement process, the
trade-off of playing<br />
strong and fast switches to playing strong. You might have 40 seconds
left after 30 moves, butÂ your ELO 2100 opponent has a indefendable mate
threat while 5 seconds remaining. Still owned...</p>
<p>Last but not least, you can disprove the above prejudice just like this:
On big online chess platforms,Â like chessbase, there are a wide range of
various strength classes of bullet players. Bullet players ELO rating,
whoÂ play often and are well trained, disperse around 1500-3000 ELO (at
least on chessbase), just likeÂ the equivalent players who just play
'real chess games'. If bullet was all about luck, why is the range so
big and diversified? JustÂ because they move in differeing velocity?
(yeah, it's a rethorical question).</p>
<p><strong>Prejudice 2. Real chess players don't play bullet games</strong></p>
<p>There are even big official blitz campionships and a lot of
grandmastersÂ play for fun and part time seriously blitz and bullet
games. It will neverÂ replace the original chess, but it has it's own
valid place.</p>
<p><strong>Prejudice 3. Mouse and high latency times make 'fair' games
impossible</strong></p>
<p>That's just nonsense. While the critisms are partially true for some
poorly programmedÂ web platforms, these arguments aren't valid for the
more sophisticated,Â non browser based chess platforms like chessbase,
where you're able to make premoves,Â have super low latency times and
much benefits. A normal mouse is perfectly fine andÂ you don't need to
invest money in special ones. I never understood the guys claiming
thatÂ I won because I possibly have the better mouse.</p>
<p>Despite everything said, I still have to admit that there is some kind
of hardware/configuration hurdle between novice or even average bullet
players and theÂ advanced onces: You have to figure out some tricks and
shenanigans which give you advantages:</p>
<ul>
<li>Use premoves</li>
<li>When you're both really short on time (1 or 2 second before timeout)
    and you still have a figure to sacrifce, do it while checking! Just
    make the most spatial imparing check possible, so that the opponent
    is forced to move and 'think'. Usually he's moving really fast some
    random peasants and then he is forced to move his mouse the whole
    way to the king, and, tadaaaa, you won on time!</li>
<li>Hands down: Bullet chess players are rude and emotional people,
    mainly because it's such a enormous mental stressing game. So, if
    you win on time, don't feel sorry about it! It's part of the game
    configuration, and winning on time is like winning on check mate.
    You were just better.</li>
<li>Check as often as you can. It steals time from your opponent.</li>
<li>Internalize openings.</li>
</ul>
<p><strong>Prejudice 4. Bullet chess is a silly game ;)</strong></p>
<p>I guess after you played it the first time, you very mentally so broken
that you became angry and blamed the game instead of yourself. It's a
hell of a thrilling, stressing and somehow insane game. It need sheer
unimaginable mental ressources, and not everyone can handel that! It's a
dead tough game, not a silly one, not ment for ramblers :D</p>
<p><strong>Prejudice 5. Bullet chess is bad, because it makes you a worse chess
player</strong></p>
<p>Often bullet chessÂ is considered as a game which ruins your normal chess
skillsÂ (as you can see on the wikipedia article above, even by world
famous chess players support this opinion), because it animates you to
move quickly and don't spend (too much) time on positional and general
thinking. Chess is by all means not a game designed to play in a minute.
I would never say that. What I want to say instead is, that we have to
carefully distinguish between the 2 games. They aren't the same. You
also don't say that hall football is stupid and silly because it
misinterprets the rules of the well known football. They are two similar
games (both played with balls, several players and on grass), but have
different approaches on tactics and strategy. And if you want to become
successful in bullet chess, you need to be deadly concentrated, very
fast, and in my opintion the most important, you constantly need to have
a inner overview over the time!</p>
<p>Write me and I would love to play some games with you, recently, I
prefer <a href="http://chess.com" title="chess.com">chess.com</a>, and if you dare to
challange a 1930 ELO player (of course just on bullet ;) ), I'll wait
for you :)</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="/index7.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
      <a class="btn float-right" href="/index5.html">
        Newer Posts <i class="fa fa-angle-right"></i>
      </a>
  </div>

    <footer>
      <p>&copy; Nikolai Tschacher 2015</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Coding, Learning and IT Security ",
  "url" : "",
  "image": "",
  "description": "Nikolai Tschacher's ideas and programming around security and computer science"
}
</script></body>
</html>