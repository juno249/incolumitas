<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Coding, Learning and IT Security</title><link href="/" rel="alternate"></link><link href="/feeds/security.atom.xml" rel="self"></link><id>/</id><updated>2013-03-15T23:12:00+01:00</updated><entry><title>No 1. - wp-members: Interesting peristant XSS leading to remote code execution.</title><link href="/no-1-wp-members-interesting-peristant-xss-leading-to-remote-code-execution.html" rel="alternate"></link><updated>2013-03-15T23:12:00+01:00</updated><author><name>admin</name></author><id>tag:,2013-03-15:no-1-wp-members-interesting-peristant-xss-leading-to-remote-code-execution.html</id><summary type="html">&lt;p&gt;Hey you there!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Type:&lt;/strong&gt; Stored cross site scripting&lt;br /&gt;
&lt;strong&gt;Risk:&lt;/strong&gt; Medium to high&lt;br /&gt;
&lt;strong&gt;Affecting:&lt;/strong&gt; http://wordpress.org/extend/plugins/wp-members/&lt;br /&gt;
&lt;strong&gt;Vendor site:&lt;/strong&gt; http://rocketgeek.com&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Preface&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;It has been quite some time since I took concern of my blog, although I
would have had some content ready (maybe even worth) to be published.
Around six weeks ago, I rummaged (wow - new word!) through endless lines
of wordpress plugin code, in the hope to get my hands on some low
hanging fruits (In the likely case you don't have a clue what I am
talking about: I was searching for easyily detectable security bugs in
plugin applications written for wordpress). After analysing for several
hours the architecture and design of a randomly chosen target -
&lt;a href="http://wordpress.org/extend/plugins/wp-members/"&gt;wp-members&lt;/a&gt;, a plugin
providing the site owner with the functionality to password protect
content on his wordpress site - I was able to detect a pretty nasty bug.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;The bug&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Alongside with the access restriction mechanism, the plugin furthermore
allows users to register. The potential user is presented a nice form,
which would transfer an array of registration data to the web server
when submitted. Considering this, there is only one possibile location
for a sink source and therefore origin of tainted data. The PHP file
handling the registration logic is not unsurprisingly called
wp-members-register.php. The vulnerable wp-members version can be found
&lt;a href="http://downloads.wordpress.org/plugin/wp-members.2.8.0.zip"&gt;here&lt;/a&gt; (zip
file of the youngest vulnerable version).&lt;/p&gt;
&lt;p&gt;The herein aforementioned wp-members-register.php-file contains a
unsound function named wpmem_registration( \$toggle ) which was
affected from two kinds of XSS flaws: Reflected and persistent (or
stored) XSS vulnerability. Whereas the reflected isn't really dangerous
(modern browsers easily spot them and filter them out by recognizing
script tags and html entities in the URL), the peristent on the other
hand might become rather unpleasant.&lt;/p&gt;
&lt;p&gt;This first code snippet shows the preparation of the input and some
parsing. We learn that the input is written into a two dimensional array
named \$fields.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;// build array of the posts&lt;/span&gt;
&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields&lt;/span&gt;&lt;span class="x"&gt; = get_option( &amp;#39;wpmembers_fields&amp;#39; );&lt;/span&gt;
&lt;span class="x"&gt;for( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt; = 0; &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt; &amp;lt; count( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields&lt;/span&gt;&lt;span class="x"&gt; ); &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;++ ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;    &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fieldval_arr&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;] = &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;_POST&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;][2]];&lt;/span&gt;
&lt;span class="x"&gt;    // add for _data hooks&lt;/span&gt;
&lt;span class="x"&gt;    if( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;][2] != &amp;#39;password&amp;#39; &amp;amp;&amp;amp; &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;][4] == &amp;#39;y&amp;#39; ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;          &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;fields&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;][2]] = &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fieldval_arr&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;];&lt;/span&gt;
&lt;span class="x"&gt;    }&lt;/span&gt;
&lt;span class="x"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The program logic continues with some checks for obligatory data:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;// check for required fields    &lt;/span&gt;
&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields_rev&lt;/span&gt;&lt;span class="x"&gt; = array_reverse( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields&lt;/span&gt;&lt;span class="x"&gt; );&lt;/span&gt;
&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fieldval_arr_rev&lt;/span&gt;&lt;span class="x"&gt; = array_reverse( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fieldval_arr&lt;/span&gt;&lt;span class="x"&gt; );&lt;/span&gt;

&lt;span class="x"&gt;for( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt; = 0; &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt; &amp;lt; count(&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields&lt;/span&gt;&lt;span class="x"&gt;); &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;++ ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;    &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;pass_chk&lt;/span&gt;&lt;span class="x"&gt; = ( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;toggle&lt;/span&gt;&lt;span class="x"&gt; == &amp;#39;update&amp;#39; &amp;amp;&amp;amp; &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields_rev&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;][2] == &amp;#39;password&amp;#39; ) ? true : false;&lt;/span&gt;
&lt;span class="x"&gt;    if( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields_rev&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;][5] == &amp;#39;y&amp;#39; &amp;amp;&amp;amp; &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;pass_chk&lt;/span&gt;&lt;span class="x"&gt; == false ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;        if( !&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fieldval_arr_rev&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;] ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt; &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_themsg&lt;/span&gt;&lt;span class="x"&gt; = sprintf( __(&amp;#39;Sorry, %s is a required field.&amp;#39;, &amp;#39;wp-members&amp;#39;), &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_fields_rev&lt;/span&gt;&lt;span class="x"&gt;[&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="x"&gt;][1] ); }&lt;/span&gt;
&lt;span class="x"&gt;    }&lt;/span&gt;
&lt;span class="x"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then, the we find ourselves in a big switch statement which states the
whole remainder of the function. It basically consists of two cases:
register and update. Since we are only interested in the register
functionality, we ingore the update branch.&lt;/p&gt;
&lt;p&gt;Now the coder implements some counter action against injection attacks.
He checks the supplied username if the corresponding user exists, has
valid characters and so on. When some of these checks fail, the script
denies further execution. It makes essentially the same with the
supplied email address.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;if( !&lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;username&lt;/span&gt;&lt;span class="x"&gt; ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt; &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_themsg&lt;/span&gt;&lt;span class="x"&gt; = __( &amp;#39;Sorry, username is a required field&amp;#39;, &amp;#39;wp-members&amp;#39; ); return &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_themsg&lt;/span&gt;&lt;span class="x"&gt;; exit(); } &lt;/span&gt;
&lt;span class="x"&gt;if( !validate_username( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;username&lt;/span&gt;&lt;span class="x"&gt; ) ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt; &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_themsg&lt;/span&gt;&lt;span class="x"&gt; = __( &amp;#39;The username cannot include non-alphanumeric characters.&amp;#39;, &amp;#39;wp-members&amp;#39; ); return &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_themsg&lt;/span&gt;&lt;span class="x"&gt;; exit(); }&lt;/span&gt;
&lt;span class="x"&gt;if( !is_email( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;user_email&lt;/span&gt;&lt;span class="x"&gt;) ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt; &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_themsg&lt;/span&gt;&lt;span class="x"&gt; = __( &amp;#39;You must enter a valid email address.&amp;#39;, &amp;#39;wp-members&amp;#39; ); return &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_themsg&lt;/span&gt;&lt;span class="x"&gt;; exit(); }&lt;/span&gt;
&lt;span class="x"&gt;if( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;wpmem_themsg&lt;/span&gt;&lt;span class="x"&gt; ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt; return &amp;quot;empty&amp;quot;; exit(); }&lt;/span&gt;
&lt;span class="x"&gt;if( username_exists( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;username&lt;/span&gt;&lt;span class="x"&gt; ) ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt; return &amp;quot;user&amp;quot;; exit(); } &lt;/span&gt;
&lt;span class="x"&gt;if( email_exists( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;user_email&lt;/span&gt;&lt;span class="x"&gt; ) ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt; return &amp;quot;email&amp;quot;; exit(); }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;At this point, our \$fields array is partly sanitized, the rest is still
populated with arbitrary raw data we are able to control.&lt;/p&gt;
&lt;p&gt;~~~~ {.lang:default .decode:true}
Array
(
    [username] =&amp;gt; uuuuuuuu                      SANITIZED
    [user_email] =&amp;gt; uuuuuuuu@uuuuuuuu.com       SANITIZED
    [first_name] =&amp;gt; uuuuuuuu
    [last_name] =&amp;gt; uuuuuuuu
    [addr1] =&amp;gt; uuuuuuuu
    [addr2] =&amp;gt; uuuuuuuu
    [city] =&amp;gt; uuuuuuuu
    [thestate] =&amp;gt; uuuuuuuu
    [zip] =&amp;gt; uuuuuuuu
    [country] =&amp;gt; uuuuuuuu
    [phone1] =&amp;gt; uuuuuuuu
)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;We&lt;/span&gt; &lt;span class="k"&gt;finally&lt;/span&gt; &lt;span class="nx"&gt;come&lt;/span&gt; &lt;span class="nx"&gt;to&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;first&lt;/span&gt; &lt;span class="nx"&gt;part&lt;/span&gt; &lt;span class="nx"&gt;of&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;vulnerability&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="nx"&gt;The&lt;/span&gt; &lt;span class="nx"&gt;raw&lt;/span&gt; &lt;span class="nx"&gt;post&lt;/span&gt;
&lt;span class="nx"&gt;data&lt;/span&gt; &lt;span class="nx"&gt;is&lt;/span&gt; &lt;span class="nx"&gt;inserted&lt;/span&gt; &lt;span class="nx"&gt;into&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;database&lt;/span&gt; &lt;span class="nx"&gt;through&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;wordpress&lt;/span&gt; &lt;span class="nx"&gt;API&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;
&lt;span class="nx"&gt;update&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="nx"&gt;_user&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="nx"&gt;_meta&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;

    &lt;span class="c1"&gt;// set remaining fields to wp_usermeta table&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="nx"&gt;$row&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nx"&gt;$row&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="nx"&gt;count&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="nx"&gt;$wpmem_fields&lt;/span&gt; &lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="nx"&gt;$row&lt;/span&gt;&lt;span class="o"&gt;++&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="nx"&gt;$wpmem_fields&lt;/span&gt;&lt;span class="cp"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;$row&lt;/span&gt;&lt;span class="cp"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="cp"&gt;]&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;password&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="nx"&gt;$wpmem_fields&lt;/span&gt;&lt;span class="cp"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;$row&lt;/span&gt;&lt;span class="cp"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="cp"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;user_url&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="c1"&gt;// if the field is user_url, it goes in the wp_users table&lt;/span&gt;
                &lt;span class="nx"&gt;wp_update_user&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="nx"&gt;array&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ID&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;$user_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;user_url&amp;#39;&lt;/span&gt; &lt;span class="nx"&gt;$wpmem_fieldval_arr&lt;/span&gt;&lt;span class="cp"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;$row&lt;/span&gt;&lt;span class="cp"&gt;]&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;);&lt;/span&gt;
            &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="nx"&gt;$wpmem_fields&lt;/span&gt;&lt;span class="cp"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;$row&lt;/span&gt;&lt;span class="cp"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="cp"&gt;]&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;user_email&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="c1"&gt;// email is already done above, so if it&amp;#39;s not email...&lt;/span&gt;
                    &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="nx"&gt;$wpmem_fields&lt;/span&gt;&lt;span class="cp"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;$row&lt;/span&gt;&lt;span class="cp"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="cp"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;y&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="c1"&gt;// are we using this field?&lt;/span&gt;
                                          &lt;span class="nx"&gt;update_user_meta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="nx"&gt;$user_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;$wpmem_fields&lt;/span&gt;&lt;span class="cp"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;$row&lt;/span&gt;&lt;span class="cp"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="cp"&gt;]&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;$wpmem_fieldval_arr&lt;/span&gt;&lt;span class="cp"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;$row&lt;/span&gt;&lt;span class="cp"&gt;]&lt;/span&gt; &lt;span class="p"&gt;);&lt;/span&gt;
                    &lt;span class="p"&gt;}&lt;/span&gt;
                &lt;span class="p"&gt;}&lt;/span&gt;
            &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt; 

&lt;span class="nx"&gt;Unfortunately&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;these&lt;/span&gt; &lt;span class="nx"&gt;family&lt;/span&gt; &lt;span class="nx"&gt;of&lt;/span&gt; &lt;span class="nx"&gt;wordpress&lt;/span&gt; &lt;span class="nx"&gt;API&lt;/span&gt; &lt;span class="nx"&gt;functions&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;update&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="nx"&gt;_user&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="nx"&gt;_meta&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="nx"&gt;don&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;t strip html meta characters (no&lt;/span&gt;
&lt;span class="s1"&gt;htmlspecialchars() functionality!). Maybe the author assumed that they&lt;/span&gt;
&lt;span class="s1"&gt;would.&lt;/span&gt;

&lt;span class="s1"&gt;However, now we know that we can insert arbitrary data (thus also html&lt;/span&gt;
&lt;span class="s1"&gt;and javascript code) into the database. This is nothing special or even&lt;/span&gt;
&lt;span class="s1"&gt;insecure yet, because the application could still sanitize the data when&lt;/span&gt;
&lt;span class="s1"&gt;retrieving it from the database and processing it further. Unfortunately&lt;/span&gt;
&lt;span class="s1"&gt;this doesn&amp;#39;&lt;/span&gt;&lt;span class="nx"&gt;t&lt;/span&gt; &lt;span class="nx"&gt;happen&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;

&lt;span class="nx"&gt;Well&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="nx"&gt;The&lt;/span&gt; &lt;span class="nx"&gt;next&lt;/span&gt; &lt;span class="nx"&gt;idea&lt;/span&gt; &lt;span class="nx"&gt;of&lt;/span&gt; &lt;span class="nx"&gt;mine&lt;/span&gt; &lt;span class="nx"&gt;was&lt;/span&gt; &lt;span class="nx"&gt;too&lt;/span&gt; &lt;span class="nx"&gt;look&lt;/span&gt; &lt;span class="nx"&gt;at&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;admin&lt;/span&gt; &lt;span class="nx"&gt;panel&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="nx"&gt;I&lt;/span&gt; &lt;span class="nx"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="k"&gt;this&lt;/span&gt; &lt;span class="nx"&gt;panel&lt;/span&gt; &lt;span class="nx"&gt;may&lt;/span&gt; &lt;span class="nx"&gt;show&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;tainted&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt; &lt;span class="nx"&gt;data&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="nx"&gt;a&lt;/span&gt; &lt;span class="nx"&gt;table&lt;/span&gt; &lt;span class="nx"&gt;or&lt;/span&gt; &lt;span class="nx"&gt;something&lt;/span&gt;
&lt;span class="nx"&gt;similar&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="nx"&gt;And&lt;/span&gt; &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="err"&gt;&amp;#39;&lt;/span&gt;&lt;span class="nx"&gt;s&lt;/span&gt; &lt;span class="nx"&gt;what&lt;/span&gt; &lt;span class="nx"&gt;it&lt;/span&gt; &lt;span class="nx"&gt;does&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;

&lt;span class="nx"&gt;An&lt;/span&gt; &lt;span class="nx"&gt;wordpress&lt;/span&gt; &lt;span class="nx"&gt;administrator&lt;/span&gt; &lt;span class="nx"&gt;can&lt;/span&gt; &lt;span class="nx"&gt;access&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;wordpress&lt;/span&gt; &lt;span class="nx"&gt;plugin&lt;/span&gt; &lt;span class="nx"&gt;wp&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nx"&gt;members&lt;/span&gt;
&lt;span class="nx"&gt;over&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;general&lt;/span&gt; &lt;span class="nx"&gt;admin&lt;/span&gt; &lt;span class="nx"&gt;panel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;Plugins&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;Users&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;WP&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nx"&gt;members&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="nx"&gt;Then&lt;/span&gt;
&lt;span class="nx"&gt;he&lt;/span&gt; &lt;span class="nx"&gt;sees&lt;/span&gt; &lt;span class="nx"&gt;a&lt;/span&gt; &lt;span class="nx"&gt;table&lt;/span&gt; &lt;span class="nx"&gt;overview&lt;/span&gt; &lt;span class="nx"&gt;of&lt;/span&gt; &lt;span class="nx"&gt;all&lt;/span&gt; &lt;span class="nx"&gt;registered&lt;/span&gt; &lt;span class="nx"&gt;users&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt; &lt;span class="nx"&gt;The&lt;/span&gt; &lt;span class="nx"&gt;corresponding&lt;/span&gt; &lt;span class="nx"&gt;URL&lt;/span&gt;
&lt;span class="nx"&gt;to&lt;/span&gt; &lt;span class="nx"&gt;obtain&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt; &lt;span class="nx"&gt;view&lt;/span&gt; &lt;span class="nx"&gt;is&lt;/span&gt;
&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="c1"&gt;//localhost/wp/wp-admin/users.php?page=wpmem-users (*localhost/wp*&lt;/span&gt;
&lt;span class="nx"&gt;is&lt;/span&gt; &lt;span class="nx"&gt;my&lt;/span&gt; &lt;span class="nb"&gt;document&lt;/span&gt; &lt;span class="nx"&gt;root&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt; &lt;span class="k"&gt;case&lt;/span&gt;&lt;span class="p"&gt;...)&lt;/span&gt;

&lt;span class="nx"&gt;Well&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;the&lt;/span&gt; &lt;span class="nx"&gt;table&lt;/span&gt; &lt;span class="nx"&gt;consits&lt;/span&gt; &lt;span class="nx"&gt;of&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt; &lt;span class="nx"&gt;columns&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;

&lt;span class="o"&gt;~~~~&lt;/span&gt; &lt;span class="p"&gt;{.&lt;/span&gt;&lt;span class="nx"&gt;lang&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="k"&gt;default&lt;/span&gt; &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;decode&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="s2"&gt;&amp;quot;Username   &lt;/span&gt;
&lt;span class="s2"&gt;Name    &lt;/span&gt;
&lt;span class="s2"&gt;E-mail  &lt;/span&gt;
&lt;span class="s2"&gt;Phone   &lt;/span&gt;
&lt;span class="s2"&gt;Country&lt;/span&gt;
&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Remember that our investigations revealed that we are able to insert
html/javascript into the database for the Name, Phone and Country field?
Let's check, where this admin panel is made and wheter the data is
sanitized:&lt;/p&gt;
&lt;p&gt;The view is generated through the function wpmem_admin_users() in the
/wp-content/plugins/wp-members/user.php file. The actual&lt;br /&gt;
value submitted at registration time is then echoed to the page at line
261:&lt;br /&gt;
Excerpt:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;echo &amp;quot;  ID}&amp;amp;&amp;quot; . esc_attr( stripslashes( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;_SERVER&lt;/span&gt;&lt;span class="x"&gt;[&amp;#39;REQUEST_URI&amp;#39;] ) ) . &amp;quot;\&amp;quot;&amp;gt;&amp;quot; . &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;user&lt;/span&gt;&lt;span class="x"&gt;-&amp;gt;user_login . &amp;quot;\n&amp;quot;;&lt;/span&gt;
&lt;span class="x"&gt;echo &amp;quot;  \n&amp;quot;;&lt;/span&gt;
&lt;span class="x"&gt;echo &amp;quot;  &amp;quot; . get_user_meta( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;user&lt;/span&gt;&lt;span class="x"&gt;-&amp;gt;ID, &amp;#39;first_name&amp;#39;, &amp;#39;true&amp;#39; ) . &amp;quot; &amp;quot; . get_user_meta( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;user&lt;/span&gt;&lt;span class="x"&gt;-&amp;gt;ID, &amp;#39;last_name&amp;#39;, &amp;#39;true&amp;#39; ) . &amp;quot;\n&amp;quot;;&lt;/span&gt;
&lt;span class="x"&gt;echo &amp;quot;  &amp;quot; . &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;user&lt;/span&gt;&lt;span class="x"&gt;-&amp;gt;user_email . &amp;quot;\n&amp;quot;;&lt;/span&gt;

&lt;span class="x"&gt;        if( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;col_phone&lt;/span&gt;&lt;span class="x"&gt; == true ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;echo &amp;quot;  &amp;quot; . get_user_meta( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;user&lt;/span&gt;&lt;span class="x"&gt;-&amp;gt;ID, &amp;#39;phone1&amp;#39;, &amp;#39;true&amp;#39; ) . &amp;quot;\n&amp;quot;;&lt;/span&gt;
&lt;span class="x"&gt;        }&lt;/span&gt;

&lt;span class="x"&gt;        if( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;col_country&lt;/span&gt;&lt;span class="x"&gt; == true ) &lt;/span&gt;&lt;span class="err"&gt;{&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;echo &amp;quot;  &amp;quot; . get_user_meta( &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;user&lt;/span&gt;&lt;span class="x"&gt;-&amp;gt;ID, &amp;#39;country&amp;#39;, &amp;#39;true&amp;#39; ) . &amp;quot;\n&amp;quot;;&lt;/span&gt;
&lt;span class="x"&gt;        }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The value isn't propperly escaped, neither at the time when inserted
into the database, nor when selected with get_user_meta(). Maybe the
coder thought that get_user_meta() is XSS safe?!&lt;/p&gt;
&lt;p&gt;The code is only triggered when a user with a field containing the
exploit code is shown in the admin table. This is normally not the case,
because there are a vast amount of of users and they are distributed
over many sites in the panel. Why is that no reduce the threat level of
the attack vector?&lt;br /&gt;
Users are listed in alphabetical order in the admin panel, according to
the usernames alphabetical position submitted at registration. So we can
force with a username like 'aaaaaaaaaaaaaaa' (of course not so
suspicous) that we are shown (echoed) easily at the first page! This
means our exploit code is always triggered when the admin access the
plugin panel, therefore the exploitation chances are pretty good!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;How would a blackhat design the exploit?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The original data shouldn't look suspicous, no suspicion at all should
be provocated (sneaky stealth mode enabled). The javascript code
shouldn't take long to execute or alter the front end surface. The code
must be maximally redundant and should be obfuscated and of course well
tested!&lt;br /&gt;
Wikipedia says:&lt;/p&gt;
&lt;p&gt;&lt;em&gt;"""The persistent (or stored) XSS vulnerability is a more devastating
variant of a cross-site scripting flaw: it occurs when the data provided
by the attacker is saved by the server, and then permanently displayed
on "normal" pages returned to other users in the course of regular
browsing, without proper HTML escaping.&lt;br /&gt;
"""&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;When the payload is triggered, we automatically have the admin cookie.
So we could steal the cookie and send it to the attackers server to log
in from there and upload a shell. This is ways too strenuous and
verbose, so we directly manipulate a existing plugin via the built-in
plugin-editor of wordpress. The nonce is no further problem, since we
just know it (XSS eliminates XSRF prevention!) At the exectution time
the exploit could send a little notification message to our server and
then that blackhat, knows that his shell is ready for him to access.&lt;/p&gt;
&lt;p&gt;​4. How can we find vulnerable sites including the plugin?&lt;/p&gt;
&lt;p&gt;Google dork of wp-members:&lt;/p&gt;
&lt;p&gt;&lt;em&gt;"This content is restricted to site members."&lt;/em&gt;&lt;br /&gt;
I recenty published a python script to scan pages with google =&gt;
&lt;a href="http://incolumitas.com/2013/01/06/googlesearch-a-rapid-python-class-to-get-search-results"&gt;http://incolumitas.com/2013/01/06/googlesearch-a-rapid-python-class-to-get-search-results&lt;/a&gt;&lt;br /&gt;
We could scan pages with the above dork and find lots of sites with the
installed vulnerable plugin.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;The consequences&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;On every server where wp-members is installed and when the registration
is open (which is the normal case, since a sane website never refuses
users\^\^), a malicious user can register with valid data (to pass
several registration checks) and the additional exploit code in the
&lt;em&gt;phone&lt;/em&gt; or &lt;em&gt;country&lt;/em&gt; field in the registration form.&lt;br /&gt;
Whenever a admin looks at the overview in his admin panel from
wp-members, the injected code is executed. Because the javascript code
runs in the context of the admin, the code is absolutely TRUSTED (stored
XSS):The code can do whatever action the wordpress admin panel provides.
For example: Change the PHP code of another plugin over the standard
edit function provided in the wordpress admin panel
(/wp/wp-admin/plugin-editor.php) to something like&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cm"&gt;/* Bet you get the idea */&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and gain a remote shell on the server. This means the server is fully
compromised (at least http/sql). No need to crack salted md5 hashes,
like in boring sql injections. Direct RCE.&lt;/p&gt;
&lt;p&gt;The plugin currently has (271,196) downloads (242,142 when I found the
bug 6 weeks ago), 600 downloads on a daily base. I estimate the number
of servers who actually installed the plugin at around 30.000 (is this
actually very modest guessing). Due to the nature of the flaw:&lt;br /&gt;
I guess that a determined blackhat could find 80% of all vulnerable
servers through spiders. Furthmore, modestly guessing, on 30% of these
servers the&lt;br /&gt;
exploit would be triggered. This makes: 0.8*0.3*30.000 = 7200. After
adjusting downwards, realisticly 5000 servers could be compromised
(shell access) within a short period of time (few days to a week).
These&lt;br /&gt;
servers could act as a neat DOS-Botnet; servers have lot's of
networking power, don't they?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Prevention&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Sanitizing untrusted data. It's always the same story. Wheter it's a
command execution, buffer overflows, sqli injections, XSS, there is one
simple approach to chocke off the root of the problem: Allow only data
into the application, which compares positvly with a whitelist. This
sounds easy, indeed it is, but under the financial pressure of greedy
organizations and general coding stress, security is often ignored and
missed.&lt;/p&gt;
&lt;p&gt;On the technical side, htmlspecialchars() over the \$fields[] array in
wp-members-register.php.&lt;br /&gt;
htmlspecialchars() over every data the user is able to manipulate and
craft!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Last words&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This was only the most gaping flaw, the other became (yeah, they exist)
rather uninteresting, since I had already a way to get on the server.
Chad Butler, the author, fixed the bugs very quickly and professionaly.
He took all my suggestions/concerns very serious and it was generally a
nice experience working with him!&lt;/p&gt;</summary></entry><entry><title>Linux/Unix privileges from a blackhats perspective</title><link href="/linuxunix-privileges-from-a-blackhats-perspective.html" rel="alternate"></link><updated>2012-12-30T23:18:00+01:00</updated><author><name>admin</name></author><id>tag:,2012-12-30:linuxunix-privileges-from-a-blackhats-perspective.html</id><summary type="html">&lt;p&gt;Hey folks!&lt;/p&gt;
&lt;p&gt;Had some difficulties understanding UNIX file permissions in all it's
variations and eternal predisposition to misuse as adminman! Made a
little PDF, the independent blog article will follow soon. It's just a
pain in the ass to format all that LibreOffice into a nice wordpress
format. Next time, I will just do it in plain ASCII 7 Bit style,
goddamnit...&lt;/p&gt;
&lt;p&gt;Hell, it's time to read some phrack stuff again :)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Download PDF here:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="http://incolumitas.com/?attachment_id=175"&gt;blackhats_view&lt;/a&gt;&lt;/p&gt;</summary><category term="file permissions"></category><category term="privilege escalation"></category><category term="security"></category><category term="UNIX"></category></entry></feed>